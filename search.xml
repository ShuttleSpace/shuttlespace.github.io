<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Flutter-Image</title>
    <url>/2019/06/05/Flutter-Image/</url>
    <content><![CDATA[<p>æ˜¾ç¤ºå›¾ç‰‡çš„ç»„ä»¶.</p>
<a id="more"></a>
<p>æä¾›äº†ä»¥ä¸‹å‡ ä¸ªä¸åŒç”¨é€”çš„æ„é€ æ–¹æ³•:</p>
<ul>
<li><code>new Image</code>: ä» <code>ImageProvider</code> ä¸­è·å–å›¾ç‰‡.</li>
<li><code>new Image.asset</code>: ä½¿ç”¨ key ä» <code>AssetBundle</code> ä¸­è·å–å›¾ç‰‡</li>
<li><code>new Image.network</code>: ä» URL ä¸­è·å–å›¾ç‰‡</li>
<li><code>new Image.file</code>: ä» <code>File</code> ä¸­è·å–å›¾ç‰‡</li>
<li><code>new Image.memory</code>: ä» <code>Uint8List</code> ä¸­è·å–å›¾ç‰‡</li>
</ul>
<p>æ”¯æŒä»¥ä¸‹å›¾ç‰‡æ ¼å¼: JPEG,PNG,GIF,Animated GIF,WebP,Animated WebP,BMP,WBMP.</p>
<p>ä¸ºäº†è‡ªåŠ¨å®ç°åƒç´ å¯†åº¦çº§çš„èµ„äº§ç®¡ç†, ç¡®ä¿åœ¨ <code>MaterialApp</code>,<code>WidgetsApp</code>,<code>MediaQuery</code>ç»„ä»¶æ ‘ä¸­ä½¿ç”¨ <code>AssetImage</code> æŒ‡å®šçš„ <code>Image</code> ç»„ä»¶.</p>
<p>å›¾ç‰‡æ˜¯ç”¨ <code>paintImage</code> ç”»å‡ºæ¥çš„,å®ƒåŒ…å«äº† Image ä¸­çš„ä¸åŒå±æ€§è¯¦æƒ…æè¿°.</p>
<h2 id="ç±»ä¼¼ç»„ä»¶"><a href="#ç±»ä¼¼ç»„ä»¶" class="headerlink" title="ç±»ä¼¼ç»„ä»¶"></a>ç±»ä¼¼ç»„ä»¶</h2><ul>
<li><code>Icon</code></li>
<li><code>new Ink.Image</code>: åœ¨ material app ä¸­æ¨èä½¿ç”¨(ç‰¹åˆ«æ˜¯å›¾ç‰‡åœ¨ <code>Material</code> ä¸­,è€Œä¸”ä¸Šé¢æœ‰ <code>InkWell</code>)</li>
<li><code>Image</code>: <code>dart:ui</code> æä¾›</li>
</ul>
<h2 id="ç»§æ‰¿-ğŸŒ²"><a href="#ç»§æ‰¿-ğŸŒ²" class="headerlink" title="ç»§æ‰¿ ğŸŒ²"></a>ç»§æ‰¿ ğŸŒ²</h2><p><code>Object &gt; Diagnosticable &gt; DiagnosticableTree &gt; Widget &gt; StatefulWidget &gt; Image</code></p>
<h2 id="å±æ€§"><a href="#å±æ€§" class="headerlink" title="å±æ€§"></a>å±æ€§</h2><ul>
<li><code>alignment</code> -&gt; <code>AlignmentGeometry</code></li>
<li><code>centerSlice</code> -&gt; <code>Rect</code>: .9 å›¾</li>
<li><code>color</code> -&gt; <code>Color</code></li>
<li><code>colorBlendMode</code> -&gt; <code>BlendMode</code>: æ··åˆé¢œè‰²</li>
<li><code>excludeFromSemantics</code> -&gt; <code>bool</code></li>
<li><code>filterQuality</code> -&gt; <code>FilterQuality</code></li>
<li><code>fit</code> -&gt; <code>BoxFit</code></li>
<li><code>gaplessPlayback</code> -&gt; <code>bool</code>: å½“ image provider æ”¹å˜æ—¶æ˜¯å¦æ˜¾ç¤ºæ—§çš„å›¾ç‰‡.</li>
<li><code>heihgt</code> -&gt; <code>double</code></li>
<li><code>image</code> -&gt; <code>ImageProvider</code></li>
<li><code>matchTextDirection</code> -&gt; <code>bool</code></li>
<li><code>repeat</code> -&gt; <code>ImageRepeat</code></li>
<li><code>semanticLabel</code> -&gt; <code>String</code></li>
<li><code>width</code> -&gt; <code>double</code></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Flutter-Text</title>
    <url>/2019/06/06/Flutter-Text/</url>
    <content><![CDATA[<p>å­—ç¬¦ä¸²æ ¹æ®å¸ƒå±€çº¦æŸå¯èƒ½è·¨è¶Šå¤šè¡Œæˆ–è€…åªæ˜¾ç¤ºåœ¨ä¸€è¡Œ.</p>
<a id="more"></a>
<p><code>style</code> å‚æ•°æ˜¯å¯é€‰çš„.å¦‚æœå¿½ç•¥,é»˜è®¤ä½¿ç”¨æœ€è¿‘çš„çˆ¶ç»„ä»¶çš„ <code>DefaultTextStyle</code>.å¦‚æœç»™å®šçš„æ ·å¼ <code>TextStyle.inherit</code> å±æ€§ä¸º true(é»˜è®¤),åˆ™ç»™å®šçš„æ ·å¼å°†å’Œæœ€è¿‘çš„çˆ¶ç»„ä»¶çš„ <code>DefaultTextStyle</code> åˆå¹¶.è¿™ä¸ªåˆå¹¶æ“ä½œå¾ˆæœ‰ç”¨,ä¾‹å¦‚ä½¿ç”¨é»˜è®¤çš„ font family å’Œå¤§å°ä½¿å­—ä½“ bold.</p>
<p>ä½¿ç”¨ <code>Text.rich</code> æ„é€ æ–¹æ³•,<code>Text</code> ç»„ä»¶å¯ä»¥ä½¿ç”¨ä¸åŒçš„ <code>TextSpan</code> æ ·å¼æ˜¾ç¤ºä¸€æ®µæ–‡å­—.</p>
<h3 id="äº¤äº’"><a href="#äº¤äº’" class="headerlink" title="äº¤äº’"></a>äº¤äº’</h3><p>ä½¿ç”¨ <code>GestureDetector</code> ç»„ä»¶,è®¾ç½® <code>GestureDetector.onTap</code> å¤„ç†å™¨å¯ä»¥ä½¿ <code>Text</code> å“åº” touch äº‹ä»¶.</p>
<p>åœ¨ material design è®¾è®¡ app ä¸­,å¯ä»¥ä½¿ç”¨ <code>FlatButton</code> ä»£æ›¿,å¦‚æœä¸é€‚åˆçš„è¯,æœ€å°‘éƒ½åº”è¯¥ä½¿ç”¨ <code>InkWell</code> ä»£æ›¿ <code>GestureDetector</code>.</p>
<p>ä¸ºäº†ä½¿æ–‡æœ¬åˆ†éƒ¨åˆ†äº¤äº’,ä½¿ç”¨ <code>RichText</code>,åœ¨ç›¸å…³éƒ¨åˆ†æ–‡æœ¬ä¸ŠæŒ‡å®š <code>TapGestureRecognize</code> ä½œä¸º <code>TextSpan.recognizer</code>.</p>
<h3 id="ç»§æ‰¿-ğŸŒ²"><a href="#ç»§æ‰¿-ğŸŒ²" class="headerlink" title="ç»§æ‰¿ ğŸŒ²"></a>ç»§æ‰¿ ğŸŒ²</h3><p><code>Object &gt; Diagnosticable &gt; DiiagnosticableTree &gt; Widget &gt; StatelessWidget &gt; Text</code></p>
]]></content>
  </entry>
  <entry>
    <title>Flutter-Row</title>
    <url>/2019/06/04/Flutter-Row/</url>
    <content><![CDATA[<p>ä»¥æ¨ªå‘æ•°ç»„çš„æ–¹å¼æ˜¾ç¤ºå­ç»„ä»¶çš„ç»„ä»¶.</p>
<a id="more"></a>
<p>ä¸ºäº†ä½¿å…¶ä¸€ä¸ªç»„ä»¶å¡«å……å‰©ä½™å¯ç”¨ç©ºé—´,å¯ä»¥ä½¿ç”¨ <code>Expanded</code>å¯¹å…¶è¿›è¡ŒåŒ…è£….</p>
<p><code>Row</code> ç»„ä»¶ä¸ä¼šæ»‘åŠ¨(é€šå¸¸ä¸€ä¸ª<code>Row</code>ç»„ä»¶ä¸­çš„å­ç»„ä»¶è¿‡å¤šå·²ç»è¶…å‡ºäº†å¯ç”¨ç©ºé—´,åˆ™ä¼šå¯¼è‡´é”™è¯¯).å¦‚æœåœ¨ä¸è¶³çš„ç©ºé—´ä¸­æƒ³è¦ä¸€æ’ç»„ä»¶èƒ½å¤Ÿæ»‘åŠ¨,å¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>ListView</code>.</p>
<p><code>Column</code> ç«–å‘æ’åˆ—.</p>
<p>å¦‚æœä»…æœ‰ä¸€ä¸ªå­ç»„ä»¶,é‚£ä¹ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>Align</code> æˆ– <code>Center</code> å®šä½è¯¥å­ç»„ä»¶.</p>
<h4 id="ä¸ºä»€ä¹ˆæˆ‘çš„-row-æœ‰ä¸€æ¡é»„é»‘ç›¸é—´çš„æ¡çº¹"><a href="#ä¸ºä»€ä¹ˆæˆ‘çš„-row-æœ‰ä¸€æ¡é»„é»‘ç›¸é—´çš„æ¡çº¹" class="headerlink" title="ä¸ºä»€ä¹ˆæˆ‘çš„ row æœ‰ä¸€æ¡é»„é»‘ç›¸é—´çš„æ¡çº¹?"></a>ä¸ºä»€ä¹ˆæˆ‘çš„ row æœ‰ä¸€æ¡é»„é»‘ç›¸é—´çš„æ¡çº¹?</h4><p>å¦‚æœ <code>Row</code>çš„å†…å®¹æ˜¯ä¸å¯ä¼¸ç¼©æ‰©å±•çš„(æ²¡æœ‰ä½¿ç”¨ <code>Expanded</code> æˆ– <code>Flexible</code> ç»„ä»¶åŒ…è£…),è¿åœ¨ä¸€èµ·æ¯” row æœ¬èº«æ›´å®½,é‚£ä¹ˆæˆ‘ä»¬å°±ç§° row æº¢å‡ºäº†.<br>å¦‚æœ row æº¢å‡ºäº†,é‚£ä¹ˆ row å°±æ²¡æœ‰å¤šä½™çš„ç©ºé—´å»åˆ†é…ç»™å®ƒçš„<code>Flexible</code> å’Œ <code>Expanded</code> å­ç»„ä»¶. row ä¼šåœ¨è¾¹ä¸Šæ˜¾ç¤ºä¸€æ¡é»„é»‘ç›¸é—´çš„æ¡è¡¨ç¤ºæº¢å‡ºäº†.å¦‚æœ row å¤–æœ‰ç©ºé—´,é‚£ä¹ˆæº¢å‡ºäº®å°†ä¼šä»¥çº¢è‰²å­—ä½“æ‰“å°å‡ºæ¥.</p>
<h2 id="å¸ƒå±€ç®—æ³•"><a href="#å¸ƒå±€ç®—æ³•" class="headerlink" title="å¸ƒå±€ç®—æ³•"></a>å¸ƒå±€ç®—æ³•</h2><blockquote>
<p>æ¥ä¸‹æ¥ä»‹ç» framework æ˜¯å¦‚ä½•æ¸²æŸ“ <code>Row</code> çš„.æŸ¥çœ‹ <code>BoxConstraints</code> äº†è§£ç›’å¸ƒå±€æ¨¡å‹.</p>
</blockquote>
<p><code>Row</code> çš„å¸ƒå±€åˆ†ä»¥ä¸‹ 6 æ­¥:<br>1ã€ä½¿ç”¨æ— è¾¹ç•Œçš„æ°´å¹³çº¦æŸå’Œä¼ å…¥çš„å‚ç›´çº¦æŸè®¾ç½®æ¯ä¸ªå­ç»„ä»¶ flex å› å­ä¸º null æˆ– 0.å¦‚æœ <code>crossAxisAlignment</code> å€¼ä¸º <code>CrossAxisAlignment.stetch</code>,ä½¿ç”¨æ»¡è¶³ä¼ å…¥çš„å‚ç›´çº¦æŸçš„æœ€å¤§é«˜åº¦è€Œä¸æ˜¯ä½¿ç”¨å‡†ç¡®çš„å‚ç›´çº¦æŸ.<br>2ã€å¯¹é 0 flex å› å­çš„å­ç»„ä»¶,æŒ‰ç…§å…¶ flex å› å­å°†å‰©ä¸‹çš„æ°´å¹³ç©ºé—´åˆ†å‰².å¦‚ä¸€ä¸ª flex å› å­ä¸º 2.0 çš„å­ç»„ä»¶åœ¨æ°´å¹³ç©ºé—´ä¸Šå°†æ¯” flex å› å­æ˜¯ 1.0 çš„å­ç»„ä»¶å®½ 2 å€.<br>3ã€ä½¿ç”¨ç›¸åŒçš„å‚ç›´çº¦æŸæŒ‰ç…§æ­¥éª¤ 1 å¸ƒå±€å‰©ä¸‹çš„å­ç»„ä»¶,ä½¿ç”¨åŸºäºæ­¥éª¤ 2 ç”³è¯·åˆ°çš„ç©ºé—´ä½œä¸ºæ°´å¹³çº¦æŸè€Œä¸æ˜¯æ— è¾¹ç•Œæ°´å¹³çº¦æŸå¸ƒå±€.<code>Flexible.fit</code> å±æ€§å€¼ä¸º <code>FlexFit.tight</code> çš„å­ç»„ä»¶å—åˆ°ä¸¥æ ¼çº¦æŸ(å¦‚å¼ºåˆ¶å¡«å……ç”³è¯·åˆ°çš„ç©ºé—´),è€Œ <code>Flexible.fit</code> å±æ€§å€¼ä¸º <code>FlexFit.tight</code> çš„å­ç»„ä»¶çº¦æŸå®½æ¾(å¦‚ä¸å¼ºåˆ¶å¡«å……ç”³è¯·åˆ°çš„ç©ºé—´).<br>4ã€<code>Row</code> çš„é«˜åº¦æ€»æ˜¯æœ€å¤§å­ç»„ä»¶çš„é«˜åº¦(ä¸€èˆ¬æ»¡è¶³ä¼ å…¥çš„å‚ç›´çº¦æŸ).<br>5ã€<code>Row</code> çš„å®½åº¦ç”± <code>mainAxisSize</code> å±æ€§å†³å®š.å¦‚æœ <code>mainAxisSize</code> å±æ€§å€¼ä¸º <code>MainAxisSize.max</code>,é‚£ä¹ˆ <code>Row</code> çš„å®½åº¦æ˜¯ä¼ å…¥çº¦æŸçš„æœ€å¤§å®½åº¦.å¦‚æœ <code>mainAxisSize</code> çš„å€¼ä¸º <code>MainAxisSize.min</code>,é‚£ä¹ˆ <code>Row</code> çš„å®½åº¦æ˜¯æ‰€æœ‰å­ç»„ä»¶çš„å®½åº¦ä¹‹å’Œ(å—ä¼ å…¥çº¦æŸ).<br>6ã€æ ¹æ® <code>mainAxisAlignment</code> å’Œ <code>crossAxisAlignment</code> ç¡®å®šæ¯ä¸ªå­ç»„ä»¶çš„ä½ç½®.ä¾‹å¦‚,å¦‚æœ <code>mainAxisAlignment</code>æ˜¯ <code>MainAxisAlignment.spaceBetween</code>,<br>æ²¡æœ‰è¢«åˆ†é…ç»™å­ç»„ä»¶çš„ç©ºé—´å°†ä¼šå¹³å‡åˆ†é…åˆ°å„ä¸ªå­ç»„ä»¶ä¹‹é—´.</p>
<h2 id="ç»§æ‰¿-ğŸŒ²"><a href="#ç»§æ‰¿-ğŸŒ²" class="headerlink" title="ç»§æ‰¿ ğŸŒ²"></a>ç»§æ‰¿ ğŸŒ²</h2><p><code>Object &gt; Diagnosticable &gt; DiagnosticableTree &gt; Widget &gt; RenderObjectWidget &gt; MultiChildRenderObjectWidget &gt; Flex &gt; Row</code></p>
]]></content>
  </entry>
  <entry>
    <title>Flutter-Column</title>
    <url>/2019/06/04/Flutter-Column/</url>
    <content><![CDATA[<p>ä»¥å‚ç›´æ•°ç»„æ–¹å¼æ˜¾ç¤ºå­ç»„ä»¶çš„ç»„ä»¶.</p>
<a id="more"></a>
<p>æƒ³è¦æŸä¸ªå­ç»„ä»¶æ‰©å±•å¡«å……å‚ç›´ç©ºé—´,ä½¿ç”¨ <code>Expanded</code> ç»„ä»¶åŒ…è£…å³å¯.</p>
<p><code>Column</code> ç»„ä»¶ä¸ä¼šæ»‘åŠ¨(é€šå¸¸å¦‚æœ <code>Column</code> ä¸­çš„å¤šä¸ªå­ç»„ä»¶è¶…å‡ºäº†å¯ç”¨ç©ºé—´,åˆ™ä¼šæŠ¥é”™).å¦‚æœæœ‰ä¸€æ’ç»„ä»¶,è€Œä¸”æƒ³è¦åœ¨ç©ºé—´ä¸è¶³æ—¶èƒ½æ»‘åŠ¨,è€ƒè™‘ä½¿ç”¨ <code>ListView</code>.</p>
<p>æ¨ªå‘æ’åˆ—è€ƒè™‘ä½¿ç”¨ <code>Row</code>.</p>
<p>å¦‚æœåªæœ‰ä¸€ä¸ªå­ç»„ä»¶,è€ƒè™‘ä½¿ç”¨ <code>Align</code> æˆ– <code>Center</code> å®šä½ç»„ä»¶.</p>
<h4 id="å¦‚æœä¼ å…¥çš„å‚ç›´çº¦æŸæ˜¯æ— è¾¹ç•Œçš„"><a href="#å¦‚æœä¼ å…¥çš„å‚ç›´çº¦æŸæ˜¯æ— è¾¹ç•Œçš„" class="headerlink" title="å¦‚æœä¼ å…¥çš„å‚ç›´çº¦æŸæ˜¯æ— è¾¹ç•Œçš„"></a>å¦‚æœä¼ å…¥çš„å‚ç›´çº¦æŸæ˜¯æ— è¾¹ç•Œçš„</h4><p>å¦‚æœä¸€ä¸ª <code>Column</code> ç»„ä»¶æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª <code>Expanded</code> æˆ– <code>Flexible</code> ç»„ä»¶,å¹¶ä¸”è¢«æ”¾åœ¨å¦ä¸€ä¸ª <code>Column</code> æˆ– <code>ListView</code> æˆ–å…¶ä»–ä¸æä¾›æœ€å¤§é«˜åº¦çº¦æŸä¸Šä¸‹æ–‡çš„ç»„ä»¶ä¸­,é‚£ä¹ˆå°†ä¼šæ”¶åˆ°ä¸€ä¸ªè¿è¡Œæ—¶å¼‚å¸¸,è¡¨æ˜æœ‰é 0 flex çš„å­ç»„ä»¶,ä½†æ˜¯å…¶å‚ç›´çº¦æŸæ˜¯æ— è¾¹ç•Œçš„.</p>
<p>æ­£å¦‚å¼‚å¸¸è¡¨ç°å‡ºæ¥çš„é—®é¢˜,ä½¿ç”¨ <code>Flexible</code> æˆ– <code>Expanded</code> æ„å‘³ç€æ¥ä¸‹æ¥å¸ƒå±€å…¶ä»–çš„å­ç»„ä»¶æ—¶å¿…é¡»æŠŠå‰©ä½™çš„ç©ºé—´å¹³å‡åˆ†é…,è€Œå¦‚æœä¼ å…¥çš„å‚ç›´çº¦æŸæ˜¯æ— è¾¹ç•Œçš„è¯,å‰©ä½™çš„ç©ºé—´å°±å˜æˆæ— é™çš„.</p>
<p>è§£å†³è¯¥é—®é¢˜çš„å…³é”®åœ¨äºä¸ºä»€ä¹ˆ <code>Column</code> ä¼šæ¥æ”¶åˆ°æ— è¾¹ç•Œçš„å‚ç›´çº¦æŸ.</p>
<p>ä¸€ä¸ªå¯èƒ½çš„åŸå› æ˜¯ <code>Column</code> è¢«æ”¾åœ¨äº†å¦ä¸€ä¸ª <code>Column</code> (å†…éƒ¨çš„ <code>Column</code> æ²¡æœ‰ä½¿ç”¨ <code>Expanded</code> æˆ– <code>Flexible</code> åŒ…è£…)ä¸­.å½“ä¸€ä¸ª <code>Column</code> å¸ƒå±€å®ƒçš„é flex å­ç»„ä»¶(æ²¡æœ‰ä½¿ç”¨ <code>Expanded</code> æˆ– <code>Flexible</code> åŒ…è£…)æ—¶,è¯¥ <code>Column</code> å°±ç»™äº†å…¶å­ç»„ä»¶æ— è¾¹ç•Œçš„çº¦æŸ,è¿™æ ·å­ç»„ä»¶å¯ä»¥è‡ªå·±å†³å®šä»–ä»¬çš„ç»´åº¦(ä¼ é€’æ— è¾¹ç•Œçš„çº¦æŸæ„å‘³ç€è¯¥å­ç»„ä»¶å¯èƒ½éœ€è¦æ”¶ç¼©ä»¥åŒ…è£…å…¶å†…å®¹).å¯¹åº”çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ <code>Expanded</code> åŒ…è£…å†…éƒ¨çš„ <code>Column</code>,è¡¨æ˜å†…éƒ¨çš„ <code>Column</code> åº”è¯¥å¡«å……å¤–éƒ¨ <code>Column</code> çš„å‰©ä½™ç©ºé—´,è€Œä¸æ˜¯å»è·å–å®ƒæƒ³è¦çš„ç©ºé—´å¤§å°.</p>
<p>å¦ä¸€ä¸ªå¯èƒ½çš„åŸå› æ˜¯ä¸€ä¸ª <code>Column</code> å¯èƒ½åµŒå¥—åœ¨ <code>ListView</code> æˆ–å…¶ä»–å¯æ»‘åŠ¨çš„å‚ç›´å¸ƒå±€ç»„ä»¶ä¸­.åœ¨è¿™ç§åœºæ™¯ä¸‹,ç¡®å®å­˜åœ¨æ— é™çš„å‚ç›´ç©ºé—´(å‚ç›´æ»‘åŠ¨åˆ—è¡¨çš„é‡ç‚¹åœ¨äºå…è®¸æ— é™å‚ç›´æ»‘åŠ¨).é€šå¸¸åº”è¯¥æ£€æŸ¥ä¸ºä»€ä¹ˆå†…éƒ¨çš„ <code>Column</code> ä¼šæœ‰ä¸€ä¸ª <code>Expanded</code> æˆ– <code>Flexible</code> å­ç»„ä»¶:å®ƒçš„å¤§å°çœŸçš„æ˜¯å†…éƒ¨å­ç»„ä»¶çš„å¤§å°å—?è§£å†³æ–¹æ¡ˆæ˜¯ä»åŒ…è£…å†…éƒ¨å­ç»„ä»¶çš„çˆ¶ç»„ä»¶ä¸­ç§»é™¤ <code>Expanded</code> æˆ– <code>Flexible</code> ç»„ä»¶.</p>
<p>æŸ¥çœ‹ <code>BoxConstraints</code> è·å–æ›´å¤šå…³äºçº¦æŸçš„ä¿¡æ¯.</p>
<h4 id="é»„é»‘ç›¸é—´æ¡"><a href="#é»„é»‘ç›¸é—´æ¡" class="headerlink" title="é»„é»‘ç›¸é—´æ¡"></a>é»„é»‘ç›¸é—´æ¡</h4><p>å½“ä¸€ä¸ª <code>Column</code> çš„å†…å®¹è¶…è¿‡äº†å¯ç”¨ç©ºé—´,å³ <code>Column</code> æº¢å‡º,é‚£ä¹ˆå†…å®¹å°†è¢«è£å‰ª.åœ¨ debug æ¨¡å¼ä¸‹,åœ¨æº¢å‡ºè¾¹è§’ä¸Šä¼šæ˜¾ç¤ºä¸€ä¸ªé»„é»‘ç›¸é—´æ¡æŒ‡å‡ºè¯¥é—®é¢˜,åœ¨ <code>Column</code> ä¸‹ä¼šæ‰“å°ä¸€ä¸ªæº¢å‡ºå¤šå°‘çš„ä¿¡æ¯.</p>
<p>æœ€æ™®éçš„è§£å†³æ–¹æ¡ˆæ˜¯å½“å‚ç›´ç©ºé—´å—é™æ—¶ç¡®ä¿å†…å®¹æ»‘åŠ¨ä½¿ç”¨ <code>ListView</code> è€Œä¸æ˜¯ <code>Column</code>.</p>
<h2 id="å¸ƒå±€ç®—æ³•"><a href="#å¸ƒå±€ç®—æ³•" class="headerlink" title="å¸ƒå±€ç®—æ³•"></a>å¸ƒå±€ç®—æ³•</h2><blockquote>
<p>æ¥ä¸‹æ¥æ˜¯ framework å¦‚ä½•æ¸²æŸ“ <code>Column</code>,æŸ¥çœ‹ <code>BoxConstraints</code> è·å–ç›’å¸ƒå±€æ¨¡å‹ä¿¡æ¯.</p>
</blockquote>
<p>å¸ƒå±€ <code>Column</code> éœ€è¦ 6 æ­¥.<br>1ã€ä½¿ç”¨æ— è¾¹ç•Œçš„æ°´å¹³çº¦æŸå’Œä¼ å…¥çš„å‚ç›´çº¦æŸè®¾ç½®æ¯ä¸ªå­ç»„ä»¶ flex å› å­ä¸º null æˆ– 0.å¦‚æœ <code>crossAxisAlignment</code> å€¼ä¸º <code>CrossAxisAlignment.stetch</code>,ä½¿ç”¨æ»¡è¶³ä¼ å…¥çš„å‚ç›´çº¦æŸçš„æœ€å¤§é«˜åº¦è€Œä¸æ˜¯ä½¿ç”¨å‡†ç¡®çš„å‚ç›´çº¦æŸ.<br>2ã€å¯¹é 0 flex å› å­çš„å­ç»„ä»¶,æŒ‰ç…§å…¶ flex å› å­å°†å‰©ä¸‹çš„æ°´å¹³ç©ºé—´åˆ†å‰².å¦‚ä¸€ä¸ª flex å› å­ä¸º 2.0 çš„å­ç»„ä»¶åœ¨æ°´å¹³ç©ºé—´ä¸Šå°†æ¯” flex å› å­æ˜¯ 1.0 çš„å­ç»„ä»¶å®½ 2 å€.<br>3ã€ä½¿ç”¨ç›¸åŒçš„å‚ç›´çº¦æŸæŒ‰ç…§æ­¥éª¤ 1 å¸ƒå±€å‰©ä¸‹çš„å­ç»„ä»¶,ä½¿ç”¨åŸºäºæ­¥éª¤ 2 ç”³è¯·åˆ°çš„ç©ºé—´ä½œä¸ºæ°´å¹³çº¦æŸè€Œä¸æ˜¯æ— è¾¹ç•Œæ°´å¹³çº¦æŸå¸ƒå±€.<code>Flexible.fit</code> å±æ€§å€¼ä¸º <code>FlexFit.tight</code> çš„å­ç»„ä»¶å—åˆ°ä¸¥æ ¼çº¦æŸ(å¦‚å¼ºåˆ¶å¡«å……ç”³è¯·åˆ°çš„ç©ºé—´),è€Œ <code>Flexible.fit</code> å±æ€§å€¼ä¸º <code>FlexFit.tight</code> çš„å­ç»„ä»¶çº¦æŸå®½æ¾(å¦‚ä¸å¼ºåˆ¶å¡«å……ç”³è¯·åˆ°çš„ç©ºé—´).<br>4ã€<code>Row</code> çš„é«˜åº¦æ€»æ˜¯æœ€å¤§å­ç»„ä»¶çš„é«˜åº¦(ä¸€èˆ¬æ»¡è¶³ä¼ å…¥çš„å‚ç›´çº¦æŸ).<br>5ã€<code>Row</code> çš„å®½åº¦ç”± <code>mainAxisSize</code> å±æ€§å†³å®š.å¦‚æœ <code>mainAxisSize</code> å±æ€§å€¼ä¸º <code>MainAxisSize.max</code>,é‚£ä¹ˆ <code>Row</code> çš„å®½åº¦æ˜¯ä¼ å…¥çº¦æŸçš„æœ€å¤§å®½åº¦.å¦‚æœ <code>mainAxisSize</code> çš„å€¼ä¸º <code>MainAxisSize.min</code>,é‚£ä¹ˆ <code>Row</code> çš„å®½åº¦æ˜¯æ‰€æœ‰å­ç»„ä»¶çš„å®½åº¦ä¹‹å’Œ(å—ä¼ å…¥çº¦æŸ).<br>6ã€æ ¹æ® <code>mainAxisAlignment</code> å’Œ <code>crossAxisAlignment</code> ç¡®å®šæ¯ä¸ªå­ç»„ä»¶çš„ä½ç½®.ä¾‹å¦‚,å¦‚æœ <code>mainAxisAlignment</code>æ˜¯ <code>MainAxisAlignment.spaceBetween</code>,<br>æ²¡æœ‰è¢«åˆ†é…ç»™å­ç»„ä»¶çš„ç©ºé—´å°†ä¼šå¹³å‡åˆ†é…åˆ°å„ä¸ªå­ç»„ä»¶ä¹‹é—´.</p>
<h2 id="ç»§æ‰¿-ğŸŒ²"><a href="#ç»§æ‰¿-ğŸŒ²" class="headerlink" title="ç»§æ‰¿ ğŸŒ²"></a>ç»§æ‰¿ ğŸŒ²</h2><p><code>Object &gt; Diagnosticable &gt; DiagnosticableTree &gt; Widget &gt; RenderObjectWidget &gt; MultiChildRenderObjectWidget &gt; Flex &gt; Column</code></p>
]]></content>
  </entry>
  <entry>
    <title>GraphQL-DataFetcher</title>
    <url>/2019/04/27/GraphQL-DataFetcher/</url>
    <content><![CDATA[<p>data fetcher</p>
<a id="more"></a>
<h2 id="è·å–æ•°æ®"><a href="#è·å–æ•°æ®" class="headerlink" title="è·å–æ•°æ®"></a>è·å–æ•°æ®</h2><h3 id="graphql-å¦‚ä½•è·å–æ•°æ®"><a href="#graphql-å¦‚ä½•è·å–æ•°æ®" class="headerlink" title="graphql å¦‚ä½•è·å–æ•°æ®"></a>graphql å¦‚ä½•è·å–æ•°æ®</h3><p>graphql ä¸­çš„æ¯ä¸ªå±æ€§éƒ½å…³è”äº†ä¸€ä¸ª graphql.schema.DataFetcher.<br>ä¸€äº›å±æ€§ä¼šä½¿ç”¨ä¸“ç”¨çš„ data fetcher ä»æ•°æ®åº“è·å–è¯¥å±æ€§çš„ç›¸å…³ä¿¡æ¯.è€Œå¤§å¤šæ•°ç®€å•çš„ä½¿ç”¨å±æ€§åå’Œ Plain Old Java Object(POJO)æ¨¡å¼ ä»å†…å­˜ä¸­è·å–æ•°æ®.<br><code>åœ¨å…¶ä»– graphql å®ç°ä¸­ï¼ŒData fetcher è¢«ç§°ä¸º resolver</code><br>ç°åœ¨å£°æ˜ä¸€ä¸ªç±»å‹å®šä¹‰:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">type Query &#123;</span><br><span class="line">	products(match: String): [Product] # a list of products</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Product &#123;</span><br><span class="line">	id: ID</span><br><span class="line">	name: String</span><br><span class="line">	description: String</span><br><span class="line">	cost: Float</span><br><span class="line">	tax: Float</span><br><span class="line">	launchDate(dateFormat: String &#x3D; &quot;dd,MM,yyyy&quot;): String</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>DataFetcher</tag>
      </tags>
  </entry>
  <entry>
    <title>GraphQL-Batching</title>
    <url>/2019/05/05/GraphQL-Batching/</url>
    <content><![CDATA[<p>bactching</p>
<a id="more"></a>
<h2 id="æ‰¹å¤„ç†"><a href="#æ‰¹å¤„ç†" class="headerlink" title="æ‰¹å¤„ç†"></a>æ‰¹å¤„ç†</h2><h3 id="ä½¿ç”¨-Dataloader"><a href="#ä½¿ç”¨-Dataloader" class="headerlink" title="ä½¿ç”¨ Dataloader"></a>ä½¿ç”¨ Dataloader</h3><p>å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ graphql,é‚£ä¹ˆä½ å¯èƒ½é‡åˆ°æ•°æ®å›¾æŸ¥è¯¢.è¿™å¯ä»¥é€šè¿‡æœ¬åœ°æ•°æ®å›¾åŠ è½½è½»æ¾å®ç°.<br>ä½¿ç”¨ <code>java-dataloader</code> å°†å¸®åŠ©ä½ æ›´é«˜æ•ˆçš„å¤„ç†æ•°æ®å›¾æ¡ç›®çš„ç¼“å­˜å’Œæ‰¹é‡è¯·æ±‚.å¦‚æœ dataloader å·²ç»å‘ç°äº†ä¸€ä¸ªä¹‹å‰çš„æ•°æ®æ¡ç›®,å®ƒå°†ä¼šç¼“å­˜æ•°æ®å¹¶ä¸”ç›´æ¥è¿”å›ä¸å†å‘èµ·è¯·æ±‚.<br>å‡è®¾æˆ‘ä»¬éœ€è¦æŸ¥è¯¢ä¸€ä¸ªè‹±é›„å’Œä»–ä»¬æœ‹å‹çš„åå­—åŠä»–ä»¬æœ‹å‹çš„æœ‹å‹çš„åå­—.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    hero &#123;</span><br><span class="line">        name &#123;</span><br><span class="line">            friends &#123;</span><br><span class="line">                name &#123;</span><br><span class="line">                    friends &#123;</span><br><span class="line">                        name</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæŸ¥è¯¢çš„ç»“æœå¦‚ä¸‹.</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"hero"</span>: &#123;</span><br><span class="line">		<span class="attr">"name"</span>: <span class="string">"R2-D2"</span>,</span><br><span class="line">		<span class="attr">"friends"</span>: [</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="attr">"name"</span>: <span class="string">"Luke Skywalker"</span>,</span><br><span class="line">				<span class="attr">"friends"</span>: [</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="attr">"name"</span>: <span class="string">"HanSolo"</span></span><br><span class="line">					&#125;,</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="attr">"name"</span>: <span class="string">"Leia Organa"</span></span><br><span class="line">					&#125;,</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="attr">"name"</span>: <span class="string">"C-3P0"</span></span><br><span class="line">					&#125;,</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="attr">"name"</span>: <span class="string">"R2-D2"</span></span><br><span class="line">					&#125;</span><br><span class="line">				]</span><br><span class="line">			&#125;,</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="attr">"name"</span>: <span class="string">"Han Solo"</span>,</span><br><span class="line">				<span class="attr">"friends"</span>: [</span><br><span class="line">					&#123; <span class="attr">"name"</span>: <span class="string">"Luke Skywalker"</span> &#125;,</span><br><span class="line">					&#123; <span class="attr">"name"</span>: <span class="string">"Leia Organa"</span> &#125;,</span><br><span class="line">					&#123; <span class="attr">"name"</span>: <span class="string">"R2-D2"</span> &#125;</span><br><span class="line">				]</span><br><span class="line">			&#125;,</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="attr">"name"</span>: <span class="string">"Leia Organa"</span>,</span><br><span class="line">				<span class="attr">"friends"</span>: [</span><br><span class="line">					&#123; <span class="attr">"name"</span>: <span class="string">"Luke Skywalker"</span> &#125;,</span><br><span class="line">					&#123; <span class="attr">"name"</span>: <span class="string">"Han Solo"</span> &#125;,</span><br><span class="line">					&#123; <span class="attr">"name"</span>: <span class="string">"C-3PO"</span> &#125;,</span><br><span class="line">					&#123; <span class="attr">"name"</span>: <span class="string">"R2-D2"</span> &#125;</span><br><span class="line">				]</span><br><span class="line">			&#125;</span><br><span class="line">		]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€å·®çš„åŠæ³•æ˜¯æ¯æ¬¡è°ƒç”¨ <code>DataFetcher</code>è·å– person å¯¹è±¡.<br>æœ¬ä¾‹ä¸­å°†å‘èµ· 15 æ¬¡ç½‘ç»œè¯·æ±‚.å³ä½¿å¾ˆå¤šäººæœ‰å…±åŒçš„æœ‹å‹.ä½¿ç”¨ <code>dataloader</code>ä½ å¯ä»¥ä½¿ graphql æŸ¥è¯¢å˜å¾—æ›´é«˜æ•ˆ.<br>å½“ graphql é™åºæŸ¥è¯¢æ¯ä¸ªå±‚çº§æ—¶(hero -&gt; friends -&gt; friends),dataloader è°ƒç”¨ promise ä¼ é€’ person å¯¹è±¡.åœ¨æ¯ä¸ªå±‚çº§ä¸­è°ƒç”¨ <code>dataloader.dispatch()</code> æ‰¹é‡å‘èµ·éƒ¨åˆ†æŸ¥è¯¢è¯·æ±‚.åŠ ä¸Šç¼“å­˜(é»˜è®¤ä½¿ç”¨),ä¹‹å‰çš„ person å°†è¢«è¿”å›.<br>ä¸Šä¾‹ä¸­åªæ¶‰åŠåˆ° 5 ä¸ªç‹¬ç«‹çš„ people,åˆç†çš„ä½¿ç”¨ç¼“å­˜å’Œæ‰¹é‡è¯·æ±‚å°†åªæœ‰ 3 ä¸ªæ‰¹é‡åŠ è½½å‡½æ•°è¢«è°ƒç”¨,3 ä¸ªç½‘ç»œè¯·æ±‚æˆ–æ•°æ®åº“æŸ¥è¯¢æ€»æ¯” 15 ä¸ªè¦å¥½.<br>å¦‚æœä½ ä½¿ç”¨äº† <code>java.util.concurrent.CompletableFuture.supplyAsync()</code>,é‚£ä¹ˆä½ å¯ä»¥é€šè¿‡å¼‚æ­¥è°ƒç”¨ä½¿æŸ¥è¯¢å˜å¾—æ›´é«˜æ•ˆ.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  batch loader å¯èƒ½è¢«è°ƒç”¨å¤šæ¬¡ï¼Œå› ä¸ºå®ƒçš„æ— çŠ¶æ€æ€§ï¼Œæ‰€ä»¥é€‚åˆä½œä¸ºå•ä¾‹ä½¿ç”¨</span></span><br><span class="line">BatchLoader&lt;String,Object&gt; characterBatchLoader = <span class="keyword">new</span> BatchLoader&lt;String,Object&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CompletableStage&lt;List&lt;Object&gt;&gt; load(List&lt;String&gt; keys) &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ supplyAsync() æœ€å¤§åŒ–å¹¶è¡Œæ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; getCharacterDataViaBatchHTTPApi(keys));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™ä¸ª data laoder è·å–å…³è”çš„äººç‰©ï¼ŒæŠŠä»–ä»¬æ”¾å…¥ graphql schema</span></span><br><span class="line">DataFetcher heroDataFetcher = <span class="keyword">new</span> DataFetcher() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(DataFetchingEnvironment environment)</span> </span>&#123;</span><br><span class="line">        DataLoader&lt;String,Object&gt; dataloader = environment.getDataLoader(<span class="string">"character"</span>);</span><br><span class="line">        <span class="keyword">return</span> dataloader.load(<span class="string">"2001"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">DataFetcher friendsDataFetcher = <span class="keyword">new</span> DataFetcher() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(DataFetchingEnvironment environment)</span> </span>&#123;</span><br><span class="line">        StarWarsCharacter starWarsCharacter = environment.getSource();</span><br><span class="line">        List&lt;String&gt; friendsIds = starWarsCharacter.getFriendIds();</span><br><span class="line">        DataLoader&lt;String,Object&gt; dataloader = environment.getDataLoader(<span class="string">"character"</span>);</span><br><span class="line">        <span class="keyword">return</span> dataloader.loadMany(friendsIds);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">DataLoaderDispatcherInstrumentationOptions options = DataLoaderDispatcherInstrumentationOptions.newOptions().includeStatistics(<span class="keyword">true</span>);</span><br><span class="line">DataLoaderDispatcherInstrumentation dispatcherInstrumentation = <span class="keyword">new</span> DataLoaderDispatcherInstrumentation(options);</span><br><span class="line">GraphQL graphql = GraphQL.newGraphQL(buildSchema())</span><br><span class="line">    .instrumentation(dispatcherInstrumentation)</span><br><span class="line">    .build();</span><br><span class="line"><span class="comment">// å› ä¸º data loader æ˜¯æœ‰çŠ¶æ€çš„,æ‰€ä»¥æ¯æ¬¡è¯·æ±‚éƒ½ä¼šè¢«æ‰§è¡Œ</span></span><br><span class="line">DataLoader&lt;String,Object&gt; characterDataLoader = DataLoader.newDataLoader(characterBatchLoader);</span><br><span class="line">DataLoaderRegistry registry = <span class="keyword">new</span> DataLoaderRegistry();</span><br><span class="line">registry.register(<span class="string">"character"</span>,characterDataLoader);</span><br><span class="line"></span><br><span class="line">ExecutionInput executionInput = newExecutionInput()</span><br><span class="line">    .query(getQuery())</span><br><span class="line">    .dataLoaderRegistry(registry)</span><br><span class="line">    .build();</span><br><span class="line">ExecutionResult executionResult = graphql.execute(executionInput);</span><br></pre></td></tr></table></figure>

<p>æœ¬ä¾‹ä¸­å› ä¸ºæˆ‘ä»¬éœ€è¦å¾®è°ƒ <code>DataLoaderDispatcherInstrumentation</code>é€‰é¡¹,æ‰€ä»¥æ‰‹åŠ¨æ·»åŠ .å¦‚æœä¸è¦çš„è¯,é»˜è®¤ä¼šè‡ªåŠ¨æ·»åŠ çš„.</p>
<h3 id="ä»…é€‚ç”¨äº-AsyncExecutionStrategy-çš„-Data-Loader"><a href="#ä»…é€‚ç”¨äº-AsyncExecutionStrategy-çš„-Data-Loader" class="headerlink" title="ä»…é€‚ç”¨äº AsyncExecutionStrategy çš„ Data Loader"></a>ä»…é€‚ç”¨äº AsyncExecutionStrategy çš„ Data Loader</h3><p>è¿™æ˜¯å› ä¸ºæ­¤æ‰§è¡Œç­–ç•¥çŸ¥é“åœ¨æœ€ä½³æ—¶æœºåˆ†å‘ä½ çš„ load è°ƒç”¨.å®ƒé€šè¿‡æ·±åº¦è¿½è¸ªä½ æœ‰å¤šå°‘ä¸ªçªå‡ºçš„å±æ€§åŠä»–ä»¬æ˜¯å¦æ˜¯åˆ—è¡¨å€¼ç­‰å®ç°.<br>å…¶ä»–ç­–ç•¥å¦‚ <code>ExecutorServiceExecutionStrategy</code>æ— æ³•å®ç°è¿™ä¸ªåŠŸèƒ½,å› ä¸ºå¦‚æœ data loader ä»£ç æ£€æµ‹åˆ°ä½ æ²¡æœ‰ä½¿ç”¨ <code>AsyncExecitionStrategy</code>,é‚£ä¹ˆå½“ç¢°åˆ°æ¯ä¸ªå±æ€§æ—¶,å®ƒå°†ç®€å•çš„åˆ†å‘ data loader.ä½ å¯èƒ½ä¼šå¾—åˆ°å€¼çš„ <code>caching</code>,ä½†ä½ ç»å¯¹æ‹¿ä¸åˆ°ä»–ä»¬çš„ <code>batching</code>.</p>
<h3 id="Data-Loader-çš„æ¯ä¸€ä¸ªè¯·æ±‚"><a href="#Data-Loader-çš„æ¯ä¸€ä¸ªè¯·æ±‚" class="headerlink" title="Data Loader çš„æ¯ä¸€ä¸ªè¯·æ±‚"></a>Data Loader çš„æ¯ä¸€ä¸ªè¯·æ±‚</h3><p>å¦‚æœä½ æ­£åœ¨ä¸º web è¯·æ±‚æä¾›æœåŠ¡,é‚£ä¹ˆå¯ä»¥ä¸ºç”¨æˆ·è¯·æ±‚æŒ‡å®šæ•°æ®.å¦‚æœä½ æœ‰ç”¨æˆ·æŒ‡å®šçš„æ•°æ®,ä½ å¯èƒ½ä¸ä¼šç¼“å­˜ç”¨æˆ· a çš„æ•°æ®,ç„¶ååœ¨åç»­çš„è¯·æ±‚ä¸­æŠŠå®ƒä¼ é€’ç»™ç”¨æˆ· b.<br>ä½ çš„ DataLoader å®ä¾‹çš„èŒƒå›´æ˜¯å¾ˆé‡è¦çš„.ä½ å¯èƒ½æƒ³æ¯ä¸ª web è¯·æ±‚åˆ›å»ºä¸€ä¸ª dataloader ä»¥ç¡®ä¿æ•°æ®åªå¯¹ç‰¹å®šçš„ web è¯·æ±‚ç¼“å­˜.åŒæ—¶ç¡®ä¿ <code>dispatch</code>è°ƒç”¨ä¸å½±å“å…¶ä»–çš„ graphql æ‰§è¡Œ.<br>DataLoader é»˜è®¤è¡Œä¸ºç±»ä¼¼ç¼“å­˜.å¦‚æœå‘ç°ä¹‹å‰å­˜åœ¨æŸä¸ª key å¯¹åº”çš„å€¼,é‚£ä¹ˆä¼šè‡ªåŠ¨è¿”å›å®ƒ.<br>å¦‚æœä½ çš„æ•°æ®å¯ä»¥è·¨ web è¯·æ±‚åˆ†äº«,é‚£ä¹ˆä½ å¯èƒ½éœ€è¦æ”¹å˜ä½ çš„ data loader ç¼“å­˜å®ç°,è¿™æ ·ä»–ä»¬å°±èƒ½é€šè¿‡å¦‚ memcached æˆ– redis è¿™æ ·çš„ç¼“å­˜å±‚è¿›è¡Œæ•°æ®åˆ†äº«.<br>ä¸‹ä¾‹ä¸­ä»ç„¶æ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ª data loader,ç„¶è€Œç¼“å­˜å±‚å…è®¸æ•°æ®åˆ†äº«.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CacheMap&lt;String,Object&gt; crossRequestCacheMap = <span class="keyword">new</span> CacheMap&lt;String,Object&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsKey</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisIntegration.containsKey(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisIntegration.getValue(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheMap&lt;String,Object&gt; <span class="title">set</span><span class="params">(String key,Object value)</span> </span>&#123;</span><br><span class="line">        redisIntegration.setValue(key,value);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheMap&lt;String,Object&gt; <span class="title">delete</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        redisIntegration.clearKey(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheMap&lt;String,Object&gt; <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        redisIntegration.clearAll();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">DataLoaderOptions options = DataLoaderOptions.newOptions().setCacheMap(crossRequestCacheMap);</span><br><span class="line">DataLoader&lt;String,Object&gt; dataloader = DataLoader.newDataLoader(batchLoader,options);</span><br></pre></td></tr></table></figure>

<h3 id="åªèƒ½å¼‚æ­¥è°ƒç”¨çš„æ‰¹é‡åŠ è½½åŠŸèƒ½"><a href="#åªèƒ½å¼‚æ­¥è°ƒç”¨çš„æ‰¹é‡åŠ è½½åŠŸèƒ½" class="headerlink" title="åªèƒ½å¼‚æ­¥è°ƒç”¨çš„æ‰¹é‡åŠ è½½åŠŸèƒ½"></a>åªèƒ½å¼‚æ­¥è°ƒç”¨çš„æ‰¹é‡åŠ è½½åŠŸèƒ½</h3><p>æ­¤ dataloader ä»£ç æ¨¡å¼æ•´åˆæ‰€æœ‰æ˜æ˜¾çš„ data loader è°ƒç”¨åˆ°ä¸€ä¸ªæ›´æœ‰æ•ˆçš„æ‰¹é‡åŠ è½½è°ƒç”¨.<br>graphql-java è¿½è¸ªå·²å‘èµ·çš„æ˜æ˜¾çš„ data loader è°ƒç”¨,ç„¶ååœ¨æœ€åˆé€‚çš„æ—¶æœº(å³æ‰€æœ‰çš„ graphql å±æ€§å·²ç»æ ¡éªŒæˆåŠŸå¹¶åˆ†å‘)åœ¨åå°è°ƒç”¨<code>dispatch</code>.<br>ç„¶è€Œæœ‰äº›æƒ…å†µä¸‹å°†å¯¼è‡´ä½ çš„ data loader è°ƒç”¨æ°¸ä¸ä¼šå®Œæˆ,è¿™ä¸­æƒ…å†µå¿…é¡»é¿å….è¿™ç§æƒ…å†µåŒ…æ‹¬åœ¨å¼‚æ­¥çº¿ç¨‹è°ƒç”¨ <code>DataLoader</code>.<br>ä¸‹é¢çš„ ğŸŒ° ä¸ä¼šæˆåŠŸ(å°†æ°¸è¿œæ— æ³•å®Œæˆ).</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BatchLoader&lt;String,Object&gt; batchLoader = <span class="keyword">new</span> BatchLoader&lt;String,Object&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CompletionStage&lt;List&lt;Object&gt;&gt; load(List&lt;String&gt; keys) &#123;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.completedFuture(getTheseCharacters(keys));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">DataLoader&lt;String,Object&gt; characterDataLoader = DataLoader.newDataLoader(batchLoader);</span><br><span class="line"></span><br><span class="line">DataFetcher dataFetcherThatCallsTheDataLoader = <span class="keyword">new</span> DataFetcher() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(DataFetchingEnvironment environment)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åƒä¸‡è¦é¿å…è¿™æ ·åš</span></span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            String argId = environment.getArgument(<span class="string">"id"</span>);</span><br><span class="line">            DataLoader&lt;String,Object&gt; characterLoader = environment.getDataLoader(<span class="string">"characterLoader"</span>);</span><br><span class="line">            <span class="keyword">return</span> characterLoader.load(argId);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ ğŸŒ° ä¸­,<code>characterDataLoader.load(argId)</code> å¯ä»¥åœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„æœªæ¥æŸä¸ªæ—¶åˆ»è¢«è°ƒç”¨. graphql-java å¼•æ“ä¸çŸ¥é“ä½•æ—¶æ˜¯æœ€ä½³æ—¶æœºå»åˆ†å‘æ˜æ˜¾çš„ <code>DataLoader</code> è°ƒç”¨,å› æ­¤è¿™ä¸ª data loader å¯èƒ½æ°¸è¿œä¸ä¼šå¦‚æœŸæ‰§è¡Œ,ä¹Ÿä¸ä¼šæœ‰ç»“æœè¿”å›.<br>è¯·è®°ä½,data loader è°ƒç”¨ä»…ä»…æ˜¯ä¸€ä¸ªä¿è¯,åé¢ä¼šå°†æ˜æ˜¾çš„è°ƒç”¨æ‰¹é‡è°ƒç”¨åœ¨åˆé€‚çš„æ—¶æœºè·å–ç»“æœ.æœ€ä½³æ—¶æœºæ˜¯ graphql å±æ€§æ ‘å·²ç»æ ¡éªŒè¿‡,ä¸”æ‰€æœ‰çš„å±æ€§å€¼å·²ç»è¢«åˆ†å‘.<br>ä¸‹é¢çš„ ğŸŒ° ä¾ç„¶æ˜¯å¼‚æ­¥ä»£ç ,ä½†æ˜¯æŠŠå®ƒæ”¾åœ¨ <code>BatchLoader</code> é‡Œ.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BatchLoader&lt;String,Object&gt; batchLoader = <span class="keyword">new</span> BatchLoader&lt;String,Object&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CompletionStage&lt;List&lt;Object&gt;&gt; load(List&lt;String&gt; keys) &#123;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; getThreseCharacters(keys));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">DataLoader&lt;String,Object&gt; characterDataLoader = DataLoader.newDataLoader(batchLoader);</span><br><span class="line"></span><br><span class="line">DataFetcher dataFetcherThatCallsTheDataLoader = <span class="keyword">new</span> DataFetcher() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(DataFetchingEnvironment environment)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è¿™æ˜¯é˜”ä»¥æ»´</span></span><br><span class="line">        String argId = environment.getArgument(<span class="string">"id"</span>);</span><br><span class="line">        DataLoader&lt;String,Object&gt; characterLoader = environment.getDataLoader(<span class="string">"characterLoader"</span>);</span><br><span class="line">        <span class="keyword">return</span> characterLoader.load(argId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ ğŸŒ° <code>characterDataLoader.load(argId)</code> ä¼šç«‹å³è¿”å›.è¿™å°†ä¼šæŠŠ data è¯·æ±‚å…¥é˜Ÿåˆ—,z å½“æ‰€æœ‰çš„ graphql å±æ€§éƒ½åˆ†å‘åå†æ‰§è¡Œ.<br>ç„¶åå½“ <code>DataLoader</code> è¢«åˆ†å‘å,ä»–çš„ <code>BatchLoader</code> å‡½æ•°è¢«è°ƒç”¨.è¿™ä¸ªä»£ç å¯ä»¥å¼‚æ­¥æ‰§è¡Œ,æ‰€ä»¥ä½ å¯ä»¥æœ‰å¤šä¸ªæ‰¹é‡åŠ è½½å‡½æ•°,ä»–ä»¬å¯ä»¥åŒæ—¶æ‰§è¡Œ.åœ¨ä¸Šä¾‹ä¸­ <code>CompletableFuture.supplyAsync(() -&gt; getTheseCharacters(keys));</code> å°†å†å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è¿”å› <code>getTheseCharacters()</code> æ–¹æ³•.</p>
<h3 id="å‘ä½ çš„-data-loader-ä¼ é€’-context"><a href="#å‘ä½ çš„-data-loader-ä¼ é€’-context" class="headerlink" title="å‘ä½ çš„ data loader ä¼ é€’ context"></a>å‘ä½ çš„ data loader ä¼ é€’ context</h3><p>data load åº“æ”¯æŒä¼ é€’ä¸¤ä¸ªç±»å‹çš„ context åˆ° batch loader.ç¬¬ä¸€ä¸ªæ˜¯æ¯ä¸ª dataloader ä¸€ä¸ªå…¨å±€çš„ context å¯¹è±¡,ç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ª loaded key ä¸€ä¸ª context å¯¹è±¡çš„ map.<br>è¿™å…è®¸ä½ ä¼ é€’ä¸‹æ¸¸éœ€è¦çš„é¢å¤–ä¿¡æ¯.dataloader key ç”¨åœ¨ç¼“å­˜ç»“æœ,è€Œ context å¯¹è±¡å¯ä»¥ç”¨åœ¨è°ƒç”¨ä¸­.<br>åœ¨ä¸‹é¢çš„ ğŸŒ° ä¸­,æˆ‘ä»¬æœ‰ä¸€ä¸ªå…¨å±€çš„å®‰å…¨ context å¯¹è±¡,æä¾›äº†ä¸€ä¸ªè°ƒç”¨ token,åŒæ—¶å¯ä»¥ä¼ é€’ graphql åŸå¯¹è±¡åˆ°æ¯ä¸ª <code>dataLoader.load()</code> è°ƒç”¨ä¸­.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BatchLoaderWithContext&lt;String,Object&gt; batchLoaderWithCtx = <span class="keyword">new</span> BatchLoaderWithContext&lt;String,Object&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CompletionStage&lt;List&lt;Object&gt;&gt; load(List&lt;String&gt; keys,BatchLoaderEnvironment loaderContext) &#123;</span><br><span class="line">        <span class="comment">// è·å–å…¨å±€ context å¯¹è±¡</span></span><br><span class="line">        SecurityContext sercurityCtx = loaderContext.getContext();</span><br><span class="line">        <span class="comment">// æ¯ä¸ªé”®éƒ½æœ‰ä¸€ä¸ª context å¯¹è±¡é›†</span></span><br><span class="line">        Map&lt;Object,Object&gt; keysToSOurceObjects = loaderContext.getKeyContexts();</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; getTheseCharacters(securityCtx.getToken(),keys,keysToSourceObjects));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">SecurityContext securityCtx = SecurityContext.newSecurityContext();</span><br><span class="line">BatchLoaderContextProvider contextProvider = <span class="keyword">new</span> BatchLoaderContextProvider() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object getÃ‡ontext() &#123;</span><br><span class="line">        <span class="keyword">return</span> securityCtx;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">DataLoaderOptions loaderOptions = DataLoaderOptions.newOptions().setBatchLoaderContextProvider(contextProvider);</span><br><span class="line">DataLoader&lt;String,Object&gt; characterDataLoader = DataLoader.newDataLoader(batchLoaderWithCtx,loaderOptions);</span><br><span class="line"></span><br><span class="line">DataFetcher dataFetcherCallsTheDataLoader = <span class="keyword">new</span> DataFetcher() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(DataFetchingEnvironment environment)</span> </span>&#123;</span><br><span class="line">        String argId = environment.getArgument(<span class="string">"id"</span>);</span><br><span class="line">        Object source = environment.getSource();</span><br><span class="line">        <span class="keyword">return</span> characterDataLoader.load(argId,source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>GraphQL-Data mapping</title>
    <url>/2019/05/05/GraphQL-Data-mapping/</url>
    <content><![CDATA[<p>data mapping</p>
<a id="more"></a>
<h2 id="Mapping-data"><a href="#Mapping-data" class="headerlink" title="Mapping data"></a>Mapping data</h2><h3 id="graphql-æ˜¯å¦‚ä½•æŠŠå¯¹è±¡æ•°æ®åŒ¹é…åˆ°ç±»å‹çš„"><a href="#graphql-æ˜¯å¦‚ä½•æŠŠå¯¹è±¡æ•°æ®åŒ¹é…åˆ°ç±»å‹çš„" class="headerlink" title="graphql æ˜¯å¦‚ä½•æŠŠå¯¹è±¡æ•°æ®åŒ¹é…åˆ°ç±»å‹çš„"></a>graphql æ˜¯å¦‚ä½•æŠŠå¯¹è±¡æ•°æ®åŒ¹é…åˆ°ç±»å‹çš„</h3><p>graphql å†…éƒ¨å…¨éƒ¨æ˜¯å…³äºå£°æ˜ç±»å‹ schema,ç„¶ååœ¨è¿è¡ŒåŒ¹é…åˆ°æ•°æ®.<br>ä½œä¸ºç±»å‹ schema çš„è®¾è®¡è€…,ä½ åº”è¯¥åœ¨å¤„ç†è¿™äº›å…ƒç´ .</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">type Query &#123;</span><br><span class="line">	products(match: String): [Product] # a list of products</span><br><span class="line">&#125;</span><br><span class="line">type Product &#123;</span><br><span class="line">	id: ID</span><br><span class="line">	name: String</span><br><span class="line">	description: String</span><br><span class="line">	cost: Float</span><br><span class="line">	tax: Float</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå¯ä»¥æ‰§è¡ŒæŸ¥è¯¢</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">query ProductQuery &#123;</span><br><span class="line">	products(match: &quot;Paper*&quot;) &#123;</span><br><span class="line">		id</span><br><span class="line">		name</span><br><span class="line">		cost</span><br><span class="line">		tax</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹äº <code>Query.products</code>å±æ€§æœ‰ä¸€ä¸ªç»‘å®šçš„ <code>DataFetcher</code>è´Ÿè´£æŸ¥æ‰¾åŒ¹é…è¾“å…¥å‚æ•°çš„ product s åˆ—è¡¨.<br>å‡è®¾æˆ‘ä»¬æœ‰ 3 ä¸ªä¸‹æ¸¸æœåŠ¡.ä¸€ä¸ªè·å–äº§å“ä¿¡æ¯,ä¸€ä¸ªè·å–äº§å“ä»·æ ¼ä¿¡æ¯,ä¸€ä¸ªè®¡ç®—æŸ¥æ–°ç¨æ”¶ä¿¡æ¯.<br>graphql-java ä½¿ç”¨è¿™äº›å¯¹è±¡è¿è¡Œ data fetcher,è·å–ä¿¡æ¯ç„¶åå°†å…¶åŒ¹é…åˆ° schema æŒ‡å®šçš„ç±»å‹ä¸­.<br>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è·å–åˆ°è¿™ 3 ä¸ªæºçš„ä¿¡æ¯,ç„¶åæŠŠå®ƒä»¬ä½œä¸ºä¸€ä¸ª unified ç±»å‹å±•ç¤º.<br>æˆ‘ä»¬å¯ä»¥å¯¹ cost å’Œ tax éœ€è¦è®¡ç®—çš„å±æ€§æŒ‡å®š data fetcher,ä½†è¿™éœ€è¦æ›´å¤šçš„ç»´æŠ¤ç²¾åŠ›,å¯èƒ½å¯¼è‡´ N+1 æ€§èƒ½é—®é¢˜.<br>æˆ‘ä»¬æœ€å¥½åœ¨ <code>Query.products</code> data fetcher ä¸­è·å–æ‰€æœ‰çš„ä¿¡æ¯,åŒæ—¶åˆ›å»ºä¸€ä¸ª unified æ•°æ®è§†å›¾.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataFetcher produtctsDataFetcher = <span class="keyword">new</span> DataFetcher() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(DataFetchingEnvironment env)</span> </span>&#123;</span><br><span class="line">        String matchArg = env.getArgument(<span class="string">"match"</span>);</span><br><span class="line">        List&lt;ProductInfo&gt; productInfos = getMatchingProducts(matchArg);</span><br><span class="line">        List&lt;ProductCostInfo&gt; productConstInfo = getProdutConsts(productInfo);</span><br><span class="line">        List&lt;ProductTaxInfo&gt; productTaxInfo = getProductTax(productInfo);</span><br><span class="line">        <span class="keyword">return</span> mapDataTogether(productInfo,productCostInfo,productTaxInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æœ‰ 3 ä¸ªç±»å‹çš„ä¿¡æ¯éœ€è¦è¢«æ•´åˆä¸ºä¸€ä¸ªä»¥ä¾¿ graphql æŸ¥è¯¢å¯ä»¥è®¿é—® id,name,cost,tax å±æ€§.<br>æœ‰ 2 ä¸­æ–¹æ³•å¯ä»¥åˆ›å»ºè¿™ä¸ªæ˜ å°„.ä¸€ä¸ªæ˜¯ä½¿ç”¨ç±»å‹ä¸å®‰å…¨çš„ <code>List&lt;Map&gt;</code> ç»“æ„,å¦ä¸€ä¸ªæ˜¯ä½¿ç”¨ç±»å‹å®‰å…¨çš„ <code>List&lt;ProductDTO&gt;</code>å°è£…è¿™äº›æ•°æ®.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;Map&gt; <span class="title">mapDataTogetherViaMap</span><span class="params">(List&lt;ProductInfo&gt; productInfo,List&lt;ProductCostInfo&gt; productCostInfo,List&lt;ProductTaxInfo&gt; productTaxInfo)</span> </span>&#123;</span><br><span class="line">    List&lt;Map&gt; unifiedView = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; productInfo.size();i++) &#123;</span><br><span class="line">        ProductInfo info = productInfo.get(i);</span><br><span class="line">        ProductCostInfo cost = productCostInfo.get(i);</span><br><span class="line">        ProductTaxInfo tax = productTaxInfo.get(i);</span><br><span class="line"></span><br><span class="line">        Map&lt;String,Object&gt; objectMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        objectMap.put(<span class="string">"id"</span>,info.getId());</span><br><span class="line">        objectMap.put(<span class="string">"name"</span>,info.getName());</span><br><span class="line">        objectMap.put(<span class="string">"descriptioin"</span>,info.getDescription());</span><br><span class="line">        objectMap.put(<span class="string">"cost"</span>,cost.getCost());</span><br><span class="line">        objectMap.put(<span class="string">"tax"</span>,tax.getTax());</span><br><span class="line"></span><br><span class="line">        unifiedView.add(objectMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> unifiedView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductDTO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String description;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Float cost;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Float tax;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProductDTO</span><span class="params">(String id, String name, String description, Float cost, Float tax)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.description = description;</span><br><span class="line">        <span class="keyword">this</span>.cost = cost;</span><br><span class="line">        <span class="keyword">this</span>.tax = tax;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Float <span class="title">getCost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cost;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Float <span class="title">getTax</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tax;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;ProductDTO&gt; <span class="title">mapDataTogetherViaDTO</span><span class="params">(List&lt;ProductInfo&gt; productInfo, List&lt;ProductCostInfo&gt; productCostInfo, List&lt;ProductTaxInfo&gt; productTaxInfo)</span> </span>&#123;</span><br><span class="line">    List&lt;ProductDTO&gt; unifiedView = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; productInfo.size(); i++) &#123;</span><br><span class="line">        ProductInfo info = productInfo.get(i);</span><br><span class="line">        ProductCostInfo cost = productCostInfo.get(i);</span><br><span class="line">        ProductTaxInfo tax = productTaxInfo.get(i);</span><br><span class="line"></span><br><span class="line">        ProductDTO productDTO = <span class="keyword">new</span> ProductDTO(</span><br><span class="line">                info.getId(),</span><br><span class="line">                info.getName(),</span><br><span class="line">                info.getDescription(),</span><br><span class="line">                cost.getCost(),</span><br><span class="line">                tax.getTax()</span><br><span class="line">        );</span><br><span class="line">        unifiedView.add(productDTO);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> unifiedView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>graphql å¼•æ“ç°åœ¨å¯ä»¥ä½¿ç”¨ object åˆ—è¡¨ç„¶åè¿è¡ŒæŸ¥è¯¢è·å– id,name,cost,tax å±æ€§.<br>graphql-java é»˜è®¤çš„ data fetcher <code>graphql.schema.PropertyDataFetcher</code> åŒæ—¶æ”¯æŒ map å’Œ POJO.<br>å¯¹äºåˆ—è¡¨çš„æ¯ä¸€ä¸ªå¯¹è±¡éƒ½ä¼šé€šè¿‡ id å±æ€§,æˆ–ä½¿ç”¨ name åœ¨ map é‡ŒæŸ¥æ‰¾,æˆ–é€šè¿‡ getId() æ–¹æ³•è·å–,ç„¶åè¿”å›ç»™ graphql response.å¯¹äºæŸ¥è¯¢ä¸­çš„æ¯ä¸ªç±»å‹éƒ½ä¼šæ‰§è¡Œè¿™æ ·çš„æ“ä½œ.<br>é€šè¿‡åœ¨é«˜çº§ data fetcher ä¸­åˆ›å»ºä¸€ä¸ª unified view,ä½ å°±å¯ä»¥åœ¨è¿è¡Œæ—¶æ•°æ®å’Œ graphql schema ä¹‹é—´å»ºç«‹ä¸€ä¸ªæ˜ å°„.</p>
]]></content>
  </entry>
  <entry>
    <title>GraphQL-Execution</title>
    <url>/2019/05/04/GraphQL-Execution/</url>
    <content><![CDATA[<p>execution</p>
<a id="more"></a>
<h2 id="Execution"><a href="#Execution" class="headerlink" title="Execution"></a>Execution</h2><h3 id="Queries"><a href="#Queries" class="headerlink" title="Queries"></a>Queries</h3><p>å¯¹ schema æ‰§è¡Œ query,ä½¿ç”¨åˆé€‚çš„å‚æ•°æ„å»ºä¸€ä¸ªæ–°çš„ GraphQL å¯¹è±¡,ç„¶åè°ƒç”¨<code>execute()</code>.<br>query çš„ç»“æœæ˜¯åŒ…å«æŸ¥è¯¢æ•°æ®æˆ–è€…ï¼ˆå¹¶ä¸”ï¼‰ä¸€ç³»åˆ—é”™è¯¯çš„<code>ExecutionResult</code> å¯¹è±¡.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">GraphQLSchema schema = GraphQLSchema.newSchema().query(queryType).build();</span><br><span class="line">GraphQL graphQl = GraphQL.newGraphQL(schema).build();</span><br><span class="line">ExecutionInput executionInput = ExecutionInput.newExecutionInput().query(<span class="string">"query &#123; hero &#123; name &#125;&#125;"</span>);</span><br><span class="line">ExectionResult executionResult = graphQl.execute(executionInput);</span><br><span class="line">Object data = executionResult.getData();</span><br><span class="line">List&lt;GraphQLError&gt; errors = executionResult.getErrors();</span><br></pre></td></tr></table></figure>

<p>æ›´å¤šå¤æ‚çš„æŸ¥è¯¢ç¤ºä¾‹è¯·å‚è€ƒ<a href="https://github.com/graphql-java/graphql-java/blob/master/src/test/groovy/graphql/StarWarsQueryTest.groovy" target="_blank" rel="noopener">StarWars query tests</a>;</p>
<h3 id="Data-Fetchers"><a href="#Data-Fetchers" class="headerlink" title="Data Fetchers"></a>Data Fetchers</h3><p>æ¯ä¸ª graphql å±æ€§ç±»å‹éƒ½æœ‰ä¸€ä¸ª <code>graphql.schema.DataFetcher</code> ä¸ä¹‹å…³è”.å…¶ä»– graphql å®ç°é€šå¸¸æŠŠè¿™ä¸ªç±»å‹æˆä¸º <code>resolvers</code>.<br>é€šå¸¸å¯ä»¥ä½¿ç”¨<code>graphql.schema.PropertyDataFetcher</code>æ¥æ£€æŸ¥ æä¾›å±æ€§å€¼çš„ Java POJO å¯¹è±¡.å¦‚æœæŸä¸ªå±æ€§æœªæŒ‡å®š data fetcher,é»˜è®¤ä¼šä½¿ç”¨è¿™ä¸ª.<br>ç„¶è€Œä½ å¯èƒ½éœ€è¦ä½¿ç”¨è‡ªå®šä¹‰çš„ data fetcehr è·å–ä½ çš„é¡¶çº§åŸŸå¯¹è±¡.å¯èƒ½æ¶‰åŠåˆ°æ•°æ®åº“è°ƒç”¨æˆ–é€šè¿‡ HTTP è¯·æ±‚å…¶ä»–ç³»ç»Ÿ.<br><code>graphql-java</code>ä¸å…³å¿ƒä½ æ˜¯å¦‚ä½•è·å–ä½ çš„åŸŸå¯¹è±¡,è¿™æ˜¯ä½ éœ€è¦å…³å¿ƒçš„åœ°æ–¹.åŒæ—¶ä¹Ÿä¸å…³å¿ƒç”¨æˆ·è®¿é—®æ•°æ®æˆæƒ.è¿™äº›éƒ½åº”è¯¥æ”¾åˆ°ä½ è‡ªå·±çš„é€»è¾‘å¤„ç†å±‚.<br>data fetcher ç¤ºä¾‹å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataFetcher userDataFetcher = <span class="keyword">new</span> DataFetcher() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(DataFetchingEnvironment environment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fetchUserFromDatabase(environment.getArgument(<span class="string">"userId"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ª <code>DataFetcher</code>éƒ½ä¼šä¼ é€’ä¸€ä¸ª <code>graphql.schema.DataFetchingEnvironment</code> å¯¹è±¡(åŒ…å«äº†å°†è¦è·å–çš„å±æ€§,è·å–è¯¥å±æ€§æ‰€éœ€æä¾›çš„å‚æ•°å’Œå…¶ä»–ä¿¡æ¯å¦‚å±æ€§çš„çˆ¶å¯¹è±¡,query æ ¹å¯¹è±¡æˆ– query ä¸Šä¸‹æ–‡å¯¹è±¡).<br>ä¸Šä¾‹ä¸­,<code>execution</code>å°†ä¼šåœ¨ data fetcher è¿”å›ç»“æœåæ‰ç»§ç»­æ‰§è¡Œ.å¯ä»¥é€šè¿‡è¿”å›<code>CompletionStage</code> å¯¹è±¡ä½¿ <code>DataFetcher</code> å¼‚æ­¥æ‰§è¡Œ,è¯¦æƒ…è¯·ç»§ç»­é˜…è¯».</p>
<h3 id="å½“è·å–æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸"><a href="#å½“è·å–æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸" class="headerlink" title="å½“è·å–æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸"></a>å½“è·å–æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸</h3><p>å¦‚æœåœ¨ data fetcher è°ƒç”¨ä¸­å‘ç”Ÿå¼‚å¸¸,é‚£ä¹ˆé»˜è®¤æ‰§è¡Œç­–ç•¥å°†ç”Ÿæˆ<code>graphql.ExceptionWhileDataFetching</code> é”™è¯¯,ç„¶åæ·»åŠ åˆ°ç»“æœä¸­çš„é”™è¯¯é›†ä¸­.åˆ‡è®° graphql å…è®¸å¸¦é”™è¯¯çš„éƒ¨åˆ†ç»“æœ.<br>ä¸‹é¢æ˜¯æ ‡å‡†çš„è¡Œä¸º.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleDataFetcherExceptionHandler</span> <span class="keyword">implements</span> <span class="title">DataFetcherExceptionhandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(SimpleDataFetcherExceptionHandler.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(DataFetcherExceptionHandlerParameters handlerParameters)</span> </span>&#123;</span><br><span class="line">        Throwable exception = handlerParameters.getException();</span><br><span class="line">        SourceLocation sourceLocation = handlerParameters.getField().getSourceLocation();</span><br><span class="line">        ExecutionPath path = handlerParameters.getPath();</span><br><span class="line"></span><br><span class="line">        ExceptionWhileDataFetching error = <span class="keyword">new</span> ExceptionWhileDataFetching(path,exception,sourceLocation);</span><br><span class="line">        handlerParameters.getExecutionContext().addError(error);</span><br><span class="line">        log.warn(error.getMessage(),exception);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½ æŠ›å‡ºçš„æ˜¯<code>GraphqlError</code>,é‚£ä¹ˆå®ƒä¼šä» exception ä¸­è½¬æ¢ message å’Œè‡ªå®šä¹‰æ‰©å±•å±æ€§åˆ° <code>ExceptionWhileDataFetching</code>å¯¹è±¡.æ­¤å¤„å…è®¸ä½ å‘è°ƒç”¨è€…è¿”å›è‡ªå®šä¹‰çš„å±æ€§åˆ° graphql error.<br>ä¾‹å¦‚æƒ³è±¡ä½ çš„ data fetcher å°†æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸.<code>foo</code> å’Œ <code>fizz</code> å±æ€§å°†è¢«æ·»åŠ åˆ°è¿”å›çš„ graphql error ä¸­.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomRuntimeException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> <span class="keyword">implements</span> <span class="title">GrapQLError</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">getExtension</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; customAttributes = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        customAttributes.put(<span class="string">"foo"</span>,<span class="string">"bar"</span>);</span><br><span class="line">        cutomAttributes.put(<span class="string">"fizz"</span>,<span class="string">"whizz"</span>);</span><br><span class="line">        <span class="keyword">return</span> customAttributes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;SourceLocation&gt; <span class="title">getLocation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ErrorType <span class="title">getErrorType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ErrorType.DataFetchingException;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½ å¯ä»¥é€šè¿‡åˆ›å»ºè‡ªå·±çš„ <code>graphql.execution.DataFetcherExceptionHandler</code>å¼‚å¸¸å¤„ç†ä»£ç æ”¹å˜æ­¤é»˜è®¤è¡Œä¸º,ç»™å‡ºä½ è‡ªå·±çš„æ‰§è¡Œç­–ç•¥.<br>ä¾‹å¦‚ä¸Šé¢çš„ä»£ç è®°å½•äº†åŸºç¡€å¼‚å¸¸å’Œå †æ ˆè·Ÿè¸ª.æœ‰çš„äººå¯èƒ½ä¸å–œæ¬¢åœ¨è¾“å‡ºé”™è¯¯åˆ—è¡¨ä¸­çœ‹åˆ°è¿™äº›.æ‰€ä»¥ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªæœºåˆ¶æ”¹å˜è¿™ä¸ªè¡Œä¸º.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataFetcherExceptionHandler handler = <span class="keyword">new</span> DataFetcherExceptionHandler() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(DataFetcherExceptionHandlerParameters handlerParameters)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">ExecutionStrategy executionStrategy = <span class="keyword">new</span> AsyncExecutionStrategy(handler);</span><br></pre></td></tr></table></figure>

<h3 id="è¿”å›å€¼å’Œé”™è¯¯"><a href="#è¿”å›å€¼å’Œé”™è¯¯" class="headerlink" title="è¿”å›å€¼å’Œé”™è¯¯"></a>è¿”å›å€¼å’Œé”™è¯¯</h3><p>åœ¨<code>DataFetcher</code>å®ç°ä¸­é€šè¿‡ç›´æ¥æˆ–è€…ä½¿ç”¨ <code>CompletableFuture</code> å®ä¾‹åŒ…è£…å¼‚æ­¥æ‰§è¡Œè¿”å› <code>graphql.execution.DataFetcherResult</code> æ¥å®ç°åŒæ—¶è¿”å›æ•°æ®å’Œå¤šä¸ªé”™è¯¯.å½“ä½ çš„<code>DataFetcher</code> éœ€è¦ä»å¤šä¸ªæ•°æ®æºæˆ–å…¶ä»– GraphQL èµ„æºè·å–æ•°æ®æ—¶ç‰¹åˆ«æœ‰ç”¨.<br>åœ¨è¿™ä¸ª ğŸŒ° ä¸­,<code>DataFetcher</code> ä»å¦ä¸€ä¸ª GraphQL èµ„æºä¸­è·å– user åŒæ—¶è¿”å›æ•°æ®å’Œé”™è¯¯.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataFetcher userDataFetcher = <span class="keyword">new</span> DataFetcher() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(DataFetchingEnvironment environment)</span> </span>&#123;</span><br><span class="line">        Map response = fetchUserFromRemoteGraphQLResource(environment.getArgument(<span class="string">"userID"</span>));</span><br><span class="line">        List&lt;GralhQLError&gt; errors = response.get(<span class="string">"errors)</span></span><br><span class="line"><span class="string">                                            .stream()</span></span><br><span class="line"><span class="string">                                            .map(MyMapGraphQLError::new)</span></span><br><span class="line"><span class="string">                                            .collect(Collections.toList());</span></span><br><span class="line"><span class="string">        return new DataFetcherResult(response.get("</span>data<span class="string">"),errors);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="å°†ç»“æœåºåˆ—åŒ–ä¸º-JSON"><a href="#å°†ç»“æœåºåˆ—åŒ–ä¸º-JSON" class="headerlink" title="å°†ç»“æœåºåˆ—åŒ–ä¸º JSON"></a>å°†ç»“æœåºåˆ—åŒ–ä¸º JSON</h3><p>è°ƒç”¨ graphql æœ€å¸¸è§çš„æ–¹æ³•æ˜¯é€šè¿‡ HTTP,è¿”å› JSON å“åº”.æ‰€ä»¥ä½ éœ€è¦å°† <code>graphql.ExecutionResult</code> è½¬ä¸º JSON.<br>æœ€å¸¸ç”¨çš„å®ç°æ˜¯ä½¿ç”¨ Jackson æˆ– GSON è¿™æ ·çš„ JSON åºåˆ—åŒ–åº“.ç„¶è€Œå®ƒä»¬è§£ææ•°æ®çš„æ–¹å¼æœ‰å®ƒä»¬è‡ªå·±çš„ä¸€å¥—æ–¹å¼.ä¾‹å¦‚ <code>nulls</code>å¯¹ graphql ç»“æœæ˜¯å¾ˆé‡è¦çš„,æ‰€ä»¥ä½ å¿…é¡»åœ¨è®¾ç½® json mapper æ—¶åŒ…å«å®ƒ.<br>ä¸ºäº†ä¿è¯ä½ è·å–çš„ JSON ç»“æœ 100% ç¬¦åˆ graphql çš„éœ€æ±‚,ä½ åº”è¯¥å¯¹ç»“æœè°ƒç”¨<code>toSpecification</code>,ç„¶åå°†å…¶ä½œä¸º JSON è¿”å›.<br>è¿™å°†ä¼šç¡®ä¿è¿”å›çš„ç»“æœç¬¦åˆ<a href="http://facebook.github.io/graphql/#sec-Response" target="_blank" rel="noopener">è§„èŒƒ</a>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ExecutionResult executionResult = graphQL.execute(executinInput);</span><br><span class="line">Map&lt;String,Object&gt; toSpecificationResult = executionResult.toSpecification();</span><br><span class="line">sendAsJson(toSpecificationResult);</span><br></pre></td></tr></table></figure>

<h3 id="Mutations"><a href="#Mutations" class="headerlink" title="Mutations"></a>Mutations</h3><p><a href="http://graphql.org/learn/queries/#mutations" target="_blank" rel="noopener">åœ¨è¿™å„¿</a>å­¦ä¹  mutations.<br>æœ¬è´¨ä¸Šä½ éœ€è¦å®šä¹‰ä¸€ä¸ªæ¥æ”¶å‚æ•°ä½œä¸ºè¾“å…¥çš„ <code>GraphQLObjectType</code> .è¿™äº›å‚æ•°ä½ å¯ä»¥é€šè¿‡ data fetcher è°ƒç”¨ä¿®æ”¹ä½ çš„æ•°æ®å­˜å‚¨.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mutation CreateReviewForEpisode($ep: Episode!, $review: ReviewInput!) &#123;</span><br><span class="line">	createReview(episode: $ep, review: $review) &#123;</span><br><span class="line">		stars</span><br><span class="line">		commentary</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨æ‰§è¡Œ mutation æ“ä½œä¸­éœ€è¦ä¼ é€’å‚æ•°,æœ¬ä¾‹ä¸­æ˜¯ <code>$ep</code> å’Œ <code>$review</code> å‚æ•°.<br>ä½ å¯ä»¥åƒè¿™æ ·åˆ›å»ºç±»å‹å¤„ç† mutation æ“ä½œ.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">GraphQLInputObjectType episodeType = newInputObject()</span><br><span class="line">                .name(<span class="string">"Episode"</span>)</span><br><span class="line">                .field(newInputObjectField()</span><br><span class="line">                        .name(<span class="string">"episodeNumber"</span>)</span><br><span class="line">                        .type(Scalars.GraphQLInt))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">GraphQLInputObjectType reviewInputType = newInputObject()</span><br><span class="line">        .name(<span class="string">"ReviewInput"</span>)</span><br><span class="line">        .field(newInputObjectField()</span><br><span class="line">                .name(<span class="string">"stars"</span>)</span><br><span class="line">                .type(Scalars.GraphQLString)</span><br><span class="line">                .name(<span class="string">"commentary"</span>)</span><br><span class="line">                .type(Scalars.GraphQLString))</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">GraphQLObjectType reviewType = newObject()</span><br><span class="line">        .name(<span class="string">"Review"</span>)</span><br><span class="line">        .field(newFieldDefinition()</span><br><span class="line">                .name(<span class="string">"stars"</span>)</span><br><span class="line">                .type(GraphQLString))</span><br><span class="line">        .field(newFieldDefinition()</span><br><span class="line">                .name(<span class="string">"commentary"</span>)</span><br><span class="line">                .type(GraphQLString))</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">GraphQLObjectType createReviewForEpisodeMutation = newObject()</span><br><span class="line">        .name(<span class="string">"CreateReviewForEpisodeMutation"</span>)</span><br><span class="line">        .field(newFieldDefinition()</span><br><span class="line">                .name(<span class="string">"createReview"</span>)</span><br><span class="line">                .type(reviewType)</span><br><span class="line">                .argument(newArgument()</span><br><span class="line">                        .name(<span class="string">"episode"</span>)</span><br><span class="line">                        .type(episodeType)</span><br><span class="line">                )</span><br><span class="line">                .argument(newArgument()</span><br><span class="line">                        .name(<span class="string">"review"</span>)</span><br><span class="line">                        .type(reviewInputType)</span><br><span class="line">                )</span><br><span class="line">        )</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">GraphQLCodeRegistry codeRegistry = newCodeRegistry()</span><br><span class="line">        .dataFetcher(</span><br><span class="line">                coordinates(<span class="string">"CreateReviewForEpisodeMutation"</span>, <span class="string">"createReview"</span>),</span><br><span class="line">                mutationDataFetcher()</span><br><span class="line">        )</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GraphQLSchema schema = GraphQLSchema.newSchema()</span><br><span class="line">        .query(queryType)</span><br><span class="line">        .mutation(createReviewForEpisodeMutation)</span><br><span class="line">        .codeRegistry(codeRegistry)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„è¾“å…¥å‚æ•°ç±»å‹æ˜¯ <code>GraphQLInputObjectType</code>.è¿™æ˜¯å¾ˆé‡è¦çš„.è¾“å…¥ç±»å‹åªèƒ½æ˜¯è¿™ç§ç±»å‹,ç»ä¸èƒ½ä½¿ç”¨è¾“å‡ºç±»å‹å¦‚ <code>GraphQLObjectType</code>.æ ‡é‡ç±»å‹æ—¢å¯ä»¥æ˜¯è¾“å…¥ç±»å‹ä¹Ÿå¯ä»¥æ˜¯è¾“å‡ºç±»å‹.<br>è¿™ä¸ª data fetcher æ‰§è¡Œ mutation,è¿”å›ä¸€äº›æœ‰æ„ä¹‰çš„è¾“å‡ºå€¼.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> DataFetcher <span class="title">mutationDataFetcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DataFetcher() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Review <span class="title">get</span><span class="params">(DataFetchingEnvironment environment)</span> </span>&#123;</span><br><span class="line">            Map&lt;String,Object&gt; episodeInputMap = environemnt.getArugment(<span class="string">"episode"</span>);</span><br><span class="line">            Map&lt;String,Object&gt; reviewInputMap = environment.getArugment(<span class="string">"review"</span>);</span><br><span class="line"></span><br><span class="line">            EpisodeInput episodeInput = EpisodeInput.fromMap(episodeInputMap);</span><br><span class="line">            ReviewInput reviewInput = ReviewInput.fromMap(reviewInputMap);</span><br><span class="line">            Review updatedReview = reviewStore().update(episodeInput, reviewInput);</span><br><span class="line">            <span class="keyword">return</span> updatedReview;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¼‚æ­¥æ‰§è¡Œ"><a href="#å¼‚æ­¥æ‰§è¡Œ" class="headerlink" title="å¼‚æ­¥æ‰§è¡Œ"></a>å¼‚æ­¥æ‰§è¡Œ</h3><p>graphql-java æ‰§è¡ŒæŸ¥è¯¢æ—¶å¯ä»¥å®Œå…¨æ”¯æŒå¼‚æ­¥æ‰§è¡Œ.ä½ å¯ä»¥é€šè¿‡è°ƒç”¨ <code>executeAsync()</code> è·å– <code>CompletableFuture</code>çš„ç»“æœ.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">GraphQL graphql = buildSchema();</span><br><span class="line">ExecutionInput executionInput = ExecutionInput.newExecutionInput().query(<span class="string">"query &#123; hero &#123; name &#125;&#125;"</span>).build();</span><br><span class="line">CompletableFuture&lt;ExecutionResult&gt; promise = graphql.executeAsync(executionInput);</span><br><span class="line">promise.thenAccept(executinoResult -&gt; &#123;</span><br><span class="line">    encodeResultToJsonAndSendResponse(executionResult);</span><br><span class="line">&#125;);</span><br><span class="line">promise.join();</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ <code>CompletableFuture</code> å¯ä»¥åœ¨æ‰§è¡Œå®Œæˆæ—¶ç»„åˆ action å’Œ function.æœ€ç»ˆè°ƒç”¨ <code>join()</code> ç­‰å¾…æ‰§è¡Œå®Œæˆ.<br>graphql-java ä½¿ç”¨å¼‚æ­¥æ‰§è¡Œçš„åŸç†æ˜¯é€šè¿‡ join è°ƒç”¨é€šè¿‡æ–¹æ³•<code>execute()</code>.æ‰€ä»¥ä¸‹é¢çš„ä»£ç æ•ˆæœæ˜¯ä¸€æ ·çš„.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ExecutionResult executionResult = graphql.execute(executionInput);</span><br><span class="line">CompletableFuture&lt;ExecutionResult&gt; promise = graphql.executeAsync(executionInput);</span><br><span class="line">ExecutionResult executionResult = promise.join();</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ <code>graphql.schema.DataFetcher</code> è¿”å›çš„æ˜¯ <code>CompletableFuture&lt;T&gt;</code> å¯¹è±¡,é‚£ä¹ˆè¿™ä¸ªç»“æœå°†è¢«ç»„åˆè¿›æ•´ä¸ªå¼‚æ­¥æŸ¥è¯¢æ‰§è¡Œä¸­.è¿™æ„å‘³ç€ä½ å¯ä»¥å¹¶è¡Œå‘èµ·å¤šä¸ªå±æ€§æŸ¥è¯¢è¯·æ±‚.ä½ ä½¿ç”¨çš„çº¿ç¨‹æ± ç­–ç•¥å–å†³äºä½ çš„ data fetcher ä»£ç .<br>ä¸‹é¢çš„ä»£ç é‡‡ç”¨äº†æ ‡å‡†çš„ <code>java.util.concurrent.ForkJoinPool.commonPool()</code> çº¿ç¨‹æ‰§è¡Œå™¨åœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹æä¾›æ•°æ®.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataFetcher userDataFetcher = <span class="keyword">new</span> DataFetcher() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(DataFetchingEnvironment environment)</span> </span>&#123;</span><br><span class="line">        CompletableFuture&lt;User&gt; userPromise = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> fetchUserViaHttp(environment.getArgument(<span class="string">"userId"</span>));</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> userPromise;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç ç”¨ Java8 Lambdas å¯ä»¥ç®€ç•¥ä¸º:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataFetcher userDataFetcher = environment -&gt; CompletableFuture.supplyAsync(() -&gt; fetchUserViaHttp(environment.getArgument(<span class="string">"userId"</span>));</span><br></pre></td></tr></table></figure>

<p>graphql-java å¼•æ“ç¡®ä¿æ‰€æœ‰çš„ <code>CompletableFuture</code> å¯¹è±¡éµç…§ graphql è§„èŒƒç»„åˆåœ¨ä¸€èµ·æä¾›æ‰§è¡Œç»“æœ.<br>è¿™æ˜¯ graphql-java åˆ›å»ºå¼‚æ­¥ data fetcher çš„å¿«æ·æ–¹å¼.ä½¿ç”¨ <code>graphql.schema.AsyncDataFetcher.async(DataFetcher&lt;T&gt;)</code> åŒ…è£…ä¸€ä¸ª DataFetcher.å¯ä»¥ä½¿ç”¨é™æ€å¯¼å…¥åˆ›å»ºæ›´æ˜“è¯»çš„ä»£ç .</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataFetcher userDataFetcher = async(environment -&gt; fetchUserViaHttp(environment.getArgument(<span class="string">"userId"</span>)));</span><br></pre></td></tr></table></figure>

<h3 id="æ‰§è¡Œç­–ç•¥"><a href="#æ‰§è¡Œç­–ç•¥" class="headerlink" title="æ‰§è¡Œç­–ç•¥"></a>æ‰§è¡Œç­–ç•¥</h3><p>ç»§æ‰¿ <code>graphql.execution.ExecutionStrategy</code> çš„ç±»å¯ä»¥ç”¨äºè¿è¡Œä¸€ä¸ªæŸ¥è¯¢æˆ–ä¿®æ”¹. graphql-java æä¾›äº†å¤§é‡ä¸åŒçš„ç­–ç•¥,å¦‚æœä½ éå¸¸è¿«åˆ‡,ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„.<br>å½“ä½ åˆ›å»º Graphql å¯¹è±¡æ—¶å¯ä»¥ç¡®å®šæ‰§è¡Œç­–ç•¥.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">GraphQL.newGraphQL(schema)</span><br><span class="line">        .queryExecutionStrategy(<span class="keyword">new</span> AsyncExecutionStrategy())</span><br><span class="line">        .mutationExecutionStrategy(<span class="keyword">new</span> AsyncSerialExecutionStrategy())</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šä¸Šé¢çš„ä»£ç å’Œé»˜è®¤è®¾ç½®ä¸€è‡´,å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯ä¸€ä¸ªæ˜æ™ºçš„ç­–ç•¥é€‰æ‹©.</p>
<h3 id="å¼‚æ­¥æ‰§è¡Œç­–ç•¥"><a href="#å¼‚æ­¥æ‰§è¡Œç­–ç•¥" class="headerlink" title="å¼‚æ­¥æ‰§è¡Œç­–ç•¥"></a>å¼‚æ­¥æ‰§è¡Œç­–ç•¥</h3><p>é»˜è®¤çš„æŸ¥è¯¢æ‰§è¡Œç­–ç•¥æ˜¯ <code>graphql.execution.AsyncExecutionStrategy</code>,ä¼šæŠŠæ¯ä¸€ä¸ªå±æ€§ä½œä¸º <code>CompletableFuture</code> å¯¹è±¡åˆ†å‘,å¹¶ä¸”ä¸å…³å¿ƒå“ªä¸ªæœ€å…ˆå®Œæˆ.æ­¤ç­–ç•¥æ˜¯æ€§èƒ½æœ€ä½³çš„æ‰§è¡Œç­–ç•¥.<br>data fetchers æœ¬èº«ä¼šè¿”å› <code>CompletionStage</code> å€¼,è¿™å°†å¯¼è‡´å®Œå…¨å¼‚æ­¥çš„è¡Œä¸º.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">	hero &#123;</span><br><span class="line">		enemies &#123;</span><br><span class="line">			name</span><br><span class="line">		&#125;</span><br><span class="line">		friends &#123;</span><br><span class="line">			name</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AsyncExecutionStrategy</code> è‡ªç”±åˆ†å‘ <i>enemies</i> å±æ€§å’Œ <i>friends</i>å±æ€§.<i>enemies</i> å±æ€§ä¸å¿…ç­‰å¾… <i>friends</i>å±æ€§è¿”å›.è¿™æ˜¯éå¸¸ä½æ•ˆçš„.<br>æ— è®ºå¦‚ä½•,æœ€ç»ˆä¼šå°†ç»“æœæŒ‰é¡ºåºæ’åˆ—.æŸ¥è¯¢ç»“æœå°†éµç…§ graphql è§„èŒƒ,è¿”å›ç»“æœå¯¹åº” query å±æ€§é¡ºåº.åªæœ‰ data fetcher çš„æ‰§è¡Œæ˜¯éšæœºé¡ºåº.</p>
<h3 id="å¼‚æ­¥åºåˆ—åŒ–æ‰§è¡Œç­–"><a href="#å¼‚æ­¥åºåˆ—åŒ–æ‰§è¡Œç­–" class="headerlink" title="å¼‚æ­¥åºåˆ—åŒ–æ‰§è¡Œç­–"></a>å¼‚æ­¥åºåˆ—åŒ–æ‰§è¡Œç­–</h3><p>graphql è§„èŒƒè¦æ±‚ mutation å¿…é¡»æŒ‰ç…§ query å±æ€§çš„é¡ºåºåºåˆ—åŒ–æ‰§è¡Œ.<br>æ‰€ä»¥ mutation é»˜è®¤ä½¿ç”¨ <code>graphql.execution.AsyncSerialExecutionStrategy</code> ç­–ç•¥.å®ƒä¼šä¿è¯åœ¨æ‰§è¡Œä¸‹ä¸€ä¸ªå’Œåé¢å‰å½“å‰çš„æ¯ä¸ªå±æ€§æ‰§è¡Œå®Œæ¯•.ä¹Ÿå¯ä»¥åœ¨ mutation data fetcher ä¸­è¿”å› <code>CompletionStage</code> å¯¹è±¡,å¹¶ä¸”ä¼šæŒ‰é¡ºåºåœ¨ä¸‹ä¸€ä¸ª mutation å±æ€§ data fetcher è¢«åˆ†å‘ä¹‹å‰æ‰§è¡Œå®Œæ¯•.</p>
<h3 id="è®¢é˜…æ‰§è¡Œç­–ç•¥"><a href="#è®¢é˜…æ‰§è¡Œç­–ç•¥" class="headerlink" title="è®¢é˜…æ‰§è¡Œç­–ç•¥"></a>è®¢é˜…æ‰§è¡Œç­–ç•¥</h3><p>graphql å…è®¸å¯¹ graphql data åˆ›å»ºæœ‰çŠ¶æ€çš„è®¢é˜….å¯ä»¥ä½¿ç”¨ <code>SubscriptionExecutionStrategy</code>å®ç°,åŒæ—¶æ”¯æŒ reactive-stream API.<br><a href="https://www.graphql-java.com/documentation/v12/subscriptions" target="_blank" rel="noopener">æŸ¥çœ‹</a>äº†è§£æ›´å¤šåŸºäº graphql æœåŠ¡çš„è®¢é˜…æ”¯æŒ.</p>
<h3 id="æŸ¥è¯¢ç¼“å­˜"><a href="#æŸ¥è¯¢ç¼“å­˜" class="headerlink" title="æŸ¥è¯¢ç¼“å­˜"></a>æŸ¥è¯¢ç¼“å­˜</h3><p>åœ¨ graphql-java å¼•æ“æ‰§è¡ŒæŸ¥è¯¢ä¹‹å‰å¿…é¡»è¢«è§£æå’Œæ£€éªŒ,å¹¶ä¸”è¿™ä¸ªå¤„ç†è¿‡ç¨‹å¯èƒ½æœ‰äº›è€—æ—¶.<br>ä¸ºäº†é¿å…é‡å¤è§£æ/æ ¡éªŒ<code>GraphQL.Builder</code>å…è®¸<code>PreparsedDocumentProvider</code>å®ä¾‹å¤ç”¨<code>Document</code>å®ä¾‹.<br>æ³¨æ„ âš ï¸,è¿™åªç¼“å­˜è§£æçš„ <code>Document</code>,ä¸ç¼“å­˜æŸ¥è¯¢ç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Cache&lt;String,PreparsedDocumentEntry&gt; cache = Caffeine.newBuilder().maximumSize(<span class="number">10_000</span>).build();</span><br><span class="line">GraphQL graphql = GraphQL.newGraphQL(StarWarsSchema.starWarsSchema)</span><br><span class="line">        .preparsedDocumentProvider(cache::get)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure>

<ul>
<li>è¿™ä¸ªç¼“å­˜å®ä¾‹åº”è¯¥æ˜¯çº¿ç¨‹å®‰å…¨å…±äº«çš„.</li>
<li><code>PreparsedDocumentProvider</code> æ˜¯ä¸€ä¸ªåªæœ‰ä¸€ä¸ª get æ–¹æ³•çš„å‡½æ•°æ¥å£,æˆ‘ä»¬å¯ä»¥ä¼ é€’ä¸€ä¸ªæ–¹æ³•å¼•ç”¨åˆ°é‡Œé¢ä»¥åŒ¹é… builder çš„ç­¾å.</li>
</ul>
<p>ä¸ºäº†å®ç°é«˜ç¼“å­˜è¦†ç›–ç‡,æ¨èå±æ€§å‚æ•°é€šè¿‡å˜é‡ä¼ é€’è€Œä¸æ˜¯ç›´æ¥åœ¨ query ä¸­å®šä¹‰.<br>ä¸‹é¢çš„æŸ¥è¯¢:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">query HelloTo &#123;</span><br><span class="line">	sayHello(to: &quot;ME&quot;) &#123;</span><br><span class="line">		greeting</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åº”è¯¥è¿™æ ·å†™:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">query HelloTo($to: String!) &#123;</span><br><span class="line">	sayHello(to: $to) &#123;</span><br><span class="line">		greeting</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å’Œå˜é‡</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;to&quot;: &quot;Me&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨å°±å¯ä»¥ä¸ç®¡æä¾›çš„å˜é‡æ˜¯ä»€ä¹ˆè€Œé‡ç”¨æŸ¥è¯¢.</p>
]]></content>
  </entry>
  <entry>
    <title>GraphQL-Scalars</title>
    <url>/2019/05/05/GraphQL-Scalars/</url>
    <content><![CDATA[<p>scalars</p>
<a id="more"></a>
<h2 id="graphql-ä¸­çš„å¸¸é‡"><a href="#graphql-ä¸­çš„å¸¸é‡" class="headerlink" title="graphql ä¸­çš„å¸¸é‡"></a>graphql ä¸­çš„å¸¸é‡</h2><h3 id="scalars"><a href="#scalars" class="headerlink" title="scalars"></a>scalars</h3><p>graphql ç±»å‹ç³»ç»Ÿçš„å¶å­èŠ‚ç‚¹è¢«ç§°ä¸º scalars.ä¸€æ—¦åˆ°è¾¾äº† scalar ç±»å‹åˆ™æ— æ³•åœ¨æ²¿ç€ç±»å‹ç»“æ„ç»§ç»­å‘ä¸‹äº†.scalar ç±»å‹æ˜¯æŒ‡ä¸å¯å†åˆ†å‰²çš„å€¼.<br>graphql è§„èŒƒæ˜ç¡®è¦æ±‚æ‰€æœ‰çš„è¯­è¨€å®ç°å¿…é¡»å…·æœ‰ä»¥ä¸‹ scalar ç±»å‹.</p>
<ul>
<li>String å³ <code>GraphQLString</code>- ä¸€ä¸ª UTF-8 å­—ç¬¦ä¸²åºåˆ—.</li>
<li>Boolean å³ <code>GraphQLBoolean</code>- true or false.</li>
<li>Int å³ <code>GraphQLInt</code>- æœ‰ç¬¦å·çš„ 32 æ•´å‹æ•°.</li>
<li>Float å³ <code>GraphQLFloat</code>- æœ‰ç¬¦å·çš„åŒç²¾åº¦æµ®ç‚¹æ•°.</li>
<li>ID å³ <code>GraphQLID</code>- ç±»ä¼¼äº String çš„å”¯ä¸€æ ‡è¯†ç¬¦.å®šä¹‰ä¸€ä¸ª ID æ ‡è¯†ç¬¦å³è¡¨ç¤ºè¯¥å±æ€§ä¸æ˜¯äººç±»å¯è¯†åˆ«çš„ç”¨é€”.<br>graphql-java ä¸º java ç³»ç»Ÿæ·»åŠ äº†ä»¥ä¸‹æœ‰ç”¨çš„ scalar ç±»å‹.</li>
<li>Long å³ <code>GraphQLLong</code>- åŸºäº java.lang.Long çš„ scalar.</li>
<li>Short å³ <code>GraphQLShort</code>- åŸºäº java.lang.Short çš„ scalar.</li>
<li>Byte å³ <code>GraphQLByte</code>- åŸºäº java.lang.Byte çš„ scalar.</li>
<li>BigDecimal å³ <code>GraphQLBigDicimal</code> åŸºäº java.math.BigDecimal çš„ scalar.</li>
<li>BigInteger å³ <code>GrapQLBigInteger</code> åŸºäº java.math.BigInteger çš„ scalar.</li>
</ul>
<p><code>graphql.Scalars</code>ç±»åŒ…å«äº†æä¾› scalar ç±»å‹çš„å•ä¾‹å®ä¾‹.</p>
<h3 id="è‡ªå®šä¹‰-scalars"><a href="#è‡ªå®šä¹‰-scalars" class="headerlink" title="è‡ªå®šä¹‰ scalars"></a>è‡ªå®šä¹‰ scalars</h3><p>ä½ å¯ä»¥å®ç°è‡ªå®šä¹‰ scalar.åœ¨è¿è¡Œæ—¶ä½ éœ€è¦å®Œæˆç±»å‹å¼ºåˆ¶è½¬æ¢,åé¢ä¼šè§£é‡Š.å‡è®¾æˆ‘ä»¬éœ€è¦ä¸€ä¸ª email çš„ scalar ç±»å‹.å®ƒæŠŠ email åœ°å€ä½œä¸ºè¾“å…¥è¾“å‡º.<br>æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå¦‚ä¸‹çš„ <code>graphql.schema.GraphQLScalarType</code> å•ä¾‹å®ä¾‹.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> GraphQLScalarType EMAIL = <span class="keyword">new</span> GraphQLScalarType(<span class="string">"email"</span>,<span class="string">"A cusom scalar that handles emails"</span>,<span class="keyword">new</span> Coercing() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">serialize</span><span class="params">(Object dataFetcehrResult)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serilizeEmail(dataFetcherResult);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">parseValue</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> parseEmailFromVariable(input);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">parseLiteral</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> parseEmailFromAstLiteral(input);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="å¼ºåˆ¶ç±»å‹è½¬æ¢"><a href="#å¼ºåˆ¶ç±»å‹è½¬æ¢" class="headerlink" title="å¼ºåˆ¶ç±»å‹è½¬æ¢"></a>å¼ºåˆ¶ç±»å‹è½¬æ¢</h3><p>è‡ªå®šä¹‰ scalar å®ç°çš„çœŸæ­£ä½œç”¨ç‚¹åœ¨ <code>graphql.schema.Coercing</code>å®ç°.æœ‰ 3 ä¸ªå‡½æ•°éœ€è¦å®ç°</p>
<ul>
<li><code>parseValue</code>- æ¥æ”¶ä¸€ä¸ªè¾“å…¥å˜é‡,è½¬æ¢ä¸º java è¿è¡Œæ—¶å®ç°.</li>
<li><code>parseLiteral</code>-æ¥æ”¶ä¸€ä¸ª AST å­—ç¬¦ <code>graphql.language.Value</code> ä½œä¸ºè¾“å…¥,è½¬æ¢ä¸º java è¿è¡Œæ—¶å®ç°.</li>
<li><code>serialize</code>-æ¥æ”¶ä¸€ä¸ª Java å¯¹è±¡,æœ€ç»ˆè½¬ä¸º scalar è¾“å‡ºç±»å‹.<br>æ‰€ä»¥ä½ è‡ªå®šä¹‰çš„ scalar å®ç°éœ€è¦å¤„ç† 2 ä¸­ç±»å‹çš„è¾“å…¥(parseValue/parseLiteral)å’Œ 1 ä¸­è¾“å‡º(serialize).<br>å¦‚ä¸‹æŸ¥è¯¢,ä½¿ç”¨äº†å˜é‡,AST å­—ç¬¦ç„¶åè¾“å‡ºæˆ‘ä»¬éœ€è¦çš„ scalar ç±»å‹ email.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mutation Contact($mainContact: Email!) &#123;</span><br><span class="line">	makeContact(</span><br><span class="line">		mainContactEmail: $mainContact</span><br><span class="line">		backupContactEmial: &quot;backup@company.com&quot;</span><br><span class="line">	) &#123;</span><br><span class="line">		id</span><br><span class="line">		mainContactEmail</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çš„è‡ªå®šä¹‰ email scalar ç±»å‹å°†</p>
<ul>
<li>è°ƒç”¨ <code>parseValue</code> å°† <code>$mainContact</code>å˜é‡è½¬ä¸ºè¿è¡Œæ—¶å¯¹è±¡.</li>
<li>è°ƒç”¨ <code>parseLiteral</code> å°† AST <code>graphql.language.StringValue</code> â€œ<a href="mailto:backup@company.com">backup@company.com</a>â€œ è½¬æ¢ä¸ºè¿è¡Œæ—¶å¯¹è±¡.</li>
<li>è°ƒç”¨ <code>serialize</code> å°† mainContactEmial è¿è¡Œæ—¶å®ç°è½¬ä¸ºè¾“å‡ºå¯¹è±¡å½¢å¼.</li>
</ul>
<h3 id="è¾“å…¥è¾“å‡ºæ ¡éªŒ"><a href="#è¾“å…¥è¾“å‡ºæ ¡éªŒ" class="headerlink" title="è¾“å…¥è¾“å‡ºæ ¡éªŒ"></a>è¾“å…¥è¾“å‡ºæ ¡éªŒ</h3><p>ä¾‹å¦‚æˆ‘ä»¬çš„ email scalar å°†ä¼šæ ¡éªŒè¾“å…¥è¾“å‡ºæ˜¯å¦æ˜¯çœŸæ˜¯çš„ email åœ°å€.<br><code>graphql.schema.Coercing</code> åè®®å¦‚ä¸‹:</p>
<ul>
<li><code>serialize</code> åªå…è®¸æŠ›å‡º <code>graphql.schema.CoercingSerializeException</code>.è¿™è¡¨æ˜å€¼æ— æ³•è¢«åºåˆ—åŒ–ä¸ºåˆé€‚çš„å½¢å¼.å†³ä¸å…è®¸æŒ‡å®šå…¶ä»–è¿è¡Œæ—¶å¼‚å¸¸ä»¥å–å¾—æ™®é€šçš„ graphql æ ¡éªŒè¡Œä¸º.å¿…é¡»è¿”å›ä¸€ä¸ªé <code>null</code> å€¼.</li>
<li><code>parseValue</code> åªå…è®¸æŠ›å‡º <code>graphql.schema.CoercingParseValueException</code>.è¿™è¡¨æ˜å€¼æ— æ³•è¢«ä½œä¸ºè¾“å…¥è§£æä¸ºåˆé€‚çš„å½¢å¼..å†³ä¸å…è®¸æŒ‡å®šå…¶ä»–è¿è¡Œæ—¶å¼‚å¸¸ä»¥å–å¾—æ™®é€šçš„ graphql æ ¡éªŒè¡Œä¸º.å¿…é¡»è¿”å›ä¸€ä¸ªé <code>null</code> å€¼.</li>
<li><code>parseLiteral</code> åªå…è®¸æŠ›å‡º <code>graphql.schema.CoercingParseLiterialException</code>.è¿™è¡¨æ˜ AST å€¼æ— æ³•è¢«ä½œä¸ºè¾“å…¥è§£æä¸ºåˆé€‚çš„å½¢å¼..å†³ä¸å…è®¸æŒ‡å®šå…¶ä»–è¿è¡Œæ—¶å¼‚å¸¸ä»¥å–å¾—æ™®é€šçš„ graphql æ ¡éªŒè¡Œä¸º.<br>æœ‰çš„äººå°è¯•ä¾èµ–è¿è¡Œæ—¶å¼‚å¸¸æ ¡éªŒä»¥æœŸè·å–æ™®é€šçš„ graphql é”™è¯¯.è¿™æ˜¯è¡Œä¸é€šçš„.å¿…é¡»éµç…§ <code>Coercing</code> æ–¹æ³•åè®®ä½¿ graphql-java å¼•æ“æŒ‰ç…§ grapqhl çš„ scalar ç±»å‹è§„èŒƒè¿è¡Œ.</li>
</ul>
<h3 id="ç¤ºä¾‹å®ç°"><a href="#ç¤ºä¾‹å®ç°" class="headerlink" title="ç¤ºä¾‹å®ç°"></a>ç¤ºä¾‹å®ç°</h3><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ email scalar ç±»å‹å®ç°,å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ç»§æ‰¿ <code>Coercing</code> å®ç°ä¸€ä¸ª scalar.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailScalar</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> GraphQLScalarType EMAIL = <span class="keyword">new</span> GraphQLScalarType(<span class="string">"email"</span>,<span class="string">"A custom scalar that handles emails"</span>,<span class="keyword">new</span> Coercing() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">serialize</span><span class="params">(Object dataFetcherResult)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> serializeEmail(dataFetcherResult);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">parseValue</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> parseEmailFromVariable(input);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">parseLiterial</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> parseEmialFromAstLiterial(input);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">looksLikeAnEmailAddress</span><span class="params">(String possibleEmailValue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Pattern.matches(<span class="string">"[A-Za-z0-9]@[.*]"</span>,possibleEmailValue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">serialzeEmail</span><span class="params">(Object dataFetcherResult)</span> </span>&#123;</span><br><span class="line">        String possibleEmailValue = String.valueOf(dataFetcherResult);</span><br><span class="line">        <span class="keyword">if</span> (looksLikeAnEmailAddress(possibleEmailValue)) &#123;</span><br><span class="line">            <span class="keyword">return</span> possibleEmailValue;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CoercingSerializeException(<span class="string">"Unable to serialize"</span> + possibleEmailValue + <span class="string">" as an email address"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">parseEmailFromVariable</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            String possibleEmailValue = input.toString();</span><br><span class="line">            <span class="keyword">if</span> (looksLikeAnEmailAddress(possibleEmailValue)) &#123;</span><br><span class="line">                <span class="keyword">return</span> possibleEmailValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CoercingParseValueException(<span class="string">"Unable to parse variable value "</span> + input + <span class="string">" as an email address"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">parseEmailFromAstLiterial</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input <span class="keyword">instanceof</span> StringValue) &#123;</span><br><span class="line">            String possibleEmailValue = ((StringValue)input).getValue();</span><br><span class="line">            <span class="keyword">if</span> (looksLikeAnEmailAddress(possibleEmailValue)) &#123;</span><br><span class="line">                <span class="keyword">return</span> possibleEmailValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CoercingParseLiterialException(<span class="string">"Unable to parse variable value "</span> + input + <span class="string">" as an email address"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>Kotlin å‚æ•°ä¸èƒ½ä¸º var</title>
    <url>/2020/02/15/Kotlin-%E5%8F%82%E6%95%B0%E4%B8%8D%E8%83%BD%E4%B8%BA-var/</url>
    <content><![CDATA[<p>ä» Kotlin M5.1 ä¹‹åä¸å†æ”¯æŒå‡½æ•°å‚æ•°å¯å˜(var).</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">fun foo(var x: Int) &#123;</span><br><span class="line">    x &#x3D; 5</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸»è¦æ˜¯è¿™å›å¯¼è‡´æ­§ä¹‰:å¯èƒ½è®¤ä¸ºä¼ é€’çš„æ˜¯å¼•ç”¨å‚æ•°(æ­¤ç‰¹æ€§ä¸æ”¯æŒ,éœ€è¦åœ¨ runtime ä¿®æ”¹).<br>å¦ä¸€ä¸ªåŸå› æ˜¯ä¸»æ„é€ å‡½æ•°:ä¸»æ„é€ å‡½æ•°ä½¿ç”¨ <code>val</code> æˆ– <code>var</code>å£°æ˜ä¸åŒæ€§è´¨çš„å±æ€§,è€Œæ™®é€šå‡½æ•°å´ä¸éœ€è¦è¿™æ ·çš„åŠŸèƒ½.<br>åŒæ—¶å¯å˜å‚æ•°å¯ä¸æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯,æ‰€ä»¥åœ¨å‡½æ•°æ”¯æŒå¯å˜å‚æ•°æˆ–<code>for-loop</code>å—éƒ½ä¸å†æ”¯æŒ.</p>
<p><a href="https://blog.jetbrains.com/kotlin/2013/02/kotlin-m5-1/" target="_blank" rel="noopener">origin</a></p>
]]></content>
      <tags>
        <tag>kotlin</tag>
      </tags>
  </entry>
  <entry>
    <title>Groovy template</title>
    <url>/2019/08/16/Groovy-template/</url>
    <content><![CDATA[<p>Groovy MarkupTemplateEngine ä¸»è¦é¢å‘ç”Ÿæˆç±» XML(XML,XHTML,HTML5â€¦)çš„æ ‡è®°è¯­è¨€,ä½†æ˜¯ä¹Ÿæ”¯æŒå…¶ä»–åŸºäºå†…å®¹çš„æ–‡æœ¬.å’Œä¼ ç»Ÿçš„æ¨¡ç‰ˆå¼•æ“ç›¸æ¯”,æ­¤å¼•æ“æ”¯æŒåŸºäº DSL çš„ builder è¯­æ³•.</p>
<a id="more"></a>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">xmlDeclaration()</span><br><span class="line">cars &#123;</span><br><span class="line">  carsh.each &#123;</span><br><span class="line">    car(<span class="string">make:</span>it.make,<span class="string">model:</span>it.model)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h3><p><code>MarkupTemplateEngine</code>æ”¯æŒå¼•ç”¨æ¥è‡ªå¦ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹.</p>
<ul>
<li>å¦ä¸€ä»½æ¨¡ç‰ˆ</li>
<li>åŸç”Ÿå†…å®¹</li>
<li>éœ€è¦è½¬ä¹‰çš„å†…å®¹</li>
</ul>
]]></content>
      <tags>
        <tag>è¯‘</tag>
      </tags>
  </entry>
  <entry>
    <title>LiveData</title>
    <url>/2019/02/28/LiveData/</url>
    <content><![CDATA[<p>LiveData</p>
<a id="more"></a>
<h3 id="LiveData-çš„ä¼˜åŠ¿"><a href="#LiveData-çš„ä¼˜åŠ¿" class="headerlink" title="LiveData çš„ä¼˜åŠ¿"></a>LiveData çš„ä¼˜åŠ¿</h3><ul>
<li>ç¡®ä¿ UI å’Œæ•°æ®çŠ¶æ€åŒ¹é…<blockquote>
<p>LiveData éµå¾ªè§‚å¯Ÿè€…æ¨¡å¼ã€‚</p>
</blockquote>
</li>
<li>æ— å†…å­˜æ³„æ¼</li>
<li>ä¸ä¼šå› ä¸º Activity è¢«ç»ˆæ­¢è€Œå´©æºƒ<blockquote>
<p>å¦‚æœè§‚å¯Ÿè€…å¤„äº inactive çŠ¶æ€ï¼Œä¾‹å¦‚ activity å¤„äºå›é€€æ ˆä¸­ï¼Œé‚£ä¹ˆå®ƒä¸ä¼šæ¥æ”¶åˆ°ä»»ä½• LiveData äº‹ä»¶.</p>
</blockquote>
</li>
<li>ä¸ç”¨æ‰‹åŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</li>
<li>æ—¶åˆ»æ›´æ–°æ•°æ®çŠ¶æ€<blockquote>
<p>å¦‚æœä¸€ä¸ªè§‚å¯Ÿè€…çš„å˜ä¸º inactiveï¼Œé‚£ä¹ˆå®ƒä¼šåœ¨é‡æ–° active æ—¶è·å–æœ€æ–°çš„æ•°æ®çŠ¶æ€ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ª activiy å¦‚æœå¤„äºåå°ï¼Œé‚£ä¹ˆå®ƒå°†åœ¨é‡æ–°è¿”å›å‰å°æ—¶è·å–åˆ°æœ€æ–°çš„æ•°æ®ã€‚</p>
</blockquote>
</li>
<li>åº”å¯¹ configuration change<blockquote>
<p>å¦‚æœä¸€ä¸ª activity æˆ– fragment ç”±äº configuration change(è®¾å¤‡æ—‹è½¬) å¯¼è‡´é‡æ–°åˆ›å»ºï¼Œå®ƒä¼šç«‹å³è·å–æœ€æ–°å¯ç”¨çš„æ•°æ®.</p>
</blockquote>
</li>
<li>å…±äº«èµ„æº<blockquote>
<p>å¯ä»¥ä½¿ç”¨å•ä¾‹æ¨¡å¼æ‰©å±• LiveDataï¼Œå°è£…ç³»ç»ŸæœåŠ¡åœ¨ app å†…å…±äº«ã€‚</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>åœ¨ ViewModel å¯¹è±¡ä¸­ä¿å­˜å¯ä»¥æ›´æ–° UI çš„ LiveData å¯¹è±¡ï¼Œè€Œä¸æ˜¯åœ¨ activity æˆ– fragment çš„åŸå› æ˜¯ï¼š</p>
<ul>
<li>é¿å… activty æˆ– framgent è¿‡åº¦è†¨èƒ€ã€‚UI controller ä»…è´Ÿè´£å±•ç¤ºæ•°æ®è€Œä¸æ˜¯ä¿å­˜æ•°æ®çŠ¶æ€</li>
<li>ä»ç‰¹æ€§çš„ activity æˆ– fragment ä¸­å‰¥ç¦» LiveData å®ä¾‹ï¼Œä½¿å¾— LiveData å¯¹è±¡å¯ä»¥åœ¨ configuration change ä¸­å­˜æ´»ã€‚</li>
</ul>
</blockquote>
<p><em>è¯·åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ setValue(T) æ›´æ–° LiveData å¯¹è±¡.å¦‚æœæ˜¯åœ¨å·¥ä½œçº¿ç¨‹ï¼Œè¯·è°ƒç”¨ postValue(T).</em></p>
]]></content>
      <tags>
        <tag>Architecture Components</tag>
      </tags>
  </entry>
  <entry>
    <title>Java å¹¶å‘å’Œå¤šçº¿ç¨‹æŒ‡å—</title>
    <url>/2019/08/26/Java-%E5%B9%B6%E5%8F%91%E5%92%8C%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%8C%87%E5%8D%97/</url>
    <content><![CDATA[<a id="more"></a>]]></content>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
        <tag>å¹¶å‘</tag>
      </tags>
  </entry>
  <entry>
    <title>JGit</title>
    <url>/2019/03/16/JGit/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>JGit æ˜¯ä¸€ä¸ªåŸºäº EDL(BSD åè®®çš„å˜ç§)æˆæƒçš„è½»é‡çº§ã€å®ç° Git ç‰ˆæœ¬æ§åˆ¶ç³»ç»ŸåŠŸèƒ½(å¸¸è§„ä»“åº“è®¿é—®,ç½‘ç»œåè®®,ç‰ˆæœ¬æ§åˆ¶æ ¸å¿ƒç®—æ³•)çš„çº¯ Java åº“.</p>
<a id="more"></a>
<h2 id="å…¥é—¨"><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h2><h3 id="è·å–"><a href="#è·å–" class="headerlink" title="è·å–"></a>è·å–</h3><p>åœ¨<a href="https://mvnrepository.com/" target="_blank" rel="noopener">ä»“åº“æœç´¢å¼•æ“</a>ä¸­æœç´¢ jgit å³å¯è·å–å„ç§æ·»åŠ ä¾èµ–çš„æ–¹å¼.æˆ‘ç°åœ¨åŸºæœ¬ä½¿ç”¨çš„æ˜¯ gradle ä¾èµ–</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">implementation(<span class="string">"org.eclipse.jgit:org.eclipse.jgit:5.3.0.201903130848-r"</span>)</span><br><span class="line">implementation(<span class="string">"org.eclipse.jgit:org.eclipse.jgit.http.server:5.3.0.201903130848-r"</span>)</span><br></pre></td></tr></table></figure>

<p>JGit ä¹Ÿå…·æœ‰ CLI(åŠŸèƒ½æ¯” git CLI å°‘),å¯ä»¥è¯•ä¸€ä¸‹ JGit çš„åŠŸèƒ½.</p>
<h4 id="æ‰‹åŠ¨ç¼–è¯‘-JGit-CLI"><a href="#æ‰‹åŠ¨ç¼–è¯‘-JGit-CLI" class="headerlink" title="æ‰‹åŠ¨ç¼–è¯‘ JGit CLI"></a>æ‰‹åŠ¨ç¼–è¯‘ JGit CLI</h4><p>å‡è®¾å·²ç» clone EGit ä»“åº“. <code>git clone https://git.eclipse.org/r/jgit/jgit.git</code> <a href="https://wiki.eclipse.org/EGit/Contributor_Guide#JGit" target="_blank" rel="noopener">å…·ä½“æŸ¥çœ‹</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">~/src/jgit$ mvn clean install</span><br><span class="line"><span class="comment"># è¿›å…¥ jgit å¯æ‰§è¡Œæ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹</span></span><br><span class="line">org.eclipse.jgit.pgm/target/jgit</span><br><span class="line"><span class="comment"># æŸ¥çœ‹ version å‘½ä»¤</span></span><br><span class="line">prompt$ ./jgit version</span><br><span class="line">jgit version xxxxx</span><br><span class="line"><span class="comment"># å¦‚æœç»å¸¸ä½¿ç”¨ jgit å‘½ä»¤,å¯ä»¥æ·»åŠ æ‰§è¡Œé“¾æ¥(é€šå¸¸åœ¨ /usr/local/bin)</span></span><br><span class="line">sudo ln -s /path/to/jgit /usr/<span class="built_in">local</span>/bin/jgit</span><br></pre></td></tr></table></figure>

<h4 id="åœ¨-JGit-CLI-è¿è¡Œå‘½ä»¤"><a href="#åœ¨-JGit-CLI-è¿è¡Œå‘½ä»¤" class="headerlink" title="åœ¨ JGit CLI è¿è¡Œå‘½ä»¤"></a>åœ¨ JGit CLI è¿è¡Œå‘½ä»¤</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">prompt$ ./git</span><br><span class="line"><span class="comment"># ä¼šåˆ—å‡ºæœ€å¸¸ç”¨çš„å‘½ä»¤</span></span><br><span class="line">jgit --git-dir GIT_DIR --<span class="built_in">help</span> (-h) --show-stack-trace <span class="built_in">command</span> [ARG ...]</span><br><span class="line"></span><br><span class="line">The most commonly used commands are:</span><br><span class="line"> branch   List, create, or delete branches</span><br><span class="line"> <span class="built_in">clone</span>    Clone a repository into a new directory</span><br><span class="line"> commit   Record changes to the repository</span><br><span class="line"> daemon   Export repositories over git://</span><br><span class="line"> diff     Show diffs</span><br><span class="line"> fetch    Update remote refs from another repository</span><br><span class="line"> init     Create an empty git repository</span><br><span class="line"> <span class="built_in">log</span>      View commit <span class="built_in">history</span></span><br><span class="line"> push     Update remote repository from <span class="built_in">local</span> refs</span><br><span class="line"> rm       Stop tracking a file</span><br><span class="line"> tag      Create a tag</span><br><span class="line"> version  Display the version of jgit</span><br><span class="line"></span><br><span class="line"> <span class="comment"># å¸¸ç”¨çš„ debug test å‘½ä»¤</span></span><br><span class="line"> prompt$ ./jgit debug-show-commands</span><br></pre></td></tr></table></figure>

<h5 id="æŸ¥çœ‹ä»“åº“"><a href="#æŸ¥çœ‹ä»“åº“" class="headerlink" title="æŸ¥çœ‹ä»“åº“"></a>æŸ¥çœ‹ä»“åº“</h5><p>åœ¨æŸ¥çœ‹æœ€å¸¸ç”¨çš„å‘½ä»¤ä¹‹å‰ï¼Œä½ å¯èƒ½æƒ³çŸ¥é“è¯¥ä»“åº“åŒ…å«äº†å¤šå°‘åˆ†æ”¯ï¼Œå½“å‰åˆ†æ”¯æ˜¯é‚£ä¸ª.ä½¿ç”¨ branch -v å¯ä»¥è·å–æ‰€æœ‰åˆ†æ”¯çš„ç®€ç•¥ä¿¡æ¯ï¼Œç‰ˆæœ¬å·ï¼Œç‰ˆæœ¬å·æäº¤ä¿¡æ¯çš„ç¬¬ä¸€è¡Œ.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">prompt$ ./jgit branch -v</span><br><span class="line"><span class="comment">#  master       4d4adfb Git Project import: don't hide but gray out existing projects</span></span><br><span class="line"><span class="comment"># * traceHistory 6b9fe04 [historyView] Add trace instrumentation</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å’Œ git-log ä¸€æ · log å‘½ä»¤æ˜¾ç¤ºæäº¤ä¿¡æ¯</span></span><br><span class="line">jgit <span class="built_in">log</span> --author Math --grep tycho master</span><br><span class="line"><span class="comment"># æ˜¾ç¤º master åˆ†é’Ÿä¸­ï¼Œä½œè€…ååŒ…å« Math,æäº¤ä¿¡æ¯åŒ…å« tycho çš„æœæœ‰æäº¤ä¿¡æ¯.</span></span><br><span class="line"><span class="comment"># commit xxxx</span></span><br><span class="line"><span class="comment"># Author: Math xxxx</span></span><br><span class="line"><span class="comment"># Date: xxx</span></span><br><span class="line"><span class="comment"># Update build to use tycho x.xx.x</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># å¤§å¤šæ•°çš„æœç´¢éƒ½ä¼šç²¾ç¡®è¿‡æ»¤æäº¤æ—¥å¿—ï¼Œå¦‚æäº¤è€…å§“åç­‰</span></span><br></pre></td></tr></table></figure>

<h5 id="å†å²å›¾å½¢åŒ–"><a href="#å†å²å›¾å½¢åŒ–" class="headerlink" title="å†å²å›¾å½¢åŒ–"></a>å†å²å›¾å½¢åŒ–</h5><p><code>jgit glog</code></p>
<h3 id="æ ¸å¿ƒæ¦‚å¿µ"><a href="#æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="æ ¸å¿ƒæ¦‚å¿µ"></a>æ ¸å¿ƒæ¦‚å¿µ</h3><h4 id="API"><a href="#API" class="headerlink" title="API"></a>API</h4><h4 id="ä»“åº“"><a href="#ä»“åº“" class="headerlink" title="ä»“åº“"></a>ä»“åº“</h4><p>Repository ç®¡ç†æ‰€æœ‰çš„é¡¹ç›®å’Œå¼•ç”¨ï¼Œç®¡ç†ä»£ç </p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> repository = FileRepositoryBuilder()</span><br><span class="line">    .setGitDir(File(<span class="string">"/my/git/directory"</span>))</span><br><span class="line">    .readEnvironment() <span class="comment">// æ‰«æ GIT_* ç¯å¢ƒå˜é‡</span></span><br><span class="line">    .findGitDir() <span class="comment">// æ‰«ææ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">    .build()</span><br></pre></td></tr></table></figure>

<h4 id="Git-å¯¹è±¡"><a href="#Git-å¯¹è±¡" class="headerlink" title="Git å¯¹è±¡"></a>Git å¯¹è±¡</h4><p>åœ¨ Git object model æ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯ç”± SHA-1 id è¡¨ç¤º.åœ¨ JGit ä¸­æ˜¯ç”± <code>AnyObjectId</code> å’Œ <code>ObjectId</code>ç±»è¡¨ç¤º.<br>åœ¨ Git object model ä¸­å®šä¹‰äº†å››ç§å¯¹è±¡ç±»å‹:</p>
<ul>
<li>blob: ç”¨äºå­˜å‚¨æ–‡ä»¶å¯¹è±¡</li>
<li>tree: å¯ä»¥çœ‹ä½œä¸€ä¸ªæ–‡ä»¶å¤¹ï¼ŒæŒ‡å‘å…¶ä»–çš„ tree æˆ– blob</li>
<li>commit: æŒ‡å‘ä¸€ä¸ª tree çš„æäº¤ä¿¡æ¯</li>
<li>tag: çªå‡ºæäº¤ä¿¡æ¯,é€šå¸¸ç”¨æ¥æ ‡è®°ç‰¹æ®Šçš„ release ç‰ˆæœ¬.</li>
</ul>
<p>ä¸ºäº†ä»ä¸€ä¸ªä»“åº“ä¸­è¯†åˆ«ä¸€ä¸ªå¯¹è±¡ï¼Œåªè¦ä¼ å…¥ä¸€ä¸ªæ­£ç¡®çš„ revision å­—ç¬¦ä¸²å³å¯</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> head = repository.resolve(<span class="string">"HEAD"</span>)</span><br></pre></td></tr></table></figure>

<h4 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h4><p>ref æ˜¯ä¸€ä¸ªåŒ…å«å•ä¸ªå¯¹è±¡æ ‡è¯†ç¬¦çš„å˜é‡.å¯¹è±¡æ ‡è¯†ç¬¦å¯ä»¥æ˜¯ä»»ä½• Git åˆæ³•å¯¹è±¡(blob,tree,commit,tag)<br>ä¾‹å¦‚,è·å– head çš„å¼•ç”¨.</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> HEAD = repository.findRef(<span class="string">"refs/heads/master"</span>)</span><br></pre></td></tr></table></figure>

<h4 id="RevWalk"><a href="#RevWalk" class="headerlink" title="RevWalk"></a>RevWalk</h4><p>RevWalk éå† commit graphï¼Œå¹¶æŒ‰é¡ºåºç”ŸæˆåŒ¹é…çš„ commit</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> revWalk = RevWalk(repository)</span><br></pre></td></tr></table></figure>

<h4 id="RevCommit"><a href="#RevCommit" class="headerlink" title="RevCommit"></a>RevCommit</h4><p>RevCommit è¡¨ç¤º Git object model ä¸­çš„ä¸€ä¸ª commit</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> commit = walk.parseCommit(objectIdOfCommit);</span><br></pre></td></tr></table></figure>

<h4 id="RevTag"><a href="#RevTag" class="headerlink" title="RevTag"></a>RevTag</h4><p>RevCommit è¡¨ç¤º Git object model ä¸­çš„ä¸€ä¸ª Tag</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> tag = walk.parseCommit(objectIdOfTag);</span><br></pre></td></tr></table></figure>

<h4 id="RevTree"><a href="#RevTree" class="headerlink" title="RevTree"></a>RevTree</h4><p>RevCommit è¡¨ç¤º Git object model ä¸­çš„ä¸€ä¸ª tree</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> tree = walk.parseCommit(objectIdOfTree);</span><br></pre></td></tr></table></figure>

<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p>è™½ç„¶ JGit åŒ…å«äº†è®¸å¤šå’Œ Git ä»“åº“äº¤äº’çš„ä½çº§ä»£ç ï¼ŒåŒæ—¶è¿˜æœ‰ä¸€äº›å‚è€ƒ<code>org.eclipse.jgit.apit</code>åŒ…ä¸­ Git porcelain å‘½ä»¤çš„é«˜çº§ API.</p>
<h4 id="æ·»åŠ å‘½ä»¤-git-add"><a href="#æ·»åŠ å‘½ä»¤-git-add" class="headerlink" title="æ·»åŠ å‘½ä»¤(git-add)"></a>æ·»åŠ å‘½ä»¤(git-add)</h4><p>add å‘½ä»¤å¯ä»¥å‘ç´¢å¼•ä¸­æ·»åŠ æ–‡ä»¶ï¼ŒåŒæ—¶å¯ä»¥é€šè¿‡ setter æ–¹æ³•é…ç½®</p>
<ul>
<li>addFilepattern()</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> git = Git(repository)</span><br><span class="line">git.add()</span><br><span class="line">    .addFilepattern(<span class="string">"/dir"</span>)</span><br><span class="line">    .call()</span><br></pre></td></tr></table></figure>

<h4 id="æäº¤å‘½ä»¤-git-commit"><a href="#æäº¤å‘½ä»¤-git-commit" class="headerlink" title="æäº¤å‘½ä»¤(git-commit)"></a>æäº¤å‘½ä»¤(git-commit)</h4><ul>
<li>setAuthor()</li>
<li>setCommitter()</li>
<li>setAll()</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">git.commit()</span><br><span class="line">    .setAuthor(<span class="string">"author"</span>,<span class="string">"email"</span>)</span><br><span class="line">    .setMessage(<span class="string">"message"</span>)</span><br><span class="line">    .call()</span><br></pre></td></tr></table></figure>

<h4 id="tag-å‘½ä»¤-git-tag"><a href="#tag-å‘½ä»¤-git-tag" class="headerlink" title="tag å‘½ä»¤(git-tag)"></a>tag å‘½ä»¤(git-tag)</h4><ul>
<li>setName()</li>
<li>setMessage()</li>
<li>setTagger()</li>
<li>setObjectId()</li>
<li>setForceUpdate()</li>
<li>setSigned(): æš‚ä¸æ”¯æŒï¼Œä¼šæŠ›å¼‚å¸¸</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">git.tag()</span><br><span class="line">    .setName(<span class="string">"tag"</span>)</span><br><span class="line">    .call()</span><br></pre></td></tr></table></figure>

<h4 id="log-å‘½ä»¤-git-log"><a href="#log-å‘½ä»¤-git-log" class="headerlink" title="log å‘½ä»¤(git-log)"></a>log å‘½ä»¤(git-log)</h4><ul>
<li>add(AnyObjectId start)</li>
<li>addRange(AnyObjectId since,AnyObjectId until)</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">git.log()</span><br><span class="line">    .add(head)</span><br><span class="line">    .call()</span><br></pre></td></tr></table></figure>

<h4 id="merge-å‘½ä»¤-git-merge"><a href="#merge-å‘½ä»¤-git-merge" class="headerlink" title="merge å‘½ä»¤(git-merge)"></a>merge å‘½ä»¤(git-merge)</h4><p>TODO</p>
<h4 id="Ant-ä»»åŠ¡"><a href="#Ant-ä»»åŠ¡" class="headerlink" title="Ant ä»»åŠ¡"></a>Ant ä»»åŠ¡</h4><p>JGit åœ¨ <code>org.eclipse.jgit.ant</code> åŒ…ä¸­æä¾›äº† Ant ä»»åŠ¡åŠŸèƒ½.<br>æ·»åŠ ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">taskdef</span> <span class="attr">resource</span>=<span class="string">"org/eclipse/jgti/ant/ant-tasks.properties"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">classpath</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pathelement</span> <span class="attr">location</span>=<span class="string">"path/to/org.eclipse.jgit.ant-VERSION.jar"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pathelement</span> <span class="attr">location</span>=<span class="string">"path/to/org.eclipse.jgit-VERSION.jar"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pathelement</span> <span class="attr">location</span>=<span class="string">"path/to/jsch-0.1.44-1.jar"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">classpath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">taskdef</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æä¾›äº† <code>git-cloneã€git-initã€git-checkout</code>ä»»åŠ¡.</p>
<h4 id="git-clone"><a href="#git-clone" class="headerlink" title="git-clone"></a>git-clone</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">git-clone</span> <span class="attr">uri</span>=<span class="string">"http://egit.eclipse.org/jgit.git"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>uri(å¿…é¡»)</li>
<li>dest(å¯é€‰): å…‹éš†çš„ç›®æ ‡æ–‡ä»¶åœ°å€.é»˜è®¤ä½¿ç”¨åŸºäº uri è·¯å¾„æœ€åä¸€ä¸ªç»„ä»¶ä½œä¸ºå¯è¯†åˆ«çš„åç§°çš„æ–‡ä»¶å¤¹.</li>
<li>bare(å¯é€‰): true/false/yes/no è¡¨ç¤ºæ˜¯å¦å…‹éš† bare ä»“åº“. é»˜è®¤ false</li>
<li>branch(å¯é€‰): é»˜è®¤ HEAD</li>
</ul>
<h4 id="git-init"><a href="#git-init" class="headerlink" title="git-init"></a>git-init</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">git-init</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>dest(å¯é€‰): é»˜è®¤ $GIT_DIR æˆ–å½“å‰æ–‡ä»¶å¤¹</li>
<li>bare(å¯é€‰)</li>
</ul>
<h4 id="git-checkout"><a href="#git-checkout" class="headerlink" title="git-checkout"></a>git-checkout</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">git-checkout</span> <span class="attr">src</span>=<span class="string">"path/to/repo"</span> <span class="attr">branch</span>=<span class="string">"origin/experimental"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>src(å¿…é¡»)</li>
<li>branch(å¿…é¡»)</li>
<li>createbranch(å¯é€‰): true/false/yes/no æ˜¯å¦ä¼šåˆ›å»ºæ–° branchã€‚é»˜è®¤ false.</li>
<li>force(å¯é€‰): true/false/yes/no å¦‚æœ true/yes,å‘½åçš„ branch å·²å­˜åœ¨ï¼Œå·²å­˜åœ¨ branch çš„èµ·ç‚¹å°†ä¼šè¢«è®¾ç½®åˆ°æ–°çš„èµ·ç‚¹ã€‚å¦‚æœ false,å­˜åœ¨çš„ branch ä¸ä¼šè¢«æ”¹å˜.é»˜è®¤ false.</li>
</ul>
<h4 id="git-add"><a href="#git-add" class="headerlink" title="git-add"></a>git-add</h4><p>TODO</p>
<h3 id="ä»£ç ç‰‡æ®µ"><a href="#ä»£ç ç‰‡æ®µ" class="headerlink" title="ä»£ç ç‰‡æ®µ"></a>ä»£ç ç‰‡æ®µ</h3><h4 id="è·å–æŸä¸€æäº¤è®°å½•çš„å­è®°å½•"><a href="#è·å–æŸä¸€æäº¤è®°å½•çš„å­è®°å½•" class="headerlink" title="è·å–æŸä¸€æäº¤è®°å½•çš„å­è®°å½•"></a>è·å–æŸä¸€æäº¤è®°å½•çš„å­è®°å½•</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">PlotWalk revWalk = <span class="keyword">new</span> PlotWalk(repo());</span><br><span class="line">ObjectId rootId = (branch == <span class="keyword">null</span>) ? repo().resolve(HEAD) : branch.getObjectId();</span><br><span class="line">RevComment root = revWalk.parseCommit(rootId);</span><br><span class="line">revWalk.markStart(root);</span><br><span class="line">PlotCommitList&lt;PlotLane&gt; plotCommitList = <span class="keyword">new</span> PlotCommitList&lt;PlotLane&gt;();</span><br><span class="line">plotCOmmitList.source(revWalk);</span><br><span class="line">plotCommitList.fillTo(Integer.MAX_VALUE);</span><br><span class="line"><span class="keyword">return</span> revWalk;</span><br></pre></td></tr></table></figure>

<h3 id="é«˜çº§ä¸»é¢˜"><a href="#é«˜çº§ä¸»é¢˜" class="headerlink" title="é«˜çº§ä¸»é¢˜"></a>é«˜çº§ä¸»é¢˜</h3><h4 id="ä½¿ç”¨-RevWalk-å‡å°‘å†…å­˜ä½¿ç”¨"><a href="#ä½¿ç”¨-RevWalk-å‡å°‘å†…å­˜ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨ RevWalk å‡å°‘å†…å­˜ä½¿ç”¨"></a>ä½¿ç”¨ RevWalk å‡å°‘å†…å­˜ä½¿ç”¨</h4><p>revision walk æ¥å£å’Œ RevWalkï¼ŒRevCommit ç±»è½»é‡çº§è®¾è®¡ã€‚ç„¶è€Œå½“é¢å¯¹ç›¸å½“å¤§çš„ä»“åº“æ—¶å®ƒä»¬å¯èƒ½ä»ç„¶éœ€è¦å¾ˆå¤šå†…å­˜ã€‚æ¥ä¸‹æ¥æä¾›äº†ä¸€äº›æ–¹æ³•åœ¨éå†ä¿®è®¢å›¾(walking the revision graph)æ—¶å‡å°‘å†…å­˜ã€‚</p>
<h4 id="é™åˆ¶éå†ä¿®è®¢å›¾-Restrict-the-walked-revision-graph"><a href="#é™åˆ¶éå†ä¿®è®¢å›¾-Restrict-the-walked-revision-graph" class="headerlink" title="é™åˆ¶éå†ä¿®è®¢å›¾(Restrict the walked revision graph)"></a>é™åˆ¶éå†ä¿®è®¢å›¾(Restrict the walked revision graph)</h4><p>ä»…éå†é‚£äº›å¿…è¦çš„å›¾.å³å¦‚æœæŸ¥æ‰¾ refs/heads/master è€Œä¸æ˜¯ refs/remotes/origin/master çš„æäº¤è®°å½•,ç¡®ä¿å¯¹ refs/heads/master è°ƒç”¨ markStart(),å¯¹ refs/remotes/origin/master è°ƒç”¨ markUninteresting(). RevWalk traversal è®²åªè§£æå¯¹ä½ æœ‰ç”¨çš„æäº¤è®°å½•,è€Œä¸”ä¼šé¿å…åœ¨å†å²è®°å½•ä¸­æŸ¥è¯¢.è¿™è®²å‡å°‘å†…éƒ¨ object map çš„å¤§å°,å› æ­¤å‡å°‘æ•´ä½“å†…å­˜å ç”¨.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">RevWalk walk = <span class="keyword">new</span> RevWalk(repository);</span><br><span class="line">ObjectId from = repository.resolve(<span class="string">"refs/heads/master"</span>);</span><br><span class="line">ObjectId to = repository.resolve(<span class="string">"refs/remotes/origin/master"</span>);</span><br><span class="line"></span><br><span class="line">walk.markStart(walk.parseCommit(from));</span><br><span class="line">walk.markUnInteresting(walk.parseCommit(to));</span><br></pre></td></tr></table></figure>

<h4 id="ä¸¢å¼ƒæäº¤è®°å½•å†…å®¹"><a href="#ä¸¢å¼ƒæäº¤è®°å½•å†…å®¹" class="headerlink" title="ä¸¢å¼ƒæäº¤è®°å½•å†…å®¹"></a>ä¸¢å¼ƒæäº¤è®°å½•å†…å®¹</h4><p><code>setRetainBody(false)</code> å¯ä»¥ç”¨æ¥ä¸¢å¼ƒæäº¤è®°å½•å†…å®¹ï¼Œå¦‚æœä½ ä¸éœ€è¦ä½œè€…ï¼Œæäº¤è€…ï¼Œæˆ–ä¿¡æ¯ç­‰.ä¸éœ€è¦è¯¥æ•°æ®çš„ä¾‹å­å¦‚åªä½¿ç”¨ RevWalk å®Œæˆ branch merge æˆ–ä½¿ç”¨ git rev-list å®Œæˆç›¸å…³åŠŸèƒ½.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">RevWalk walk = <span class="keyword">new</span> RevWalk(repository);</span><br><span class="line">walk.setRetainBody(<span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>

<p>å¦‚æœç¡®å®éœ€è¦è¿™äº›ä¿¡æ¯ï¼Œå¯ä»¥è€ƒè™‘æ‹†åˆ†ä½ éœ€è¦çš„æ•°æ®ç„¶åå¯¹ RevCommit è°ƒç”¨ dispose().å¦‚æœéœ€è¦é•¿æ—¶é—´ä½¿ç”¨è¿™äº›ä¿¡æ¯,ä½ ä¼šå‘ç° JGit å†…éƒ¨ä½¿ç”¨çš„å†…å­˜æ¯”ä½ è‡ªå·±å¤„ç†å ç”¨çš„å†…å­˜è¦å°‘ï¼Œç‰¹åˆ«æ˜¯éœ€è¦å…¨éƒ¨çš„ä¿¡æ¯æ—¶ã€‚è¿™æ˜¯å› ä¸º JGit å†…éƒ¨ä½¿ç”¨ byte æ•°ç»„ä¿å­˜ UTF-8 ç¼–ç çš„ä¿¡æ¯.å¦‚æœä½¿ç”¨ UTF-16 ç¼–ç çš„ Java String å å†…å­˜å°†ä¼šå˜å¤§ï¼Œå‡è®¾å¤§éƒ¨åˆ†çš„æ¶ˆæ¯æ˜¯ US-ASCII ç¼–ç çš„.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">RevWalk walk = <span class="keyword">new</span> RevWalk(repository);</span><br><span class="line">Set&lt;String&gt; authorEmails = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line"><span class="keyword">for</span> (RevCommit commit : walk) &#123;</span><br><span class="line">    authorEmails.add(commit.getAuthorIdent().getEmailAddress());</span><br><span class="line">    commit.dispose();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="RevWalk-å’Œ-RevCommit-çš„å­ç±»"><a href="#RevWalk-å’Œ-RevCommit-çš„å­ç±»" class="headerlink" title="RevWalk å’Œ RevCommit çš„å­ç±»"></a>RevWalk å’Œ RevCommit çš„å­ç±»</h4><p>å¦‚æœéœ€è¦è·å–æŸä¸ªæäº¤è®°å½•çš„æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ RevWalk RevCommit çš„å­ç±», RevWalk.createCommit() æ„å»º RevCommit å­ç±»çš„å®ä¾‹ã€‚ç„¶åå°†æ›´å¤šçš„ä¿¡æ¯å­˜å…¥ RevCommit å­ç±»,è¿™æ ·å°±ä¸éœ€è¦é¢å¤–çš„ HashMap å°† RevCommit æˆ– ObjectId è½¬æ¢ä¸º è‡ªå®šä¹‰çš„æ•°æ®å±æ€§.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReviewedRevision</span> <span class="keyword">extends</span> <span class="title">RevCommit</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Date reviewDate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ReviewedRevision</span><span class="params">(AnyObjectId id,Date reviewDate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(id);</span><br><span class="line">        <span class="keyword">this</span>.reviewDate = reviewDate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getReviewedBy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getFooterLines(<span class="string">"Reviewed-by"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getReviewDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> reviewDate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Walk</span> <span class="keyword">extends</span> <span class="title">RevWalk</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Walk</span><span class="params">(Repository repo)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(repo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> RevCommit <span class="title">createCommit</span><span class="params">(AnyObjectId id)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ReviewedRevision(id,getReviewDate(id));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Date <span class="title">getReviewDate</span><span class="params">(AnyObjectId id)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="éå†ä¿®è®¢åæ¸…ç†"><a href="#éå†ä¿®è®¢åæ¸…ç†" class="headerlink" title="éå†ä¿®è®¢åæ¸…ç†"></a>éå†ä¿®è®¢åæ¸…ç†</h4><p>RevWalk æ— æ³•ç¼©å°å†…éƒ¨çš„ object map.å¦‚æœåˆšå®Œæˆäº†éå†ä»“åº“çš„æ‰€æœ‰å†å²ï¼Œè¿™å°†ä¼šå°†æ‰€æœ‰ä¸œè¥¿åŠ è½½åˆ° object mapï¼Œå¹¶ä¸”æ— æ³•è¢«é‡Šæ”¾.å¦‚æœå†ä¸éœ€è¦è¿™äº›æ•°æ®ï¼Œå¥½çš„ä¹ æƒ¯æ˜¯ä¸¢å¼ƒè¿™ä¸ª RevWalkï¼Œç„¶åä¸ºä¸‹æ¬¡éå†é‡æ–°ç”³è¯·æ–°çš„ RevWalkã€‚è¿™æ · GC å°±ä¼šå›æ”¶åƒåœ¾ã€‚å¦å¤–ï¼Œé‡ç”¨ä¸€ä¸ªå­˜åœ¨ çš„ object map æ¯”å®Œå…¨é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„æ›´å¿«.æ‰€ä»¥ä½ éœ€è¦å¹³è¡¡å†…å­˜å›æ”¶å’Œç”¨æˆ·æ¸´æœ›æ›´å¿«çš„æ“ä½œä¹‹é—´çš„å…³ç³».</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">RevWalk walk = <span class="keyword">new</span> RevWalk(repository);</span><br><span class="line"><span class="keyword">for</span> (RevCommit commit : walk) &#123;&#125;</span><br><span class="line">walk.repository();</span><br></pre></td></tr></table></figure>

<h3 id="åŠŸèƒ½åˆ—è¡¨"><a href="#åŠŸèƒ½åˆ—è¡¨" class="headerlink" title="åŠŸèƒ½åˆ—è¡¨"></a>åŠŸèƒ½åˆ—è¡¨</h3><ul>
<li>é€šç”¨ä»“åº“æ“ä½œ<ul>
<li><a href="">æ‰“å¼€å­˜åœ¨çš„ git ä»“åº“</a></li>
<li><a href="">åˆ›å»ºæ–°çš„ git ä»“åº“</a></li>
</ul>
</li>
<li>git å‘½ä»¤æ”¯æŒ<ul>
<li><a href="">åˆå§‹åŒ–æ–°çš„ä»“åº“</a></li>
<li><a href="">æ·»åŠ æ–°æ–‡ä»¶åˆ°ç´¢å¼•ä¸­</a></li>
<li><a href="">å‘å­˜åœ¨çš„ä»“åº“æäº¤æ–‡ä»¶</a></li>
<li><a href="">æäº¤æ‰€æœ‰æ›´æ”¹</a></li>
<li><a href="">åˆ—å‡ºæäº¤è®°å½•,å¦‚ Log</a></li>
<li><a href="">åˆ—å‡ºä»“åº“çš„æ‰€æœ‰æ ‡ç­¾</a></li>
<li><a href="">åˆ—å‡ºä»“åº“çš„æ‰€æœ‰åˆ†æ”¯</a></li>
<li><a href="">åˆ—å‡ºä»“åº“çš„æ‰€æœ‰æäº¤è®°å½•</a></li>
<li><a href="">åˆ—å‡ºä»“åº“æ‰€æœ‰æœªæäº¤çš„æ›´æ”¹</a></li>
<li><a href="">åˆ›å»º/åˆ é™¤åˆ†æ”¯</a></li>
<li><a href="">åˆ›å»º/åˆ é™¤æ ‡ç­¾</a></li>
<li><a href="">å›é€€è¢«ä¿®æ”¹çš„è¿½è¸ªæ–‡ä»¶åˆ°æœ€è¿‘æäº¤è®°å½•ä¸­çš„åˆå§‹çŠ¶æ€</a></li>
<li><a href="">è¿”å›ä¸¤ä¸ªåˆ†æ”¯çš„ diff</a></li>
<li><a href="">æ˜¾ç¤ºä¸¤ä¸ª revs ä¸­åŒä¸€ä¸ªæ–‡ä»¶çš„æ”¹å˜ diff</a></li>
<li><a href="">æ˜¾ç¤ºä¸¤ä¸ªæäº¤è®°å½•ä¸­æ‰€æœ‰æ–‡ä»¶çš„æ”¹å˜ diff</a></li>
<li><a href="">æ˜¾ç¤ºä¸¤ä¸ªæäº¤è®°å½•ä¸­åŒä¸€ä¸ªæ–‡ä»¶çš„æ”¹å˜ diff,å½“æ–‡ä»¶è¢«é‡å‘½åå</a></li>
<li><a href="">æ˜¾ç¤ºçŠ¶æ€</a></li>
<li><a href="">æŠŠåˆ†æ”¯ä¸­çš„å†…å®¹å­˜å‚¨åˆ°ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ä¸­</a></li>
<li><a href="">ä½¿ç”¨è‡ªå®šä¹‰çš„æ‰“åŒ…æ ¼å¼å°†åˆ†æ”¯ä¸­çš„å†…å®¹å†™å…¥åˆ°ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ä¸­</a></li>
<li><a href="">Blame,ä¾‹å¦‚æŸ¥æ‰¾é‚£ä¸ªæäº¤è®°å½•æ”¹å˜äº†æŸä¸ªæ–‡ä»¶çš„ç‰¹å®šè¡Œ</a></li>
<li><a href="">æ·»åŠ /åˆ—å‡ºæäº¤è®°å½•é™„å¸¦çš„ç¬”è®°</a></li>
<li><a href="">åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„ç¬”è®°</a></li>
<li><a href="">æ¸…ç†æ‰€æœ‰æœªè¿½è¸ªçš„æ–‡ä»¶</a></li>
<li><a href="">åˆ›å»º/åˆ—å‡º/æäº¤/ä¸¢å¼ƒ stashes</a></li>
<li><a href="">è¿è¡Œåƒåœ¾å›æ”¶</a></li>
<li><a href="">Blame,å¦‚æŸ¥æ‰¾è°æœ€åä¿®æ”¹äº†æŸæ–‡ä»¶çš„ç‰¹å®šè¡Œ</a></li>
<li><a href="">åˆå¹¶æŸä¸€åˆ†æ”¯çš„ä¿®æ”¹</a></li>
<li><a href="">åˆ—å‡ºä¸¤ä¸ªæäº¤è®°å½•ä¿®æ”¹çš„æ‰€æœ‰æ–‡ä»¶</a></li>
</ul>
</li>
<li>ä¾›è¿œç¨‹ä»“åº“ä½¿ç”¨çš„å‘½ä»¤<ul>
<li><a href="">å¤åˆ¶è¿œç¨‹ä»“åº“åˆ°æœ¬åœ°çš„æ–°æ–‡ä»¶å¤¹ä¸­</a></li>
<li><a href="">åœ¨ä¸€ä¸ªä»“åº“ä¸­è¿­ä»£è¿œç¨‹å¼•ç”¨</a></li>
<li><a href="">ä¸å…‹éš†åˆ—å‡ºè¿œç¨‹ä»“åº“çš„æ‰€æœ‰ heads/tags</a></li>
<li><a href="">fetch from remote repository</a></li>
<li><a href="">fetch from remote repository ä¸”ä½¿ç”¨ <code>prune</code> ç§»é™¤è¿‡æœŸçš„è¿œç¨‹ branches/tags</a></li>
<li><a href="">ä½¿ç”¨ SSH åè®®/ç”¨æˆ·åå¯†ç éªŒè¯å…‹éš†è¿œç¨‹ä»“åº“</a></li>
<li><a href="">å¯¹ä¸€ä¸ª upstream åˆ†æ”¯æ‰§è¡Œ Rebase</a></li>
<li><a href="">ä½¿ç”¨ InMemoryRepository åœ¨å†…å­˜ä¸­å…‹éš†ä¸€ä¸ªä»“åº“ï¼Œå¹¶ä¸”åœ¨å†…å­˜ä¸­å®Œæˆæ“ä½œ</a></li>
</ul>
</li>
<li>åº•å±‚ API<ul>
<li><a href="">ä»ä¸€ä¸ªå‘½å ref (refs/heads/master) ä¸­è·å– SHA-1</a></li>
<li><a href="">ä»ä¸€ä¸ªåç§°æˆ– SHA-1 è·å–æäº¤è®°å½•å¯¹è±¡</a></li>
<li><a href="">è·å–æäº¤ä¿¡æ¯</a></li>
<li><a href="">ä»æäº¤è®°å½•å¯¹è±¡ï¼Œåç§°ï¼ŒSHA-1 è·å– tree å¯¹è±¡</a></li>
<li><a href="">è¯»å– file/blob çš„å†…å®¹</a></li>
<li><a href="">ä»åç§°ï¼ŒSHA-1 è·å– tag å¯¹è±¡</a></li>
<li><a href="">è§£æå¤æ‚çš„å¼•ç”¨(å¦‚ HEAD^^)ä¸º SHA-1</a></li>
<li><a href="">è¿­ä»£ä¸€ä¸ªåˆ†æ”¯çš„æ‰€æœ‰æäº¤è®°å½•</a></li>
<li><a href="">è¿­ä»£æŸä¸ªèŒƒå›´å†…çš„æäº¤è®°å½•</a></li>
<li><a href="">ä»ç‰¹å®šçš„æäº¤è®°å½•ä¸­è¯»å–ç‰¹å®šæ–‡ä»¶çš„å†…å®¹</a></li>
<li><a href="">åˆ—å‡ºå½“å‰ä»“åº“çš„è¿œç¨‹é…ç½®</a></li>
<li><a href="">ä» Git ä¸­æ‰“å°å‡ºç”¨æˆ·çš„ä¿¡æ¯</a></li>
<li><a href="">è¯»å–æ–‡ä»¶å±æ€§ï¼Œå¦‚å¯æ‰§è¡ŒçŠ¶æ€ï¼Œæ˜¯æ–‡ä»¶è¿˜æ˜¯æ–‡ä»¶å¤¹ï¼Œå¤§å°ç­‰</a></li>
<li><a href="">ä½¿ç”¨ BranchTrackingStatus ç±»è·å–å½“å‰åˆ†æ”¯ç›¸å¯¹äºè¿œç¨‹åˆ†æ”¯è¶…å‰/è½åçš„æäº¤è®°å½•</a></li>
<li><a href="">æ£€æŸ¥å…¶ä»–åˆ†æ”¯çš„æŸä¸ªæäº¤æ˜¯å¦è¢«åˆå¹¶åˆ°äº†ç»™å‡ºçš„åˆ†æ”¯</a></li>
<li><a href="">åˆ—å‡ºä½œä¸ºæŸä¸ªç‰¹å®šæäº¤è®°å½•æˆ–æ ‡ç­¾çš„æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰æ–‡ä»¶</a></li>
<li><a href="">å¾ªç¯è¿­ä»£æŸä¸ªæäº¤çš„æ–‡ä»¶</a></li>
<li><a href="">éå¾ªç¯è¿­ä»£æŸä¸ªæäº¤çš„æ–‡ä»¶</a></li>
<li><a href="">æŸ¥æ‰¾æ‰€æœ‰å¯ä»¥é€šè¿‡ tags,branches,remotes,HEADsâ€¦ç­‰å¯è®¿é—®çš„æäº¤è®°å½•</a></li>
</ul>
</li>
<li>ç¼ºå¤±çš„ä»£ç ç‰‡æ®µ<ul>
<li><a href="https://gerrit.googlesource.com/plugins/branch-network/+log/refs/heads/master/src/main/java/com/googlesource/gerrit/plugins/branchnetwork/data/JGitFacade.java" target="_blank" rel="noopener">è¿­ä»£ä»“åº“çš„æ‰€æœ‰æäº¤</a></li>
<li><a href="https://github.com/eclipse/jgit/tree/master/org.eclipse.jgit.test/tst/org/eclipse/jgit/api" target="_blank" rel="noopener">å•å…ƒæµ‹è¯•</a></li>
<li><a href="http://www.codeaffine.com/2014/04/16/how-to-manage-git-submodules-with-jgit/" target="_blank" rel="noopener">å­æ¨¡å—</a>(<a href="http://stackoverflow.com/questions/13426798/jgit-read-gitmodules" target="_blank" rel="noopener">http://stackoverflow.com/questions/13426798/jgit-read-gitmodules</a>)</li>
<li><a href="http://stackoverflow.com/questions/12987364/how-to-diff-with-two-files-by-jgit-without-creating-repo" target="_blank" rel="noopener">diffing</a></li>
<li><a href="http://stackoverflow.com/questions/4772142/jgit-unstaging-files-removing-files-from-the-index-and-ammending-a-commit" target="_blank" rel="noopener">ä¿®æ”¹ä¹‹å‰çš„æäº¤</a></li>
<li><a href="http://stackoverflow.com/questions/4803462/jgit-java-git-library-unstaging-files" target="_blank" rel="noopener">ä»ç´¢å¼•ä¸­ç§»é™¤ä¸€ä¸ªæ–‡ä»¶</a></li>
<li><a href="http://www.fancybeans.com/blog/2012/08/24/how-to-use-s3-as-a-private-git-repository/" target="_blank" rel="noopener">Amazon S3 ä¸Šçš„ git ä»“åº“</a></li>
<li><a href="http://stackoverflow.com/questions/18300898/how-to-cherry-pick-a-commit-that-has-more-than-one-parent" target="_blank" rel="noopener">cherrypick</a></li>
<li><a href="http://www.lordofthejars.com/2016/09/authenticating-with-jgit.html" target="_blank" rel="noopener">æ›´å¤šæˆæƒ</a></li>
</ul>
</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>ObjectBoxå…¥é—¨-11-Data Browser</title>
    <url>/2019/02/26/ObjectBox%E5%85%A5%E9%97%A8-11-Data-Browser/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<p>Data Browser å…·æœ‰å¦‚ä¸‹åŠŸèƒ½:</p>
<ul>
<li>æŸ¥çœ‹æ•°æ®åº“çš„ entities å’Œ schema</li>
<li>ä¸‹è½½ JSON æ ¼å¼çš„ entities</li>
</ul>
<h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    debugImplementation <span class="string">"io.objectbox:objectbox-android-objectbrowser:$objectboxVersion"</span></span><br><span class="line">    releaseImplementation <span class="string">"io.objectbox:objectbox-android:$objectboxVersion"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// apply the plugin after the dependencies block</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'io.objectbox'</span></span><br></pre></td></tr></table></figure>

<p>ä¸è¿™æ ·è®¾ç½®å¯èƒ½å‡ºç° <code>Duplicate files copied in APK lib/armeabi-v7a/libobjectbox.so</code> è¿™æ ·çš„é”™è¯¯.å› ä¸º ObjectBox æ’ä»¶åˆæ·»åŠ äº†ä¸€æ¬¡ objectbox-android åº“</p>
<p>åœ¨ AndroidManifest.xml æ·»åŠ å¦‚ä¸‹æƒé™(2.2.0 åéœ€è¦)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;!-- Required to provide the web <span class="class"><span class="keyword">interface</span> --&gt;</span></span><br><span class="line">&lt;uses-permission android:name="android.permission.INTERNET" /&gt;</span><br><span class="line">&lt;!-- Required to run keep-alive service when targeting API <span class="number">28</span> or higher --&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">"android.permission.FOREGROUND_SERVICE"</span>/&gt;</span><br></pre></td></tr></table></figure>

<p>å»ºè®®åœ¨ Application ç±»ä¸­æ·»åŠ </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">boxStore = MyObjectBox.builder().androidContext(<span class="keyword">this</span>).build();</span><br><span class="line"><span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">    <span class="keyword">boolean</span> started = <span class="keyword">new</span> AndroidObjectBrowser(boxStore).start(<span class="keyword">this</span>);</span><br><span class="line">    Log.i(<span class="string">"ObjectBrowser"</span>, <span class="string">"Started: "</span> + started);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>Kotlin/Native</title>
    <url>/2020/02/14/Kotlin-Native/</url>
    <content><![CDATA[<a id="more"></a>]]></content>
  </entry>
  <entry>
    <title>ObjectBoxå…¥é—¨-10-å…³è”</title>
    <url>/2019/02/25/ObjectBox%E5%85%A5%E9%97%A8-10-%E5%85%B3%E8%81%94/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<p>Object ä¹‹é—´çš„å…³è”å…·æœ‰æ–¹å‘æ€§.å…³è”æ˜¯å»¶è¿Ÿåˆå§‹åŒ–çš„ï¼šå®é™…çš„å¼•ç”¨å¯¹è±¡åªæœ‰åœ¨è°ƒç”¨æ—¶æ‰ä¼šä»æ•°æ®åº“ä¸­åŠ è½½ã€‚ä¸€æ—¦åŠ è½½è¿‡ï¼Œå°±ä¼šç¼“å­˜èµ·æ¥.</p>
<h3 id="To-One-å…³è”"><a href="#To-One-å…³è”" class="headerlink" title="To-One å…³è”"></a>To-One å…³è”</h3><p><img src="http://qiniu.picbed.dang8080.cn/20190225232506.png" alt="To-Oneç¤ºæ„å›¾"><br>ä½¿ç”¨ ToOne ä¼šæ™ºèƒ½çš„å¯¹ç›®æ ‡å¯¹è±¡åˆ›å»ºå…³è”ã€‚åŒæ—¶è·å–ç›®æ ‡å¯¹è±¡ç¼“å­˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Customer.java</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">public</span> <span class="keyword">long</span> id;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Order.java</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">public</span> <span class="keyword">long</span> id;</span><br><span class="line">    <span class="keyword">public</span> ToOne&lt;Customer&gt; customer;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä¸ºäº†ç»‘å®š customer å¯¹è±¡ï¼Œå¯¹ ToOne å®ä¾‹è°ƒç”¨ setTarget() ç„¶åå°±å­˜å…¥ order å¯¹è±¡</span></span><br><span class="line">Customer customer = <span class="keyword">new</span> Customer();</span><br><span class="line">Order order = <span class="keyword">new</span> Order();</span><br><span class="line">order.customer.setTarget(customer);</span><br><span class="line"><span class="keyword">long</span> orderId = boxStore.boxFor(Order.class).put(order);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¦‚æœ customer åœ¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨ï¼ŒToOne å°†ä¼šå­˜å‚¨ã€‚å¦‚æœå·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆ ToOne åªä¼šåˆ›å»ºå…³è”,ä¸ä¼šå­˜å‚¨.<br>å¦‚æœå…³è” Entity ä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰ IDs(@Id(assignable = true)),åˆ™è¯¥ Entity ä¸ä¼šè¢«å­˜å‚¨.</p>
</blockquote>
<p>åœ¨ ToOne å®ä¾‹ä¸­ï¼Œå¯é€šè¿‡ Order å¯¹è±¡çš„ getTarget() è·å– customer</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Order order = boxStore.boxFor(Order.class).get(orderId);</span><br><span class="line">Customer customer = order.customer.getTarget(customer);</span><br></pre></td></tr></table></figure>

<p>å¦‚æœåªæ˜¯æƒ³è¦è·å– ID è€Œä¸æ˜¯æ•´ä¸ªç›®æ ‡å¯¹è±¡ï¼ŒgetTargetId() å€¼å¾—æ‹¥æœ‰ï¼Œæ­¤æ–¹æ³•æ ¹æœ¬ä¸ä¼šæ¥è§¦æ•°æ®åº“ï¼Œæ‰€ä»¥é«˜æ•ˆã€‚</p>
<p>ç§»é™¤å…³è”: ä»…ç§»é™¤å…³è”å…³ç³»ï¼Œè€Œä¸ä¼šä»æ•°æ®åº“ä¸­ç§»é™¤ç›®æ ‡å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">order.customer.setTarget(<span class="keyword">null</span>);</span><br><span class="line">boxStore.boxFor(Order.class).put(order);</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹ <code>objectbox-models/default.json</code> ä¼šå‘ç°ï¼ŒToOne å±æ€§æ ¹æœ¬æ²¡æœ‰ä¿å­˜ã€‚ä»…ä»…åªæ˜¯ç›®æ ‡å¯¹è±¡çš„ ID ä¿å­˜åœ¨ä¸€ä¸ªåç§°å’Œ ToOne å±æ€§åæ‹¼æ¥ Id çš„è™šæ‹Ÿå±æ€§.</p>
<h3 id="åˆå§‹åŒ–é­”æœ¯"><a href="#åˆå§‹åŒ–é­”æœ¯" class="headerlink" title="åˆå§‹åŒ–é­”æœ¯"></a>åˆå§‹åŒ–é­”æœ¯</h3><p>æ³¨æ„åˆ° ToOne å±æ€§ customer ä»æ²¡åˆå§‹åŒ–ï¼Œç„¶è€Œè°ƒç”¨æ—¶å´ä¸ä¼šæŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚å› ä¸ºè¯¥åˆå§‹åŒ–å·²ç»æ‰§è¡Œè¿‡äº†ã€‚<br>ObjectBox æ’ä»¶ä¼šå¯¹ entity ç±»(ä»…æ”¯æŒçº¯ Java é¡¹ç›®å’Œ Android é¡¹ç›®) åœ¨è°ƒç”¨å‰æ­£ç¡®çš„åˆå§‹åŒ–ã€‚æ‰€ä»¥åœ¨è‡ªå®šä¹‰æ„é€ æ–¹æ³•æ—¶ï¼Œä½ å¯ä»¥å‡è®¾ ToOne/ToMany/List å±æ€§å·²ç»åˆå§‹åŒ–è¿‡äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    ToOne&lt;Order&gt; order;</span><br><span class="line">    ToMany&lt;Order&gt; orders;</span><br><span class="line">    <span class="keyword">transient</span> BoxStore __boxStore;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Example</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">this</span>.order = <span class="keyword">new</span> ToOne&lt;&gt;(<span class="keyword">this</span>, Example_.order);</span><br><span class="line">        <span class="keyword">this</span>.orders = <span class="keyword">new</span> ToMany&lt;&gt;(<span class="keyword">this</span>, Example_.orders);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Example</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æå‡æ€§èƒ½"><a href="#æå‡æ€§èƒ½" class="headerlink" title="æå‡æ€§èƒ½"></a>æå‡æ€§èƒ½</h3><p>ä¸ºäº†æé«˜æ€§èƒ½ï¼Œè¯·æä¾›å…¨å‚æ•°æ„é€ æ–¹æ³•ã€‚<br>å¯¹äº ToOne å±æ€§ï¼Œè¯·æ·»åŠ ä¸€ä¸ªåä¸º ToOne å±æ€§ååŠ  Id çš„ id å‚æ•°ã€‚å¯ä»¥å‚è€ƒ objectbox-models/default.json é‡Œçš„å‘½å.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">public</span> <span class="keyword">long</span> id;</span><br><span class="line">    <span class="keyword">public</span> ToOne&lt;Customer&gt; customer;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Order</span><span class="params">()</span> </span>&#123; <span class="comment">/* default constructor */</span> &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Order</span><span class="params">(<span class="keyword">long</span> id, <span class="keyword">long</span> customerId <span class="comment">/* virtual ToOne id property */</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.customer.setTargetId(customerId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ToMany-å…³è”"><a href="#ToMany-å…³è”" class="headerlink" title="ToMany å…³è”"></a>ToMany å…³è”</h3><p>å¯ä»¥ä½¿ç”¨ List æˆ– ToMany ç±»å‹å®ç° ToMany å…³è”.ç›¸å¯¹ ToOne æ¥è¯´ï¼ŒToMany å¯ä»¥å®ç°è¿½è¸ªæ•°æ®å˜åŒ–å¹¶å°†å…¶å†™å…¥æ“ä½œä¸­ï¼Œè€Œ List å¿…é¡»è‡ªå·±å®ç°.</p>
<h3 id="1-N"><a href="#1-N" class="headerlink" title="1:N"></a>1:N</h3><p><img src="http://qiniu.picbed.dang8080.cn/20190226000315.png" alt="1:N"></p>
<p>ä½¿ç”¨ @Backlink æ³¨è§£ 1:N å…³è”å±æ€§ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Customer.java</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">public</span> <span class="keyword">long</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 'to' is optional if only one relation matches</span></span><br><span class="line">    <span class="meta">@Backlink</span>(to = <span class="string">"customer"</span>)</span><br><span class="line">    <span class="keyword">public</span> ToMany&lt;Order&gt; orders;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Order.java</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">public</span> <span class="keyword">long</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ToOne&lt;Customer&gt; customer;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Customer customer = <span class="keyword">new</span> Customer();</span><br><span class="line">customer.orders.add(<span class="keyword">new</span> Order());</span><br><span class="line">customer.orders.add(<span class="keyword">new</span> Order());</span><br><span class="line"><span class="keyword">long</span> customerId = boxStore.boxFor(Customer.class).put(customer); <span class="comment">// puts customer and orders</span></span><br><span class="line"></span><br><span class="line">Customer customer = boxStore.boxFor(Customer.class).get(customerId);</span><br><span class="line"><span class="keyword">for</span> (Order order : customer.orders) &#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Order order = customer.orders.remove(<span class="number">0</span>);</span><br><span class="line">boxStore.boxFor(Customer.class).put(customer);</span><br><span class="line"><span class="comment">// optional: also remove the order from its box</span></span><br><span class="line"><span class="comment">// boxStore.boxFor(Order.class).remove(order);</span></span><br></pre></td></tr></table></figure>

<h3 id="N-N"><a href="#N-N" class="headerlink" title="N:N"></a>N:N</h3><p><img src="http://qiniu.picbed.dang8080.cn/20190226000708.png" alt="N:N"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Teacher.java</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Teacher</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">public</span> <span class="keyword">long</span> id;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Student.java</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">public</span> <span class="keyword">long</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ToMany&lt;Teacher&gt; teachers;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Teacher teacher1 = <span class="keyword">new</span> Teacher();</span><br><span class="line">Teacher teacher2 = <span class="keyword">new</span> Teacher();</span><br><span class="line"></span><br><span class="line">Student student1 = <span class="keyword">new</span> Student();</span><br><span class="line">student1.teachers.add(teacher1);</span><br><span class="line">student1.teachers.add(teacher2);</span><br><span class="line"></span><br><span class="line">Student student2 = <span class="keyword">new</span> Student();</span><br><span class="line">student2.teachers.add(teacher2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// puts students and teachers</span></span><br><span class="line">boxStore.boxFor(Student.class).put(student1, student2);</span><br><span class="line"></span><br><span class="line">Student student1 = boxStore.boxFor(Student.class).get(student1.id);</span><br><span class="line"><span class="keyword">for</span> (Teacher teacher : student1.teachers) &#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">student1.teachers.remove(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// boxStore.boxFor(Student.class).put(student1);</span></span><br><span class="line"><span class="comment">// more efficient than using put:</span></span><br><span class="line">student1.teachers.applyChangesToDb();</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢å¯ä»¥é€šè¿‡ student çŸ¥é“ teacher çš„ä¿¡æ¯ï¼Œå½“ç„¶å¯ä»¥åè¿‡æ¥</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Teacher.java</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Teacher</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">public</span> <span class="keyword">long</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Backlink</span>(to = <span class="string">"teachers"</span>) <span class="comment">// backed by the to-many relation in Student</span></span><br><span class="line">    <span class="keyword">public</span> ToMany&lt;Student&gt; students;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Student.java</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">public</span> <span class="keyword">long</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ToMany&lt;Teacher&gt; teachers;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ›´æ–°å…³è”"><a href="#æ›´æ–°å…³è”" class="headerlink" title="æ›´æ–°å…³è”"></a>æ›´æ–°å…³è”</h3><p>ToOne å’Œ ToMany å¯ä»¥è¿½è¸ªå˜åŒ–ï¼ˆåªè¦å­˜å…¥æ‹¥æœ‰å…³è”å±æ€§çš„ entityï¼‰å¹¶å°†å…¶å­˜å…¥æ•°æ®åº“ä¸­ï¼Œ<br>å¦‚æœ ID != 0 æˆ–è€… @Id(assignable = true) é‚£ä¹ˆå¯ä»¥é€šè¿‡ Box æ¥æ›´æ–°å…³è”</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// update a related entity using its box</span></span><br><span class="line">Order orderToUpdate = customer.orders.get(<span class="number">0</span>);</span><br><span class="line">orderToUpdate.text = <span class="string">"Revised description"</span>;</span><br><span class="line"><span class="comment">// DOES NOT WORK</span></span><br><span class="line"><span class="comment">// boxStore.boxFor(Customer.class).put(customer);</span></span><br><span class="line"><span class="comment">// WORKS</span></span><br><span class="line">boxStore.boxFor(Order.class).put(orderToUpdate);</span><br></pre></td></tr></table></figure>

<h4 id="æ›´æ–°-ToOne"><a href="#æ›´æ–°-ToOne" class="headerlink" title="æ›´æ–° ToOne"></a>æ›´æ–° ToOne</h4><p>ToOne ç±»æä¾›äº†å¦‚ä¸‹æ–¹æ³•æ›´æ–°å…³è”:</p>
<ul>
<li><code>setTarget(entity)</code>: åˆ›å»ºå…³è”ï¼›ä¼ å…¥ null æ¸…é™¤å…³è”</li>
<li><code>setTargetId(entityId)</code>: å¯¹å­˜åœ¨çš„ç›®æ ‡ entity åˆ›å»ºå…³è”ï¼›ä¼ å…¥ 0 æ¸…é™¤å…³è”.</li>
<li><code>setAndPutTarget(entity)</code>:</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">order.customer.setTarget(customer); <span class="comment">// or order.customer.setCustomerId(customer.getId());</span></span><br><span class="line">orderBox.put(order);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¦‚æœ entity åœ¨è°ƒç”¨ setAndPutTarget() ä¹‹å‰è¿˜æ²¡å­˜å‚¨,é‚£ä¹ˆéœ€è¦å…ˆç»‘å®šå®ƒçš„ box</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Order order = <span class="keyword">new</span> Order(); <span class="comment">// new entity</span></span><br><span class="line">orderBox.attach(order); <span class="comment">// need to attach box first</span></span><br><span class="line">order.customer.setAndPutTarget(customer);</span><br></pre></td></tr></table></figure>

<p>å¦‚æœç›®æ ‡ entity ä½¿ç”¨è‡ªå®šä¹‰ IDs,å¿…é¡»åœ¨æ›´æ–° ToOne å…³è”æ—¶å­˜å‚¨å®ƒ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">customer.id = <span class="number">12</span>; <span class="comment">// self-assigned id</span></span><br><span class="line">customerBox.put(customer); <span class="comment">// need to put customer first</span></span><br><span class="line">order.customer.setTarget(customer); <span class="comment">// or order.customer.setCustomerId(customer.getId());</span></span><br><span class="line">orderBox.put(order);</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯å› ä¸º ObjectBox åªä¿å­˜ id ä¸º 0 çš„å…³è”å¯¹è±¡.</p>
<h4 id="æ›´æ–°-ToMany"><a href="#æ›´æ–°-ToMany" class="headerlink" title="æ›´æ–° ToMany"></a>æ›´æ–° ToMany</h4><p>ToMany å®ç°äº† java.lang.List æ¥å£ã€‚å¦‚æœå‘ ToMany å®ä¾‹æ·»åŠ å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡å°±ä¼šè¢«å­˜å‚¨è¿›æ•°æ®åº“ã€‚ç§»é™¤ä¹Ÿä¸€æ ·ã€‚ï¼ˆä»…ä»…æ˜¯å…³è”è¢«ç§»é™¤è€Œå·²ï¼‰.ä¸è¦å¿˜è®°æŠŠè¿½è¸ª ToMany æ”¹å˜çš„ own entity å¯¹è±¡å­˜å‚¨.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">customer.orders.add(order1);</span><br><span class="line">customer.orders.remove(order2);</span><br><span class="line">customerBox.put(customer);</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½¿ç”¨è‡ªå®šä¹‰ IDs(@Id(assignable = true)) è¯·åœ¨ä¿®æ”¹ ToMany å‰ç»‘å®šå®ƒçš„ box</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">customer.id = <span class="number">12</span>; <span class="comment">// self-assigned id</span></span><br><span class="line">customerBox.attach(customer); <span class="comment">// need to attach box first</span></span><br><span class="line">customer.orders.add(order);</span><br><span class="line">customerBox.put(customer);</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ entity æ˜¯è‡ªå®šä¹‰ IDs,é‚£ä¹ˆéœ€è¦å…ˆå­˜å…¥è¯¥ entity,ç„¶åå†æ›´æ–°å…³è”å¹¶å­˜å‚¨ own entity.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">order.id = <span class="number">42</span>; <span class="comment">// self-assigned id</span></span><br><span class="line">orderBox.put(order); <span class="comment">// need to put order first</span></span><br><span class="line">customer.orders.add(order);</span><br><span class="line">customerBox.put(customer); <span class="comment">// put customer, add relation to order</span></span><br></pre></td></tr></table></figure>

<h3 id="æ ‘å½¢å…³è”"><a href="#æ ‘å½¢å…³è”" class="headerlink" title="æ ‘å½¢å…³è”"></a>æ ‘å½¢å…³è”</h3><p>å¯ä»¥ä½¿ç”¨ ToOne,ToMany å¤„ç†æŒ‡å‘è‡ªèº«çš„æ ‘å½¢å…³è”</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">long</span> id;</span><br><span class="line"></span><br><span class="line">    ToOne&lt;TreeNode&gt; parent;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BackLink</span></span><br><span class="line">    ToMany&lt;TreeNode&gt; children;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”Ÿæˆçš„ entity å¯ä»¥è·å–å®ƒçš„ parent å’Œ children</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">TreeNode parent = entity.parent.getTarget();</span><br><span class="line">List&lt;TreeNode&gt; children = entity.children;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>ObjectBoxå…¥é—¨-3-æ³¨è§£</title>
    <url>/2019/02/24/ObjectBox%E5%85%A5%E9%97%A8-3-%E6%B3%A8%E8%A7%A3/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<h2 id="Entity-æ³¨è§£"><a href="#Entity-æ³¨è§£" class="headerlink" title="Entity æ³¨è§£"></a>Entity æ³¨è§£</h2><h3 id="entity-æ•°æ®å¯è®¿é—®"><a href="#entity-æ•°æ®å¯è®¿é—®" class="headerlink" title="entity æ•°æ®å¯è®¿é—®"></a>entity æ•°æ®å¯è®¿é—®</h3><ul>
<li>ObjectBox éœ€è¦è®¿é—® entity çš„å±æ€§(ç”Ÿæˆ Cursor ç±»).<ul>
<li>å±æ€§åŒ…å†…å¯è§ã€‚kotlin ä¸­ä½¿ç”¨ <code>JvmField</code></li>
<li>æä¾›æ ‡å‡† <code>getters</code></li>
</ul>
</li>
<li>ä¸ºäº†æå‡æ€§èƒ½ï¼Œè¯·æä¾›å…·æœ‰å…¨éƒ¨å±æ€§çš„æ„é€ æ–¹æ³•</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">private</span> <span class="keyword">long</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Transient</span> <span class="keyword">private</span> <span class="keyword">int</span> tempUsageCount;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span></span>&#123;<span class="comment">/* é»˜è®¤æ„é€ æ–¹æ³• */</span>&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(id,name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// getters and setters for properties...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="entity-å±æ€§çš„æ³¨è§£"><a href="#entity-å±æ€§çš„æ³¨è§£" class="headerlink" title="entity å±æ€§çš„æ³¨è§£"></a>entity å±æ€§çš„æ³¨è§£</h3><ul>
<li><code>@NameInDb</code> å¯ä»¥åœ¨æ•°æ®åº“ä¸­ä¸ºå±æ€§å‘½åã€‚<ul>
<li>åº”è¯¥ä½¿ç”¨ <code>@Uid</code> æ³¨è§£æ¥ä»£æ›¿é‡å‘½åå±æ€§å’Œ entity</li>
<li><code>@NameInDb</code> ä»…æ”¯æŒå†…è”å¸¸é‡æ¥æŒ‡å®šåˆ—åã€‚</li>
</ul>
</li>
<li><code>@Transient</code> ä¿è¯å±æ€§ä¸è¢«æŒä¹…åŒ–ï¼Œtransientï¼Œstatic ä¿®é¥°ç¬¦ä¹Ÿä¸€æ ·.</li>
</ul>
<h3 id="å±æ€§ç´¢å¼•-Index"><a href="#å±æ€§ç´¢å¼•-Index" class="headerlink" title="å±æ€§ç´¢å¼• @Index"></a>å±æ€§ç´¢å¼• @Index</h3><ul>
<li><code>@Index</code> å½“å‰ä¸æ”¯æŒ <code>byte[] float double</code></li>
<li>Index typs(String).<ul>
<li>ObjectBox 2.0 å¼•å…¥äº† index types.ä¹‹å‰å¯¹æ¯ä¸€ä¸ªç´¢å¼•ï¼Œä½¿ç”¨å±æ€§çš„å€¼æ¥å®ŒæˆæŸ¥è¯¢ã€‚<br>ç°åœ¨ ObjectBox å¯ä»¥ä½¿ç”¨ hash æ¥ç”Ÿæˆ index.<br>ç”±äº String å±æ€§æ˜æ˜¾æ¯”æ ‡é‡å€¼æ›´å ç©ºé—´ï¼ŒObjectBox å¯¹ strings ä½¿ç”¨é»˜è®¤çš„ index type å®Œæˆ hash.<br>å¯ä»¥é’ˆå¯¹ String ç±»å‹çš„å±æ€§æ˜ç¡®æŒ‡å®š index type ä¸ºåŸºäºå€¼æ„å»ºç´¢å¼•ã€‚<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Index</span>( type = IndexType.VALUE)</span><br><span class="line"><span class="keyword">private</span> String name;</span><br></pre></td></tr></table></figure></li>
<li>è¯·æ³¨æ„ï¼šå¯¹äº String ç±»å‹çš„å±æ€§ï¼ŒåŸºäºå€¼çš„ç´¢å¼•å¯èƒ½æ¯”é»˜è®¤åŸºäº hash çš„ç´¢å¼•æ›´å ç©ºé—´,è¿™ç§ç»“è®ºå–å†³äºè¯¥å€¼çš„é•¿åº¦ã€‚</li>
<li>ObjectBox æ”¯æŒä»¥ä¸‹ç´¢å¼•å±æ€§:<ul>
<li>æœªæŒ‡å®šæˆ–é»˜è®¤: æ ¹æ®å±æ€§çš„ç±»å‹å†³å®š(HASH for String,VALUE for others)</li>
<li>VALUE: ä½¿ç”¨å±æ€§å€¼ç”Ÿæˆç´¢å¼•ã€‚ä¾‹å¦‚ String,å¯èƒ½æ›´å ç©ºé—´</li>
<li>HASH: ä½¿ç”¨å±æ€§å€¼çš„ 32 ä½ hash ç”Ÿæˆç´¢å¼•ã€‚å¶å°”å¯èƒ½å‘ç”Ÿ hash ç¢°æ’ï¼Œä½†å®é™…æ¦‚ç‡å¾ˆå°ã€‚é€šå¸¸æ¯” HASH64 æ›´ä½³ï¼Œå› ä¸ºå ç©ºé—´å°</li>
<li>HASH64: ä½¿ç”¨å±æ€§å€¼çš„é•¿ hash ç”Ÿæˆç´¢å¼•ã€‚æ¯” HASH å ç©ºé—´å¤§ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ä¸æ˜¯é¦–é€‰.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Unique-çº¦æŸ"><a href="#Unique-çº¦æŸ" class="headerlink" title="Unique çº¦æŸ"></a>Unique çº¦æŸ</h3><p>å¦‚æœ unique çº¦æŸçš„å±æ€§å€¼å†²çªï¼Œ<code>put()</code> æ“ä½œå°†è¢«ç»ˆæ­¢ä¸”æŠ›å‡º <code>UniqueViolationException</code> çš„å¼‚å¸¸.<br>Unique åŸºäº Index,æ‰€ä»¥å¯ä»¥åŒæ—¶ç»™å±æ€§æ·»åŠ  @Index æ³¨è§£ã€‚</p>
<h3 id="å…³ç³»"><a href="#å…³ç³»" class="headerlink" title="å…³ç³»"></a>å…³ç³»</h3>]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>ObjectBoxå…¥é—¨-1-ç®€ä»‹</title>
    <url>/2019/02/24/ObjectBox%E5%85%A5%E9%97%A8-1-%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<h2 id="å…³äº"><a href="#å…³äº" class="headerlink" title="å…³äº"></a>å…³äº</h2><p>ObjectBox å®šä½æ˜¯: é’ˆå¯¹ç§»åŠ¨ç«¯å’Œ IoT è¶…å¿«çš„ <code>(superfast edge database)</code> é¢å‘å¯¹è±¡çš„æ•°æ®åº“ .ä¸ºå°å‹è®¾å¤‡æä¾›äº†è¾¹ç¼˜è®¡ç®—èƒ½åŠ›ï¼Œä½¿å¾—æ•°æ®å¯ä»¥å¿«é€Ÿé«˜æ•ˆåœ°åœ¨æœ¬åœ°å­˜å‚¨ã€å¤„ç†ã€å®‰å…¨ç®¡ç†.ObjectBox å°äº <code>1MB</code>,æœ€é€‚åˆç§»åŠ¨ APPã€å°å‹ IoT è®¾å¤‡åŠè·¯ç”±ã€‚å¹¶ä¸” ObjectBox ä¹Ÿæ˜¯ç¬¬ä¸€ä¸ªåœ¨è¾¹ç¼˜è®¾å¤‡ä¸Šå…¼å®¹ ACID çš„é«˜æ€§èƒ½çš„ NoSQL æ•°æ®åº“.æ‰€æœ‰çš„äº§å“éƒ½æ˜¯åŸºäºå·¥ç¨‹å¸ˆæ€ç»´å¼€å‘çš„ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨æœ€å°‘çš„ä»£ç å»å®ç°æƒ³è¦çš„åŠŸèƒ½ã€‚</p>
<h3 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h3><ul>
<li>æ¯”åŒç±»ç«Ÿå“å¿« 10 å€ä»¥ä¸Šã€‚<a href="https://github.com/objectbox/objectbox-performance" target="_blank" rel="noopener">BenchMark</a></li>
<li>è·¨å¹³å°ã€‚æ”¯æŒ Linuxã€Windowsã€Mac/iOSã€Androidã€Raspberry Piã€ARM ç­‰åµŒå…¥å¼è®¾å¤‡å’Œå®¹å™¨ã€‚</li>
<li>å°äº 1MB,ç‰¹åˆ«é’ˆå¯¹å°å‹è®¾å¤‡è®¾è®¡å’Œä¼˜åŒ–ã€‚</li>
<li>æ˜“ä½¿ç”¨ã€‚</li>
<li>æ”¯æŒ reactive.</li>
<li>æ— ç¼ç»“åˆ greenDAO.(åŒä¸€å®¶å…¬å¸å‡ºå“)</li>
<li>æ›´å¥½åœ°æ”¯æŒå…³ç³»å‹æ•°æ®. æä¾›äº†æ”¹å˜è¿½è¸ª(change tracking)ï¼Œçº§è”æ·»åŠ (cascading puts)ï¼Œçµæ´»çš„åŠ è½½ç­–ç•¥(eager,lazy)</li>
<li>æ— éœ€æŒæ¡ SQL:ObjectBox è®¾è®¡ç®€å•ï¼Œä½¿ç”¨æ–¹ä¾¿ï¼Œä¸éœ€è¦æŒæ¡ SQL å³å¯ä¸Šæ‰‹.</li>
<li>æ”¯æŒ kotlin: åŒ…æ‹¬ data class.</li>
</ul>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><h3 id="Android-Java"><a href="#Android-Java" class="headerlink" title="Android(Java)"></a>Android(Java)</h3><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// root ç›®å½• build.gradle</span></span><br><span class="line">buildscript &#123;</span><br><span class="line">    ext.objectboxVersion = <span class="string">'2.3.3'</span></span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        <span class="comment">// Android Gradle plugin æœ€ä½ç‰ˆæœ¬ä¸º 3.0.0</span></span><br><span class="line">        classpath <span class="string">'com.android.tools.build:gradle:3.3.1'</span></span><br><span class="line">        classpath <span class="string">"io.objectbox:objectbox-gradle-plugin:$objectboxVersion"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app æˆ–å…¶ä»– module build.gradle</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.application'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'io.objectbox'</span> æ”¾åœ¨æœ€ä¸‹é¢</span><br></pre></td></tr></table></figure>

<h4 id="Android-Kotlin"><a href="#Android-Kotlin" class="headerlink" title="Android(Kotlin)"></a>Android(Kotlin)</h4><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app æˆ–å…¶ä»– module build.gradle</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.application'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'kotlin-android'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'kotlin-kapt'</span> å¦‚æœä½¿ç”¨ kotlin-android æ’ä»¶ï¼Œå¿…é¡»åŠ  kotlin -kapt æ’ä»¶</span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'io.objectbox'</span> æ”¾åœ¨æœ€ä¸‹é¢</span><br></pre></td></tr></table></figure>

<p>Sync gradle å³å¯è‡ªåŠ¨æ·»åŠ  ObjectBox ä¾èµ–.</p>
<h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>1ã€é¦–å…ˆæ·»åŠ  ObjectBox æ’ä»¶.<br>2ã€å¦‚æœ ObjectBox æ’ä»¶æ²¡æœ‰è‡ªåŠ¨æ·»åŠ ä¾èµ–åº“å’Œæ³¨è§£å¤„ç†å™¨ï¼Œè¯·æ‰‹åŠ¨æ·»åŠ ä¾èµ–ã€‚</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Android(Java)</span></span><br><span class="line"><span class="comment">// /app/build.gradle</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile <span class="string">"io.objectbox:objectbox-androoid:$objectboxVersion"</span></span><br><span class="line">    annotationProcessor <span class="string">"io.objectbox:objectbox-processor:$objectboxVersion"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Android(kotlin)</span></span><br><span class="line"><span class="comment">// /app/build.gradle</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile <span class="string">"io.objectbox:objectbox-android:$objectboxVersion"</span></span><br><span class="line">    kapt <span class="string">"io.objectbox:objectbox-processor:$objectboxVersioni"</span></span><br><span class="line">    <span class="comment">// é’ˆå¯¹ kotlin çš„æ‰©å±•å‡½æ•°(å¯é€‰)</span></span><br><span class="line">    compile <span class="string">"io.objectbox:objectbox-kotlin:$objectboxVersion"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3ã€æ”¹å˜ Model æ–‡ä»¶çš„è·¯å¾„</p>
<p>ObjectBox Model æ–‡ä»¶é»˜è®¤ä¿å­˜åœ¨ <code>module-name/objectbox-models/default.json</code>ã€‚</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Android(Java)</span></span><br><span class="line"><span class="comment">// /app/build.gradle</span></span><br><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        javaCompileOptions &#123;</span><br><span class="line">            annotationProcessorOptions &#123;</span><br><span class="line">                arguments = [<span class="string">"objectbox.modelPath"</span>:<span class="string">"$projectDir/schemas/objectbox.json"</span>.toString()]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Android(Kotlin)</span></span><br><span class="line"><span class="comment">// /app/build.gradle</span></span><br><span class="line">kapt &#123;</span><br><span class="line">    arguments &#123;</span><br><span class="line">        arg(<span class="string">"objectbox.modelPath"</span>:<span class="string">"$projectDir/schemas/objectbox.json"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4ã€æ”¹å˜ <code>MyObjectBox</code> çš„åŒ…å</p>
<p>MyObjectBox ç±»çš„åŒ…åé»˜è®¤å’Œ entitiy ç±»çš„åŒ…åæˆ–å…¶ä¸Šä¸€çº§æŠ¥åä¸€è‡´ã€‚</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Android(Java)</span></span><br><span class="line"><span class="comment">// /app/build.gradle</span></span><br><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        javaCompileOptions &#123;</span><br><span class="line">            annotationProcessorOptions &#123;</span><br><span class="line">                arguments = [<span class="string">"objectbox.myObjectBoxPackage"</span>:<span class="string">"com.example.custom"</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Android(Kotlin)</span></span><br><span class="line"><span class="comment">// /app/build.gradle</span></span><br><span class="line">kapt &#123;</span><br><span class="line">    arguments &#123;</span><br><span class="line">        arg(<span class="string">"objectbox.myObjectBoxPackage"</span>, <span class="string">"com.example.custom"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5ã€å¼€å¯ Debug æ¨¡å¼</p>
<p>åœ¨ /app/build.gradle ä¸­æ·»åŠ å¿…è¦çš„é€‰é¡¹åï¼Œè¿è¡Œ <code>./gradlew --info</code> å³å¯æŸ¥çœ‹ debug è¾“å‡º</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Android(Java)</span></span><br><span class="line"><span class="comment">// /app/build.gradle</span></span><br><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        javaCompileOptions &#123;</span><br><span class="line">            annotationProcessorOptions &#123;</span><br><span class="line">                arguments = [<span class="string">'objectbox.debug'</span> : <span class="string">'true'</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Android(Kotlin)</span></span><br><span class="line"><span class="comment">// /app/build.gradle</span></span><br><span class="line">kapt &#123;</span><br><span class="line">    arguments &#123;</span><br><span class="line">        arg(<span class="string">"objectbox.debug"</span>, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6ã€å¼€å¯ DaoCompat å…¼å®¹æ¨¡å¼</p>
<p>ä» greenDAO è¿ç§»è¿‡æ¥ï¼Œç”Ÿæˆå’Œ greenDAO ç›¸ä¼¼çš„ API,ä½¿ ObjectBox çœ‹èµ·æ¥å°±åƒ SQLite ä¸€æ ·ã€‚</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// /app[module]/build.gradle</span></span><br><span class="line">depdendencies &#123;</span><br><span class="line">    compile <span class="string">"org.greenrobot:objectbox-daocompat:1.10"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå¼€å¯ DaoCompat æ¨¡å¼</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Android(Java)</span></span><br><span class="line"><span class="comment">// /app[module]/build.gradle</span></span><br><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        javaCOmpileOptions &#123;</span><br><span class="line">            annotationProcessorOptions &#123;</span><br><span class="line">                arguments = [<span class="string">'objectbox.daoCompat'</span>:<span class="string">'true'</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Android(Kotlin)</span></span><br><span class="line"><span class="comment">// /app[module]/build.gradle</span></span><br><span class="line">kapt &#123;</span><br><span class="line">    arguments &#123;</span><br><span class="line">        arg(<span class="string">"objectbox.daoCompat"</span>:<span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½ è®¡åˆ’ä» greenDAO è¿ç§»åˆ° ObjectBox,é‚£ä¹ˆä½ å¯èƒ½ä¼šä¿ç•™åŸæ¥çš„ greenDAO entity ç±»ï¼ˆå¤åˆ¶è¿™äº›ç±»åˆ°å¦å¤–çš„åŒ…ä¸­ï¼‰ç„¶åæŒ‰å¦‚ä¸‹ä¿®æ”¹ã€‚</p>
<ul>
<li>é¦–å…ˆæ”¹å˜æ³¨è§£ã€‚è¯·æ³¨æ„ï¼šä¸æ˜¯æ‰€æœ‰çš„ greenDAO æ³¨è§£éƒ½æ”¯æŒæ— ç¼è¿ç§»åˆ° ObjectBox,æ”¯æŒçš„å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// greenDAO</span></span><br><span class="line"><span class="keyword">import</span> org.greenrobot.greendao.annotation.Entity;</span><br><span class="line"><span class="keyword">import</span> org.greenrobot.greendao.annotation...</span><br><span class="line"></span><br><span class="line"><span class="comment">// ObjectBox</span></span><br><span class="line"><span class="keyword">import</span> io.objectbox.annotation.Entity;</span><br><span class="line"><span class="keyword">import</span> io.objectbox.annotation...</span><br></pre></td></tr></table></figure>

<ul>
<li>ObjectBox å½“å‰ä¸æ”¯æŒ unique indexes,naming indexes,æˆ–è€…åœ¨å¤šä¸ªå±æ€§é—´ indexes.</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// greenDAO</span></span><br><span class="line"><span class="meta">@Entity</span>(indexes = ...)</span><br><span class="line"><span class="meta">@Index</span>(name = <span class="string">"idx1"</span>, unique = <span class="keyword">true</span>) <span class="keyword">private</span> String name;</span><br><span class="line"><span class="meta">@Unqiue</span> <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ObjectBox</span></span><br><span class="line"><span class="meta">@Index</span> <span class="keyword">private</span> String name;</span><br></pre></td></tr></table></figure>

<ul>
<li>è‡ªå®šä¹‰ç±»å‹ã€‚ä¿®æ”¹çˆ¶ç±»,å½“ç„¶ä¹Ÿå¯åŒæ—¶ç»§æ‰¿ï¼Œè¿™æ ·è¯¥è‡ªå®šä¹‰ç±»å‹å°±å¯åŒæ—¶åœ¨ greenDAO å’Œ ObjectBox é—´ä½¿ç”¨</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// greenDAO</span></span><br><span class="line"><span class="keyword">import</span> org.greenrobot.greendao.converter.PropertyConverter;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ObjectBox</span></span><br><span class="line"><span class="keyword">import</span> io.objectbox.converter.PropertyConverter;</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹ @Convert æ³¨è§£é‡Œçš„ columnType æ”¹ä¸º dbType</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// greenDAO</span></span><br><span class="line"><span class="meta">@Convert</span>(converter = NoteTypeConverter.class, columnType = String.class)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ObjectBox</span></span><br><span class="line"><span class="meta">@Convert</span>(converter = NoteTypeConverter.class, dbType = String.class)</span><br></pre></td></tr></table></figure>

<ul>
<li>å…³ç³»ã€‚ObjectBox ä½¿ç”¨ <code>ToOne</code> å’Œ <code>ToMany</code>ç±»å‹æ›¿ä»£ greenDAO çš„ <code>@ToOne</code> å’Œ <code>@ToMany</code> æ³¨è§£ã€‚</li>
<li>ä½¿ç”¨ BoxStore.<br>ä¿®æ”¹å®Œ entity åï¼Œè®¾ç½® BoxStore åˆ›å»º DaoSession.</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é€šå¸¸åœ¨ Application ç±»ä¸­</span></span><br><span class="line">boxStore = MyObjectBox.builder().androidContext(<span class="keyword">this</span>).build();</span><br><span class="line">daoCompatSession = <span class="keyword">new</span> DaoSession(boxStore);</span><br><span class="line"><span class="comment">// åœ¨è¿ç§»å®Œæˆåï¼Œä½ å¯èƒ½æƒ³ç§»é™¤è¿™äº›è¿ç§»æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">// é‚£ä¹ˆé€šè¿‡ greenDAO session è·å– entities,æŠŠä»–ä»¬è½¬ä¸º ObjectBox entities,</span></span><br><span class="line"><span class="comment">// ç„¶åä½¿ç”¨ DaoCompat session æ’å…¥ã€‚</span></span><br><span class="line">List&lt;com.example.app.daos.greendao.Note&gt; notes = daoSession.getNoteDao().loadAll();</span><br><span class="line">List&lt;Note&gt; convertedNotes = convertToObjectBoxNotes(notes);</span><br><span class="line">daoCompatSession.getNoteDao().insertInTx(convertedNotes);</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤æ²¡æœ‰è®¾ç½® ID (å³ id == 0),ObjectBox ä¼šä¸ºæ’å…¥çš„æ•°æ®ç”Ÿæˆä¸€ä¸ªæ–°çš„ ID.å¦‚æœæƒ³ä¿ç•™åŸæ¥çš„ ID,è¯·ä¿®æ”¹ <code>@Id(assignable = true)</code></p>
<ul>
<li>ä½¿ç”¨ DaoCompat DaoSession<br>åœ¨ä½¿ç”¨æ–° compat session æ›¿æ¢åŸæ¥çš„ API åï¼Œå¯ä»¥é€šè¿‡åœ¨ <code>Application</code> ç±»ä¸­çš„ä¸€ä¸ªæ–¹æ³•è¿”å› <code>DaoSession</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> DaoSession <span class="title">getDaoSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// greenDAO</span></span><br><span class="line">    <span class="comment">// return daoSession;</span></span><br><span class="line">    <span class="comment">// ObjectBox</span></span><br><span class="line">    <span class="keyword">return</span> daoCompatSession;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¡¨é¢ä¸Š compat DaoSession æ˜¯ greenDAO DaoSession çš„æ›¿ä»£å“ï¼Œå…¶å®å®ƒå†…éƒ¨æ˜¯ä½¿ç”¨ BoxStore ä»£æ›¿äº† greenDAO æ•°æ®åº“.<br>å¦‚æœè¿˜ä½¿ç”¨äº† greenDAO çš„é¢å¤–ç‰¹æ€§ï¼Œæ¯”å¦‚ queries,é‚£ä¹ˆè¿˜éœ€å¦‚ä¸‹ä¿®æ”¹:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// greenDAO</span></span><br><span class="line"><span class="keyword">import</span> org.greenrobot.greendao.query.Query;</span><br><span class="line"><span class="keyword">import</span> org.greenrobot.greendao...</span><br><span class="line"><span class="comment">// ObjectBox</span></span><br><span class="line"><span class="keyword">import</span> org.greenrobot.daocompat.query.Query;</span><br><span class="line"><span class="keyword">import</span> org.greenrobot.daocompat...</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Queries<br>DaoCompat æ”¯æŒä»¥ä¸‹çš„ Query åŠŸèƒ½:<br>â€“ <code>remove()</code> æ›¿ä»£ <code>DeleteQuery</code><br>â€“ <code>count()</code> æ›¿ä»£ <code>CountQuery</code><br>â€“ ä¸æ”¯æŒ <code>CursorQuery</code></p>
</li>
<li><p>DaoCompat å’Œ greenDAO çš„ä¸åŒ<br>â€“ ä¸æ”¯æŒ <code>NotNull</code><br>â€“ ä¸æ”¯æŒ <code>Joins</code> å’Œ <code>åŸç”Ÿ SQL æŸ¥è¯¢</code>.<br>â€“ ä¸æ”¯æŒå¼‚æ­¥ sessions: <code>startAsyncSession()</code><br>â€“ ä¸æ”¯æŒåŠ å¯†<br>â€“ ä»…æ”¯æŒç®€å•çš„ <code>AbstractDaoTest</code> å’Œ <code>AbstractDaoBasicTest</code></p>
</li>
</ul>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>ObjectBoxå…¥é—¨-2-åŸºæœ¬æ“ä½œ</title>
    <url>/2019/02/24/ObjectBox%E5%85%A5%E9%97%A8-2-%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<h3 id="Entity"><a href="#Entity" class="headerlink" title="Entity"></a>Entity</h3><p>åœ¨ä¸€ä¸ªç±»ä¸­è‡³å°‘éœ€è¦ <code>@Entity</code> å’Œ <code>@Id</code> ä¸¤ä¸ªæ³¨è§£æ‰èƒ½å®šä¹‰ä¸€ä¸ª ObjectBox model.ä¾‹å¦‚:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// User.java</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">public</span> <span class="keyword">long</span> id;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶å make å°±å¯ç”Ÿæˆ model.</p>
<p>| @Id çš„ç±»å‹å¿…é¡»ä¸º long.<br>| å¦‚æœ entity å‘ç”Ÿäº†å¾ˆå¤§çš„å˜åŠ¨ï¼ˆå¦‚ç§»åŠ¨ç±»æˆ–ä¿®æ”¹æ³¨è§£ï¼‰,å¿…é¡» rebuild é¡¹ç›®ä»¥ä¾¿ ObjectBox ç”Ÿæˆçš„ä»£ç å¾—åˆ°æ›´æ–°.</p>
<h3 id="æ ¸å¿ƒç±»"><a href="#æ ¸å¿ƒç±»" class="headerlink" title="æ ¸å¿ƒç±»"></a>æ ¸å¿ƒç±»</h3><ul>
<li>MyObjectBox: åŸºäº entity ç±»ç”Ÿæˆã€‚æä¾› <code>builder</code> é…ç½® BoxStore.</li>
<li>BoxStore: ObjectBox çš„å…¥å£ã€‚æ“ä½œæ•°æ®åº“ï¼Œç®¡ç† Boxes çš„å·¥å…·.</li>
<li>Box: å¯¹ entity ä¿å­˜å’ŒæŸ¥è¯¢ã€‚æ¯ä¸€ä¸ª entity éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ Boxï¼ˆç”± BoxStore æä¾›).</li>
</ul>
<h3 id="æ ¸å¿ƒåˆå§‹åŒ–"><a href="#æ ¸å¿ƒåˆå§‹åŒ–" class="headerlink" title="æ ¸å¿ƒåˆå§‹åŒ–"></a>æ ¸å¿ƒåˆå§‹åŒ–</h3><p>å®ä¾‹åŒ– BoxStore çš„æœ€å¥½æ—¶æœºæ˜¯åœ¨ app å¯åŠ¨æ—¶ã€‚æ¨èåœ¨ Application ç±»çš„ onCreate æ–¹æ³•ä¸­è¿›è¡Œ.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BoxStore boxStore;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        boxStore = MyObjectBox.builder().androidContext(<span class="keyword">this</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BoxStore <span class="title">getBoxStore</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> boxStore; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç„¶ååœ¨ app ç”Ÿå‘½å‘¨æœŸå†…å°±å¯ä»¥ä½¿ç”¨äº†</span></span><br><span class="line">notesBox = ((App) getApplicationi()).getBoxStore().boxFor(User.class);</span><br></pre></td></tr></table></figure>

<h3 id="Box-åŸºæœ¬æ“ä½œ"><a href="#Box-åŸºæœ¬æ“ä½œ" class="headerlink" title="Box åŸºæœ¬æ“ä½œ"></a>Box åŸºæœ¬æ“ä½œ</h3><ul>
<li>put: å­˜å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå¯èƒ½ä¼šè¦†ç›–å…·æœ‰ç›¸åŒ ID çš„å¯¹è±¡ã€‚å³ä½¿ç”¨ <code>put</code> æ’å…¥æˆ–æ›´æ–°å¯¹è±¡ã€‚è¿”å› IDã€‚</li>
<li>get,getAll: æä¾›ä¸€ä¸ªå¯¹è±¡çš„ IDï¼Œå¯å¿«é€Ÿçš„é€šè¿‡ <code>get</code>è·å–å®ƒã€‚<code>getAll</code> è·å–æŒ‡å®šçš„æ‰€æœ‰çš„å¯¹è±¡ã€‚</li>
<li>remove,removeAll: ä» box ä¸­åˆ é™¤ä¸€ä¸ªå¯¹è±¡ã€‚<code>removeAll</code> åˆ é™¤æŒ‡å®šçš„æ‰€æœ‰å¯¹è±¡.</li>
<li>count: è¿”å›è¯¥ box å­˜å‚¨çš„å¯¹è±¡æ•°é‡.</li>
<li>query: è¿”å›ä¸€ä¸ª <code>query builder</code>.</li>
</ul>
<h3 id="Object-IDs"><a href="#Object-IDs" class="headerlink" title="Object IDs"></a>Object IDs</h3><ul>
<li><p>Entity å¿…é¡»å…·æœ‰ä¸€ä¸ªç±»å‹ä¸º <code>long</code>,ç”± @Id æ³¨è§£å±æ€§ã€‚å½“ç„¶å¯ä»¥ä½¿ç”¨å¯ç©ºçš„ <code>java.lang.Long</code>ç±»å‹ï¼Œä½†ä¸æ¨èã€‚<br>å¦‚æœéœ€è¦ä½¿ç”¨å¦å¤–ä¸€ç§ç±»å‹çš„ ID(æœåŠ¡å™¨è¿”å›çš„ String ç±»å‹çš„ UID),æŠŠå®ƒä½œä¸ºæ™®é€šå±æ€§å³å¯ï¼Œç„¶åå¯ä»¥é€šè¿‡æ­¤ ID æŸ¥è¯¢.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span> <span class="class"><span class="keyword">class</span> <span class="title">StringIdEntity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span> priavte <span class="keyword">long</span> id;</span><br><span class="line">    <span class="keyword">private</span> String uid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">StringIdEntity entity = box.query().equal(StringIdEntity_.uid,uid).findUnique();</span><br></pre></td></tr></table></figure>
</li>
<li><p>æŒ‡å®š ID<br>ObjectBox é»˜è®¤ä¼šä¸ºæ–°å¯¹è±¡æŒ‡å®š IDs.ID è‡ªå¢.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">User user = <span class="keyword">new</span> User();</span><br><span class="line"><span class="comment">// user.id == 0</span></span><br><span class="line">box.put(user);</span><br><span class="line"><span class="comment">// user.id != 0</span></span><br><span class="line"><span class="keyword">long</span> id = user.id</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ’å…¥çš„å¯¹è±¡çš„ ID æ¯” box é‡Œçš„ ID æœ€å¤§å€¼è¿˜å¤§ï¼ŒObjectBox å°†æŠ›å‡ºé”™è¯¯.</p>
</li>
<li><p>ä¿ç•™ Object IDs<br>Object IDs ä¸èƒ½ï¼š<br>â€“ 0,null(ä½¿ç”¨ java.lang.Long)ã€‚<br>â€“ 0xFFFFFFFFFFFFFFFFï¼ˆjava ä¸­çš„ -1ï¼‰:å†…éƒ¨ä¿ç•™</p>
</li>
</ul>
<h3 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h3><ul>
<li><code>put</code> è¿è¡Œåœ¨éšå¼äº‹åŠ¡ä¸­</li>
<li>ä¼˜å…ˆä½¿ç”¨ <code>put</code> æ‰¹é‡æ“ä½œåˆ—è¡¨ ï¼ˆ<code>put(entities)</code>ï¼‰</li>
<li>å¦‚æœåœ¨å¾ªç¯ä¸­æ“ä½œå¤§é‡æ•°æ®ï¼Œè€ƒè™‘æ˜ç¡®ä½¿ç”¨äº‹åŠ¡ï¼Œå¦‚<code>runInTx()</code></li>
</ul>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>ObjectBoxå…¥é—¨-12-äº‹åŠ¡</title>
    <url>/2019/02/26/ObjectBox%E5%85%A5%E9%97%A8-12-%E4%BA%8B%E5%8A%A1/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<p>ObjectBox æ˜¯ä¸€ä¸ªæ»¡è¶³ ACID ç‰¹æ€§çš„äº¤æ˜“å‹æ•°æ®åº“.ä¸€ä¸ªäº‹åŠ¡å¯ä»¥åŒ…å«ä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆæ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚<br>å‡ ä¹æ‰€æœ‰çš„ ObjectBox çš„æ“ä½œéƒ½åŒ…å«äº†äº‹åŠ¡ã€‚æ¯”å¦‚ <code>put(),read()</code>ã€‚æ™®é€šæƒ…å†µä¸‹ï¼Œä¸ç”¨å…³å¿ƒè¿™äº›åº•å±‚çš„äº‹åŠ¡ã€‚ä½†æŸäº›å¤æ‚çš„æƒ…å†µä¸‹ï¼Œæ‰‹åŠ¨å¤„ç†äº‹åŠ¡æ“ä½œå¯ä»¥ä½¿ä½ çš„ app æ›´åŠ é«˜æ•ˆä¸€è‡´ã€‚</p>
<h3 id="æ‰‹åŠ¨äº‹åŠ¡"><a href="#æ‰‹åŠ¨äº‹åŠ¡" class="headerlink" title="æ‰‹åŠ¨äº‹åŠ¡"></a>æ‰‹åŠ¨äº‹åŠ¡</h3><p>ObjectBox æä¾›äº†å¦‚ä¸‹æ–¹æ³•å®ç°æ‰‹åŠ¨äº‹åŠ¡ï¼š</p>
<ul>
<li>runInTx: åœ¨äº‹åŠ¡ä¸­è¿è¡ŒæŒ‡å®šçš„ runnable</li>
<li>runInReadTx: åœ¨ä¸€ä¸ªåªè¯»çš„äº‹åŠ¡ä¸­è¿è¡ŒæŒ‡å®šçš„ runnable.ä¸åŒäºå†™å…¥äº‹åŠ¡ï¼Œå¤šä¸ªåªè¯»äº‹åŠ¡å¯ä»¥åŒæ—¶è¿è¡Œã€‚</li>
<li>runInTxAsync: åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡ŒæŒ‡å®šçš„ runnable.ä¸€æ—¦äº‹åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œcallback(å¯ä¸º null) å°†è¢«è°ƒç”¨.</li>
<li>callInTx: ç±»ä¼¼ runInTx(Runnable),ä½†æ˜¯æœ‰è¿”å›å€¼æˆ–æŠ›å‡ºå¼‚å¸¸.</li>
</ul>
<p>å¯¹æ‰¹é‡å­˜å…¥æ“ä½œè¿›è¡Œæ‰‹åŠ¨äº‹åŠ¡çš„ä¼˜åŠ¿æ˜¯ä½ å¯ä»¥å®ç°ä»»æ„æ•°é‡çš„æ“ä½œï¼Œä½¿ç”¨å¤šä¸ª box å¯¹è±¡ã€‚åŒæ—¶ï¼Œåœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥å¯¹æ•°æ®æœ‰ä¸€ä¸ªç›´è§‚çš„è®¤çŸ¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å†™å…¥äº‹åŠ¡</span></span><br><span class="line">boxStore.runInTx(() -&gt; &#123;</span><br><span class="line">  <span class="keyword">for</span> (User user: allUsers) &#123;</span><br><span class="line">    <span class="keyword">if</span> (modify(user)) box.put(user);</span><br><span class="line">    <span class="keyword">else</span> box.remove(user);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="äº‹åŠ¡ä»£ä»·"><a href="#äº‹åŠ¡ä»£ä»·" class="headerlink" title="äº‹åŠ¡ä»£ä»·"></a>äº‹åŠ¡ä»£ä»·</h3><p>ç†è§£äº‹åŠ¡å¯ä»¥å¾ˆå¥½çš„å¸®åŠ©æŒæ¡æ•°æ®åº“æ€§èƒ½ã€‚è¯·æ³¨æ„: å†™å…¥äº‹åŠ¡ä»£ä»·å¤§.<br>æäº¤äº‹åŠ¡åŒ…å«äº†å°†æ•°æ®åŒæ­¥åˆ°ç‰©ç†å­˜å‚¨ä¸­çš„æ“ä½œï¼Œè¿™å¯¹æ•°æ®åº“æ˜¯ä¸€ä¸ªç›¸å¯¹æ˜‚è´µçš„æ“ä½œã€‚åªæœ‰æ–‡ä»¶ç³»ç»Ÿç¡®è®¤æ‰€æœ‰çš„æ•°æ®éƒ½å­˜å‚¨ï¼Œäº‹åŠ¡æ“ä½œæ‰ä¼šè¢«è®¤ä¸ºæ˜¯æˆåŠŸçš„ã€‚äº‹åŠ¡åŒæ­¥è¯¥æ–‡ä»¶å¯èƒ½éœ€è¦å‡ æ¯«ç§’ã€‚è¯·è®°ä½ï¼šå°½é‡æŠŠå¤šä¸ªæ“ä½œ(put ç­‰)æ”¾å…¥åŒä¸€ä¸ªäº‹åŠ¡ä¸­.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸æ¨è</span></span><br><span class="line"><span class="keyword">for</span>(User user: allUsers) &#123;</span><br><span class="line">   modify(user); <span class="comment">// modifies properties of given user</span></span><br><span class="line">   box.put(user);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ¨è</span></span><br><span class="line"><span class="keyword">for</span>(User user: allUsers) &#123;</span><br><span class="line">   modify(user); <span class="comment">// modifies properties of given user</span></span><br><span class="line">&#125;</span><br><span class="line">box.put(allUsers);</span><br></pre></td></tr></table></figure>

<h3 id="è¯»å–äº‹åŠ¡"><a href="#è¯»å–äº‹åŠ¡" class="headerlink" title="è¯»å–äº‹åŠ¡"></a>è¯»å–äº‹åŠ¡</h3><p>ObjectBox çš„è¯»å–äº‹åŠ¡å¾ˆå¿«ã€‚ç›¸å¯¹äºå†™å…¥äº‹åŠ¡ï¼Œæ²¡æœ‰ commit æ“ä½œï¼Œæ‰€ä»¥æ²¡æœ‰æ˜‚è´µçš„åŒæ­¥æ–‡ä»¶ç³»ç»Ÿã€‚è¯·æ³¨æ„ï¼šåœ¨ä¸€ä¸ªè¯»å–äº‹åŠ¡ä¸­ put æ“ä½œæ˜¯éæ³•çš„ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚get,count,queries ç­‰æ“ä½œæ²¡æœ‰æ‰‹åŠ¨å£°æ˜äº‹åŠ¡(è¯»å†™),é»˜è®¤ä¼šè¿è¡Œåœ¨ä¸€ä¸ªè¯»å–äº‹åŠ¡.<br>è™½ç„¶è¯»å–äº‹åŠ¡æ¯”å†™å…¥äº‹åŠ¡ä»£ä»·å°ï¼Œä½†æ˜¯è¿˜æ˜¯æœ€å¥½æŠŠå®ƒæ”¾å…¥è¯»å–äº‹åŠ¡ä¸­ã€‚</p>
<h3 id="å¤šç‰ˆæœ¬çš„å¹¶å‘"><a href="#å¤šç‰ˆæœ¬çš„å¹¶å‘" class="headerlink" title="å¤šç‰ˆæœ¬çš„å¹¶å‘"></a>å¤šç‰ˆæœ¬çš„å¹¶å‘</h3><p>ObjectBox æä¾›äº†è¯­ä¹‰åŒ–çš„å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶(Multiversion concurrency control MVCC).å¤šä¸ªå¹¶å‘è¯»å–(è¯»å–äº‹åŠ¡)å¯ä»¥ç«‹å³æ‰§è¡Œï¼Œæ— éœ€é˜»å¡æˆ–ç­‰å¾…ã€‚è¿™æ˜¯é€šè¿‡å­˜å‚¨å¤šä¸ªç‰ˆæœ¬çš„ï¼ˆæäº¤ï¼‰æ•°æ®æ¥å®ç°çš„ã€‚å³ä¾¿ä¸€ä¸ªå†™å…¥äº‹åŠ¡æ­£åœ¨è¿è¡Œï¼Œè¯»å–äº‹åŠ¡ä¹Ÿå¯ä»¥ç«‹å³è·å–åˆ°æœ€æ–°çš„åŒæ­¥çŠ¶æ€ã€‚å†™å…¥äº‹åŠ¡æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¾¿çŠ¶æ€ä¸€è‡´ã€‚æ‰€ä»¥ä¿è¯å†™å…¥äº‹åŠ¡çŸ­å°å¯ä»¥é¿å…é˜»å¡å…¶ä»–å†™å…¥äº‹åŠ¡ã€‚å› æ­¤åœ¨ä¸€ä¸ªå†™å…¥äº‹åŠ¡ä¸­æ‰§è¡Œç½‘ç»œæ“ä½œæˆ–å¤æ‚è®¡ç®—ä¸æ¨èã€‚å°½é‡åœ¨å†™å…¥äº‹åŠ¡å‰å®Œæˆè¿™äº›æ“ä½œã€‚</p>
<p>æ³¨æ„ä¸éœ€è¦è‡ªå·±æ‰‹åŠ¨ç»´æŒå†™å…¥äº‹åŠ¡åºåˆ—ã€‚å¦‚æœå¤šçº¿ç¨‹æƒ³åŒæ—¶æ‰§è¡Œå†™å…¥äº‹åŠ¡(put,runInTx),åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œï¼Œå…¶ä»–å¿…é¡»ç­‰å¾…ã€‚ç±»ä¼¼ Java ä¸­çš„ lock æˆ– synchronizedã€‚</p>
<h4 id="æ·±å…¥å†™å…¥äº‹åŠ¡"><a href="#æ·±å…¥å†™å…¥äº‹åŠ¡" class="headerlink" title="æ·±å…¥å†™å…¥äº‹åŠ¡"></a>æ·±å…¥å†™å…¥äº‹åŠ¡</h4><p>å°½é‡é¿å…åœ¨å†™å…¥äº‹åŠ¡ä¸­ä½¿ç”¨é”(<code>synchronized</code> æˆ– <code>java.util.concurrent.locks</code>).å› ä¸ºå†™å…¥äº‹åŠ¡è¿è¡Œè´¹æ—¶ï¼Œæ‰€ä»¥ ObjectBox å†…éƒ¨ä¼šè·å–ä¸€ä¸ªå†™å…¥é”ã€‚å½“è®¾è®¡å¤šä¸ªé”æ—¶ï¼Œè¯·æé«˜è­¦æƒ•ã€‚<br>å§‹ç»ˆä»¥ç›¸åŒçš„é¡ºåºè·å–é”å¯ä»¥é¿å…æ­»é”ã€‚å¦‚æœåœ¨ä¸€ä¸ªäº‹åŠ¡è·å–äº† X é”ï¼Œè¯·ä¿è¯ä½ çš„ä»£ç åœ¨æŒæœ‰ X é”æ—¶æ²¡æœ‰åœ¨å¦å¤–ä¸€ä¸ªå†™å…¥äº‹åŠ¡ä¸­æ‰§è¡Œ.</p>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>ObjectBoxå…¥é—¨-4-æœ¬åœ°å•å…ƒæµ‹è¯•</title>
    <url>/2019/02/24/ObjectBox%E5%85%A5%E9%97%A8-4-%E6%9C%AC%E5%9C%B0%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<h2 id="å®‰å“æœ¬åœ°å•å…ƒæµ‹è¯•"><a href="#å®‰å“æœ¬åœ°å•å…ƒæµ‹è¯•" class="headerlink" title="å®‰å“æœ¬åœ°å•å…ƒæµ‹è¯•"></a>å®‰å“æœ¬åœ°å•å…ƒæµ‹è¯•</h2><h3 id="è®¾ç½®æµ‹è¯•ç¯å¢ƒ"><a href="#è®¾ç½®æµ‹è¯•ç¯å¢ƒ" class="headerlink" title="è®¾ç½®æµ‹è¯•ç¯å¢ƒ"></a>è®¾ç½®æµ‹è¯•ç¯å¢ƒ</h3><p>| æ­¤é…ç½®ä»…é’ˆå¯¹ ObjectBox 1.4 åŠä¹‹å‰ç‰ˆæœ¬.æ–°ç‰ˆæœ¬å·²ç»è‡ªåŠ¨æ·»åŠ äº† native ObjectBox ä¾èµ–åº“ã€‚</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// /app/build.gradle</span></span><br><span class="line">depdendencies &#123;</span><br><span class="line">    <span class="comment">// å¿…å¤‡ JUnit 4</span></span><br><span class="line">    testImplementation <span class="string">'junit:unit:4.12'</span></span><br><span class="line">    <span class="comment">// æ‰‹åŠ¨æ·»åŠ å¹³å°ç‹¬ç«‹çš„ native Objectbox ä¾èµ–åº“.(å¯é€‰)</span></span><br><span class="line">    testImplementation <span class="string">"io.objectbox:objectbox-linux:$objectboxVersion"</span></span><br><span class="line">    testImplementation <span class="string">"io.objectbox:objectbox-macos:$objectboxVersion"</span></span><br><span class="line">    testImplementation <span class="string">"io.objectbox:objectbox-windows:$objectboxVersion"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>| æœ¬åœ°å•å…ƒæµ‹è¯•ä»…æ”¯æŒ 64 ä½ç³»ç»Ÿ.<br>| windows å¯èƒ½éœ€è¦å®‰è£… <code>Microsoft Visual C++ 2015 Redistributable(x64)</code></p>
<h3 id="åˆ›å»ºæœ¬åœ°å•å…ƒæµ‹è¯•ç±»"><a href="#åˆ›å»ºæœ¬åœ°å•å…ƒæµ‹è¯•ç±»" class="headerlink" title="åˆ›å»ºæœ¬åœ°å•å…ƒæµ‹è¯•ç±»"></a>åˆ›å»ºæœ¬åœ°å•å…ƒæµ‹è¯•ç±»</h3><ul>
<li>å¯ä»¥ä½¿ç”¨ BoxStore builder çš„<code>directory(File)</code> æŒ‡å®šæ•°æ®åº“ä¿å­˜åœ¨æœ¬åœ°è®¾å¤‡ä¸Šã€‚</li>
<li>ä¸ºä¿è¯æ•°æ®ä¸äº¤å‰æ±¡æŸ“ï¼Œå¯ä»¥ä½¿ç”¨ <code>BoxStore.deleteAllFiles(File)</code> åˆ é™¤å·²ç»å­˜åœ¨çš„æ•°æ®åº“</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoteTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> File TEST_DIR = <span class="keyword">new</span> File(<span class="string">"objectbox-example/test-db"</span>);</span><br><span class="line">    <span class="keyword">private</span> BoxStore store;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ é™¤ä¹‹å‰çš„æ•°æ®åº“</span></span><br><span class="line">        BoxStore.deleteAllFiles(TEST_DIR);</span><br><span class="line">        store = MyObjectBox.builder()</span><br><span class="line">                <span class="comment">// æŒ‡å®šæ•°æ®åº“å­˜æ”¾è·¯å¾„</span></span><br><span class="line">                .directory(TEST_DIR)</span><br><span class="line">                <span class="comment">// æ·»åŠ  debug æ ‡è®°æ‰“å°æ—¥å¿—</span></span><br><span class="line">                .debugFlags(DebugFlags.LOG_QUERIES | DebugFlags.LOG_QUERY_PARAMETERS)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (store != <span class="keyword">null</span>) &#123;</span><br><span class="line">            store.close();</span><br><span class="line">            store = <span class="keyword">null</span></span><br><span class="line">        &#125;</span><br><span class="line">        BoxStore.deleteAllFiles(TEST_DIR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exampleTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Box&lt;Note&gt; noteBox = store.boxFor(Note.class);</span><br><span class="line">        assertEquals(...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å…³ç³»æµ‹è¯•"><a href="#å…³ç³»æµ‹è¯•" class="headerlink" title="å…³ç³»æµ‹è¯•"></a>å…³ç³»æµ‹è¯•</h3><ul>
<li>ObjectBox 1.4.4 åŠä¹‹å</li>
<li>ä¸ºäº†æµ‹è¯•å…·æœ‰ ToOne,ToMany å±æ€§çš„ entity,å¿…é¡»åœ¨æœ¬åœ° JVM åˆå§‹åŒ– entity å¹¶ä¸”æ·»åŠ ä¸€ä¸ª transient çš„ BoxStore å±æ€§.</li>
</ul>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>ObjectBoxå…¥é—¨-5-LiveData</title>
    <url>/2019/02/24/ObjectBox%E5%85%A5%E9%97%A8-5-LiveData/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<h2 id="LiveData-Arch-Comp"><a href="#LiveData-Arch-Comp" class="headerlink" title="LiveData (Arch.Comp.)"></a>LiveData (Arch.Comp.)</h2><p>ä» 1.2.0 å¼€å§‹æ”¯æŒ <code>Android Architecture Components</code><br>ObjectBox æä¾› <code>ObjectBoxLiveData</code> å¯ä»¥åœ¨ ViewModel ä¸­ä½¿ç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoteViewModel</span> <span class="keyword">extends</span> <span class="title">ViewModel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ObjectBoxLiveData&lt;Note&gt; noteLiveData;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ObjectBoxLiveData&lt;Note&gt; <span class="title">getNoteLiveData</span><span class="params">(Box&lt;Note&gt; notesBox)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (noteLiveData == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æŸ¥è¯¢æ‰€æœ‰çš„ notes, text æŒ‰ a-z çš„é¡ºåºæ’åˆ—</span></span><br><span class="line">            noteLiveData = <span class="keyword">new</span> ObjectBoxLiveData(notesBox.query().order(Note_.text).build());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> noteLiveData;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¸Šä¸€ç§æ–¹æ³•éœ€è¦ä¼ å…¥ Box.å¯ä»¥ä½¿ç”¨ <code>AndroidViewModel</code> ä»£æ›¿ï¼Œå®ƒå¯ä»¥è®¿é—® Application context,ç„¶åä¼šåœ¨ ViewModel ä¸­è°ƒç”¨ <code>((App)getApplication()).getBoxStore().boxFor()</code>.ç¬¬ä¸€ç§çš„ä¼˜åŠ¿åœ¨äºæ²¡æœ‰å¼•ç”¨ Android ç±»ï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">NoteViewModel model = ViewModelProviders.of(<span class="keyword">this</span>).get(NoteViewModel.class);</span><br><span class="line">model.getNoteLiveData(notesBox).observe(<span class="keyword">this</span>,<span class="keyword">new</span> Observer&lt;List&lt;Note&gt;&gt;&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(@Nullable List&lt;Node&gt; notes)</span> </span>&#123;</span><br><span class="line">        notesAdapter.setNotes(notes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="Paging-Arch-Comp"><a href="#Paging-Arch-Comp" class="headerlink" title="Paging (Arch.Comp.)"></a>Paging (Arch.Comp.)</h2><p>ä» 2.0.0 å¼€å§‹æ”¯æŒ.ObjectBox æä¾›äº† <code>ObjectBoxDataSource</code> ç±».å®ƒç»§æ‰¿äº† paging åº“çš„ <code>PositionalDataSource</code><br>åœ¨ ViewModel ä¸­ï¼Œç±»ä¼¼åˆ›å»º LiveData,å…ˆåˆ›å»º ObjectBox query.ç„¶åæ„é€ å¹¶ä½¿ç”¨ ObjectBoxDataSource å·¥å‚ä»£æ›¿ LiveData.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotePageViewModel</span> <span class="keyword">extends</span> <span class="title">ViewModel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> LiveData&lt;PagedList&lt;Note&gt;&gt; noteLiveDataPaged;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> LiveData&lt;PagedList&lt;Note&gt;&gt; getNoteLiveDataPaged(Box&lt;Note&gt; notesBox) &#123;</span><br><span class="line">        <span class="keyword">if</span>(noteLiveDataPaged == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Query&lt;Note&gt; query = notesBox.query().order(Note_.text).build();</span><br><span class="line">            noteLiveDataPaged = <span class="keyword">new</span> LivePagedListBuilder(</span><br><span class="line">                <span class="keyword">new</span> ObjectBoxDataSource.Factory(query),</span><br><span class="line">                <span class="number">20</span> <span class="comment">// é¡µæ•°</span></span><br><span class="line">            ).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> noteLiveDataPaged;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>ObjectBoxå…¥é—¨-7-kotlinæ”¯æŒ</title>
    <url>/2019/02/24/ObjectBox%E5%85%A5%E9%97%A8-7-kotlin%E6%94%AF%E6%8C%81/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<h2 id="Kotlin-æ”¯æŒ"><a href="#Kotlin-æ”¯æŒ" class="headerlink" title="Kotlin æ”¯æŒ"></a>Kotlin æ”¯æŒ</h2><h3 id="kotlin-Entity"><a href="#kotlin-Entity" class="headerlink" title="kotlin Entity"></a>kotlin Entity</h3><ul>
<li>åœ¨ kotlin ä¸­ï¼ŒID å±æ€§åº”è¯¥è¿™æ ·å®šä¹‰ <code>@Id var id: Long = 0</code>.ID å¿…é¡»æ˜¯ var.</li>
</ul>
<h3 id="æ„é€ å™¨"><a href="#æ„é€ å™¨" class="headerlink" title="æ„é€ å™¨"></a>æ„é€ å™¨</h3><ul>
<li>ObjectBox ä¼˜å…ˆè°ƒç”¨å…¨å‚çš„æ„é€ æ–¹æ³•ã€‚å¦‚æœè‡ªå®šä¹‰å±æ€§æˆ– transient å±æ€§ æˆ–å…³è”å±æ€§æ˜¯æ„é€ æ–¹æ³•çš„ä¸€éƒ¨åˆ†å‚æ•°ï¼ŒObjectBox å°†ä¸ä¼šè°ƒç”¨æ­¤æ„é€ æ–¹æ³•.æ‰€ä»¥åº”è¯¥æä¾›ä¸ºè¿™äº›å‚æ•°æä¾›é»˜è®¤å€¼ä»¥ç¡®ä¿æ— å‚æ„é€ æ–¹æ³•å­˜åœ¨ã€‚</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Note</span></span>(</span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">var</span> id: <span class="built_in">Long</span> = <span class="number">0</span>,</span><br><span class="line">    <span class="keyword">val</span> text: String = <span class="string">""</span>,</span><br><span class="line">    <span class="meta">@Convert( converter = StringsConverter::class, dbType = String::class)</span></span><br><span class="line">    <span class="keyword">val</span> strings: List&lt;String&gt; = listOf()</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="kotlin-Entity-ä¸­å®šä¹‰å…³è”å±æ€§"><a href="#kotlin-Entity-ä¸­å®šä¹‰å…³è”å±æ€§" class="headerlink" title="kotlin Entity ä¸­å®šä¹‰å…³è”å±æ€§"></a>kotlin Entity ä¸­å®šä¹‰å…³è”å±æ€§</h3><p>åœ¨ kotlin ä¸­å®šä¹‰å…³è”å±æ€§å¯èƒ½æ¯”è¾ƒéº»çƒ¦ã€‚ä½†è¯·æ³¨æ„ï¼šå…³è”å±æ€§å¿…é¡»ä¸º <code>var</code>. å¦åˆ™ <code>initialization magic</code> å°†ä¸èµ·ä½œç”¨.<br>é€šå¸¸å¯ä»¥ä½¿ç”¨ <code>lateinit</code> ä¿®é¥°å…³è”å±æ€§</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">var</span> id: <span class="built_in">Long</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> customer: ToOne&lt;Customer&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">var</span> id: <span class="built_in">Long</span> = <span class="number">0</span></span><br><span class="line">    <span class="meta">@Backlink( to = <span class="meta-string">"customer"</span>)</span></span><br><span class="line">    latelinit <span class="keyword">var</span> orders: List&lt;Order&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="kotlin-æ‰©å±•å‡½æ•°"><a href="#kotlin-æ‰©å±•å‡½æ•°" class="headerlink" title="kotlin æ‰©å±•å‡½æ•°"></a>kotlin æ‰©å±•å‡½æ•°</h3><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="string">"io.objectbox:objectbox-kotlin:$objectboxVersion"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>kotlin</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> box: Box&lt;DataClassEntity&gt; = store.boxFor()</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> query = box.query &#123;</span><br><span class="line">    equal(property,value)</span><br><span class="line">    order(property)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> query = box.query().inValues(property,array).build()</span><br><span class="line"></span><br><span class="line">toMany.applyChangesToDb(resetFirst = <span class="literal">true</span>) &#123; <span class="comment">// é»˜è®¤ false</span></span><br><span class="line">    add(entity)</span><br><span class="line">    removeById(id)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>ObjectBoxå…¥é—¨-8-æŸ¥è¯¢</title>
    <url>/2019/02/24/ObjectBox%E5%85%A5%E9%97%A8-8-%E6%9F%A5%E8%AF%A2/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<h2 id="Queries"><a href="#Queries" class="headerlink" title="Queries"></a>Queries</h2><ul>
<li>ä½¿ç”¨ QueryBuilder å®šä¹‰æŸ¥è¯¢æ ‡å‡†ï¼ŒQuery ç±»è¿è¡ŒæŸ¥è¯¢å¹¶è¿”å›åŒ¹é…ç»“æœ</li>
</ul>
<h3 id="QueryBuilder"><a href="#QueryBuilder" class="headerlink" title="QueryBuilder"></a>QueryBuilder</h3><ul>
<li>QueryBuilder ä½¿ç”¨ç¼–è¯‘ç”Ÿæˆçš„å…ƒä¿¡æ¯ç±»æ¥æŒ‡å®šè¦åŒ¹é…çš„å±æ€§å€¼ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;user&gt; joes = userBox.query().equal(User_.firstName,<span class="string">"Joe"</span>).build().find();</span><br><span class="line"></span><br><span class="line">QueryBuilder&lt;User&gt; builder = userBox.query();</span><br><span class="line">builder.equal(User_.firstName,<span class="string">"Joe"</span>)</span><br><span class="line">        .greater(User_.yearOfBirth,<span class="number">1970</span>)</span><br><span class="line">        .startsWith(User_.lastName,<span class="string">"O"</span>);</span><br><span class="line">List&lt;User&gt; youngJoes = builder.build().find();</span><br></pre></td></tr></table></figure>

<h3 id="è¾¹ç•Œæ¡ä»¶"><a href="#è¾¹ç•Œæ¡ä»¶" class="headerlink" title="è¾¹ç•Œæ¡ä»¶"></a>è¾¹ç•Œæ¡ä»¶</h3><ul>
<li><code>equal(),notEqual(),greater(),less()</code></li>
<li><code>isNull(),notNull()</code></li>
<li><code>between()</code></li>
<li><code>in(),notIn()</code></li>
<li><code>startsWith(),endsWith(),contains()</code></li>
<li><code>and(),or()</code></li>
</ul>
<h3 id="æ’åº"><a href="#æ’åº" class="headerlink" title="æ’åº"></a>æ’åº</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">userBox.query().equal(User_.firstName,<span class="string">"Joe"</span>)</span><br><span class="line">        .order(User_.lastName) <span class="comment">// å‡åºæ’åˆ—,å¿½ç•¥å¤§å°å†™</span></span><br><span class="line">        .find();</span><br><span class="line"></span><br><span class="line">userBox.query().equal(User_.firstName,<span class="string">"Joe"</span>)</span><br><span class="line">        .order(User_.lastName,QueryBuilder.DESCENDING | QueryBuilder.CASE_SENSITIVE)</span><br><span class="line">        .find();</span><br></pre></td></tr></table></figure>

<h3 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Query&lt;User&gt; query = builder. build();</span><br><span class="line"><span class="comment">// è¿”å›æ‰€æœ‰åŒ¹é…çš„å¯¹è±¡</span></span><br><span class="line">List&lt;User&gt; joes = query.find();</span><br><span class="line"><span class="comment">// è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…çš„å¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å› null</span></span><br><span class="line">User joe = query.findFirst();</span><br><span class="line"><span class="comment">// è¿”å›å”¯ä¸€ä¸€ä¸ªåŒ¹é…çš„å¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å› null,å¦‚æœæœ‰å¤šä¸ªå€¼æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">User joe = query.findUnique();</span><br></pre></td></tr></table></figure>

<ul>
<li>å¦‚æœæ˜¯ä¸æ–­çš„æ‰§è¡Œ Query,é‚£ä¹ˆåº”è¯¥ç¼“å­˜ Query å¯¹è±¡ï¼Œé‡å¤ä½¿ç”¨ã€‚ä¸ºäº†å¤ç”¨ Query å¯¹è±¡ï¼Œå¯ä»¥æ”¹å˜å®ƒçš„å±æ€§å€¼ï¼Œæˆ–æŸ¥è¯¢å‚æ•°ï¼Œæˆ–æ·»åŠ çš„å„ç§è¾¹ç•Œæ¡ä»¶ã€‚<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‡è®¾å·²ç»æ„å»ºäº†ä¸€ä¸ª Query å¯¹è±¡ï¼Œä½†æ˜¯ä¸ºäº†åé¢å¤ç”¨ï¼Œæ­¤å¤„ equal è¾¹ç•Œæ¡ä»¶çš„å€¼è®¾ç½®ä¸º ""</span></span><br><span class="line">Query&lt;User&gt; query = userBox.query().equal(User_.firstName,<span class="string">""</span>).build();</span><br><span class="line"><span class="comment">// æ¥ä¸‹æ¥å¯ä»¥æ ¹æ®å…·ä½“æƒ…å†µæ”¹å˜å‚æ•°å€¼</span></span><br><span class="line">List&lt;User&gt; joes = query.setParameter(User_.firstName,<span class="string">"Joe"</span>).find();</span><br><span class="line">List&lt;User&gt; jakes = query.setParameter(User_.firstName,<span class="string">"Jake"</span>).find();</span><br></pre></td></tr></table></figure></li>
<li>å¦‚æœæ˜¯å¤šä¸ªè¾¹ç•Œæ¡ä»¶ï¼Œå¯ä»¥åœ¨è¾¹ç•Œæ¡ä»¶åç»™æ¯ä¸€ä¸ªå‚æ•°è®¾ç½®ä¸€ä¸ªåˆ«å</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç»™ equal() æŸ¥è¯¢å‚æ•°è®¾ç½® name åˆ«å</span></span><br><span class="line">Query&lt;User&gt; query = userBox.query().equal(User_.firstName,<span class="string">""</span>).parameterAlias(<span class="string">"name"</span>);</span><br><span class="line"><span class="comment">// ç„¶åå¯ä»¥ä¼ å…¥é”®å€¼å¯¹æ¥ä»£æ›¿å±æ€§</span></span><br><span class="line">List&lt;User&gt; joes = query.setParameter(<span class="string">"name"</span>,<span class="string">"Joe"</span>).find();</span><br></pre></td></tr></table></figure>

<h3 id="Limit-Offset-Pagination"><a href="#Limit-Offset-Pagination" class="headerlink" title="Limit,Offset,Pagination"></a>Limit,Offset,Pagination</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Query&lt;User&gt; query = userBox.query().equal(User_.firstName,<span class="string">"Joe"</span>).build();</span><br><span class="line">List&lt;User&gt; joes = query.find(<span class="comment">/*offset*/</span><span class="number">10</span>,<span class="comment">/*limit*/</span><span class="number">5</span>,<span class="comment">/*results*/</span>);</span><br></pre></td></tr></table></figure>

<h3 id="å»¶è¿ŸåŠ è½½"><a href="#å»¶è¿ŸåŠ è½½" class="headerlink" title="å»¶è¿ŸåŠ è½½"></a>å»¶è¿ŸåŠ è½½</h3><ul>
<li><code>findLazy(),findLazyCached()</code> è¿”å› <code>LazyList</code> æŸ¥è¯¢ç»“æœã€‚</li>
<li><code>LazyList</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸å¯ä¿®æ”¹çš„åªè¯» list,åªæœ‰åœ¨è®¿é—®æ—¶æ‰ä¼šåŠ è½½æ•°æ®ã€‚ç¼“å­˜ LazyList å¯ä»¥ä¿ç•™ä¹‹å‰è®¿é—®è¿‡çš„æ•°æ®ä»¥é¿å…é‡å¤åŠ è½½ã€‚</li>
</ul>
<h3 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h3><p><code>query.remove()</code> åˆ é™¤æ‰€æœ‰åŒ¹é…çš„ç»“æœ</p>
<h3 id="å±æ€§æŸ¥è¯¢"><a href="#å±æ€§æŸ¥è¯¢" class="headerlink" title="å±æ€§æŸ¥è¯¢"></a>å±æ€§æŸ¥è¯¢</h3><p>å¦‚æœåªæƒ³è¿”å›æŸä¸ªæŒ‡å®šå±æ€§çš„å€¼è€Œä¸æ˜¯åŒ¹é…çš„å…¨éƒ¨å¯¹è±¡åˆ—è¡¨ï¼Œé‚£ä¹ˆè¯·ä½¿ç”¨ <code>PropertyQuery</code>.åœ¨æ„å»º query åè°ƒç”¨ <code>property(Property)</code> å³å¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String[] emails = userBox.query().build()</span><br><span class="line">        .property(User_.mail)</span><br><span class="line">        .findStrings();</span><br></pre></td></tr></table></figure>

<ul>
<li><code>findString()</code> è¿”å›ç¬¬ä¸€æ¡ç»“æœï¼Œ<code>findStrings()</code> è¿”å›æ‰€æœ‰ç»“æœ</li>
<li>è¿”å›çš„æ˜¯æ²¡æœ‰æ’åºçš„ç»“æœï¼Œå³ä½¿åœ¨æ„å»º query æ—¶æŒ‡å®šäº†æ’åºè§„åˆ™.</li>
</ul>
<h3 id="å¤„ç†-null-å€¼"><a href="#å¤„ç†-null-å€¼" class="headerlink" title="å¤„ç† null å€¼"></a>å¤„ç† null å€¼</h3><p>é»˜è®¤ä¸è¿”å› null å€¼ã€‚å¦‚æœå±æ€§ä¸º nullï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªæ›¿ä»£è¿”å›å€¼</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœ email ä¸º null,è¿”å› unknown</span></span><br><span class="line">String[] emails = userBox.query()</span><br><span class="line">        .property(UserBox_.mail)</span><br><span class="line">        .nullValue(<span class="string">"unknown"</span>)</span><br><span class="line">        .findStrings();</span><br></pre></td></tr></table></figure>

<h3 id="distinctï¼Œunique"><a href="#distinctï¼Œunique" class="headerlink" title="distinctï¼Œunique"></a>distinctï¼Œunique</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿”å› â€˜joe'</span></span><br><span class="line">String[] names = userBox.query()</span><br><span class="line">        .property(User_.firstName)</span><br><span class="line">        .distinct()</span><br><span class="line">        .findStrings();</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤ strings å¿½ç•¥å¤§å°å†™ã€‚å½“ç„¶å¯ä»¥å®šåˆ¶</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿”å› 'joe' 'Joe' 'JOE'</span></span><br><span class="line">String[] names = userBox.query()</span><br><span class="line">        .property(User_.firstName)</span><br><span class="line">        .distinct(StringOrder.CASE_SENSITIVE)</span><br><span class="line">        .findStrings();</span><br></pre></td></tr></table></figure>

<p>åªæŸ¥è¯¢ä¸€ä¸ªå€¼ï¼Œæ²¡æœ‰åˆ™æŠ›å‡ºå¼‚å¸¸</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String[] names = userBox.query().build().equal(User_.isAdmin, <span class="keyword">true</span>)</span><br><span class="line">    .property(User_.firstName)</span><br><span class="line">    .unique()</span><br><span class="line">    .findStrings();</span><br></pre></td></tr></table></figure>

<ul>
<li>distinct å’Œ unique å¯ä»¥ç»„åˆ</li>
</ul>
<h3 id="ç»Ÿè®¡"><a href="#ç»Ÿè®¡" class="headerlink" title="ç»Ÿè®¡"></a>ç»Ÿè®¡</h3><p>å±æ€§æŸ¥è¯¢åŒæ—¶æä¾›äº†ç»Ÿè®¡å‡½æ•°ã€‚</p>
<ul>
<li><code>min(),minDouble()</code></li>
<li><code>max(),maxDouble()</code></li>
<li><code>sum,sumDouble()</code>: sum() å¯èƒ½æº¢å‡ºå¹¶æŠ›å‡ºå¼‚å¸¸</li>
<li><code>avg()</code>: è¿”å› double</li>
<li><code>count()</code>: æ¯”æŸ¥è¯¢åˆ°å¯¹è±¡åˆ—è¡¨ç„¶åæ±‚åˆ—è¡¨é•¿åº¦è¦å¿«ã€‚å¯ä»¥å’Œ distinct() ç»„åˆ</li>
</ul>
<h3 id="ä¸ºå…³è”å±æ€§æ·»åŠ æŸ¥è¯¢æ¡ä»¶"><a href="#ä¸ºå…³è”å±æ€§æ·»åŠ æŸ¥è¯¢æ¡ä»¶" class="headerlink" title="ä¸ºå…³è”å±æ€§æ·»åŠ æŸ¥è¯¢æ¡ä»¶"></a>ä¸ºå…³è”å±æ€§æ·»åŠ æŸ¥è¯¢æ¡ä»¶</h3><p>åˆ›å»ºå…³è”å±æ€§åï¼Œå¯èƒ½æƒ³ä¸ºåªå­˜åœ¨äºå…³è” entity çš„å±æ€§æ·»åŠ æŸ¥è¯¢æ¡ä»¶ã€‚SQL ä¸­ä½¿ç”¨ JOIN.</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">var</span> id: <span class="built_in">Long</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> name: String? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> address: ToManay&lt;Address&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Address</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">var</span> id: <span class="built_in">Long</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> street: String? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> zip: String? = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æŸ¥è¯¢ä½åœ¨æŒ‡å®šè¡—é“(Address)çš„ xxx(Person)ã€‚å¯ä»¥ä½¿ç”¨<code>link(RelationInfo</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–æ‰€æœ‰åä¸º elmo çš„å¯¹è±¡</span></span><br><span class="line">val builder = box.query().equal(Person_.name,<span class="string">"Elmo"</span>);</span><br><span class="line"><span class="comment">// ä½åœ¨ Sesame è¡—é“</span></span><br><span class="line">builder.link(Person_.address).equal(Address_.street,<span class="string">"Sesame Street"</span>);</span><br><span class="line">val elmosOnSesameStreet = builder.build().find()</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæƒ³è·å–åˆ° Address åˆ—è¡¨å‘¢ï¼Ÿé‚£ä¹ˆå¯ä»¥åœ¨ Address ä¸­æ·»åŠ  @Backlint æ³¨è§£</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Address</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="meta">@Backlint(to = <span class="meta-string">"addresses"</span>)</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> persons: ToMany&lt;Person&gt;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è·å–æ‰€æœ‰ Sesame è¡—é“å¯¹è±¡</span></span><br><span class="line"><span class="keyword">val</span> builder = box.query().equal(Address_.street,<span class="string">"Sesame Street"</span>);</span><br><span class="line"><span class="comment">// åä¸º elmo</span></span><br><span class="line">builder.link(Address_.persons).equal(Person_.name,<span class="string">"Elmo"</span>);</span><br><span class="line"><span class="keyword">val</span> sesameStreetsWithElmo = builder.build().find();</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä¸ç”¨ä¿®æ”¹ Address,ä½¿ç”¨ <code>backlink(RelationInfo)</code> å³å¯å®ç°æŸ¥è¯¢</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> builder = box.query().equal(Address_.street,<span class="string">"Sesame Street"</span>);</span><br><span class="line">builder.backlink(Person_.address).equal(Person_.name,<span class="string">"Elmo"</span>);</span><br><span class="line"><span class="keyword">val</span> sesameStreetWithElmos = builder.build().find();</span><br></pre></td></tr></table></figure>

<h3 id="å…³ç³»å±æ€§çš„æ¿€è¿›åŠ è½½"><a href="#å…³ç³»å±æ€§çš„æ¿€è¿›åŠ è½½" class="headerlink" title="å…³ç³»å±æ€§çš„æ¿€è¿›åŠ è½½"></a>å…³ç³»å±æ€§çš„æ¿€è¿›åŠ è½½</h3><p>é»˜è®¤å…³ç³»å±æ€§æ˜¯æ‡’åŠ è½½çš„ã€‚ç¬¬ä¸€æ¬¡è®¿é—® ToOne ,ToMany å±æ€§æ—¶ä¼šåˆ°æ•°æ®åº“ä¸­æŸ¥è¯¢æ•°æ®ï¼Œç„¶åéƒ½ä¼šä½¿ç”¨ç¼“å­˜è¿‡çš„æ•°æ®ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">val customers = customerBox.query().build().find()</span><br><span class="line">customers[<span class="number">0</span>].orders[<span class="number">0</span>]; <span class="comment">// ç¬¬ä¸€æ¬¡è®¿é—®è§¦å‘æ•°æ®åº“æŸ¥è¯¢</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœæƒ³åœ¨æŸ¥è¯¢ç»“æœè¿”å›æ—¶å®ç°é¢„è¯»å– ToOne,ToMany æ•°æ®,è¯·ä½¿ç”¨ QueryBuilder.eager</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">val customers = customerBox.query()</span><br><span class="line">           .eager(Customer_.orders)</span><br><span class="line">           .build()</span><br><span class="line">           .find();</span><br></pre></td></tr></table></figure>

<p>eager åŠ è½½ä»…æ”¯æŒä¸€å±‚æ·±åº¦ã€‚å¦‚æœæœ‰åµŒå¥—çš„å…³è”å±‚çº§ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ query filter å®ç°ã€‚</p>
<h3 id="query-filters"><a href="#query-filters" class="headerlink" title="query filters"></a>query filters</h3><p>åº”ç”¨äºå¤æ‚çš„è¾¹ç•Œæ¡ä»¶ï¼ŒQueryBuilder ç±»ä¸èƒ½å®ç°ã€‚ä½¿ç”¨å¦‚ä¸‹è§„åˆ™å°†ä¼šéå¸¸é«˜æ•ˆï¼š</p>
<ul>
<li>ä½¿ç”¨æ ‡å‡†çš„æ•°æ®åº“è¾¹ç•Œæ¡ä»¶ç¼©å°ç›®æ ‡èŒƒå›´ã€‚(ä½¿ç”¨ QueryBuilder è·å–ç›®æ ‡)</li>
<li>ç„¶åä½¿ç”¨ QueryFilter è¿‡æ»¤<br>QueryFilter ä¸€æ¬¡æ£€æŸ¥ä¸€ä¸ªç›®æ ‡å¯¹è±¡ï¼Œç¬¦åˆè¿”å› true</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç¼©å°èŒƒå›´</span></span><br><span class="line">songBox.query().equal(Song_.bandId,bandId)</span><br><span class="line">        .filter((song) -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> song.starCount * <span class="number">2</span> &gt; song.downloads;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<p>å…³æ³¨ä¸€ä¸‹æ€§èƒ½:</p>
<ul>
<li>ObjectBox åˆ›å»ºå¯¹è±¡éå¸¸å¿«</li>
<li>è™šæ‹Ÿæœºä¼šå›æ”¶çŸ­æœŸå¯¹è±¡ã€‚<br>æ­¤å¤„å›æ”¶å°†æ¯”åˆ›å»ºå¿«ï¼Œæ‰€ä»¥æ€§èƒ½ä¸æ˜¯é—®é¢˜ã€‚</li>
</ul>
<h4 id="query-filters-å’Œ-ToMany"><a href="#query-filters-å’Œ-ToMany" class="headerlink" title="query filters å’Œ ToMany"></a>query filters å’Œ ToMany</h4><p>ToMany æä¾›äº†å¾ˆå¤šå‡½æ•°å¯ä»¥æ–¹ä¾¿çš„è½¬ä¸º query filters:</p>
<ul>
<li><code>hasA</code></li>
<li><code>hasAll</code></li>
<li><code>getById</code></li>
</ul>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>ObjectBoxå…¥é—¨-9-è®¢é˜…è§‚å¯Ÿ</title>
    <url>/2019/02/25/ObjectBox%E5%85%A5%E9%97%A8-9-%E8%AE%A2%E9%98%85%E8%A7%82%E5%AF%9F/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<h2 id="Data-Observers-Reactive-Extensions"><a href="#Data-Observers-Reactive-Extensions" class="headerlink" title="Data Observers, Reactive Extensions"></a>Data Observers, Reactive Extensions</h2><p>è®¢é˜…è§‚å¯Ÿæ¨¡å¼ï¼ŒRx æ”¯æŒ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Query&lt;Task&gt; query = taskBox.query().equal(Task_.complete,<span class="keyword">false</span>).build();</span><br><span class="line">query.subscribe(subscriptions)</span><br><span class="line">    .on(AndroidScheduler.mainThread())</span><br><span class="line">    .observer(data -&gt; updateUi(data));</span><br></pre></td></tr></table></figure>

<h3 id="Data-Observers"><a href="#Data-Observers" class="headerlink" title="Data Observers"></a>Data Observers</h3><p>å½“æ•°æ®æ”¹å˜æ—¶ï¼ŒObjectBox ä¼šé€šçŸ¥æ‰€æœ‰çš„è®¢é˜…è€….ä»–ä»¬å¯ä»¥è®¢é˜…ç¡®å®šçš„æ•°æ®ç±»å‹(é€šè¿‡ BoxStore)æˆ–æŸ¥è¯¢ç»“æœé›†ã€‚å®ç° <code>io.objectbox.reactive.DataObserver</code> å³å¯åˆ›å»ºè§‚å¯Ÿè€…</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">DataObserver</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onData</span><span class="params">(T data)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">| onData() å¼‚æ­¥è°ƒç”¨ï¼Œä¸ç”¨å…³å¿ƒçº¿ç¨‹</span><br></pre></td></tr></table></figure>

<h4 id="è®¢é˜…æ™®é€šæ”¹å˜"><a href="#è®¢é˜…æ™®é€šæ”¹å˜" class="headerlink" title="è®¢é˜…æ™®é€šæ”¹å˜"></a>è®¢é˜…æ™®é€šæ”¹å˜</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataObserver&lt;Class&lt;Task&gt;&gt; taskObserver = <span class="keyword">new</span> DataObserver&lt;Class&lt;Task&gt;&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onData</span><span class="params">(Class&lt;Note&gt; data)</span></span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line">boxStore.subscribe(Task.class).observer(taskObserver);</span><br><span class="line">| subscribe() ä¼šæ¥å—æ‰€æœ‰å¯ç”¨çš„å¯¹è±¡ç±»å‹æ”¹å˜é€šçŸ¥ã€‚</span><br></pre></td></tr></table></figure>

<h4 id="è®¢é˜…æŸ¥è¯¢"><a href="#è®¢é˜…æŸ¥è¯¢" class="headerlink" title="è®¢é˜…æŸ¥è¯¢"></a>è®¢é˜…æŸ¥è¯¢</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Query&lt;Task&gt; query = taskBox.query().equal(Task_.completed, <span class="keyword">false</span>).build();</span><br><span class="line">subscription = query.subscribe().observer(data -&gt; updateUi(data));</span><br></pre></td></tr></table></figure>

<h4 id="å–æ¶ˆè®¢é˜…"><a href="#å–æ¶ˆè®¢é˜…" class="headerlink" title="å–æ¶ˆè®¢é˜…"></a>å–æ¶ˆè®¢é˜…</h4><p>å½“è°ƒç”¨ observer() æ—¶ï¼Œè¿”å› <code>io.objectbox.reactive.DataSubscription</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">DataSubscription</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCanceled</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataSubscription subscription = boxStore.subscribe().observer(myObserver);</span><br><span class="line"></span><br><span class="line"><span class="comment">// At some later point:</span></span><br><span class="line">subscription.cancel();</span><br></pre></td></tr></table></figure>

<p>é€šå¸¸æƒ…å†µä¸‹å»ºè®®ä½¿ç”¨ DataSubscriptionList</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> DataSubscriptionList subscriptions = <span class="keyword">new</span> DataSubscriptionList();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">super</span>.onStart();</span><br><span class="line">  Query&lt;X&gt; query = box.query()... .build();</span><br><span class="line">  query.subscribe(subscriptions)... .observe(...);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> Â <span class="keyword">super</span>.onStop();</span><br><span class="line">  subscriptions.cancel();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="è®¢é˜…ï¼Œäº‹åŠ¡"><a href="#è®¢é˜…ï¼Œäº‹åŠ¡" class="headerlink" title="è®¢é˜…ï¼Œäº‹åŠ¡"></a>è®¢é˜…ï¼Œäº‹åŠ¡</h4><p>å½“äº‹åŠ¡æäº¤æ—¶å‘å‡ºè®¢é˜…é€šçŸ¥ã€‚å•ç‹¬è°ƒç”¨<code>box.put(),remove()</code> ï¼Œé»˜è®¤çš„äº‹åŠ¡ä¼šå¼€å¯æäº¤ã€‚ä¾‹å¦‚å¦‚ä¸‹å°†è§¦å‘ä¸¤æ¬¡ User.class é€šçŸ¥ï¼›</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">box.put(firendUser);</span><br><span class="line">box.put(myUser);</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ <code>runInTx(),callInTx()</code> å¯ä»¥å°†å¤šä¸ªæ“ä½œåœ¨åŒä¸€ä¸ªåäº”ä¸­æäº¤.å¦‚ä¸Šå¯ä»¥ä¿®æ”¹ä¸º:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">box.put(friendUser,myUser);</span><br></pre></td></tr></table></figure>

<h4 id="å“åº”å¼æ‰©å±•"><a href="#å“åº”å¼æ‰©å±•" class="headerlink" title="å“åº”å¼æ‰©å±•"></a>å“åº”å¼æ‰©å±•</h4><h5 id="çº¿ç¨‹åˆ‡æ¢"><a href="#çº¿ç¨‹åˆ‡æ¢" class="headerlink" title="çº¿ç¨‹åˆ‡æ¢"></a>çº¿ç¨‹åˆ‡æ¢</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Query&lt;Task&gt; query = taskBox.query().equal(Task_.complete, <span class="keyword">false</span>).build();</span><br><span class="line">query.subscribe().on(AndroidScheduler.mainThread()).observer(data -&gt; updateUi(data));</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰ Looper åˆ›å»º AndroidScheduler,æˆ–è€…å®ç° <code>io.objectbox.reactive.Scheduler</code></p>
<ul>
<li>æŸ¥è¯¢åœ¨åå°çº¿ç¨‹æ‰§è¡Œ</li>
<li>DataTransformer è¿è¡Œåœ¨åå°çº¿ç¨‹</li>
<li>DataObserver å’Œ ErrorObserver è¿è¡Œåœ¨åå°çº¿ç¨‹ï¼Œé™¤éé€šè¿‡ on() æŒ‡å®š</li>
</ul>
<h5 id="æ•°æ®è½¬æ¢"><a href="#æ•°æ®è½¬æ¢" class="headerlink" title="æ•°æ®è½¬æ¢"></a>æ•°æ®è½¬æ¢</h5><p>å¦‚ä½•è®¢é˜…å®é™…çš„å¯¹è±¡æ•°é‡:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">boxStore.subscribe()</span><br><span class="line">    .transform(clazz -&gt; <span class="keyword">return</span> boxStore.boxFor(clazz).count())</span><br><span class="line">    .observer(count -&gt; updateCount(count));</span><br></pre></td></tr></table></figure>

<h5 id="å¼‚å¸¸è®¢é˜…"><a href="#å¼‚å¸¸è®¢é˜…" class="headerlink" title="å¼‚å¸¸è®¢é˜…"></a>å¼‚å¸¸è®¢é˜…</h5><p>transformer å¯èƒ½æŠ›å‡ºå„ç§å¼‚å¸¸ï¼ŒDataObserver å¯èƒ½æŠ›å‡º RuntimeException.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ErrorObserver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable th)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ subscribe() åè°ƒç”¨ onError() å³å¯.</p>
<h5 id="ä¸€æ¬¡é€šçŸ¥-vs-æ”¹å˜å³é€šçŸ¥"><a href="#ä¸€æ¬¡é€šçŸ¥-vs-æ”¹å˜å³é€šçŸ¥" class="headerlink" title="ä¸€æ¬¡é€šçŸ¥ vs. æ”¹å˜å³é€šçŸ¥"></a>ä¸€æ¬¡é€šçŸ¥ vs. æ”¹å˜å³é€šçŸ¥</h5><p>å½“è®¢é˜… query åï¼ŒDataObserver å…·æœ‰å¦‚ä¸‹è¡Œä¸ºï¼š</p>
<ul>
<li>åˆå§‹åŒ–æŸ¥è¯¢ç»“æœ(å°±åœ¨è®¢é˜…å)</li>
<li>æ›´æ–°æŸ¥è¯¢ç»“æœ(åœ¨æ•°æ®æ”¹å˜å)</li>
</ul>
<p>æœ‰æ—¶å€™ä»…å¯¹å…¶ä¸­ä¸€ç§è¡Œä¸ºæ„Ÿå…´è¶£.single() å’Œ onlyChange() åº”è¿è€Œç”Ÿ(åœ¨ subscribe() åè°ƒç”¨)<br>single() åªå“åº”ä¸€æ¬¡é€šçŸ¥å³è‡ªåŠ¨å–æ¶ˆã€‚</p>
<h5 id="å¼±å¼•ç”¨"><a href="#å¼±å¼•ç”¨" class="headerlink" title="å¼±å¼•ç”¨"></a>å¼±å¼•ç”¨</h5><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸ºäº†é¿å…å†…å­˜æ³„éœ²ï¼Œé€šå¸¸å°½å¯èƒ½åœ¨ä¸éœ€è¦çš„æ—¶å€™å–æ¶ˆè®¢é˜…ã€‚å½“ç„¶ï¼Œä½ ä¸åœ¨ä¹çš„è¯ï¼Œåœ¨ subscribe() åè°ƒç”¨ weak() ä¹Ÿå¯ä»¥.</p>
<h4 id="ObjectBox-RxJava-æ‰©å±•åº“"><a href="#ObjectBox-RxJava-æ‰©å±•åº“" class="headerlink" title="ObjectBox RxJava æ‰©å±•åº“"></a>ObjectBox RxJava æ‰©å±•åº“</h4><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">implementation <span class="string">"io.objectbox:objectbox-rxjava:$objectboxVersion"</span></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>ObjectBoxé«˜çº§-2-Object IDs</title>
    <url>/2019/02/26/ObjectBox%E9%AB%98%E7%BA%A7-2-Object-IDs/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<p>Object å¿…é¡»å…·æœ‰ä¸€ä¸ªç±»å‹ä¸º <code>long</code> çš„å±æ€§.å½“ç„¶å¯ä»¥ä½¿ç”¨å®ƒçš„åŒ…è£…ç±» <code>java.lang.Long</code>,ä½†æ˜¯ä¸å»ºè®®ä½¿ç”¨åŒ…è£…ç±».<br>å…¶ä»–ç±»å‹çš„ ID ( UID ç­‰)å¯ä»¥è‡ªç”±å®šä¹‰ï¼ŒæŸ¥è¯¢ç­‰æ“ä½œã€‚</p>
<h3 id="news-vs-persisted-entities"><a href="#news-vs-persisted-entities" class="headerlink" title="news vs. persisted entities"></a>news vs. persisted entities</h3><p>å½“åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œè¿˜æ²¡æœ‰å­˜å…¥ï¼Œå®ƒä»¬çš„ ID æ˜¯ 0.ä¸€æ—¦è¯¥å¯¹è±¡å­˜å…¥ï¼ŒObjectBox å°†ä¸ºè¯¥å¯¹è±¡æŒ‡å®š ID.å¯ä»¥é€šè¿‡ <code>put()</code>è¿”å›å€¼æ‹¿åˆ°è¯¥ ID.</p>
<p>æ‰€ä»¥åœ¨ ObjectBox å†…éƒ¨é€šå¸¸æŠŠ ID ä½œä¸ºä¸€ä¸ªçŠ¶æ€æŒ‡ç¤ºå™¨,å¦‚æœä¸º 0 è¡¨ç¤ºæ–°åˆ›å»ºï¼Œä¸ä¸º 0 è¡¨ç¤ºå·²ç»å­˜å‚¨ã€‚å…³è”ç‰¹åˆ«ä¾èµ–è¿™ä¸ªç‰¹æ€§.</p>
<h3 id="ç‰¹æ®Šçš„-Object-IDs"><a href="#ç‰¹æ®Šçš„-Object-IDs" class="headerlink" title="ç‰¹æ®Šçš„ Object IDs"></a>ç‰¹æ®Šçš„ Object IDs</h3><p>Object IDs å¯èƒ½æ˜¯ä»»æ„ <code>long</code> å€¼ï¼Œé™¤äº†ä»¥ä¸‹ä¸¤ç§:</p>
<ul>
<li>0: æˆ–è€…å½“ç±»å‹ä¸º <code>Long</code> æ—¶ä¸º null,è¢«è®¤ä¸ºæ˜¯æ–°åˆ›å»ºï¼Œè¿˜æœªå­˜å‚¨ã€‚<code>put</code>è¿™ä¸ªå¯¹è±¡æ€»æ˜¯ä¼šæ’å…¥ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œå¹¶æŒ‡å®šä¸€ä¸ªæœªä½¿ç”¨è¿‡çš„ ID.</li>
<li>0xFFFFFFFFFFFFFFFF (-1 in Java): ObjectBox ä¿ç•™ã€‚</li>
</ul>
<h3 id="ObjectBox-æŒ‡å®š-ID"><a href="#ObjectBox-æŒ‡å®š-ID" class="headerlink" title="ObjectBox æŒ‡å®š ID"></a>ObjectBox æŒ‡å®š ID</h3><p>å¯¹äºæ¯ä¸€ä¸ªæ–°å¯¹è±¡ï¼ŒObjectBox æŠŠæ¯”å½“å‰ box ä¸­æœ€å¤§çš„ ID å€¼å¤§çš„æœªä½¿ç”¨çš„å€¼æŒ‡å®šç»™æ–°å¯¹è±¡çš„ ID.æ¯”å¦‚ box ä¸­æœ‰ä¸€ä¸ª ID ä¸º 1 å’Œ ID ä¸º 100 çš„å¯¹è±¡ï¼Œé‚£ä¹ˆæ–°åˆ›å»ºå¯¹è±¡çš„ ID å°†ä¸º 101.</p>
<p>é»˜è®¤åªæœ‰ ObjectBox å¯ä»¥æŒ‡å®š ID(ğŸ‘‡ ä»‹ç»).å¦‚æœè¯•å›¾è‡ªå·±å­˜å…¥ä¸€ä¸ª ID æ¯”å½“å‰ ID å€¼æœ€å¤§çš„è¿˜å¤§çš„å¯¹è±¡ï¼ŒObjectBox å°†æŠ›å‡ºé”™è¯¯ã€‚</p>
<h3 id="æ‰‹åŠ¨æŒ‡å®š-IDs"><a href="#æ‰‹åŠ¨æŒ‡å®š-IDs" class="headerlink" title="æ‰‹åŠ¨æŒ‡å®š IDs"></a>æ‰‹åŠ¨æŒ‡å®š IDs</h3><p>å¦‚æœéœ€è¦æ‰‹åŠ¨æŒ‡å®š ID,é‚£ä¹ˆè¯·æ·»åŠ å¦‚ä¸‹æ³¨è§£:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Id</span>(assignable = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">long</span> id;</span><br></pre></td></tr></table></figure>

<p>è¿™å°†ä¼šå…è®¸å­˜å…¥ä»»æ„å€¼ ID çš„å¯¹è±¡ã€‚å½“ç„¶è®¾ç½® ID ä¸º 0 æ—¶ï¼ŒObjectBox å°†åˆ¶å®šæ–° ID</p>
<blockquote>
<p>è‡ªå®šä¹‰ ID ä¼šæ‰“ç ´è‡ªåŠ¨çŠ¶æ€æŒ‡ç¤ºç›‘è§†(new vs. persisted). æ‰€ä»¥åº”è¯¥ç«‹å³å­˜å…¥è¯¥è‡ªå®šä¹‰ ID å¯¹è±¡ï¼Œå¯èƒ½è¿˜å¾—æ‰‹åŠ¨ç»‘å®š boxï¼Œç‰¹åˆ«åœ¨å…³è”çŠ¶å†µä¸‹.</p>
</blockquote>
<h3 id="ID-çš„-String-åˆ«å-è¿˜åœ¨è·¯ä¸Šâ€¦"><a href="#ID-çš„-String-åˆ«å-è¿˜åœ¨è·¯ä¸Šâ€¦" class="headerlink" title="ID çš„ String åˆ«å (è¿˜åœ¨è·¯ä¸Šâ€¦)"></a>ID çš„ String åˆ«å (è¿˜åœ¨è·¯ä¸Šâ€¦)</h3><p>æŸ¥çœ‹ç‰¹æ€§å®ç°è¿›åº¦<a href="https://github.com/objectbox/objectbox-java/issues/167" target="_blank" rel="noopener">String ID alias</a></p>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>ObjectBoxé«˜çº§-1-é…ç½®</title>
    <url>/2019/02/26/ObjectBox%E9%AB%98%E7%BA%A7-1-%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<h3 id="æ‰‹åŠ¨æ·»åŠ ä¾èµ–åº“"><a href="#æ‰‹åŠ¨æ·»åŠ ä¾èµ–åº“" class="headerlink" title="æ‰‹åŠ¨æ·»åŠ ä¾èµ–åº“"></a>æ‰‹åŠ¨æ·»åŠ ä¾èµ–åº“</h3><p>å¦‚æœ ObjectBox æ’ä»¶æ²¡æœ‰è‡ªåŠ¨æ·»åŠ ä¾èµ–åº“å’Œæ³¨è§£å¤„ç†å™¨ï¼Œé‚£ä¹ˆæ‰‹åŠ¨æ·»åŠ ã€‚</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// all below should be added automatically by the plugin</span></span><br><span class="line">    compile <span class="string">"io.objectbox:objectbox-android:$objectboxVersion"</span></span><br><span class="line">    annotationProcessor <span class="string">"io.objectbox:objectbox-processor:$objectboxVersion"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// all below should be added automatically by the plugin</span></span><br><span class="line">    compile <span class="string">"io.objectbox:objectbox-android:$objectboxVersion"</span></span><br><span class="line">    kapt <span class="string">"io.objectbox:objectbox-processor:$objectboxVersion"</span></span><br><span class="line">    <span class="comment">// some useful Kotlin extension functions</span></span><br><span class="line">    compile <span class="string">"io.objectbox:objectbox-kotlin:$objectboxVersion"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ”¹å˜-model-æ–‡ä»¶ä½ç½®"><a href="#æ”¹å˜-model-æ–‡ä»¶ä½ç½®" class="headerlink" title="æ”¹å˜ model æ–‡ä»¶ä½ç½®"></a>æ”¹å˜ model æ–‡ä»¶ä½ç½®</h3><p>é»˜è®¤ model æ–‡ä»¶ä½äº module-name/objectbox-models/default.json.</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        javaCompileOptions &#123;</span><br><span class="line">            annotationProcessorOptions &#123;</span><br><span class="line">                arguments = [ <span class="string">"objectbox.modelPath"</span> : <span class="string">"$projectDir/schemas/objectbox.json"</span>.toString() ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">kapt &#123;</span><br><span class="line">    arguments &#123;</span><br><span class="line">        arg(<span class="string">"objectbox.modelPath"</span>, <span class="string">"$projectDir/schemas/objectbox.json"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ”¹å˜-MyObjectBox-çš„åŒ…å"><a href="#æ”¹å˜-MyObjectBox-çš„åŒ…å" class="headerlink" title="æ”¹å˜ MyObjectBox çš„åŒ…å"></a>æ”¹å˜ MyObjectBox çš„åŒ…å</h3><p>é»˜è®¤ MyObjectBox ç±»åŒ…åå’Œ entity ç±»æˆ–å…¶çˆ¶ç±»çš„åŒ…åç›¸åŒ.</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        javaCompileOptions &#123;</span><br><span class="line">            annotationProcessorOptions &#123;</span><br><span class="line">                arguments = [ <span class="string">"objectbox.myObjectBoxPackage"</span> : <span class="string">"com.example.custom"</span> ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">kapt &#123;</span><br><span class="line">    arguments &#123;</span><br><span class="line">        arg(<span class="string">"objectbox.myObjectBoxPackage"</span>, <span class="string">"com.example.custom"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¼€å¯-debug-æ¨¡å¼"><a href="#å¼€å¯-debug-æ¨¡å¼" class="headerlink" title="å¼€å¯ debug æ¨¡å¼"></a>å¼€å¯ debug æ¨¡å¼</h3><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        javaCompileOptions &#123;</span><br><span class="line">            annotationProcessorOptions &#123;</span><br><span class="line">                arguments = [ <span class="string">'objectbox.debug'</span> : <span class="string">'true'</span> ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">kapt &#123;</span><br><span class="line">    arguments &#123;</span><br><span class="line">        arg(<span class="string">"objectbox.debug"</span>, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="greenDAO-å…¼å®¹"><a href="#greenDAO-å…¼å®¹" class="headerlink" title="greenDAO å…¼å®¹"></a>greenDAO å…¼å®¹</h3><p>æŸ¥çœ‹<a href="https://blog.dang8080.cn/2019/02/24/ObjectBox%E5%85%A5%E9%97%A8-1-%E7%AE%80%E4%BB%8B/#é…ç½®">greenDAO å…¼å®¹é…ç½®</a></p>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>ObjectBoxé«˜çº§-4-entityç»§æ‰¿</title>
    <url>/2019/02/26/ObjectBox%E9%AB%98%E7%BA%A7-4-entity%E7%BB%A7%E6%89%BF/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<p>ObjectBox å…è®¸å­ç±»ç»§æ‰¿ entity çˆ¶ç±»æŒä¹…åŒ–çš„å±æ€§ã€‚åŒæ ·ä¹Ÿæ”¯æŒç»§æ‰¿é entity ç±»ã€‚1.4+ ä¹Ÿæ”¯æŒå¤šç»§æ‰¿.<br>å¯¹äºçˆ¶ç±»æ¥è¯´å¯ä»¥ä½¿ç”¨ @BaseEntity.</p>
<ul>
<li>æ— æ³¨è§£: ç±»æœ¬èº«åŠå…¶å±æ€§ä¸éœ€è¦æŒä¹…åŒ–</li>
<li>@BaseEntity: å±æ€§åœ¨å­ç±»ä¸­æŒä¹…åŒ–ï¼Œç±»æœ¬èº«ä¸æŒä¹…åŒ–</li>
<li>@Entity: å±æ€§åœ¨å­ç±»ä¸­æŒä¹…åŒ–ï¼Œç±»æœ¬èº«ä¹ŸæŒä¹…åŒ–</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// base class:</span></span><br><span class="line"><span class="meta">@BaseEntity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span> <span class="keyword">long</span> id;</span><br><span class="line">    String baseString;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Base</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Base</span><span class="params">(<span class="keyword">long</span> id, String baseString)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.baseString = baseString;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sub class:</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sub</span> <span class="keyword">extends</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String subString;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Sub</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Sub</span><span class="params">(<span class="keyword">long</span> id, String baseString, String subString)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(id, baseString);</span><br><span class="line">        <span class="keyword">this</span>.subString = subString;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// entities inherit properties from entities</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubSub</span> <span class="keyword">extends</span> <span class="title">Sub</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String subSubString;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubSub</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubSub</span><span class="params">(<span class="keyword">long</span> id, String baseString, String subString, String subSubString)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(id, baseString, subString);</span><br><span class="line">        <span class="keyword">this</span>.subSubString = subSubString;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä½¿ç”¨å‰æ³¨æ„"><a href="#ä½¿ç”¨å‰æ³¨æ„" class="headerlink" title="ä½¿ç”¨å‰æ³¨æ„"></a>ä½¿ç”¨å‰æ³¨æ„</h4><ul>
<li>åœ¨ç»§æ‰¿é“¾ä¸­å¯èƒ½å­˜åœ¨ç”± @BaseEntity æ³¨è§£çš„ç±»ï¼Œå®ƒä»¬çš„å±æ€§å°†è¢«å¿½ç•¥ï¼Œä¸ä¼šæˆä¸º entity model çš„ä¸€éƒ¨åˆ†</li>
<li>ä¸æ¨èç»§æ‰¿ä¸€ä¸ªä»…å«æœ‰ ID å±æ€§çš„ base entity ç±».</li>
<li>æŸäº›æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ interface æ›´ç®€å•æ˜äº†</li>
</ul>
<h3 id="é™åˆ¶"><a href="#é™åˆ¶" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h3><ul>
<li>@BaseEntity æ³¨è§£çš„çˆ¶ç±»ä¸èƒ½æˆä¸º library çš„ä¸€éƒ¨åˆ†ã€‚</li>
<li>æ²¡æœ‰å¤šæ€æŸ¥è¯¢(ä¾‹å¦‚æŸ¥è¯¢çˆ¶ç±»å´å¸Œæœ›å¾—åˆ°å­ç±»)</li>
<li>å½“å‰æ— è®ºæ˜¯ @Entity è¿˜æ˜¯ @BaseEntity æ³¨è§£çš„çˆ¶ç±»ï¼Œéƒ½ä¸èƒ½ä½¿ç”¨ ToOne ToMany å…³è”</li>
</ul>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>ObjectBoxé«˜çº§-3-è‡ªå®šä¹‰ç±»å‹</title>
    <url>/2019/02/26/ObjectBox%E9%AB%98%E7%BA%A7-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<p>ObjectBox æ”¯æŒä»¥ä¸‹ç±»å‹ï¼ˆJavaï¼‰:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">boolean</span>, Boolean</span><br><span class="line"><span class="keyword">int</span>, Integer</span><br><span class="line"><span class="keyword">short</span>, Short</span><br><span class="line"><span class="keyword">long</span>, Long</span><br><span class="line"><span class="keyword">float</span>, Float</span><br><span class="line"><span class="keyword">double</span>, Double</span><br><span class="line"><span class="keyword">byte</span>, Byte</span><br><span class="line"><span class="keyword">char</span>, Character</span><br><span class="line"><span class="keyword">byte</span>[]</span><br><span class="line">String</span><br><span class="line">Date</span><br></pre></td></tr></table></figure>

<h3 id="è½¬æ¢å™¨æ³¨è§£å’Œå±æ€§è½¬æ¢"><a href="#è½¬æ¢å™¨æ³¨è§£å’Œå±æ€§è½¬æ¢" class="headerlink" title="è½¬æ¢å™¨æ³¨è§£å’Œå±æ€§è½¬æ¢"></a>è½¬æ¢å™¨æ³¨è§£å’Œå±æ€§è½¬æ¢</h3><p>ä½¿ç”¨ @Convert æ³¨è§£å°†å…¶ä»–ç±»å‹å±æ€§è½¬ä¸ºå†…ç½®å±æ€§ã€‚æ­¤å¤„éœ€è¦æä¾› PropertyConverter å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// enum è½¬ä¸º Integer</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Convert</span>(converter = RoleConverter.class, dbType = Integer.class)</span><br><span class="line">    <span class="keyword">private</span> Role role;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> Role &#123;</span><br><span class="line">        DEFAULT(<span class="number">0</span>), AUTHOR(<span class="number">1</span>), ADMIN(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">        Role(<span class="keyword">int</span> id) &#123;</span><br><span class="line">            <span class="keyword">this</span>.id = id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleConverter</span> <span class="keyword">implements</span> <span class="title">PropertyConverter</span>&lt;<span class="title">Role</span>, <span class="title">Integer</span>&gt;</span>; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Role <span class="title">convertToEntityProperty</span><span class="params">(Integer databaseValue)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (databaseValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (Role role : Role.values()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (role.id == databaseValue) &#123;</span><br><span class="line">                    <span class="keyword">return</span> role;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Role.DEFAULT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">convertToDatabaseValue</span><span class="params">(Role entityProperty)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> entityProperty == <span class="keyword">null</span> ? <span class="keyword">null</span> : entityProperty.id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="more"><a href="#more" class="headerlink" title="more"></a>more</h3><ul>
<li>å¦‚æœæ˜¯åœ¨ entity ç±»ä¸­å®šä¹‰è‡ªå®šä¹‰è½¬æ¢å™¨ï¼Œé‚£ä¹ˆè¯¥è½¬æ¢å™¨åº”è¯¥ä¸º static.</li>
<li>åˆ«å¿˜è®°æ­£ç¡®å¤„ç† null,é€šå¸¸å¦‚æœ input æ˜¯ nullï¼Œä¹Ÿåº”è¿”å› null.</li>
<li>æ¨èä½¿ç”¨åŸºæœ¬æ•°æ®ç±»å‹ï¼Œæ›´æ˜“è½¬æ¢.</li>
<li>ç»å¯¹ä¸èƒ½åœ¨è½¬æ¢å™¨ä¸­è°ƒç”¨æ•°æ®åº“(Box,BoxStore),è½¬æ¢å™¨æ–¹æ³•åœ¨äº‹åŠ¡ä¸­è°ƒç”¨ï¼Œä¾‹å¦‚è¯»å–æˆ–å†™å…¥å¯¹è±¡åˆ° box ä¸­å°†ä¼šå¤±è´¥ã€‚</li>
<li>ä¸ºæé«˜æ€§èƒ½ï¼ŒObjectBox ä½¿ç”¨äº†å¯¹æ‰€æœ‰çš„è½¬æ¢å™¨ä½¿ç”¨äº†å”¯ä¸€ä¸€ä¸ªå®ä¾‹ã€‚è¯·ä¿è¯é™¤é»˜è®¤æ— å‚æ„é€ æ–¹æ³•å¤–æ²¡æœ‰è‡ªå®šä¹‰å…¶ä»–æ„é€ æ–¹æ³•ã€‚åŒæ—¶è¯·ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œåº”ä¸ºåœ¨ multiple entities ä¸­å¯èƒ½æ¶‰åŠåˆ°å¹¶å‘.</li>
</ul>
<h3 id="List-Array-ç±»å‹"><a href="#List-Array-ç±»å‹" class="headerlink" title="List/Array ç±»å‹"></a>List/Array ç±»å‹</h3><p>å¯ä»¥ä½¿ç”¨è½¬æ¢å™¨è½¬æ¢ List ç±»å‹ã€‚ä¾‹å¦‚æŠŠ List<String> è½¬ä¸ºä¸€æ¡ String çš„ JSON æ•°ç»„.<br>å½“å‰ä¸æ”¯æŒ Array è½¬æ¢å™¨.æŸ¥çœ‹ç‰¹æ€§å®ç°è¿›åº¦<a href="https://github.com/objectbox/objectbox-java/issues/42" target="_blank" rel="noopener">Array</a></p>
<h3 id="Enums"><a href="#Enums" class="headerlink" title="Enums"></a>Enums</h3><p>æœ€ä½³å®è·µ:</p>
<ul>
<li>ä¸è¦æŒä¹…åŒ– enum çš„ ordinal æˆ– name: äºŒè€…éƒ½ä¸ç¨³å®šï¼Œä¸”åœ¨ä¸‹æ¬¡ä½ ä¿®æ”¹ enum å®šä¹‰æ—¶ä¼šæ”¹å˜</li>
<li>ä½¿ç”¨ç¨³å®šçš„ ids: åœ¨ enum ä¸­å®šä¹‰è‡ªå®šä¹‰å±æ€§(integer,string) éƒ½å¯ä»¥ä¿è¯ç¨³å®šã€‚ä½¿ç”¨è¯¥ç‰¹æ€§ä½œä¸ºä½ çš„æŒä¹…åŒ–æ˜ å°„.</li>
<li>å‡†å¤‡å¥½åº”å¯¹æœªçŸ¥: å®šä¹‰ä¸€ä¸ª UNKNOWN çš„ enmu å€¼ã€‚å¯ä»¥åº”å¯¹ null æˆ– unknown å€¼çš„æƒ…å†µã€‚ä¾‹å¦‚å¯ä»¥ç¡®ä¿å·²ç»è¢«ç§»é™¤çš„ enum å€¼ä¸ä¼šå¯¼è‡´ App å´©æºƒ.</li>
</ul>
<h3 id="æŸ¥è¯¢æ—¶çš„è‡ªå®šä¹‰ç±»å‹"><a href="#æŸ¥è¯¢æ—¶çš„è‡ªå®šä¹‰ç±»å‹" class="headerlink" title="æŸ¥è¯¢æ—¶çš„è‡ªå®šä¹‰ç±»å‹"></a>æŸ¥è¯¢æ—¶çš„è‡ªå®šä¹‰ç±»å‹</h3><p><code>QueryBuilder</code> æ˜¯ä¸å…³å¿ƒè‡ªå®šç±»å‹çš„ã€‚è¯·ä½¿ç”¨å†…ç½®ç±»å‹æŸ¥è¯¢ã€‚</p>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>ObjectBoxé«˜çº§-6-å…ƒæ¨¡å‹,IDs,UIDs</title>
    <url>/2019/02/26/ObjectBox%E9%AB%98%E7%BA%A7-6-%E5%85%83%E6%A8%A1%E5%9E%8B-IDs-UIDs/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<p>ä¸åƒ SQLite è¿™æ ·çš„æ•°æ®åº“ï¼ŒObjectBox ä¸éœ€è¦ä½ åˆ›å»º database schema.è¿™ä¸æ„å‘³ç€ ObjectBox æ˜¯æ—  schema çš„ã€‚ä¸ºé«˜æ•ˆèµ·è§ï¼ŒObjectBox å¯¹å­˜å‚¨çš„æ•°æ®ç»´æŠ¤äº†ä¸€ä¸ªå…ƒæ¨¡å‹(meta model)ã€‚æ­¤å…ƒæ¨¡å‹å®é™…ä¸Šç­‰ä»·äº ObjectBox çš„ schema.å®ƒåŒ…å«äº†æ‰€æœ‰å±æ€§çš„ç±»å‹ã€indexes ç­‰.ä¸åŒä¹‹å¤„åœ¨äº ObjectBox è¯•å›¾è‡ªåŠ¨ç®¡ç†è¯¥å…ƒæ¨¡å‹.æŸäº›æƒ…å†µä¸‹ï¼Œè¿™éœ€è¦ä½ å¸®å¿™.</p>
<blockquote>
<p>Object çš„ IDs æ˜¯ @Id å®šä¹‰çš„ï¼Œè€Œ æ‰€æœ‰ entity ç±»å‹çš„å®ä¾‹éƒ½ç»‘å®šä¸€ä¸ª meta model ID.</p>
</blockquote>
<h3 id="JSON-for-consistent-IDs"><a href="#JSON-for-consistent-IDs" class="headerlink" title="JSON for consistent IDs"></a>JSON for consistent IDs</h3><p>ObjectBox æŠŠä¸€éƒ¨åˆ†å…ƒæ¨¡å‹ä¿å­˜åœ¨ JSON æ–‡ä»¶ä¸­.<strong>æ­¤æ–‡ä»¶åº”è¯¥é€šè¿‡ç‰ˆæœ¬æ§åˆ¶è½¯ä»¶ç®¡ç†</strong>,ä¸»è¦åŸå› æ˜¯ï¼šå®ƒå¯ä»¥ä¿è¯ å…ƒæ¨¡å‹é‡Œçš„ IDs å’Œ UIDs è·¨è®¾å¤‡ä¸€è‡´.</p>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>ObjectBoxå…¥é—¨-6-Javaæ¡Œé¢åº”ç”¨.md</title>
    <url>/2019/02/24/ObjectBox%E5%85%A5%E9%97%A8-6-Java%E6%A1%8C%E9%9D%A2%E5%BA%94%E7%94%A8/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<h2 id="Java-æ¡Œé¢åº”ç”¨"><a href="#Java-æ¡Œé¢åº”ç”¨" class="headerlink" title="Java æ¡Œé¢åº”ç”¨"></a>Java æ¡Œé¢åº”ç”¨</h2><h3 id="åµŒå…¥å¼æ•°æ®åº“"><a href="#åµŒå…¥å¼æ•°æ®åº“" class="headerlink" title="åµŒå…¥å¼æ•°æ®åº“"></a>åµŒå…¥å¼æ•°æ®åº“</h3><p>ObjectBox ä¸ä»…ä»…é€‚ç”¨äº Android é¡¹ç›®ï¼ŒåŒæ—¶ä¹Ÿé€‚ç”¨äºè¿è¡Œåœ¨ Windows Linux macOS ä¸Šçš„çº¯ Java(JVM) æ¡Œé¢åº”ç”¨.</p>
<h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>è¯·ä½¿ç”¨ Gradle ä½œä¸ºæ„å»ºå·¥å…·ï¼Œå› ä¸º ObjectBox ä½¿ç”¨äº† Gradle æ’ä»¶.</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    ext.objectboxVersion = <span class="string">'2.3.3'</span></span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">        maven&#123; url <span class="string">"https://plugins.gradle.org/m2/"</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">"net.ltgt.gradle:gradle-apt-plugin:0.20"</span></span><br><span class="line">        classpath <span class="string">"io.objectbox:objectbox-gradle-plugin:$objectboxVersion"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">repositories &#123;</span><br><span class="line">    jcenter()</span><br><span class="line">&#125;</span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'java'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'net.ltgt.apt-idea'</span> <span class="comment">// æ³¨è§£å¤„ç†å™¨æ’ä»¶</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'io.objectbox'</span></span><br></pre></td></tr></table></figure>

<h3 id="Native-åº“"><a href="#Native-åº“" class="headerlink" title="Native åº“"></a>Native åº“</h3><p>ObjectBox æ˜¯ç”± C/C++å†™æˆçš„å¯ä»¥è¿è¡Œå¤§å¤šæ•° native code çš„å¯¹è±¡æ•°æ®åº“ã€‚</p>
<h3 id="æ”¹å˜-Model-æ–‡ä»¶ä½ç½®"><a href="#æ”¹å˜-Model-æ–‡ä»¶ä½ç½®" class="headerlink" title="æ”¹å˜ Model æ–‡ä»¶ä½ç½®"></a>æ”¹å˜ Model æ–‡ä»¶ä½ç½®</h3><p>é»˜è®¤ model æ–‡ä»¶å­˜å‚¨åœ¨ <code>module-name/objectbox-models/default.json</code>.å¯ä»¥é€šè¿‡ä¿®æ”¹ objectbox.modelPath æ¥æ”¹å˜</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åœ¨é¡¹ç›® build.gradle æ–‡ä»¶ï¼Œ apply plugin: 'java' ä¹‹åæ·»åŠ </span></span><br><span class="line">tasks.withType(JavaCompile) &#123;</span><br><span class="line">    options.compilerArgs += [<span class="string">"-Aobjectbox.modelPath=$projectDir/schemas/object.json]</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="æ”¹å˜-MyObjectBox-åŒ…å"><a href="#æ”¹å˜-MyObjectBox-åŒ…å" class="headerlink" title="æ”¹å˜ MyObjectBox åŒ…å"></a>æ”¹å˜ MyObjectBox åŒ…å</h3><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">tasks.withType(JavaCompile) &#123;</span><br><span class="line">    options.compilerArgs += [ <span class="string">"-Aobjectbox.modelPath=$projectDir/schemas/objectbox.json"</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¼€å¯-debug-æ¨¡å¼"><a href="#å¼€å¯-debug-æ¨¡å¼" class="headerlink" title="å¼€å¯ debug æ¨¡å¼"></a>å¼€å¯ debug æ¨¡å¼</h3><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// enable debug output for plugin</span></span><br><span class="line">objectbox &#123;</span><br><span class="line">    debug <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// enable debug output for annotation processor</span></span><br><span class="line">tasks.withType(JavaCompile) &#123;</span><br><span class="line">    options.compilerArgs += [ <span class="string">"-Aobjectbox.debug=true"</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å¯ä»¥ä½¿ç”¨-BoxStore-builder-çš„-name-String-æ¥æ”¹å˜æ•°æ®åº“å­˜å‚¨çš„ä½ç½®ã€‚"><a href="#å¯ä»¥ä½¿ç”¨-BoxStore-builder-çš„-name-String-æ¥æ”¹å˜æ•°æ®åº“å­˜å‚¨çš„ä½ç½®ã€‚" class="headerlink" title="å¯ä»¥ä½¿ç”¨ BoxStore builder çš„ name(String) æ¥æ”¹å˜æ•°æ®åº“å­˜å‚¨çš„ä½ç½®ã€‚"></a>å¯ä»¥ä½¿ç”¨ BoxStore builder çš„ name(String) æ¥æ”¹å˜æ•°æ®åº“å­˜å‚¨çš„ä½ç½®ã€‚</h4><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h3><p>æ·»åŠ  junit 4 åº“</p>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>Podman</title>
    <url>/2019/08/13/Podman/</url>
    <content><![CDATA[<p>Podman æ˜¯ä»€ä¹ˆ? Podman æ˜¯ä¸€ä¸ªéå®ˆæŠ¤çº¿ç¨‹çš„å®¹å™¨å¼•æ“,æ”¯æŒåœ¨ Linux ç³»ç»Ÿä¸Šå¼€å‘ã€ç®¡ç†å’Œè¿è¡Œ OCI å®¹å™¨.å®¹å™¨åŒæ—¶æ”¯æŒ root èº«ä»½å’Œé root èº«ä»½.åªéœ€è¦ä½¿ç”¨ <code>alias docker=podman</code> å°±å¯ä»¥ç«‹å³ä» docker åˆ‡æ¢åˆ° podman.</p>
<a id="more"></a>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><ul>
<li>Arch Linux &amp; Manjaro Linux<br><code>sudo pacman -S podman</code></li>
<li>Fedora,CentOS<br><code>sudo yum -y install podman</code></li>
<li>Fedora-CoreOS,Fedora SilverBlue<br>å†…ç½®æ— éœ€å®‰è£…</li>
<li>Gentoo<br><code>sudo emerge app-emulation/libpod</code></li>
<li>MacOS<br><code>brew cask install podman</code></li>
<li>openSUSE<br><code>sudo zypper install podman</code></li>
<li>openSUSE Kubic<br>å†…ç½®æ— éœ€å®‰è£…</li>
<li>RHEL7<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo subcription-manager repos --enable&#x3D;rhel-7-server-extras-rpms</span><br><span class="line">sudo yum -y install podman</span><br></pre></td></tr></table></figure></li>
<li>RHEL8 Beta<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo yum module enable -y contianer-tools:1.0</span><br><span class="line">sudo yum module install-y container-tools:1.0</span><br></pre></td></tr></table></figure></li>
<li>Ubuntu<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get update -qq</span><br><span class="line">sudo apt-get install -qq -y software-properties-common uidmap</span><br><span class="line">sudo add-apt-repository -y ppa:projectatomic&#x2F;ppa</span><br><span class="line">sudo apt-get update -qq</span><br><span class="line">sudo apt-get -qq -y install podman</span><br></pre></td></tr></table></figure>
<h2 id="å¼€å§‹"><a href="#å¼€å§‹" class="headerlink" title="å¼€å§‹"></a>å¼€å§‹</h2>Podman ç”± libpod åº“æä¾›çš„ä¸€ä¸ªå·¥å…·.å¯ä»¥ç”¨æ¥åˆ›å»ºç»´æŠ¤å®¹å™¨.ä¸‹é¢çš„æŒ‡å—å°†å¸¦ä½ å¦‚ä½•è®¾ç½® Podman å¹¶å®ç°ä¸€äº›åŸºæœ¬å‘½ä»¤.<h3 id="è¿è¡Œç¤ºä¾‹å®¹å™¨"><a href="#è¿è¡Œç¤ºä¾‹å®¹å™¨" class="headerlink" title="è¿è¡Œç¤ºä¾‹å®¹å™¨"></a>è¿è¡Œç¤ºä¾‹å®¹å™¨</h3><figure class="highlight plain"><figcaption><span>run -dt -p 8080:8080/tcp -e HTTPD_VAR_RUN</span></figcaption><table><tr><td class="code"><pre><span class="line">-e HTTPD_MAIN_CONF_PATH&#x3D;&#x2F;etc&#x2F;httpd&#x2F;conf \</span><br><span class="line">-e HTTPD_CONTAINER_SCRIPTS_PATH&#x3D;&#x2F;usr&#x2F;share&#x2F;container-scripts&#x2F;httpd&#x2F; \</span><br><span class="line">registry.fedoraproject.org&#x2F;f27&#x2F;httpd &#x2F;usr&#x2F;bin&#x2F;run-httpd</span><br></pre></td></tr></table></figure>
ä¸Šé¢çš„å®¹å™¨å°†å¼€å¯ä¸€ä¸ªåŸºæœ¬çš„ http server.ç”±äºæ­¤å®¹å™¨æ˜¯ä»¥ detached æ¨¡å¼è¿è¡Œ,ç”± podman run å‘½ä»¤ -d flag è¡¨ç¤º,æ‰€ä»¥ Podman åœ¨å¯åŠ¨è¿è¡Œåä»…è¾“å‡ºå®¹å™¨ ID.ç„¶åå°±å¯ä»¥è®¿é—®è¯¥ http serveräº†.<h3 id="åˆ—å‡ºæ­£åœ¨è¿è¡Œçš„å®¹å™¨"><a href="#åˆ—å‡ºæ­£åœ¨è¿è¡Œçš„å®¹å™¨" class="headerlink" title="åˆ—å‡ºæ­£åœ¨è¿è¡Œçš„å®¹å™¨"></a>åˆ—å‡ºæ­£åœ¨è¿è¡Œçš„å®¹å™¨</h3><code>podman ps</code><br><code>podman ps -a</code> åˆ—å‡ºæ‰€æœ‰çš„å®¹å™¨</li>
</ul>
]]></content>
      <tags>
        <tag>container</tag>
      </tags>
  </entry>
  <entry>
    <title>Room &amp; kotlin coroutine</title>
    <url>/2019/03/03/Room-kotlin-coroutine/</url>
    <content><![CDATA[<p>room kotlin coroutine</p>
<a id="more"></a>
<h4 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h4><p>Room 2.1 å¼€å§‹æ”¯æŒ Kotlin åç¨‹ã€‚DAO æ–¹æ³•å¯ä»¥ä½¿ç”¨ suspend æ ‡è®°ä»¥ç¡®ä¿è¿™äº›æ–¹æ³•ä¸ä¼šåœ¨ä¸»çº¿ç¨‹ä¸­è¢«æ‰§è¡Œã€‚<br>Room ä½¿ç”¨ <code>Executor</code>(æ¥è‡ªæ¡†æ¶ç»„ä»¶) ä½œä¸º <code>Dispatcher</code> è¿è¡Œ SQL è¯­å¥ï¼Œå½“ç„¶åœ¨ç¼–è¯‘ <code>RoomDatabase</code> æ—¶ï¼Œä½ ä¹Ÿå¯ä»¥æä¾›è‡ªå·±çš„ <code>Executor</code>.</p>
<blockquote>
<p>å½“å‰åç¨‹æ”¯æŒæ­£åœ¨å¼€å‘ä¸­ï¼Œæ›´å¤šç‰¹æ€§æ­£åœ¨è®¡åˆ’ä¸­</p>
</blockquote>
<h3 id="æ·»åŠ ä¾èµ–"><a href="#æ·»åŠ ä¾èµ–" class="headerlink" title="æ·»åŠ ä¾èµ–"></a>æ·»åŠ ä¾èµ–</h3><p>è¯·å‡çº§ Room åˆ° v2.1, åŒæ—¶ Kotlin v1.3.0+ , Coroutines v1.0.0+</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">implementation <span class="string">"androidx.room:room-coroutines:$&#123;versions.room&#125;"</span></span><br></pre></td></tr></table></figure>

<p>ç°åœ¨å°±å¯ä»¥ä½¿ç”¨å•¦</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Dao</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">UsersDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Query(<span class="meta-string">"SELECT * FROM users"</span>)</span></span><br><span class="line">    <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">getUsers</span><span class="params">()</span></span>: List&lt;User&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Query(<span class="meta-string">"UPDATE users SET age = age + 1 WHERE userId = :userId)</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">    suspend fun incrementUserAge(userId: String)</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"></span></span></span><br><span class="line"><span class="meta"><span class="meta-string">    @Insert</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">    suspend fun insertUser(user: User)</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"></span></span></span><br><span class="line"><span class="meta"><span class="meta-string">    @Update</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">    suspend fun updateUser(user: User)</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"></span></span></span><br><span class="line"><span class="meta"><span class="meta-string">    @Delete</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">    suspend fun deleteUser(user: User)</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">&#125;</span></span></span><br></pre></td></tr></table></figure>

<p>åœ¨è°ƒç”¨å…¶ä»– suspending DAO å‡½æ•°æ—¶ï¼Œ@Transaction ä¹Ÿå¯ä»¥è¢« suspending</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Dao</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersDao</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Transaction</span></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">setLoggedInUser</span><span class="params">(loggedInUser: <span class="type">user</span>)</span></span> &#123;</span><br><span class="line">        deleteUser(loggedInUser)</span><br><span class="line">        insertUser(loggedInUser)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Query(<span class="meta-string">"DELETE FROM users"</span>)</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">deleteUser</span><span class="params">(user: <span class="type">User</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">insertUser</span><span class="params">(user: <span class="type">User</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®æ˜¯å¦åœ¨ transaction å†…è°ƒç”¨ï¼ŒRoom å¯¹ suspending å‡½æ•°å¤„ç†é€»è¾‘ä¸åŒ.</p>
<ul>
<li>åœ¨ Transaction ä¸­<blockquote>
<p>åœ¨æ•°æ®åº“è¯­å¥è¢«è§¦å‘çš„ CoroutineContext ä¸‹ï¼ŒRoom ä¸åšä»»ä½•å¤„ç†ã€‚å‡½æ•°è°ƒç”¨è€…åº”è¯¥ç¡®ä¿æ­¤æ–¹æ³•ä¸ä¼šåœ¨ UI çº¿ç¨‹ä¸­æ‰§è¡Œ.å› ä¸º suspend å‡½æ•°åªèƒ½è¢«å…¶ä»– suspend å‡½æ•° æˆ–åœ¨ coroutine å†…è°ƒç”¨ï¼Œæ‰€ä»¥ä½ ä¸èƒ½æŠŠ Dispatchers.Main èµ‹å€¼ç»™ Dispatcherï¼Œåº”è¯¥æ˜¯ Dispatchers.IO æˆ–è‡ªå®šä¹‰</p>
</blockquote>
</li>
<li>ä¸åœ¨ Transaction ä¸­<blockquote>
<p>Room ä¼šç¡®ä¿æ•°æ®åº“è¯­å¥åœ¨ <code>Architecutre Components I/O Dispatcher</code> ä¸­è§¦å‘ã€‚è¯¥ Dispatcher åœ¨åŒä¸€ä¸ª I/O Executor çš„ä¸€ä¸ªåå°çº¿ç¨‹ä¸­è¿è¡Œ LiveData</p>
</blockquote>
</li>
</ul>
<h3 id="åº•å±‚"><a href="#åº•å±‚" class="headerlink" title="åº•å±‚"></a>åº•å±‚</h3><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Insert</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">insertUserSync</span><span class="params">(user: <span class="type">User</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Insert</span></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">insertUser</span><span class="params">(user: <span class="type">User</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>å¯¹äºåŒæ­¥ insert,ç”Ÿæˆçš„ä»£ç å¼€å§‹å¯åŠ¨ä¸€ä¸ª transaction,ç„¶åæ‰§è¡Œ insert,æ ‡è®° transaction successfull ï¼Œç»ˆç»“ã€‚<br>åŒæ­¥æ–¹æ³•åœ¨è¢«è°ƒç”¨å¤„çš„çº¿ç¨‹æ‰§è¡Œ.</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> void insertUserSync(<span class="keyword">final</span> User user) &#123;</span><br><span class="line">  __db.beginTransaction();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    __insertionAdapterOfUser.insert(user);</span><br><span class="line">    __db.setTransactionSuccessful();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    __db.endTransaction();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>suspending ä¼šç¡®ä¿ä¸ä¼šåœ¨ UI çº¿ç¨‹ä¸­æ‰§è¡Œã€‚ç”Ÿæˆçš„ä»£ç ä¼šä¼ é€’ä¸€ä¸ª Continuation.åœ¨ <code>Callable#call()</code> ä¸­æ‰§è¡Œå’ŒåŒæ­¥ç›¸åŒçš„ä»£ç </p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object insertUserSuspend(<span class="keyword">final</span> User user,</span><br><span class="line">    <span class="keyword">final</span> Continuation&lt;? <span class="keyword">super</span> <span class="built_in">Unit</span>&gt; p1) &#123;</span><br><span class="line">  <span class="keyword">return</span> CoroutinesRoom.execute(__db, new Callable&lt;<span class="built_in">Unit</span>&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">Unit</span> call() throws Exception &#123;</span><br><span class="line">      __db.beginTransaction();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        __insertionAdapterOfUser.insert(user);</span><br><span class="line">        __db.setTransactionSuccessful();</span><br><span class="line">        <span class="keyword">return</span> kotlin.<span class="built_in">Unit</span>.INSTANCE;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        __db.endTransaction();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, p1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CoroutinesRoom.execute</code> ä¼šæ ¹æ®æ•°æ®åº“æ˜¯å¦ open,å½“å‰è°ƒç”¨æ˜¯å¦åœ¨ transaction å†…æ¥åˆ‡æ¢å¤„ç† context.</p>
<ul>
<li>is open &amp; in transaction<blockquote>
<p>ä»…è°ƒç”¨ insert é€»è¾‘</p>
</blockquote>
</li>
<li>not in transaction<blockquote>
<p>ä½¿ç”¨ <code>Architecture Components IO Executor</code> åœ¨åå°çº¿ç¨‹æ‰§è¡Œ insert é€»è¾‘</p>
</blockquote>
</li>
</ul>
]]></content>
      <tags>
        <tag>æ•°æ®åº“</tag>
        <tag>Room</tag>
        <tag>Kotlin</tag>
        <tag>Kotlin åç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>dart-build tool</title>
    <url>/2019/12/20/dart-build-tool/</url>
    <content><![CDATA[<p>build-tool</p>
<a id="more"></a>

<h3 id="ä½¿ç”¨-build-runner-ä½œä¸ºå¼€å‘æœåŠ¡"><a href="#ä½¿ç”¨-build-runner-ä½œä¸ºå¼€å‘æœåŠ¡" class="headerlink" title="ä½¿ç”¨ build_runner ä½œä¸ºå¼€å‘æœåŠ¡"></a>ä½¿ç”¨ <code>build_runner</code> ä½œä¸ºå¼€å‘æœåŠ¡</h3><p>1ã€åœ¨ <code>pubspec.yaml</code>ä¸­æ·»åŠ <code>build_runner</code>å’Œ<code>build_web_compilers</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">environment:</span></span><br><span class="line"><span class="attr">  sdk:</span> <span class="string">'&gt;=2.0.0 &lt;3.0.0'</span></span><br><span class="line"><span class="attr">dev_dependencies:</span></span><br><span class="line"><span class="attr">  build_runner:</span> <span class="string">^1.0.0</span></span><br><span class="line"><span class="attr">  build_web_compilers:</span> <span class="string">^0.4.0</span></span><br></pre></td></tr></table></figure>
<p>2ã€ä¸‹è½½ä¾èµ–</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pub get</span><br></pre></td></tr></table></figure>
<p>3ã€å¯åŠ¨æœåŠ¡</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pub run build_runner serve</span><br></pre></td></tr></table></figure>
<p>æœåŠ¡å¯åŠ¨å,æ¯æ¬¡ä¿å­˜æ“ä½œéƒ½ä¼šè§¦å‘é‡æ–°æ„å»º.</p>
<h3 id="åˆ›å»ºè¾“å‡ºæ–‡ä»¶å¤¹"><a href="#åˆ›å»ºè¾“å‡ºæ–‡ä»¶å¤¹" class="headerlink" title="åˆ›å»ºè¾“å‡ºæ–‡ä»¶å¤¹"></a>åˆ›å»ºè¾“å‡ºæ–‡ä»¶å¤¹</h3><p>ä½¿ç”¨<code>--output &lt;directory name&gt;</code>é€‰é¡¹æ„å»º,å°†å†…éƒ¨å¼•ç”¨ URL åŒ¹é…çš„æ–‡ä»¶è·¯å¾„å’Œ<code>directory name</code>åˆå¹¶ä½œä¸ºè¾“å‡ºç›®å½•,å°†æ–‡ä»¶å†™å…¥.<br>æ­¤é€‰é¡¹å¯ä»¥åœ¨<code>build,watch,serve</code>å‘½ä»¤ä¸­ä½¿ç”¨.å¦‚æœæ²¡æœ‰ä½¿ç”¨ <code>serve</code>å‘½ä»¤æ—¶,æ­¤ç›®å½•åŒæ—¶è¢«å¦ä¸€ä¸ªä¸åŒçš„ server ä½¿ç”¨.<br>å¦‚æœåªæƒ³è¾“å‡ºåŒ…çš„ä¸€éƒ¨åˆ†,æ¯”å¦‚<code>web</code>ç›®å½•,å¯ä»¥ä½¿ç”¨<code>--output web:&lt;directory name&gt;</code>.</p>
<h3 id="ä½¿ç”¨å…¶ä»–-build-runner-å‘½ä»¤"><a href="#ä½¿ç”¨å…¶ä»–-build-runner-å‘½ä»¤" class="headerlink" title="ä½¿ç”¨å…¶ä»– build_runner å‘½ä»¤"></a>ä½¿ç”¨å…¶ä»– <code>build_runner</code> å‘½ä»¤</h3><ul>
<li><code>build</code>: æ‰§è¡Œå•ç‹¬æ„å»ºç„¶åé€€å‡º.å¦‚æœä½ çš„æ„å»ºä¼šæŠŠäº§ç‰©è¾“å‡ºåˆ°æºç æ–‡ä»¶ä¸­ä¼šå¾ˆæœ‰ç”¨.ä½¿ç”¨<code>--output &lt;dirname&gt;</code> å¯ä»¥å°†æ‰€æœ‰çš„æºå’Œç”Ÿæˆçš„äº§ç‰©è¾“å‡ºåˆ°åˆå¹¶ç›®å½•ä¸­.</li>
<li><code>watch</code>: ç±»ä¼¼ <code>build</code>,ä½†æ˜¯åœ¨æ–‡ä»¶æ”¹å˜æ—¶è¿”å›.ä½¿ç”¨<code>--output &lt;dirname&gt;</code>å°†æ•°æ®çš„æ”¹å˜ä¿å­˜åˆ°åˆå¹¶çš„ç›®å½•ä¸­.å¯ä»¥ä¿æŒè¾“å‡ºæŒç»­æ›´æ–°å’Œå…¶ä»–åŸºäºæ–‡ä»¶çš„å¼€å‘æœåŠ¡å™¨é…åˆä½¿ç”¨.</li>
<li><code>test</code>: åˆ›å»ºè¾“å‡ºç›®å½•ç„¶åè¿è¡Œ<code>pub run test</code>.æ­¤å‘½ä»¤éœ€è¦ <code>dev dependency</code>ä¸­æœ‰<code>build_test</code>ä¾èµ–.</li>
</ul>
<h3 id="åˆ‡æ¢åˆ°-dart2js"><a href="#åˆ‡æ¢åˆ°-dart2js" class="headerlink" title="åˆ‡æ¢åˆ° dart2js"></a>åˆ‡æ¢åˆ° dart2js</h3><p>é»˜è®¤æƒ…å†µä¸‹ <code>build_web_compilers</code>ä½¿ç”¨<code>dartdevc</code>.å¦‚æœéœ€è¦åˆ‡æ¢åˆ° dart2js,åœ¨ <code>pub run build_runner build/serve</code>åä¼ é€’<code>--release</code>é€‰é¡¹.åœ¨<code>build.yaml</code>æ–‡ä»¶ä¸­é…ç½®.</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">targets:</span></span><br><span class="line">  <span class="string">$default:</span></span><br><span class="line"><span class="attr">    builders:</span></span><br><span class="line">      <span class="string">build_web_compilers|entrypoint:</span></span><br><span class="line"><span class="attr">        optioins:</span></span><br><span class="line"><span class="attr">          dart2js_args:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--minify</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--fast_startup</span></span><br></pre></td></tr></table></figure>

<h2 id="build-yaml-æ ¼å¼"><a href="#build-yaml-æ ¼å¼" class="headerlink" title="build.yaml æ ¼å¼"></a><code>build.yaml</code> æ ¼å¼</h2><p><code>build.yaml</code> æ–‡ä»¶æŒ‰ç…§ <code>BuildConfig</code>å¯¹è±¡é…ç½®.</p>
<h3 id="BuildConfig"><a href="#BuildConfig" class="headerlink" title="BuildConfig"></a>BuildConfig</h3><table>
<thead>
<tr>
<th>key</th>
<th>value</th>
<th>default</th>
</tr>
</thead>
<tbody><tr>
<td><code>targets</code></td>
<td><code>Map&lt;String,BuildTarget&gt;</code></td>
<td>a single target with the same name as the package</td>
</tr>
</tbody></table>
]]></content>
  </entry>
  <entry>
    <title>flutter å­¦ä¹ ç¬”è®°</title>
    <url>/2019/06/04/flutter-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<p>flutter çš„æ ¸å¿ƒè®¾è®¡æ˜¯å°†æ•´ä¸ªåº”ç”¨çš„å„ä¸ªéƒ¨åˆ†å„ä¸ªå±‚çº§éƒ½çœ‹ä½œ Widget æ¥æ¸²æŸ“,æ‰€ä»¥æŒ‰ç…§ Widget çš„åˆ†ç±»æ¥å­¦ä¹ ä¼šæ¯”è¾ƒå…¨é¢ã€‚</p>
<a id="more"></a>
<h2 id="åŸºç¡€ç»„ä»¶"><a href="#åŸºç¡€ç»„ä»¶" class="headerlink" title="åŸºç¡€ç»„ä»¶"></a>åŸºç¡€ç»„ä»¶</h2><h3 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h3><ul>
<li>Row</li>
<li>Column</li>
<li>Image</li>
<li>Text</li>
<li>Icon</li>
<li>RaisedButton</li>
<li>Scaffold</li>
<li>AppBar</li>
<li>FlutterLogo</li>
<li>Placeholder</li>
</ul>
<h2 id="Material-ç»„ä»¶"><a href="#Material-ç»„ä»¶" class="headerlink" title="Material ç»„ä»¶"></a>Material ç»„ä»¶</h2><h3 id="ç»“æ„å’Œå¯¼èˆª"><a href="#ç»“æ„å’Œå¯¼èˆª" class="headerlink" title="ç»“æ„å’Œå¯¼èˆª"></a>ç»“æ„å’Œå¯¼èˆª</h3><ul>
<li>Scaffold</li>
<li>AppBar</li>
<li>BottomNavigationBar</li>
<li>TabBar</li>
<li>TabBarView</li>
<li>MaterialApp</li>
<li>WidgetsApp</li>
<li>Drawer</li>
</ul>
<h3 id="æŒ‰é’®"><a href="#æŒ‰é’®" class="headerlink" title="æŒ‰é’®"></a>æŒ‰é’®</h3><ul>
<li>RaisedButton</li>
<li>FloatingActionButton</li>
<li>FlatButton</li>
<li>IconButton</li>
<li>PopupMenuButton</li>
<li>ButtonBar</li>
</ul>
<h3 id="è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†"><a href="#è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†" class="headerlink" title="è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†"></a>è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†</h3><ul>
<li>TextField</li>
<li>Checkbox</li>
<li>Radio</li>
<li>Switch</li>
<li>Slider</li>
<li>Date &amp; Time Pickers</li>
</ul>
<h3 id="å¯¹è¯æ¡†-Alert-Panel"><a href="#å¯¹è¯æ¡†-Alert-Panel" class="headerlink" title="å¯¹è¯æ¡†,Alert Panel"></a>å¯¹è¯æ¡†,Alert Panel</h3><ul>
<li>SimpleDialog</li>
<li>AlertDialog</li>
<li>BottomSheet</li>
<li>ExpansionPanel</li>
<li>SnackBar</li>
</ul>
<h3 id="ä¿¡æ¯å±•ç¤º"><a href="#ä¿¡æ¯å±•ç¤º" class="headerlink" title="ä¿¡æ¯å±•ç¤º"></a>ä¿¡æ¯å±•ç¤º</h3><ul>
<li>Image</li>
<li>Icon</li>
<li>Chip</li>
<li>Tooltip</li>
<li>DataTable</li>
<li>Card</li>
<li>LinearProgressIndicator</li>
</ul>
<h3 id="å¸ƒå±€"><a href="#å¸ƒå±€" class="headerlink" title="å¸ƒå±€"></a>å¸ƒå±€</h3><ul>
<li>ListTile</li>
<li>Stepper</li>
<li>Divider</li>
</ul>
<h2 id="Cupertino"><a href="#Cupertino" class="headerlink" title="Cupertino"></a>Cupertino</h2><ul>
<li>CupertinoActivityIndicator</li>
<li>CupertinoAlertDialog</li>
<li>CupertinoButton</li>
<li>CupertinoDialog</li>
<li>CupertinoDialogAction</li>
<li>CupertinoSlider</li>
<li>CupertinoSwitch</li>
<li>CupertinoPageTransition</li>
<li>CupertinoFullScreenDialogTransition</li>
<li>CupertinoNavigationBar</li>
<li>CupertinoTabBar</li>
<li>CupertinoPageScaffold</li>
<li>CupertinoTabScaffold</li>
<li>CupertinoTabView</li>
</ul>
<h2 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a>Layout</h2><h3 id="å•ä¸ªå…ƒç´ "><a href="#å•ä¸ªå…ƒç´ " class="headerlink" title="å•ä¸ªå…ƒç´ "></a>å•ä¸ªå…ƒç´ </h3><ul>
<li>Container</li>
<li>Padding</li>
<li>Center</li>
<li>Align</li>
<li>FittedBox</li>
<li>AspectRatio</li>
<li>ConstrainedBox</li>
<li>Baseline</li>
<li>FractionallySizedBox</li>
<li>IntrinsicHeight</li>
<li>IntrinsicWidth</li>
<li>LimitedBox</li>
<li>Offstage</li>
<li>OverflowBox</li>
<li>SizedBox</li>
<li>SizedOverflowBox</li>
<li>Transform</li>
<li>CustomSingleChildLayout</li>
</ul>
<h3 id="å¤šä¸ªå…ƒç´ "><a href="#å¤šä¸ªå…ƒç´ " class="headerlink" title="å¤šä¸ªå…ƒç´ "></a>å¤šä¸ªå…ƒç´ </h3><ul>
<li>Row</li>
<li>Column</li>
<li>Stack</li>
<li>IndexedStack</li>
<li>Flow</li>
<li>Table</li>
<li>Wrap</li>
<li>ListBody</li>
<li>ListView</li>
<li>CustomMultiChildLayout</li>
</ul>
<h3 id="LayoutBuilder"><a href="#LayoutBuilder" class="headerlink" title="LayoutBuilder"></a>LayoutBuilder</h3><h2 id="Text"><a href="#Text" class="headerlink" title="Text"></a>Text</h2><ul>
<li>Text</li>
<li>RichText</li>
<li>DefaultTextStyle</li>
</ul>
<h2 id="Assets"><a href="#Assets" class="headerlink" title="Assets"></a>Assets</h2><ul>
<li>Image</li>
<li>Icon</li>
<li>RawImage</li>
<li>AssetBundle</li>
</ul>
<h2 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h2><ul>
<li>Form</li>
<li>FormField</li>
<li>RawKeyboardListener</li>
</ul>
<h2 id="Animation"><a href="#Animation" class="headerlink" title="Animation"></a>Animation</h2><ul>
<li>AnimatedContainer</li>
<li>AnimatedCrossFade</li>
<li>Hero</li>
<li>AnimatedBuilder</li>
<li>DecoratedBoxTransition</li>
<li>FadeTransition</li>
<li>PositionedTransition</li>
<li>RotationTransition</li>
<li>ScaleTransition</li>
<li>SizeTransition</li>
<li>SlideTransition</li>
<li>AnimatedDefaultTextStyle</li>
<li>AnimatedListState</li>
<li>AnimatedModalBarrier</li>
<li>AnimatedOpacity</li>
<li>AnimatedPhysicalModal</li>
<li>AnimatedPositioned</li>
<li>AnimatedSize</li>
<li>AnimatedWidget</li>
<li>AnimatedWidgetBaseState</li>
</ul>
<h2 id="äº¤äº’"><a href="#äº¤äº’" class="headerlink" title="äº¤äº’"></a>äº¤äº’</h2><ul>
<li>LongPressDraggable</li>
<li>GestureDetector</li>
<li>DragTarget</li>
<li>Dismissible</li>
<li>IgnorePointer</li>
<li>AbsorbPointer</li>
<li>Navigator</li>
<li>Scrollable</li>
</ul>
<h2 id="æ ·å¼"><a href="#æ ·å¼" class="headerlink" title="æ ·å¼"></a>æ ·å¼</h2><ul>
<li>Padding</li>
<li>Theme</li>
<li>MediaQuery</li>
</ul>
<h2 id="Draw"><a href="#Draw" class="headerlink" title="Draw"></a>Draw</h2><ul>
<li>Opacity</li>
<li>Transform</li>
<li>DecoratedBox</li>
<li>FractionalTransition</li>
<li>RotatedBox</li>
<li>ClipOval</li>
<li>ClipPath</li>
<li>ClipRect</li>
<li>CustomPaint</li>
<li>BackdropFilter</li>
</ul>
<h2 id="Async"><a href="#Async" class="headerlink" title="Async"></a>Async</h2><ul>
<li>FutureBuilder</li>
<li>StreamBuilder</li>
</ul>
<h2 id="æ»šåŠ¨"><a href="#æ»šåŠ¨" class="headerlink" title="æ»šåŠ¨"></a>æ»šåŠ¨</h2><ul>
<li>ListView</li>
<li>NestedScrollView</li>
<li>GridView</li>
<li>SingleChildScrollView</li>
<li>Scrollable</li>
<li>Scrollbar</li>
<li>CustomScrollView</li>
<li>NotificationListener</li>
<li>ScrollConfiguration</li>
<li>RefreshIndicator</li>
</ul>
<h2 id="è¾…åŠ©"><a href="#è¾…åŠ©" class="headerlink" title="è¾…åŠ©"></a>è¾…åŠ©</h2><ul>
<li>Semantics</li>
<li>MergeSemantics</li>
<li>ExcludeSemantics</li>
</ul>
]]></content>
      <tags>
        <tag>flutter</tag>
      </tags>
  </entry>
  <entry>
    <title>dart-flutter engine</title>
    <url>/2019/12/20/dart-flutter-engine/</url>
    <content><![CDATA[<h1 id="Flutter-engine"><a href="#Flutter-engine" class="headerlink" title="Flutter engine"></a>Flutter engine</h1><p>Flutter Engine ä¸åˆ›å»ºæˆ–ç®¡ç†çº¿ç¨‹,ç›¸åº”çš„ç”± embedder åˆ›å»ºç®¡ç†ã€message loops.</p>
<p>embedder æä¾›äº† task runner æ¥æ‰§è¡Œä»»åŠ¡.</p>
<p>Dart VM ä¼šæœ‰è‡ªå·±çš„çº¿ç¨‹æ± .è€Œ Flutter engine å’Œ embedder éƒ½æ— æ³•è®¿é—®åˆ°çº¿ç¨‹æ± çš„çº¿ç¨‹.</p>
<a id="more"></a>

<h3 id="Task-Runner-Configuration"><a href="#Task-Runner-Configuration" class="headerlink" title="Task Runner Configuration"></a>Task Runner Configuration</h3><p>Flutter engine ä¼šå‘ embedder ç”³è¯·4ä¸ª task runner å¼•ç”¨. engine ä¸åœ¨ä¹å¼•ç”¨æ˜¯ä¸æ˜¯åŒä¸€ä¸ª task runner,æˆ–è€…å¤šä¸ª task runner è¿è¡Œåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­.<br>ä¸ºäº†ä¼˜åŒ–æ€§èƒ½, embedder åº”è¯¥ä¸ºæ¯ä¸ª task runner åˆ†é…ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹.è™½ç„¶ engine ä¸å…³å¿ƒ task runner è¿è¡Œçš„çº¿ç¨‹æƒ…å†µ,ä½†æ˜¯åœ¨ engine çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­çº¿ç¨‹é…ç½®åº”è¯¥ä¿æŒä¸€è‡´.ä¹Ÿå°±æ˜¯å¦‚æœ embedder ä¸ºtask runner åˆ†é…äº†ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹,é‚£ä¹ˆç›´åˆ° engine é”€æ¯,è¿™ä¸ª task runner éƒ½åªèƒ½åœ¨è¿™ä¸ªçº¿ç¨‹è¿è¡Œ.<br>å¸¸ç”¨çš„ task runners:</p>
<ul>
<li>Platform Task Runner</li>
<li>UI Task Runner</li>
<li>GPU Task Runner</li>
<li>IO Task Runner</li>
</ul>
<h3 id="Platform-Task-Runner"><a href="#Platform-Task-Runner" class="headerlink" title="Platform Task Runner"></a>Platform Task Runner</h3><p>æ­¤ task runner è¿è¡Œçš„çº¿ç¨‹è¢« embedder è®¤ä¸ºæ˜¯ä¸»çº¿ç¨‹.</p>
<p>æ­¤çº¿ç¨‹æ‰§è¡Œçš„ task runner éƒ½æ˜¯ç”± embedder åˆ†é…çš„.engine æŒ‡æ´¾çš„ task runner æ˜¯æ— æ„ä¹‰çš„.å¤šä¸ª Flutter engine å¯ä»¥åœ¨åŸºäºä¸åŒçº¿ç¨‹ä¸Šè¿è¡Œçš„ platform task runner å¯åŠ¨.Flutter Content Handler åœ¨ Fuchsia ä¸­å°±æ˜¯æ­¤åŸç†.æ¯ä¸ª Flutter åº”ç”¨æ‰€åœ¨çš„è¿›ç¨‹ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Flutter engine,åŒæ—¶æ¯ä¸ª engine éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ platform thread.</p>
<p>å’Œ Flutter engine çš„ä»»ä½•äº¤äº’æ“ä½œå¿…é¡»åœ¨ platform thread ä¸­æ‰§è¡Œ.è€Œåœ¨å…¶ä»–çº¿ç¨‹ä¸­å’Œ engine äº¤äº’, debug æ„å»ºä¸­è§¦å‘æ–­è¨€,release æ„å»ºä¸­æ˜¯éçº¿ç¨‹å®‰å…¨çš„.Flutter engine ä¸­çš„å¾ˆå¤šç»„ä»¶éƒ½æ˜¯éçº¿ç¨‹å®‰å…¨çš„.ä¸€æ—¦ engine é…ç½®è¿è¡Œå,åªè¦ embedder API çš„è®¿é—®æ˜¯åœ¨ platform thread ä¸­æ‰§è¡Œçš„,embedder å°±ä¸å¿…æŒ‡æ´¾ task runner å»é…ç½® engine.</p>
<p>æ­¤ task runner é™¤äº†åœ¨ engine å¯åŠ¨åè´Ÿè´£ embedder å’Œ engine äº¤äº’å¤–,åŒæ—¶ä¼šæ‰§è¡Œ platform messages.è¿™æ˜¯å› ä¸ºåªæœ‰åœ¨ platform çš„ä¸»çº¿ç¨‹è®¿é—® platform APIs æ‰æ˜¯å®‰å…¨çš„.æ’ä»¶ä¸å¿…å°†ä»–ä»¬çš„è°ƒç”¨é‡æ–°åˆ†é…åˆ°ä¸»çº¿ç¨‹ä¸Š.å¦‚æœæ’ä»¶ç®¡ç†è‡ªå·±çš„ worker çº¿ç¨‹,é‚£ä¹ˆæ’ä»¶åœ¨å“åº”ç»“æœè¢«æäº¤åˆ° engine ç”± Dart å¤„ç†å‰åº”è¯¥å°†å…¶å…¥é˜Ÿåˆ° platform çº¿ç¨‹ä¸­.å’Œ engine çš„äº¤äº’å¿…é¡»åœ¨ platform çº¿ç¨‹æ‰§è¡Œ.</p>
<p>å³ä½¿ platform çº¿ç¨‹è¢«é˜»å¡äº†å¾ˆé•¿æ—¶é—´,Flutter rendering pipelineä¹Ÿä¸ä¼šè¢«é˜»å¡.platform å¯¹æ­¤çº¿ç¨‹ä¸Šçš„è€—æ—¶æ“ä½œè¿›è¡Œäº†è¯¸å¤šé™åˆ¶.æ‰€ä»¥å»ºè®®ä»»ä½•è€—æ—¶æ“ä½œåœ¨å°†æ‰§è¡Œç»“æœè¿”å›å¹¶è¢«å…¥é˜Ÿåˆ° platform çº¿ç¨‹ä¹‹å‰åº”è¯¥åœ¨ç‹¬ç«‹çš„çº¿ç¨‹ä¸­æ‰§è¡Œ(ä¸æ˜¯ä¸Šé¢è®¨è®ºçš„4ç§çº¿ç¨‹).å¦‚æœä¸è¿™ä¹ˆåšå¯èƒ½å¯¼è‡´ platform æŒ‡å®šçš„ watchdog ç»ˆç»“åº”ç”¨.è¯¸å¦‚ androidã€ios ä¹Ÿä½¿ç”¨ platform çº¿ç¨‹ä¼ é€’ç”¨æˆ·è¾“å…¥æ—¶é—´.é˜»å¡ platform çº¿ç¨‹å°†å¯¼è‡´æ“ä½œè¢«ä¸¢å¼ƒ.</p>
<h3 id="UI-Task-Runner"><a href="#UI-Task-Runner" class="headerlink" title="UI Task Runner"></a>UI Task Runner</h3><p>engine åœ¨ root isolate é€šè¿‡ UI Task Runner æ‰§è¡Œæ‰€æœ‰çš„ Dart ä»£ç .root isolate å’Œ Flutter ç»‘å®šæ‰èƒ½æ‰§è¡Œ.æ­¤ isolate è¿è¡Œåº”ç”¨ç¨‹åºçš„ main dart code.engine ç»‘å®šæ­¤ isolate æäº¤æ‰§è¡Œ frames. Flutter çš„æ¯ä¸€å¸§:</p>
<ul>
<li>root isolate å‘Šè¯‰ engine è¦æ¸²æŸ“å“ªä¸€å¸§</li>
<li>engine ä¼šè¯¢é—® platform åœ¨ä¸‹ä¸€æ¬¡ vsync æ—¶æ˜¯å¦éœ€è¦ be notified.</li>
<li>platform ç­‰å¾…ä¸‹ä¸€ vsync.</li>
<li>åœ¨ vsync, engine ä¼šå”¤é†’ dart codeæ‰§è¡Œå¦‚ä¸‹æ“ä½œ:<ul>
<li>æ›´æ–°åŠ¨ç”»æ’å€¼å™¨</li>
<li>åœ¨ build phase é‡å»ºåº”ç”¨çš„ widget.</li>
<li>å¸ƒå±€æ–°æ„å»ºçš„ widget,å°†å…¶ç»˜åˆ¶åˆ°å±‚é‡Œçš„ tree ä¸­ç«‹å³æäº¤ç»™ engine.æ­¤å¤„å®é™…æ²¡æœ‰æ …æ ¼åŒ–.</li>
</ul>
</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>git ç¬”è®°</title>
    <url>/2019/03/17/git-%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<a id="more"></a>
<ul>
<li>config</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹é…ç½®</span></span><br><span class="line">git config --<span class="built_in">local</span> <span class="comment"># å¯¹æŸä¸ªä»“åº“æœ‰æ•ˆ</span></span><br><span class="line">git config --global <span class="comment"># å¯¹å½“å‰ç”¨æˆ·æ‰€æœ‰ä»“åº“æœ‰æ•ˆ</span></span><br><span class="line">git config --system <span class="comment"># å¯¹ç³»ç»Ÿæ‰€æœ‰ç™»å½•ç”¨æˆ·æœ‰æ•ˆ</span></span><br><span class="line"><span class="comment"># æŸ¥çœ‹é…ç½®</span></span><br><span class="line">git config --list --<span class="built_in">local</span></span><br><span class="line">git config --list --global</span><br><span class="line">git config --list --system</span><br><span class="line"><span class="comment"># æ‰“å¼€ç¼–è¾‘å™¨ä¿®æ”¹config</span></span><br><span class="line">git config -e <span class="comment"># ä»…å¯¹å½“å‰ä»“åº“æœ‰æ•ˆ</span></span><br><span class="line"><span class="comment"># å˜æ›´æ–‡ä»¶å</span></span><br><span class="line">git mv readme readme.md <span class="comment"># é¿å…  mv x y -&gt; git add -&gt; git rm</span></span><br><span class="line">git <span class="built_in">log</span> [åˆ†æ”¯]</span><br><span class="line">        --oneline <span class="comment"># ä¸€è¡Œæ˜¾ç¤º</span></span><br><span class="line">        -n4 <span class="comment"># æŒ‡å®šæœ€æ–°çš„å‡ æ¬¡æäº¤</span></span><br><span class="line">        --all <span class="comment"># æ‰€æœ‰åˆ†æ”¯çš„æäº¤</span></span><br><span class="line">        --graph <span class="comment"># å›¾å½¢åŒ–æ˜¾ç¤º</span></span><br><span class="line"><span class="comment"># æ‰“å¼€å†…ç½®å¸®åŠ©ç½‘é¡µ.</span></span><br><span class="line">git <span class="built_in">help</span> --web [<span class="built_in">log</span>]</span><br><span class="line"><span class="comment"># gui</span></span><br><span class="line">gitk --all</span><br><span class="line">git branch -av</span><br><span class="line"><span class="comment"># åœ¨ ./git/refs/heads/xxx ä¸­æŸ¥çœ‹ä¿¡æ¯</span></span><br><span class="line">git cat-file -t master <span class="comment"># è¿”å› git object model ç±»å‹: blog, tree, commit, tag</span></span><br><span class="line">            -p <span class="comment"># æ˜¾ç¤ºæ‰€æœ‰å†…å®¹</span></span><br><span class="line"><span class="comment"># åˆ é™¤åˆ†æ”¯</span></span><br><span class="line">git branch -D [fixup]</span><br><span class="line"><span class="comment"># å˜åŸº</span></span><br><span class="line">git rebase -i</span><br><span class="line"><span class="comment"># æš‚å­˜åŒºå’Œæœ€è¿‘ä¸€æ¬¡æäº¤çš„åŒºåˆ«</span></span><br><span class="line">git diff --cached</span><br><span class="line"><span class="comment"># å°†æš‚å­˜åŒºçš„å†…å®¹ä¸¢å¼ƒ</span></span><br><span class="line">git reset HEAD -- &lt;file&gt;</span><br><span class="line"><span class="comment"># å°†æš‚å­˜åŒºçš„å†…å®¹æ¢å¤åˆ°æœ¬åœ°</span></span><br><span class="line">git checkout -- &lt;file&gt;</span><br><span class="line"><span class="comment"># è®¾ç½®åˆ«å</span></span><br><span class="line">git config --global alias.co checkout</span><br><span class="line">git config --global alias.br branch</span><br><span class="line">git config --global alias.ci commit</span><br><span class="line">git config --global alias.st status</span><br><span class="line">git config --global alias.last <span class="string">'log -1 HEAD'</span></span><br><span class="line">git config --global alias.unstage <span class="string">'reset HEAD --'</span>; git unstage fileA === git reset HEAD -- fileA</span><br><span class="line">git config --global alias.visual <span class="string">'!gitk'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å„ä¸ªåˆ†æ”¯æ‰€æŒ‡çš„å¯¹è±¡  --decorate</span></span><br><span class="line">git <span class="built_in">log</span> --oneline --decorate</span><br><span class="line">git <span class="built_in">log</span> --oneline --decorate --graph --all</span><br><span class="line"><span class="comment"># è·Ÿè¸ªè¿œç¨‹åˆ†æ”¯</span></span><br><span class="line">git checkout --track origin/serverfix</span><br><span class="line">git checkout -b sf origin/serverfix; sf åˆ†æ”¯è¿½è¸ª origin/serverfix åˆ†æ”¯.</span><br><span class="line"><span class="comment"># æ·»åŠ ä¿®æ”¹æ­£åœ¨è¿½è¸ªçš„ä¸Šæ¸¸åˆ†æ”¯; -u / --set-upstream-to</span></span><br><span class="line">git branch -u origin/serverfix</span><br><span class="line"><span class="comment"># å½“è®¾ç½®å¥½è·Ÿè¸ªåˆ†æ”¯åï¼Œå¯é€šè¿‡ @&#123;upstream&#125; æˆ– @&#123;u&#125; å¿«æ·æ–¹å¼æ¥å¼•ç”¨.æ‰€æœ‰å¦‚æœ master è·Ÿè¸ª origin/masterã€‚é‚£ä¹ˆ git merge @&#123;u&#125; å¯ä»¥å–ä»£ git merage origin/master.</span></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ‰€æœ‰è·Ÿè¸ªåˆ†æ”¯</span></span><br><span class="line">git branch -vv</span><br><span class="line"><span class="comment"># åˆ é™¤æœåŠ¡ç«¯çš„åˆ†æ”¯</span></span><br><span class="line">git push origin --delete serverfix</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">git init --bare --shared ; <span class="comment"># shared ä¼šè‡ªåŠ¨ä¿®æ”¹è¯¥ä»“åº“ç›®å½•çš„ç»„æƒé™ä¸ºå¯å†™.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ºæœåŠ¡ç«¯é…ç½® SSH è®¿é—®</span></span><br><span class="line">sudo adduser git</span><br><span class="line">su git</span><br><span class="line"><span class="built_in">cd</span></span><br><span class="line">mkdir .ssh &amp;&amp; chmod 700 .ssh</span><br><span class="line">touch .ssh/authorized_keys &amp;&amp; chmod 600 .ssh/authorized_keys</span><br><span class="line">cat /tmp/id_rsa.john.pub &gt;&gt; ~/.ssh/authorized_keys</span><br><span class="line">cat /tmp/id_rsa.josie.pub &gt;&gt; ~/.ssh/authorized_keys</span><br><span class="line"><span class="comment"># é™åˆ¶ git ç”¨æˆ·åªèƒ½è®¿é—®é¡¹ç›®ï¼Œæ— æ³•ç™»å½•è¿œç¨‹ä¸»æœº.</span></span><br><span class="line">cat /etc/shells</span><br><span class="line"><span class="built_in">which</span> git-shell</span><br><span class="line">sudo vim /etc/shellsï¼› <span class="comment"># å°† git-shell æ·»åŠ </span></span><br><span class="line">sudo chsh git /usr/bin/git-shell; <span class="comment"># é™åˆ¶ git ç”¨æˆ·åªèƒ½åˆ©ç”¨ SSH è¿æ¥å¯¹ Git ä»“åº“è¿›è¡Œæ¨é€å’Œæ‹‰å»æ“ä½œï¼Œè€Œä¸èƒ½ç™»å½•æœºå™¨å¹¶å–å¾—æ™®é€š shell.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è®¾ç½® git åè®®,ä¸éœ€è¦é…ç½® SSH å…¬é’¥.</span></span><br><span class="line">git daemon --reuseaddr --base-path=/opt/git/ /opt/git/;</span><br><span class="line"><span class="comment"># --reuseaddr å…è®¸æœåŠ¡å™¨åœ¨æ— éœ€ç­‰å¾…æ—§è¿æ¥è¶…æ—¶çš„æƒ…å†µä¸‹é‡å¯</span></span><br><span class="line"><span class="comment"># --base-path å…è®¸ç”¨æˆ·åœ¨æœªå®Œå…¨æŒ‡å®šè·¯å¾„çš„æ¡ä»¶ä¸‹å…‹éš†é¡¹ç›®,ç»“å°¾çš„è·¯å¾„å°†å‘Šè¯‰ git å®ˆæŠ¤è¿›ç¨‹ä»ä½•å¤„å¯»æ‰¾ä»“åº“æ¥å¯¼å‡º.å¦‚æœæœ‰é˜²ç«å¢™è¿è¡Œï¼Œè¯·å¼€æ”¾ 9418 ç«¯å£.</span></span><br><span class="line"><span class="comment"># ç©ºç™½é”™è¯¯(æ¢è¡Œ\tab\ã€‚ã€‚ã€‚)</span></span><br><span class="line">git diff --check</span><br><span class="line"><span class="comment"># éƒ¨åˆ†æš‚å­˜</span></span><br><span class="line">git add --patch</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">git merge --squash featureB</span><br><span class="line"><span class="comment"># --squash æ¥å—è¢«åˆå¹¶åˆ†æ”¯ä¸Šçš„æ‰€æœ‰å·¥ä½œï¼Œå¹¶å°†å…¶å‹ç¼©è‡³ä¸€ä¸ªå˜æ›´åŠï¼Œä½¿ä»“åº“æˆä¸ºçœŸæ­£åˆå¹¶å‘ç”Ÿçš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯ç”Ÿæˆä¸€ä¸ªåˆå¹¶æäº¤.</span></span><br><span class="line"><span class="comment"># æ‰“åŒ… archive</span></span><br><span class="line">git archive master --prefix=<span class="string">'project/'</span> | gzip &gt; `git describe master`.tar.gz</span><br><span class="line">git archive master --prefix=<span class="string">'project/'</span> --format=zip &gt; `git describe master`.zips</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">git diff --ours</span><br><span class="line">        <span class="comment"># --theirs</span></span><br><span class="line">        <span class="comment"># --base -b</span></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>ObjectBoxé«˜çº§-5-æ›´æ–°æ•°æ®æ¨¡å‹</title>
    <url>/2019/02/26/ObjectBox%E9%AB%98%E7%BA%A7-5-%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B/</url>
    <content><![CDATA[<p>objectbox</p>
<a id="more"></a>
<p>ObjectBox å¤§å¤šæ•°æƒ…å†µä¸‹è‡ªåŠ¨ç®¡ç†æ•°æ®æ¨¡å‹.å½“æ·»åŠ /åˆ é™¤ entities æˆ–å±æ€§æ—¶ï¼ŒObjectBox è‡ªåŠ¨ä½œå‡ºå“åº”ã€‚<br>å¯¹äºå…¶ä»–æ”¹å˜å¦‚ ä¿ç•™æˆ–æ”¹å˜ç±»å‹ï¼ŒObjectBox éœ€è¦é¢å¤–ä¿¡æ¯ã€‚</p>
<h3 id="UIDs"><a href="#UIDs" class="headerlink" title="UIDs"></a>UIDs</h3><p>ObjectBox é€šè¿‡ unique IDs(UIDs) æ¥è¿½è¸ª entities å’Œå±æ€§çš„å˜åŒ–ã€‚æ‰€æœ‰çš„ UIDs éƒ½å­˜å‚¨åœ¨ module-name/objectbox-models/default.json ä¸­,å¯ä»¥ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶è½¯ä»¶(git)è¿›è¡Œç®¡ç†ã€‚</p>
<p>ç®€å•æ¥è¯´: ä¸ºäº†ä½¿ UID ç›¸å…³çš„æ”¹å˜ç”Ÿæ•ˆï¼Œåœ¨è¿™äº› entity æˆ– å±æ€§ä¸Šæ”¾ç½® @Uid ç„¶åç¼–è¯‘ï¼Œåœ¨è·å–è¿›ä¸€æ­¥æç¤ºã€‚</p>
<h3 id="é‡å‘½å-entities-å’Œ-å±æ€§"><a href="#é‡å‘½å-entities-å’Œ-å±æ€§" class="headerlink" title="é‡å‘½å entities å’Œ å±æ€§"></a>é‡å‘½å entities å’Œ å±æ€§</h3><p>éœ€è¦ UID æ³¨è§£çš„åŸå› æ˜¯: å¦‚æœä»…ä»…æ”¹å˜ entities å’Œå±æ€§çš„åå­—ï¼ŒObjectBox åªä¼šæ„è¯†åˆ° old entity ä¸è§äº†ï¼Œè€Œåˆ›å»ºäº†æ–°çš„ entity.<br>æ‰€ä»¥å‘Šè¯‰ ObjectBox é‡å‘½å entity å’Œæ•°æ®ï¼Œè€Œä¸æ˜¯ä¸¢å¼ƒå®ƒä»¬.å®ƒä»¬æ˜¯ç›¸åŒçš„ä¸€ä¸ª entityã€‚å®é™…ä¸Šæ˜¯åœ¨å†…éƒ¨ç»™ entity ç»‘å®šä¸€ä¸ª UID.å±æ€§ä¹Ÿä¸€æ ·.</p>
<h3 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h3><p>ç¬¬ä¸€æ­¥: ä¸ºæƒ³è¦é‡å‘½åçš„ entity/å±æ€§æ·»åŠ ç©ºçš„ @Uid æ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Uid</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyName</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ­¥: ç¼–è¯‘é¡¹ç›®ï¼Œç„¶åä¼šè¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼šç»™å‡ºå½“å‰ entity/å±æ€§çš„ UID</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">error: [ObjectBox] UID operations <span class="keyword">for</span> entity <span class="string">"MyName"</span>:</span><br><span class="line">  [Rename] apply the current UID using <span class="meta">@Uid</span>(<span class="number">6645479796472661392L</span>) -</span><br><span class="line">  [Change/reset] apply a <span class="keyword">new</span> UID using <span class="meta">@Uid</span>(<span class="number">4385203238808477712L</span>)</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰éƒ¨: æŠŠä¸Šé¢çš„ UID å¤åˆ¶åˆ° @Uid() é‡Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Uid</span>(<span class="number">6645479796472661392L</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyName</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬å››æ­¥: é‡å‘½åå§</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Uid</span>(<span class="number">6645479796472661392L</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyNewName</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æˆ–è€…å¯ä»¥åœ¨ default.json ä¸­æ‰¾åˆ° UID,ç„¶åç›´æ¥ä½¿ç”¨åˆ° @Uid() ä¸Šï¼Œé‡å‘½åå³å¯</p>
</blockquote>
<h3 id="ä¿®æ”¹å±æ€§ç±»å‹"><a href="#ä¿®æ”¹å±æ€§ç±»å‹" class="headerlink" title="ä¿®æ”¹å±æ€§ç±»å‹"></a>ä¿®æ”¹å±æ€§ç±»å‹</h3><p>æƒ³è¦ä¿®æ”¹å±æ€§ç±»å‹ï¼Œé‚£ä¹ˆ ObjectBox å†…éƒ¨å¾—åˆ›å»ºä¸€ä¸ªæ–°ç±»å‹ã€‚å› ä¸º ObjectBox ä¸ä¼šè¿ç§»æ•°æ®ã€‚</p>
<ul>
<li>é‡å‘½åå±æ€§ç±»å‹ï¼šè¿™æ ·è¯¥å±æ€§å°±ä¼šè¢«è®¤ä¸ºæ˜¯æ–°å±æ€§(å¦‚æœè¯¥å±æ€§å·²ç»æœ‰ @Uid æ³¨è§£äº†ï¼Œåˆ™è¡Œä¸é€š)</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// old:</span></span><br><span class="line">String year;</span><br><span class="line"><span class="comment">// new:</span></span><br><span class="line"><span class="keyword">int</span> yearInt;</span><br></pre></td></tr></table></figure>

<ul>
<li>å‘Šè¯‰ ObjectBox å¯¹æ–°å±æ€§ä½¿ç”¨æ–° UID.</li>
</ul>
<h4 id="å®è·µä¸€ä¸‹"><a href="#å®è·µä¸€ä¸‹" class="headerlink" title="å®è·µä¸€ä¸‹"></a>å®è·µä¸€ä¸‹</h4><p>ç¬¬ä¸€æ­¥ï¼šå¯¹æƒ³ä¿®æ”¹ç±»å‹çš„å±æ€§æ·»åŠ  @Uid æ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Uid</span></span><br><span class="line">String year;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ­¥: ç¼–è¯‘è·å–é”™è¯¯ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">error: [ObjectBox] UID operations <span class="keyword">for</span> property <span class="string">"MyEntity.year"</span>:</span><br><span class="line">  [Rename] apply the current UID using <span class="meta">@Uid</span>(<span class="number">6707341922395832766L</span>) -</span><br><span class="line">  [Change/reset] apply a <span class="keyword">new</span> UID using <span class="meta">@Uid</span>(<span class="number">9204131405652381067L</span>)</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰æ­¥ï¼šä¸ºè¯¥å±æ€§åº”ç”¨æ–° @Uid,å¹¶ä¿®æ”¹ç±»å‹.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Uid</span>(<span class="number">9204131405652381067L</span>)</span><br><span class="line"><span class="keyword">int</span> year;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>ObjectBox</tag>
        <tag>æ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>å¸¸ç”¨å‘½ä»¤è®°å½•</title>
    <url>/2019/03/28/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<a id="more"></a>
<h2 id="Homebrew"><a href="#Homebrew" class="headerlink" title="Homebrew"></a>Homebrew</h2><h3 id="gradle-completion"><a href="#gradle-completion" class="headerlink" title="gradle-completion"></a>gradle-completion</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install gradle-completion</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$fpath</span> | grep <span class="string">"/usr/local/share/zsh/site-functions"</span></span><br><span class="line"><span class="comment"># æ‰§è¡Œç»“æœ</span></span><br><span class="line">Add the following line to your ~/.bash_profile:</span><br><span class="line">  [[ -r <span class="string">"/usr/local/etc/profile.d/bash_completion.sh"</span> ]] &amp;&amp; . <span class="string">"/usr/local/etc/profile.d/bash_completion.sh"</span></span><br><span class="line"></span><br><span class="line">Bash completion has been installed to:</span><br><span class="line">  /usr/<span class="built_in">local</span>/etc/bash_completion.d</span><br><span class="line">==&gt; gradle-completion</span><br><span class="line">Bash completion has been installed to:</span><br><span class="line">  /usr/<span class="built_in">local</span>/etc/bash_completion.d</span><br><span class="line"></span><br><span class="line">zsh completions have been installed to:</span><br><span class="line">  /usr/<span class="built_in">local</span>/share/zsh/site-functions</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>Dart-Zone</title>
    <url>/2019/10/23/dart-Zone/</url>
    <content><![CDATA[<p>Dart æ˜¯å•çº¿ç¨‹æ¨¡å‹,ç›¸å¯¹äº JavaScript,å…¶ä¹Ÿæœ‰ <code>microTaskQueue</code> å’Œ <code>eventTaskQueue</code>.</p>
<a id="more"></a>
<p><code>Zone</code> ä»£è¡¨æŸä¸ªç¯å¢ƒçš„ç¨³å®šè·¨å¼‚æ­¥ç¯å¢ƒè°ƒç”¨.</p>
<p>ä»£ç é€šå¸¸éƒ½æ‰§è¡Œåœ¨ä¸€ä¸ª <code>zone</code>ä¸­,å¦‚<code>Zone.current</code>.è€Œ<code>main</code>å‡½æ•°é€šå¸¸è¿è¡Œåœ¨é»˜è®¤çš„<code>Zone.root</code>ä¸Šä¸‹æ–‡ä¸­.<br>é€šè¿‡ <code>runZoned</code> åˆ›å»ºä¸€ä¸ªæ–°<code>zone</code> æˆ– <code>Zone.run</code> å°†ä»£ç è¿è¡Œåˆ°ä¸€ä¸ªç”± <code>Zone.fork</code>åˆ›å»ºçš„ä¸Šä¸‹æ–‡ä¸­.</p>
<p>å¼€å‘è€…å¯ä»¥é€šè¿‡è¦†ç›–ä¸€ä¸ªå­˜åœ¨<code>zone</code>çš„ä¸€äº›æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªæ–°<code>zone</code>.å¦‚è‡ªå®šä¹‰<code>zone</code>å¯ä»¥æ›¿æ¢æˆ–ä¿®æ”¹<code>print</code>ã€timersã€<br>micortasksã€uncaught erros çš„é»˜è®¤è¡Œä¸º.</p>
<p><code>Zone</code>ç±»ä¸å¯ä»¥è¢«ç»§æ‰¿.å¯ä»¥ä½¿ç”¨ fork å­˜åœ¨çš„ <code>zone</code>,é€šå¸¸æ˜¯<code>Zone.current</code>å’Œ<code>ZoneSpecification</code>æ¥è‡ªå®šä¹‰<code>zone</code>.è¿™å’Œç»§æ‰¿<code>Zone</code>ç±»æ¥åˆ›å»ºæ–°çš„<code>zone</code>ç±»ä¼¼.</p>
<p>å¼‚æ­¥å›è°ƒæ€»æ˜¯è¿è¡Œåœ¨å…¶è¢«è§„å®šçš„<code>zone</code>ä¸Šä¸‹æ–‡ä¸­.ä½¿ç”¨ä¸€ä¸‹æ­¥éª¤å®ç°:</p>
<ul>
<li>é¦–å…ˆä½¿ç”¨<code>registerCallback</code>ã€<code>registerUnaryCallback</code>ã€<code>registerBinaryCallback</code>ä¸­çš„ä¸€ä¸ªæ³¨å†Œ.<code>zone</code>å°±å°±å¯ä»¥è®°å½•æ­¤<code>callback</code>æˆ–ä¿®æ”¹å®ƒ(è¿”å›ä¸€ä¸ªä¸åŒçš„<code>callback</code>).æ‰§è¡Œæ³¨å†Œçš„ä»£ç (å¦‚ <code>Future.then</code>)ä¹Ÿä¼šè®°ä½å½“å‰çš„<code>zone</code>,ä¹‹å<code>callback</code>å°±å¯ä»¥åœ¨æ­¤<code>zone</code>ä¸­è¿è¡Œ.</li>
<li>ä¹‹ååœ¨ä¸Šé¢ä¿ç•™çš„<code>zone</code>ä¸­è¿è¡Œæ³¨å†Œçš„<code>callback</code>.<br>è¿™äº›é€šå¸¸éƒ½æœ‰å¹³å°å¤„ç†,ç”¨æˆ·æ— éœ€æ“å¿ƒ.å¦‚æœè¦æ ¹æ®åº•å±‚æä¾›çš„åŠŸèƒ½æˆ–<code>native extensions</code>å¼€å‘è‡ªå®šä¹‰çš„å¼‚æ­¥è§„åˆ™,åˆ™å¿…é¡»å®ç°ä¸Šé¢ä¸¤æ­¥.</li>
</ul>
<p><code>bindCallback</code>ã€<code>bindUnaryCallback</code>ã€<code>bindBinaryCallback</code> åˆ™ç®€åŒ–äº†ä¸Šé¢çš„æ­¥éª¤,ç›´æ¥è°ƒç”¨å³å¯.</p>
<p><code>bindCallbackGuarded</code>ã€<code>bindUnaryCallbackGuarded</code>ã€<code>bindBinaryCallbackGuarded</code>å¯ä»¥é€šè¿‡<code>Zone.runGuarded</code>æ¥è°ƒç”¨.</p>
<blockquote>
<p>Dart æ„é€ æ–¹æ³•ä¸å¯è§çš„å®ç°æ–¹å¼: Zone._();</p>
</blockquote>
<p>æ‰€æœ‰çš„éš”ç¦»å…¥å£å‡½æ•°è¢«è°ƒç”¨æ—¶(<code>main</code>æˆ–<code>spawned</code> å‡½æ•°)éƒ½è¿è¡Œåœ¨æ ¹<code>zone</code>(å³ <code>Zone.current</code>ç­‰äº<code>Zone.root</code>).å¦‚æœæ²¡æœ‰åˆ›å»ºè‡ªå®šä¹‰çš„<code>zone</code>,åé¢çš„ä»£ç éƒ½ä¼šè¿è¡Œåœ¨æ­¤æ ¹<code>zone</code>ä¸­.</p>
<p>å¦‚æœå¼‚æ­¥å›è°ƒå¦‚<code>Future</code>æˆ–<code>Stream</code>æ²¡æœ‰æ•è·å¼‚å¸¸,åˆ™ä¼šè°ƒç”¨<code>zone.handleUncaughtError</code>æ¥æ•è·å¼‚å¸¸.</p>
<p><code>error zone</code>(<code>Zone.current.errorZone</code>)æ˜¯å¤„ç†æœªæ•è·å¼‚å¸¸çš„åœ°æ–¹.å¼‚æ­¥å¼‚å¸¸ä¸ä¼šä¼ é€’åˆ°ä¸åŒçš„error handler.</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'dart:async'</span>;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  <span class="keyword">var</span> future;</span><br><span class="line">  runZoned(() &#123;</span><br><span class="line">    future = Future.error(<span class="string">"asynchronous error"</span>);</span><br><span class="line">  &#125;,onError:(e)&#123;<span class="built_in">print</span>(e);&#125;);</span><br><span class="line">  future.catchError(e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">"is never reached"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>Dart</tag>
      </tags>
  </entry>
  <entry>
    <title>ç§»åŠ¨ä¼˜å…ˆçš„å“åº”å¼ç½‘é¡µè®¾è®¡</title>
    <url>/2019/04/12/%E7%A7%BB%E5%8A%A8%E4%BC%98%E5%85%88%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BD%91%E9%A1%B5%E8%AE%BE%E8%AE%A1/</url>
    <content><![CDATA[<p><a href="https://www.html5rocks.com/en/mobile/responsivedesign/" target="_blank" rel="noopener">åŸæ–‡</a></p>
<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>æœ¬æ–‡å°†æ¢ç´¢å¦‚ä½•åˆ›å»ºç§»åŠ¨ä¼˜å…ˆçš„ç½‘é¡µè®¾è®¡ä½“éªŒã€‚</p>
<ul>
<li>ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºç§»åŠ¨ä¼˜å…ˆï¼Œå“åº”å¼ï¼Œé€‚åº”å¼ç½‘é¡µè®¾è®¡ä½“éªŒ?</li>
<li>å¦‚ä½•é’ˆå¯¹é€‚åº”å¼ç«™ç‚¹ç»„ç»‡ HTML ç»“æ„ä»¥ä¾¿ä¼˜åŒ–æ€§èƒ½ï¼Œä¼˜å…ˆè€ƒè™‘çµæ´»æ€§?</li>
<li>å¦‚ä½•ä¹¦å†™ä¼˜å…ˆå®šä¹‰å…±äº«æ ·å¼ã€é’ˆå¯¹å¤§å±å’Œåª’ä½“æŸ¥è¯¢æ„å»ºã€ä½¿ç”¨ç›¸å¯¹å•ä½çš„ CSS?</li>
<li>å¦‚ä½•ç¼–å†™ä¸å¼•äººæ³¨ç›®çš„ Javascript æ¥æœ‰æ¡ä»¶åœ°åŠ è½½å†…å®¹ç‰‡æ®µï¼Œåˆ©ç”¨è§¦æ‘¸äº‹ä»¶å’Œåœ°ç†å®šä½</li>
<li>æˆ‘ä»¬å¯ä»¥åšäº›ä»€ä¹ˆæ¥è¿›ä¸€æ­¥å¢å¼ºæˆ‘ä»¬çš„é€‚åº”æ€§ä½“éªŒ<a id="more"></a>
<h2 id="é€‚åº”æ€§çš„å¿…è¦æ€§"><a href="#é€‚åº”æ€§çš„å¿…è¦æ€§" class="headerlink" title="é€‚åº”æ€§çš„å¿…è¦æ€§"></a>é€‚åº”æ€§çš„å¿…è¦æ€§</h2></li>
</ul>
<p>éšç€ç½‘ç»œç¯å¢ƒè¶Šæ¥è¶Šå¤æ‚ï¼Œä¸ºè¶Šæ¥è¶Šå¤šçš„ç¯å¢ƒæä¾›å¯é çš„ç½‘ç»œä½“éªŒå˜å¾—æä¸ºé‡è¦.å¹¸è¿çš„æ˜¯ï¼Œå“åº”å¼ web è®¾è®¡ç»™ web å¼€å‘è€…æä¾›äº†ä¸€äº›å¯ä»¥åŒ¹é…ä»»æ„å¤§å°å±å¹•çš„å·¥å…·æ¥ç»„ç»‡å¸ƒå±€.</p>
]]></content>
      <tags>
        <tag>ç¿»è¯‘</tag>
        <tag>web</tag>
      </tags>
  </entry>
  <entry>
    <title>teamcityè‡ªåŠ¨åŒ–æ›´æ–°hexoåšå®¢</title>
    <url>/2019/03/09/teamcity%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9B%B4%E6%96%B0hexo%E5%8D%9A%E5%AE%A2/</url>
    <content><![CDATA[<p>hexo deploy</p>
<a id="more"></a>
<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>åœ¨çŸ¥ä¹æ‰¾åˆ°äº†ä¸€ä¸ªæ›´å¥½çš„æ–¹æ³•: [åŸæ–‡](ä½¿ç”¨ hexoï¼Œå¦‚æœæ¢äº†ç”µè„‘æ€ä¹ˆæ›´æ–°åšå®¢ï¼Ÿ - CrazyMilk çš„å›ç­” - çŸ¥ä¹<br><a href="https://www.zhihu.com/question/21193762/answer/79109280" target="_blank" rel="noopener">https://www.zhihu.com/question/21193762/answer/79109280</a>)<br>åœ¨è¿™é‡Œæˆ‘æ•´ç†ä¸€ä¸‹:</p>
<ul>
<li>åˆ›å»ºä»“åº“ xxx.github.io.</li>
<li>åˆ›å»ºä¸¤ä¸ªåˆ†æ”¯: master/hexo.(å¯åœ¨ github ç½‘é¡µæˆ–æœ¬åœ°åˆ›å»º)</li>
<li><code>git clone git@github.com:xxx/xxx.github.io.git</code></li>
<li>å¦‚æœæ²¡æœ‰åœ¨ç½‘é¡µåˆ›å»ºåˆ†æ”¯,å¯ä»¥åœ¨æ­¤å¤„åˆ›å»º.<code>git checkout -b master; git checkout -b hexo</code></li>
<li>æ¥ä¸‹æ¥æ‰§è¡Œ <code>npm install hexo; hexo init; npm i; npm i hexo-deployer-git</code>,æ­¤å¤„åœ¨ <code>hexo</code> åˆ†æ”¯æ“ä½œ</li>
<li>ä¿®æ”¹ _config.yml çš„ deploy å‚æ•°,æ­¤å¤„åœ¨ <code>master</code> åˆ†æ”¯æ“ä½œ.</li>
<li>æˆ‘ä½¿ç”¨äº†<code>hexo-next-theme</code>,ä» git ä¸Šä¸‹è½½å,è¿›å…¥ <code>themes/next</code> æ‰§è¡Œ <code>git submodule init</code>,å°† <code>next</code> ä¸»é¢˜å…³è”,æ­¤å¤„åœ¨ <code>hexo</code> åˆ†æ”¯æ“ä½œ</li>
<li><code>git add .; git commit -m &quot;blahblahblah&quot;; git push origin hexo;</code> æäº¤ç½‘ç«™ç›¸å…³æ–‡ä»¶.</li>
<li><code>hexo g -d</code> ç”Ÿæˆç½‘ç«™å¹¶éƒ¨ç½²åˆ° <code>github</code>.</li>
</ul>
<h3 id="å°†-CNAME-å›¾ç‰‡ç­‰æ–‡ä»¶æ”¾å…¥-source-ç›®å½•ä¸‹-å¯ä¿è¯æ¨é€åˆ°-github-ä¸ä¼šè¢«åˆ é™¤"><a href="#å°†-CNAME-å›¾ç‰‡ç­‰æ–‡ä»¶æ”¾å…¥-source-ç›®å½•ä¸‹-å¯ä¿è¯æ¨é€åˆ°-github-ä¸ä¼šè¢«åˆ é™¤" class="headerlink" title="å°† CNAME,å›¾ç‰‡ç­‰æ–‡ä»¶æ”¾å…¥ source ç›®å½•ä¸‹,å¯ä¿è¯æ¨é€åˆ° github ä¸ä¼šè¢«åˆ é™¤."></a>å°† CNAME,å›¾ç‰‡ç­‰æ–‡ä»¶æ”¾å…¥ <code>source</code> ç›®å½•ä¸‹,å¯ä¿è¯æ¨é€åˆ° github ä¸ä¼šè¢«åˆ é™¤.</h3><h1 id="âš ï¸-ğŸ‘‡-èƒ¡æ‰¯-è§‚çœ‹è¯·è°¨æ…"><a href="#âš ï¸-ğŸ‘‡-èƒ¡æ‰¯-è§‚çœ‹è¯·è°¨æ…" class="headerlink" title="âš ï¸ ğŸ‘‡ èƒ¡æ‰¯,è§‚çœ‹è¯·è°¨æ…!!!"></a>âš ï¸ ğŸ‘‡ èƒ¡æ‰¯,è§‚çœ‹è¯·è°¨æ…!!!</h1><p><code>TeamCity</code> æ˜¯ <code>Jetbrains</code> å…¬å¸å‡ºå“çš„æŒç»­åŒ–é›†æˆå·¥å…·ï¼Œç±»ä¼¼<code>Jenkins</code>,ç•Œé¢æ›´åŠ ç°ä»£åŒ–ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§,è€Œä¸”å®ƒçš„ server å’Œ agent æ˜¯åˆ†ç¦»çš„ï¼Œå¯ä»¥æŒ‡å®šæœ¬æœºæˆ–è¿œç¨‹çš„æœºå™¨æ¥è¿è¡Œæ„å»ºç­–ç•¥ï¼Œå…¶ä¸­è¿˜æœ‰è°ƒåº¦é˜Ÿåˆ—ç®—æ³•.<br><code>hexo</code> æ˜¯é™æ€åšå®¢ç”Ÿæˆå·¥å…·.<code>hexo d -g</code>å‘½ä»¤å¯ä»¥è‡ªåŠ¨ç”Ÿæˆ <code>public</code> æ–‡ä»¶å¤¹åŠ HTMLï¼Œç„¶åå°†å…¶æ¨é€åˆ° github(åœ¨<code>_config.yml</code>ä¸­å·²ç»é…ç½®è¿‡).<br>ä¸€èˆ¬ç”¨æˆ·å¯èƒ½å¯¹<code>theme</code>è‡ªå®šä¹‰(ä¿®æ”¹<code>theme</code>ä¸‹çš„<code>_config.yml</code>),å½“æ¢æœºæˆ–å¤‡ä»½æ—¶ï¼Œå¸Œæœ›å°†åšå®¢æºæ–‡ä»¶(*.md)åŠä¿®æ”¹çš„ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸€å¹¶å¤‡ä»½.è€Œ<code>hexo</code>é»˜è®¤åªå¤‡ä»½<code>public</code>æ–‡ä»¶å¤¹,æ‰€ä»¥æœ¬æ–‡æ¢ç´¢ä½¿ç”¨ CI<code>TeamCity</code>å°†æ¨é€åˆ°<code>Github</code>çš„æºæ–‡ä»¶ç¼–è¯‘ç”Ÿæˆ<code>public</code>æ–‡ä»¶,è¿™æ ·æ¯æ¬¡å†™å®Œæ–‡ç« ,åªè¦å°†å…¶æ¨é€åˆ°<code>Github</code>,<code>TeamCity</code>ä¼šè‡ªåŠ¨ç”Ÿæˆåšå®¢<code>HTML</code>.</p>
<p>è·å–åˆ°è¯¥ Key.è€Œå®é™…ä¸Šåœ¨ build æ‰§è¡Œæ—¶ key ä»¥ ing è¢«åˆ é™¤äº†,ä¸å¯èƒ½è·å–åˆ°.è¿™å¹¶ä¸æ„å‘³ç€ç»å¯¹å®‰å…¨ï¼Œåªæ˜¯å¢åŠ äº† key è¢«ç›—çš„éš¾åº¦. agent å¿…é¡»å®‰å…¨.</p>
<h3 id="teamcity-å®‰è£…"><a href="#teamcity-å®‰è£…" class="headerlink" title="teamcity å®‰è£…"></a>teamcity å®‰è£…</h3><p><code>TeamCity</code>æä¾›äº† <code>Docker</code>å®‰è£…æ–¹å¼ï¼Œå› æ­¤è¯·æå‰å®‰è£…å¥½<code>Docker</code>.<br>æ–‡ä»¶ç›®å½•å¦‚ä¸‹(è¯·æå‰åˆ›å»º),teamcity æ”¯æŒå¤šç§æ•°æ®å­˜å‚¨æ–¹å¼ï¼Œæ­¤å¤„ä½¿ç”¨ mysql æ¥å­˜å‚¨ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># - teamcity</span></span><br><span class="line">    - agent</span><br><span class="line">        - conf</span><br><span class="line">        - data</span><br><span class="line">    - server</span><br><span class="line">        - data</span><br><span class="line">        - datadir</span><br><span class="line">        - opt</span><br><span class="line">    - mysql</span><br><span class="line">        - backup</span><br><span class="line">        - data</span><br><span class="line">    dockery-compose.yml</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ˜¯<code>docker-compose.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">``yaml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">"3.3"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  teamcity-server:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">jetbrains/teamcity-server</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">teamcity-server</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">8111</span><span class="string">:8111</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">$PWD/server/datadir:/data/teamcity_server/datadir</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">$PWD/server/opt/logs:/opt/teamcity/logs</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">$PWD/server/data:/data/teamcity_server/others</span> <span class="comment"># å…¶ä»–çš„ä¸€äº›èµ„æºï¼Œå¯ä»¥ä»æœ¬æœºå¤åˆ¶åˆ° server ä¸Š</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line">      <span class="comment">#   TEAMCITY_SERVER_MEM_OPTS: -Xmx2g -XX:MaxPermSize=270m -XX:ReservedCodeCacheSize=350m</span></span><br><span class="line"><span class="attr">      MYSQL_USER:</span> <span class="string">team-user</span></span><br><span class="line"><span class="attr">      MYSQL_PASSWORD:</span> <span class="string">team-pwd</span></span><br><span class="line"><span class="attr">      MYSQL_ROOT_PASSWORD:</span> <span class="string">teamcity8080</span></span><br><span class="line"><span class="attr">      MYSQL_DATABASE:</span> <span class="string">teamcitydb</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">db</span></span><br><span class="line"><span class="attr">    links:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">db</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">team</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  db:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">teamcity-db</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">$PWD/mysql:/etc/mysql/conf.d</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">$PWD/mysql/backup:/var/lib/mysql</span> <span class="comment"># åªæœ‰ /var/lib/mysql å¯¹åº”æœ¬åœ°æ–‡ä»¶ä¸ºç©ºï¼Œæ‰ä¼šåˆ›å»ºè¿™ä¸ªæ•°æ®åº“,å³åˆæ¬¡åˆ›å»ºæ—¶ï¼Œè¿™ä¸ªå¯¹åº”çš„æœ¬åœ°æ–‡ä»¶å¤¹è¦ä¸ºç©º</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">$PWD/mysql/data:/others</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      MYSQL_USER:</span> <span class="string">team-user</span></span><br><span class="line"><span class="attr">      MYSQL_PASSWORD:</span> <span class="string">team-pwd</span></span><br><span class="line"><span class="attr">      MYSQL_ROOT_PASSWORD:</span> <span class="string">teamcity8080</span></span><br><span class="line"><span class="attr">      MYSQL_DATABASE:</span> <span class="string">teamcitydb</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">3306</span><span class="string">:3306</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">team</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># &lt;&gt;&lt;&gt; agent &lt;&gt;&lt;&gt;</span></span><br><span class="line"><span class="attr">  teamcity-agent:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">jetbrains/teamcity-agent</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">teamcity-agent</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">$PWD/agent/conf:/data/teamcity_agent/conf</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">$PWD/agent/data:/data/teamcity_agent/others</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      AGENT_NAME:</span> <span class="string">MacbookPro</span></span><br><span class="line"><span class="attr">      SERVER_URL:</span> <span class="attr">http://xxx.xxx.x.xxx:8111</span> <span class="comment"># æ­¤å¤„å¯¹åº”çš„æ˜¯ TeamCityServer çš„IP, localhost/127.0.0.1 éƒ½ä¸è¡Œï¼Œè¯·ä½¿ç”¨æ­£ç¡®çš„ IP,ç«¯å£å¯¹åº”ä¸Šé¢æš´éœ²å‡ºæ¥çš„ç«¯å£</span></span><br><span class="line"><span class="attr">    links:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">teamcity-server</span></span><br><span class="line">  <span class="comment"># teamcity_agent é»˜è®¤çš„ä»»åŠ¡ç¯å¢ƒè·¯å¾„: opt/buildagent/work</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  team:</span></span><br><span class="line"><span class="attr">    driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åæ‰§è¡Œ <code>docker-compose up -d</code> å³å¯ã€‚</p>
<blockquote>
<p>éœ€è¦å…ˆæ ¹æ®æœ¬æœº OS å®‰è£…<code>docker-compose</code> &gt; <code>docker-compose up -d</code> ç”ŸæˆæœåŠ¡<br><code>docker-compose down</code> è§£ä½“æœåŠ¡ï¼Œåˆ é™¤å®¹å™¨,ç½‘ç»œ<br><code>docker-compose start/stop</code> å¯åŠ¨ç»ˆæ­¢æœåŠ¡</p>
</blockquote>
<ul>
<li><p>æ‰“å¼€ <code>http://localhost:8111</code> æˆ– <code>http://[ip]:8111</code> å³å¯è¿›å…¥ TeamCity Server web äº¤äº’ç¯å¢ƒ.æŒ‰ç…§æç¤ºåˆå§‹åŒ–.ç™»å½•æ—¶é»˜è®¤æ²¡æœ‰è®¿å®¢åˆ›å»ºæ–°ç”¨æˆ·çš„æƒé™ï¼Œæ‰€ä»¥éœ€è¦å·²è¶…çº§ç”¨æˆ·æƒé™ç™»å½•ï¼Œç‚¹å‡»ä¸‹é¢çš„ä»¥è¶…çº§æƒé™ç™»å½•åæç¤ºè¾“å…¥ token,å¯ä»¥è¿›å…¥ TeamCity Server æœ¬åœ°æ˜ å°„æ–‡ä»¶ä¸­æŸ¥æ‰¾ï¼Œæˆ–æ˜¯ä½¿ç”¨ <code>docker logs teamcity-server</code> å³å¯çœ‹åˆ° tokenã€‚</p>
</li>
<li><p>åˆ›å»ºé¡¹ç›®æ—¶ï¼ŒTeamCity é»˜è®¤ä½¿ç”¨ç”¨æˆ·åå¯†ç è¿æ¥ Github,å½“ç„¶å¯ä»¥é€šè¿‡ä¸Šä¼ æœ¬åœ° ssh key å¯†é’¥åˆ° TeamCity Server,é€šè¿‡ TeamCity Server è¿æ¥.</p>
</li>
<li><p>è®¾ç½®ç¼–è¯‘æ­¥éª¤,æˆ‘å†æ¬¡æ‰§è¡Œäº†<code>shell è„šæœ¬</code></p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#! /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… nodejs</span></span><br><span class="line">VERSION=v10.15.2</span><br><span class="line">DISTRO=linux-x64</span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">checkNode</span></span>() &#123;</span><br><span class="line">  ISNODESUCCEED=$(node -v)</span><br><span class="line">  <span class="keyword">if</span> [ ISNODESUCCEED != <span class="variable">$VERSION</span> ]; <span class="keyword">then</span></span><br><span class="line">    installNode</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"NodeJSå·²å®‰è£…"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">insallNode</span></span>() &#123;</span><br><span class="line">  mkdir -p /usr/<span class="built_in">local</span>/lib/nodejs</span><br><span class="line">  tar -xJf /data/teamcity_agent/others/node-<span class="variable">$VERSION</span>-<span class="variable">$DISTRO</span> <span class="comment"># -v ä¼šè¾“å‡ºè§£å‹æ—¥å¿—ï¼Œæ­¤å¤„å¤ªå¤šï¼Œæ‰€ä»¥å…³é—­</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/lib/nodejs/node-<span class="variable">$VERSION</span>-<span class="variable">$DISTRO</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">source</span> ~/.profile</span><br><span class="line"></span><br><span class="line">  checkNode</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">checkNode</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">npm i</span><br><span class="line"><span class="comment"># ç”Ÿæˆpublicæ–‡ä»¶</span></span><br><span class="line">./node_modules/hexo/bin/hexo g</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸º github.io é…ç½® CNAME</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">"/CNAME"</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"blog.dang8080.cn"</span> &gt; CNAME</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½® git</span></span><br><span class="line"></span><br><span class="line">git config --global credential.helper store <span class="comment"># ä¿å­˜ github æäº¤è€…ä¿¡æ¯ï¼Œä¸‹æ¬¡ä¸ç”¨å†è¾“å¯†ç </span></span><br><span class="line">git config --global user.name <span class="string">"Humphrey"</span></span><br><span class="line">git config --global user.email <span class="string">"dang8080@qq.com"</span></span><br><span class="line"></span><br><span class="line">git add --all</span><br><span class="line">git commit -m <span class="string">"TeamCity CI æäº¤éƒ¨ç½²: <span class="variable">$(date)</span>"</span></span><br><span class="line">git push origin master</span><br></pre></td></tr></table></figure>

<h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜:"></a>é—®é¢˜:</h3><blockquote>
<p>æ‰€ä»¥é—®é¢˜æ¥äº†,é…ç½®å®Œäº†ç‚¹å‡» <code>run</code> æŸ¥çœ‹ Build log ä¼šå‘ç° push å¤±è´¥ã€‚å› ä¸ºé€šè¿‡ https å‘ github æäº¤ä»£ç éœ€è¦äº¤äº’å¼è¾“å…¥ç”¨æˆ·å¯†ç ã€‚è€Œæ­¤å¤„æ²¡æœ‰æä¾›ï¼Œå°†å¯†ç ç¡¬ç¼–ç åˆ°æ­¤ shell é‡Œæäº¤åˆ° github ä¹Ÿä¸å®‰å…¨ã€‚<br>æˆ–è€…å³ä½¿æ˜¯é€šè¿‡ä¿®æ”¹ VCS root ä½¿ç”¨ <a href="mailto:git@github.com">git@github.com</a> ssh checkout çš„ä»£ç ï¼Œä¹Ÿæ— æ³•æ¨é€åˆ° github.</p>
</blockquote>
<h4 id="é—®é¢˜å®šä½"><a href="#é—®é¢˜å®šä½" class="headerlink" title="é—®é¢˜å®šä½:"></a>é—®é¢˜å®šä½:</h4><blockquote>
<p>TeamCity SSH agent ä½¿ç”¨æœ¬æœº(Linux/MacOS)çš„ OpenSSH ç®¡ç† SSH,å¯¹äº Windows,éœ€è¦æ‰‹åŠ¨å®‰è£… OpenSSH (CygWin,MinGW,Git for Windows).<br>SSH agent å¿…é¡»æ·»åŠ åˆ° <code>$PATH</code> ä¸­.<br>ç¬¬ä¸€æ¬¡è¿æ¥åˆ°è¿œç¨‹åœ°å€æ—¶ï¼ŒSSH agent ä¼šè¯¢é—®æ˜¯å¦ä¿å­˜è¿œç¨‹åœ°å€çš„ fingerprint åˆ°åœ°å€æ•°æ®åº“ <code>~/.ssh/known_hosts</code>ä¸­.<br>ä¸ºäº†é¿å…è¯¢é—®ï¼Œå¯ä»¥æå‰é…ç½®ã€‚å¦‚æœç›¸ä¿¡è¯¥è¿œç¨‹åœ°å€ï¼Œå¯ä»¥ç¦ç”¨è¿œç¨‹åœ°å€æ£€æŸ¥</p>
</blockquote>
<blockquote>
<p>å¯¹æ‰€æœ‰çš„è¿æ¥éƒ½ç¦ç”¨ï¼Œ<code>~/.ssh/config</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">Host \*</span><br><span class="line">StrictHostKeyChecking no</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç‰¹å®šè¿æ¥,<code>-o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no</code></p>
</blockquote>
<blockquote>
<p>TeamCity å½“å‰ä»…æ”¯æŒ PEM æ ¼å¼çš„ key.å¦‚æœä½¿ç”¨äº†å…¶ä»–æ ¼å¼çš„ keyï¼Œè¯·å°†å…¶è½¬æ¢ä¸º PEM.å¯ä»¥åœ¨ TeamCity web ç•Œé¢ <code>Conversions -&gt; Export OpenSSH key</code> ä¸­è½¬æ¢.</p>
</blockquote>
<blockquote>
<p>OpenSSH æœ€è¿‘ç‰ˆæœ¬é»˜è®¤ä¸ç”Ÿæˆ PEM æ ¼å¼ key.ä½¿ç”¨ä¸‹åˆ—æ–¹å¼ç”Ÿæˆ PEM: <code>ssh-keygen -t rsa -m PEM</code></p>
</blockquote>
<blockquote>
<p>ä¸Šä¼ åˆ° TeamCity Server çš„ SSH key é»˜è®¤ä¿å­˜åœ¨ <code>&lt;TeamCity Data Directory&gt;/config/projects/&lt;project&gt;/pluginData/ssh_keys</code>ï¼ŒTeamCity ä¼šè¿½è¸ªæ­¤æ–‡ä»¶å¤¹ä¿è¯ SSH key æ›´æ–°ã€‚SSH key é€‚ç”¨äºæœ¬é¡¹ç›®åŠå­é¡¹ç›®.</p>
</blockquote>
<blockquote>
<p>åœ¨ TeamCity agent checkout æ‰§è¡Œæ—¶ï¼ŒGit æ’ä»¶ä¼šä» TeamCity Server ä¸‹è½½ SSH key åˆ° agent.è¯¥ key ä¼šæš‚æ—¶ä¿å­˜åœ¨ TeamCity agent çš„æ–‡ä»¶ç³»ç»Ÿé‡Œï¼Œåœ¨ <code>fetch/clone</code> ç»“æŸåå°±è¢«åˆ é™¤.</p>
</blockquote>
<blockquote>
<p>key è¢«åˆ é™¤çš„åŸå› æ˜¯ï¼šé€šè¿‡ build æ‰§è¡Œçš„ test å¯èƒ½ä¼šç•™ä¸‹æ¶æ„ä»£ç ï¼Œä¹‹åä¼šè®¿é—® TeamCity agent æ–‡ä»¶ç³»ç»Ÿ,</p>
</blockquote>
<p>TeamCity æ˜¯ä¸æ”¯æŒ git ssh æ¨åŠ¨ä»£ç åˆ° github çš„.ï¼ˆæ”¯æŒ ssh ä¼ é€æ–‡ä»¶ï¼‰</p>
<h4 id="æ–¹æ¡ˆä¸€"><a href="#æ–¹æ¡ˆä¸€" class="headerlink" title="æ–¹æ¡ˆä¸€:"></a>æ–¹æ¡ˆä¸€:</h4><p>å½“ <code>run</code> ä¸€æ¬¡ä¹‹åï¼Œæ‰§è¡Œ <code>docker exec -it teamcity-agent bash</code> è¿›å…¥ <code>opt/buildagent/work/xxxxx/</code> ä¸‹,æ‰‹åŠ¨ <code>git push origin master</code>ã€‚è¿™æ ·åç»­å°±ä¸ç”¨å†é…ç½®äº†</p>
<h4 id="æ–¹æ¡ˆäºŒ-ç¡¬æ ¸"><a href="#æ–¹æ¡ˆäºŒ-ç¡¬æ ¸" class="headerlink" title="æ–¹æ¡ˆäºŒ:(ç¡¬æ ¸)"></a>æ–¹æ¡ˆäºŒ:(ç¡¬æ ¸)</h4><p><code>github</code> éœ€è¦ä¿å­˜æœ¬æœºçš„ SSH pub key,æ‰æ¥å— git ssh æ¨é€.é‚£æˆ‘ä»¬å°±åœ¨ TeamCity ç”Ÿæˆ ssh key,ç„¶åæ·»åŠ åˆ° github.</p>
<h5 id="å®è·µä¸€"><a href="#å®è·µä¸€" class="headerlink" title="å®è·µä¸€"></a>å®è·µä¸€</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docekr <span class="built_in">exec</span> -it teamcity-agent bash</span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-add [id_rsa]</span><br><span class="line"><span class="comment"># ç„¶åå¤åˆ¶ id_rsa.pub çš„å†…å®¹åˆ° github å³å¯</span></span><br></pre></td></tr></table></figure>

<h5 id="å®è·µäºŒ"><a href="#å®è·µäºŒ" class="headerlink" title="å®è·µäºŒ"></a>å®è·µäºŒ</h5><p>è¿ TeamCity agent bash ä¹Ÿä¸æƒ³è¿›ï¼Œä½¿ç”¨ shell æ„å»º<br>å…ˆå®‰è£… expect tcl tk</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt-get update &amp;&amp; apt-get install tcl tk expect</span><br><span class="line"><span class="comment"># ä¸‹é¢æ˜¯ shell</span></span><br><span class="line"><span class="comment">#! /usr/bin/expect -f</span></span><br><span class="line"><span class="built_in">set</span> context <span class="variable">$PWD</span></span><br><span class="line"><span class="comment"># åˆ é™¤æ—§key</span></span><br><span class="line">spawn rm -f <span class="string">"<span class="variable">$context</span>/id_rsa"</span> <span class="string">"<span class="variable">$context</span>/id_rsa.pub"</span></span><br><span class="line">expect&#123;&#125;</span><br><span class="line"><span class="comment"># ç”Ÿæˆæ–°key</span></span><br><span class="line">spawn ssh-keygen -t rsa</span><br><span class="line">expect&#123;</span><br><span class="line">  <span class="string">"*save the key*"</span> &#123; send <span class="string">"<span class="variable">$context</span>/id_rsa\r"</span>;exp_continue &#125;</span><br><span class="line">  <span class="string">"*passphrase*"</span> &#123; send <span class="string">"\r"</span>;exp_continue &#125;</span><br><span class="line">  <span class="string">"*again*"</span> &#123; send <span class="string">"\r"</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line">spawn ssh-add <span class="string">"<span class="variable">$context</span>/id_rsa"</span></span><br><span class="line">sshcheck=$(ssh -vT git@github.com)</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$sshcheck</span> =~ <span class="string">"successfully authenticated"</span> ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"ssh é…ç½®æˆåŠŸ"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"ssh é…ç½®å¤±è´¥"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># å¤åˆ¶ pub</span></span><br><span class="line">pubkey=$(cat <span class="string">"<span class="variable">$context</span>/id_rsa)</span></span><br><span class="line"><span class="string">curl -H "</span>Content-Type:application/json<span class="string">" -X POST --data '&#123; "</span>title<span class="string">":"</span>TeamCityAgentAuto<span class="string">","</span>key<span class="string">":"</span><span class="variable">$pubkey</span><span class="string">"&#125;'</span></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>teamcity</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>[è¯‘]-LiveData with SnackBar,Navigation and other events(the SingleLiveEvent case)</title>
    <url>/2019/02/28/%E8%AF%91-LiveData-with-SnackBar-Navigation-and-other-events-the-SingleLiveEvent-case/</url>
    <content><![CDATA[<p><a href="https://medium.com/androiddevelopers/livedata-with-snackbar-navigation-and-other-events-the-singleliveevent-case-ac2622673150" target="_blank" rel="noopener">åŸæ–‡</a></p>
<p>view(activity/fragment) å’Œ ViewModel äº¤æµçš„æ¯”è¾ƒå¥½çš„æ–¹å¼æ˜¯ LiveData observables. view è®¢é˜… LiveData çš„æ”¹å˜ä¸”éšæ—¶å“åº”ã€‚è¿™é€‚ç”¨äºè¿ç»­ä¸æ–­çš„æ˜¾ç¤ºåœ¨ä¸€ä¸ªå±å¹•çš„æ•°æ®ã€‚<br><img src="http://qiniu.picbed.dang8080.cn/20190228202711.png" alt="LiveData"><br>ä½†æ˜¯æŸäº›æ•°æ®å´æ›´åº”è¯¥è¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œæ¯”å¦‚ Snackbar æ¶ˆæ¯ï¼Œnavigation äº‹ä»¶ æˆ– dialog è§¦å‘å™¨ã€‚<br><img src="http://qiniu.picbed.dang8080.cn/20190228202852.png" alt="LiveData once"><br>ä¸å…¶è¯•ç€é€šè¿‡æ‰©å±• Architecture Components æ‰©å±•æˆ–åº“è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸å¦‚æˆ‘ä»¬å¯ä»¥ç›´é¢è¿™æ˜¯ä¸ªè®¾è®¡ç¼ºé™·ã€‚æˆ‘ä»¬æ¨èä½ æŠŠä½ çš„äº‹ä»¶çœ‹ä½œæ˜¯çŠ¶æ€çš„ä¸€éƒ¨åˆ†ã€‚æœ¬æ–‡æˆ‘ä»¬å°†åˆ—ä¸¾ä¸€äº›å¸¸è§çš„é”™è¯¯å’Œæ¨èçš„è§£å†³æ–¹æ¡ˆã€‚</p>
<a id="more"></a>
<h3 id="âŒ-Bad-1-å¯¹äº‹ä»¶ä½¿ç”¨-LiveData"><a href="#âŒ-Bad-1-å¯¹äº‹ä»¶ä½¿ç”¨-LiveData" class="headerlink" title="âŒ Bad: 1. å¯¹äº‹ä»¶ä½¿ç”¨ LiveData"></a>âŒ Bad: 1. å¯¹äº‹ä»¶ä½¿ç”¨ LiveData</h3><p>åœ¨ LiveData å¯¹è±¡å†…éƒ¨ç›´æ¥æŒæœ‰ Snackbar æ¶ˆæ¯æˆ– navigation ä¿¡å·ã€‚åŸåˆ™ä¸Šæ™®é€šçš„ LiveData å¯¹è±¡å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼Œä½†å®é™…ä¸Šä¼šæš´éœ²ä¸€äº›é—®é¢˜ã€‚<br>åœ¨ master/detail æ¶æ„çš„ app ä¸­ï¼Œå¦‚ä¸‹æ˜¯ maters çš„ ViewModel</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¯·ä¸è¦å¯¹äº‹ä»¶è¿™æ ·ç”¨</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListViewModel</span> : <span class="type">ViewModel &#123;</span></span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> _navigateToDetails = MutableLiveData&lt;<span class="built_in">Boolean</span>&gt;()</span><br><span class="line">  <span class="keyword">val</span> navigateToDetails : LiveData&lt;<span class="built_in">Boolean</span>&gt;</span><br><span class="line">      <span class="keyword">get</span>() = _navigateToDetails</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">userClicksOnButton</span><span class="params">()</span></span> &#123;</span><br><span class="line">    _navigateToDetails.value = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ View(activity/fragment) ä¸­</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">myViewModel.navigateToDetails.observe(<span class="keyword">this</span>,Observer &#123;</span><br><span class="line">  <span class="keyword">if</span> (it) startActivity(DetailsActivity....)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>æ­¤æ–¹æ¡ˆçš„ä¸è¶³åœ¨äº <code>_navigateToDetails</code>å°†ä¼šä¸€ç›´ä¸º true,è€Œä¸”ä¸å¯èƒ½å›åˆ°é¦–å±:</p>
<ul>
<li>ç”¨æˆ·ç‚¹å‡»æŒ‰é’®å¯åŠ¨ Details Activity</li>
<li>ç”¨æˆ·æŒ‰è¿”å›æŒ‰é’®ï¼Œå›åˆ°ä¸» Activity</li>
<li>å½“ activity è¿›å…¥å›é€€æ ˆæ—¶ observers å¤±æ´»ï¼Œç°åœ¨å†æ¬¡æ¿€æ´»</li>
</ul>
<p>ä» ViewModel ä¸­è°ƒç”¨ navigation ä¸”ç«‹å³å°†å…¶è®¾ä¸º false</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">userClicksOnButton</span><span class="params">()</span></span> &#123;</span><br><span class="line">  _navigateToDetails.value = <span class="literal">true</span></span><br><span class="line">  _navigateToDetails.value = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯è¯·æ³¨æ„ï¼š LiveData ä¿å­˜æ•°æ®ä½†ä¸ä¼šä¿è¯åœ¨æ¥å—åˆ°äº‹ä»¶æ—¶å‘é€ä»»ä½•æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå½“æ²¡æœ‰è§‚å¯Ÿè€…æ´»è·ƒæ—¶æ›´æ–°å€¼ï¼Œé‚£ä¹ˆä¸€ä¸ªæ–°å€¼å°†æ›¿æ¢åŸæ¥çš„å€¼ã€‚åŒæ—¶ï¼Œä»ä¸åŒçº¿ç¨‹è®¾ç½®å±æ€§å°†ä¼šå¯¼è‡´ç«äº‰çŠ¶æ€ï¼Œæ­¤æ—¶ä»…èƒ½ä¿è¯ä¸€ä¸ªè§‚å¯Ÿè€…è¢«è°ƒç”¨ã€‚</p>
<p>æœ€ä¸»è¦çš„é—®é¢˜æ˜¯ï¼Œè¿™ä¸ªæ–¹æ¡ˆå¾ˆéš¾ç†è§£è€Œä¸”ä»£ç åƒåœ¾ã€‚æ‰€ä»¥æˆ‘ä»¬å¦‚ä½•ä¿è¯åœ¨ navigation äº‹ä»¶å‘ç”Ÿæ—¶å€¼é‡ç½®ï¼Ÿ</p>
<h3 id="âŒBetter-2-ä½¿ç”¨-LiveData-wrapper-äº‹ä»¶ï¼Œåœ¨è§‚å¯Ÿè€…ä¸­é‡ç½®å±æ€§"><a href="#âŒBetter-2-ä½¿ç”¨-LiveData-wrapper-äº‹ä»¶ï¼Œåœ¨è§‚å¯Ÿè€…ä¸­é‡ç½®å±æ€§" class="headerlink" title="âŒBetter: 2.ä½¿ç”¨ LiveData wrapper äº‹ä»¶ï¼Œåœ¨è§‚å¯Ÿè€…ä¸­é‡ç½®å±æ€§."></a>âŒBetter: 2.ä½¿ç”¨ LiveData wrapper äº‹ä»¶ï¼Œåœ¨è§‚å¯Ÿè€…ä¸­é‡ç½®å±æ€§.</h3><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">listViewModel.navigateToDetails.observe(<span class="keyword">this</span>,Observer &#123;</span><br><span class="line">  <span class="keyword">if</span> (it) &#123;</span><br><span class="line">    myViewModel.navigateToDetailsHandled()</span><br><span class="line">    startActivity(DetailsActivity...)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListViewModel</span>: <span class="type">ViewModel &#123;</span></span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> _navigateToDetails = MutableLiveData&lt;<span class="built_in">Boolean</span>&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> navigateToDetails: LiveData&lt;<span class="built_in">Boolean</span>&gt;</span><br><span class="line">    <span class="keyword">get</span>() = _navigateToDetails</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">userClicksOnButton</span><span class="params">()</span></span> &#123;</span><br><span class="line">    _navigateToDetails.value = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">navigateToDetailsHandled</span><span class="params">()</span></span> &#123;</span><br><span class="line">    _navigateToDetails.value = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ–¹æ¡ˆçš„ä¸è¶³ä¹‹å¤„åœ¨äºæœ‰äº›å†—ä½™ä»£ç </p>
<h3 id="âœ…-okï¼šä½¿ç”¨-SingleLiveEvent"><a href="#âœ…-okï¼šä½¿ç”¨-SingleLiveEvent" class="headerlink" title="âœ… okï¼šä½¿ç”¨ SingleLiveEvent"></a>âœ… okï¼šä½¿ç”¨ SingleLiveEvent</h3><p>SingleLiveEvent åªé€‚ç”¨äºéƒ¨åˆ†åœºæ™¯ã€‚åªå‘é€å’Œæ›´æ–°ä¸€æ¬¡çŠ¶æ€çš„ LiveData</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListViewModel</span>: <span class="type">ViewModel &#123;</span></span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> _navigateToDetails = SingleLiveEvent&lt;Any&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> navigateToDetails: LiveData&lt;Any&gt;</span><br><span class="line">    <span class="keyword">get</span>() = _navigateToDetails</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">userClicksOnButton</span><span class="params">()</span></span> &#123;</span><br><span class="line">    _navigateToDetails.call()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">myViewModel.navigateToDetails.observe(<span class="keyword">this</span>, Observer &#123;</span><br><span class="line">    startActivity(DetailsActivity...)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SingleLiveEvent</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleLiveEvent</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">MutableLiveData</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"SingleLiveEvent"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean mPending = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observe</span><span class="params">(LifecycleOwner owner, <span class="keyword">final</span> Observer&lt;T&gt; observer)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasActiveObservers()) &#123;</span><br><span class="line">            Log.w(TAG, <span class="string">"Multiple observers registered but only one will be notified of changes."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Observe the internal MutableLiveData</span></span><br><span class="line">        <span class="keyword">super</span>.observe(owner, <span class="keyword">new</span> Observer&lt;T&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(@Nullable T t)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (mPending.compareAndSet(<span class="keyword">true</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">                    observer.onChanged(t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(@Nullable T t)</span> </span>&#123;</span><br><span class="line">        mPending.set(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">super</span>.setValue(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Used for cases where T is Void, to make calls cleaner.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        setValue(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ–¹æ¡ˆçš„ä¸è¶³ä¹‹å¤„åœ¨äºåªæœ‰ä¸€ä¸ªè®¢é˜…è€…ã€‚å¦‚æœä½ æœ‰å¤šä¸ªè§‚å¯Ÿè€…ï¼Œé‚£ä¹ˆåªæœ‰ä¸€ä¸ªè¢«è°ƒç”¨ä¸”ä¸ä¿è¯é¡ºåºã€‚<br><img src="http://qiniu.picbed.dang8080.cn/20190303082724.png" alt="SingleLiveEvent"></p>
<h3 id="âœ…-æ¨èï¼šä½¿ç”¨-Event-Wrapper"><a href="#âœ…-æ¨èï¼šä½¿ç”¨-Event-Wrapper" class="headerlink" title="âœ… æ¨èï¼šä½¿ç”¨ Event Wrapper"></a>âœ… æ¨èï¼šä½¿ç”¨ Event Wrapper</h3><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">Event</span>&lt;<span class="type">out T</span>&gt;</span>(<span class="keyword">private</span> <span class="keyword">val</span> content: T) &#123;</span><br><span class="line">  <span class="keyword">val</span> hasBeenHandled = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">set</span> <span class="comment">// åªè¯»å±æ€§</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * è¿”å› content, é˜»æ­¢å…¶å†æ¬¡è°ƒç”¨</span></span><br><span class="line"><span class="comment">  fun getContentIfNotHandled(): T? &#123;</span></span><br><span class="line"><span class="comment">    return if (hasBeenHandled) &#123;</span></span><br><span class="line"><span class="comment">        null</span></span><br><span class="line"><span class="comment">    &#125; else &#123;</span></span><br><span class="line"><span class="comment">        hasBeenHandled = true</span></span><br><span class="line"><span class="comment">        content</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  fun peekContent(): T = content</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListViewModel</span> : <span class="type">ViewModel &#123;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> _navigateToDetails = MutableLiveData&lt;Event&lt;String&gt;&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> navigateToDetails : LiveData&lt;Event&lt;String&gt;&gt;</span><br><span class="line">        <span class="keyword">get</span>() = _navigateToDetails</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">userClicksOnButton</span><span class="params">(itemId: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        _navigateToDetails.value = Event(itemId)  <span class="comment">// Trigger the event by setting a new Event as a new value</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListViewModel</span> : <span class="type">ViewModel &#123;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> _navigateToDetails = MutableLiveData&lt;Event&lt;String&gt;&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> navigateToDetails : LiveData&lt;Event&lt;String&gt;&gt;</span><br><span class="line">        <span class="keyword">get</span>() = _navigateToDetails</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">userClicksOnButton</span><span class="params">(itemId: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        _navigateToDetails.value = Event(itemId)  <span class="comment">// Trigger the event by setting a new Event as a new value</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ–¹æ¡ˆçš„ä¼˜åŠ¿æ˜¯ç”¨æˆ·éœ€è¦ä½¿ç”¨ <code>getContentIfNotHandled() æˆ– peekContent()</code>æŒ‡å®šæ„å›¾ã€‚æ­¤æ–¹æ³•æŠŠäº‹ä»¶æŠ½è±¡ä¸º state çš„ä¸€éƒ¨åˆ†ï¼šå˜æˆä»…è¡¨ç¤ºæ˜¯å¦è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚<br><img src="http://qiniu.picbed.dang8080.cn/20190303074902.png" alt="ä½¿ç”¨ Event wrapper,å¯ä»¥åœ¨å•ä¸€ç”¨æˆ·äº‹ä»¶ä¸Šæ·»åŠ å¤šä¸ªè§‚å¯Ÿè€…"></p>
<h4 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h4><p>æ€»ä¹‹ï¼ŒæŠŠäº‹ä»¶ä½œä¸ºçŠ¶æ€çš„ä¸€éƒ¨åˆ†ã€‚<br>ä½¿ç”¨è¿™ä¸ª EventObserver åœ¨å¤§é‡äº‹ä»¶ç»“æŸåç§»é™¤å®ƒ</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventObserver</span>&lt;<span class="type">T</span>&gt;</span>(<span class="keyword">private</span> <span class="keyword">val</span> onEventUnhandledContent: (T) -&gt; <span class="built_in">Unit</span>) : Observer&lt;Event&lt;T&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onChanged</span><span class="params">(event: <span class="type">Event</span>&lt;<span class="type">T</span>&gt;?)</span></span> &#123;</span><br><span class="line">        event?.getContentIfNotHandled()?.let &#123; value -&gt;</span><br><span class="line">            onEventUnhandledContent(value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> LiveData<span class="type">&lt;Event&lt;T&gt;</span>&gt;.<span class="title">observeEvent</span><span class="params">(owner: <span class="type">LifecycleOwner</span>, <span class="keyword">crossinline</span> onEventUnhandledContent: (<span class="type">T</span>)</span></span> -&gt; <span class="built_in">Unit</span>) &#123;</span><br><span class="line">    observe(owner, Observer &#123; it?.getContentIfNotHandled()?.let(onEventUnhandledContent) &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>ç¿»è¯‘</tag>
        <tag>LiveData</tag>
        <tag>Navigation</tag>
      </tags>
  </entry>
  <entry>
    <title>gradle</title>
    <url>/2019/03/28/gradle/</url>
    <content><![CDATA[<p>gradle</p>
<a id="more"></a>
<h3 id="Gradle-å‡çº§æ—¥å¿—"><a href="#Gradle-å‡çº§æ—¥å¿—" class="headerlink" title="Gradle å‡çº§æ—¥å¿—"></a>Gradle å‡çº§æ—¥å¿—</h3><p>5.0 åŒ…å«äº† Kotlin DSL ç”Ÿäº§çº§æ”¯æŒ,ä¾èµ–ç‰ˆæœ¬å¯¹é½(ç±»ä¼¼ Maven BOM),ä»»åŠ¡è¶…æ—¶,Java 11 æ”¯æŒ</p>
<ul>
<li><p>Kotlin DSL 1.0</p>
</li>
<li><p>ä¾èµ–ç‰ˆæœ¬å¯¹é½:</p>
<ul>
<li>åŒä¸€é€»è¾‘ç»„(platform)ä¸‹çš„ä¸åŒæ¨¡å—åœ¨ä¾èµ–æ ‘ä¸­å¯ä»¥æœ‰ç›¸åŒçš„ç‰ˆæœ¬.ä¹Ÿå¯ä»¥å¯¼å…¥ Maven BOMs å®šä¹‰ platform.</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">  <span class="comment">// å¯¼å…¥ BOM.æ­¤æ–‡ä»¶ä¸­ç‰ˆæœ¬å°†è¦†ç›–ä¾èµ–æ ‘ä¸­çš„å…¶ä»–ç‰ˆæœ¬</span></span><br><span class="line">  implementation(enforcedPlatform(<span class="string">"org.springframework.boot:spring-boot-dependencies:1.5.8.RELEASE"</span>))</span><br><span class="line">  <span class="comment">// ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„ç‰ˆæœ¬</span></span><br><span class="line">  implementation(<span class="string">"com.google.code.gson:gson"</span>)</span><br><span class="line">  implementation(<span class="string">"dom4j:dom4j"</span>)</span><br><span class="line">  <span class="comment">// è¦†ç›–ä¸Šé¢çš„ç‰ˆæœ¬</span></span><br><span class="line">  implementation(<span class="string">"org.codehaus.groovy:groovy:1.8.6"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Gradle build åˆå§‹åŒ–ç‰¹æ€§</p>
</li>
<li><p>å¯æœç´¢æ–‡æ¡£</p>
</li>
<li><p>ä»»åŠ¡è¶…æ—¶</p>
</li>
<li><p>è§£æä¾èµ–æ—¶ HTTP é‡è¯•</p>
</li>
<li><p>æ€§èƒ½ç‰¹æ€§</p>
<ul>
<li>Gradle å¯ä»¥ä½œä¸ºä¸€ä¸ªä½ä¼˜å…ˆçº§çš„è¿›ç¨‹å¯åŠ¨: â€“priority low æˆ–è€… org.gradle.priority=low.å¯ä»¥ä¿è¯ IDE/Browser ä¸å¡,å³ä½¿æ˜¯ä¸€ä¸ªå¾ˆæ¶ˆè€—èµ„æºçš„ gradle ä»»åŠ¡.</li>
<li>å¤šä»»åŠ¡è¾“å‡ºå±æ€§ä¸å†ç¦ç”¨ç¼“å­˜.å½“ä½¿ç”¨ <code>@OutputFiles</code> æˆ– <code>OutputDirectories</code> æ ‡è®°ä¸€ä¸ª<code>Iterable</code>ç±»å‹,Gradle é€šå¸¸ä¼šå¯¹è¯¥ä»»åŠ¡ç¦ç”¨ç¼“å­˜ä¸”è¾“å‡ºå¦‚ä¸‹ä¿¡æ¯:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Declares multiple output files <span class="keyword">for</span> the single output property <span class="string">'outputFiles'</span> via @OutputFiles,@OutputDirectories or TaskOutputs.files()</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨ä¸ä¼šå†é˜»æ­¢ç¼“å­˜äº†.å¯¹è¯¥ä»»åŠ¡ç¦ç”¨ç¼“å­˜çš„å”¯ä¸€ç†ç”±å¯èƒ½æ˜¯å¦‚æœè¾“å‡ºåŒ…å«æ–‡ä»¶æ ‘.</p>
</li>
<li><p>Java 11 è¿è¡Œæ—¶æ”¯æŒ</p>
</li>
<li><p>æ’ä»¶æˆæƒç‰¹æ€§</p>
</li>
<li><p><code>Provider è¿½è¸ªäº§å“ä»»åŠ¡</code>ï¼šProvider API å®ä¾‹æä¾›äº†è¿½è¸ªæŸå€¼å’Œä»»åŠ¡æˆ–ç”Ÿæˆè¯¥å€¼çš„ä»»åŠ¡ã€‚</p>
</li>
<li><p>Gradle Native ç‰¹æ€§</p>
</li>
<li><p>æ¨å¹¿ç‰¹æ€§</p>
</li>
</ul>
<h3 id="Gradle-ç¼–è¯‘è¯­è¨€æŒ‡å—"><a href="#Gradle-ç¼–è¯‘è¯­è¨€æŒ‡å—" class="headerlink" title="Gradle ç¼–è¯‘è¯­è¨€æŒ‡å—"></a><a href="https://docs.gradle.org/current/dsl/index.html" target="_blank" rel="noopener">Gradle ç¼–è¯‘è¯­è¨€æŒ‡å—</a></h3><h4 id="gradle-å¯ä»¥ä½¿ç”¨ä¸åŒçš„è¯­è¨€æˆ–-DSL-æ¥æ‰§è¡Œç¼–è¯‘ä»»åŠ¡"><a href="#gradle-å¯ä»¥ä½¿ç”¨ä¸åŒçš„è¯­è¨€æˆ–-DSL-æ¥æ‰§è¡Œç¼–è¯‘ä»»åŠ¡" class="headerlink" title="gradle å¯ä»¥ä½¿ç”¨ä¸åŒçš„è¯­è¨€æˆ– DSL æ¥æ‰§è¡Œç¼–è¯‘ä»»åŠ¡"></a>gradle å¯ä»¥ä½¿ç”¨ä¸åŒçš„è¯­è¨€æˆ– DSL æ¥æ‰§è¡Œç¼–è¯‘ä»»åŠ¡</h4><h4 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h4><p>ç†è§£ä»¥ä¸‹æ¦‚å¿µå¯ä»¥å¸®åŠ©ä¹¦å†™ gradle è„šæœ¬.<br>é¦–å…ˆï¼Œgradle è„šæœ¬æ˜¯ä¸€ç§å¯é…ç½®è„šæœ¬.å½“è„šæœ¬æ‰§è¡Œæ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ªç‰¹å®šç±»å‹çš„é…ç½®å¯¹è±¡.ä¾‹å¦‚ build script æ‰§è¡Œæ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ªç±»å‹ä¸º Project çš„é…ç½®å¯¹è±¡.è¿™ä¸ªå¯¹è±¡ä½œä¸ºè„šæœ¬çš„ä»£ç†å¯¹è±¡è¢«ä½¿ç”¨.ä¸‹é¢æ˜¾ç¤ºäº† gradle è„šæœ¬å¯¹åº”çš„ä»£ç†å¯¹è±¡.</p>
<table>
<thead>
<tr>
<th>è„šæœ¬ç±»å‹</th>
<th>ä»£ç†å¯¹è±¡</th>
</tr>
</thead>
<tbody><tr>
<td>build script</td>
<td>Project</td>
</tr>
<tr>
<td>init script</td>
<td>Gradle</td>
</tr>
<tr>
<td>settings script</td>
<td>settings</td>
</tr>
</tbody></table>
<p>åœ¨è„šæœ¬å†…å¯ä»¥ä½¿ç”¨è¿™äº›ä»£ç†å¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•.</p>
<h4 id="build-script-ç»“æ„"><a href="#build-script-ç»“æ„" class="headerlink" title="build script ç»“æ„"></a>build script ç»“æ„</h4><p>ä¸€æ®µç¼–è¯‘è„šæœ¬ç”± 0 ä¸ªæˆ–å¤šä¸ªè¯­å¥å’Œè„šæœ¬å—ç»„æˆã€‚è¯­å¥å¯ä»¥åŒ…å«æ–¹æ³•è°ƒç”¨ï¼Œå±æ€§èµ‹å€¼ï¼Œå®šä¹‰å±€éƒ¨å˜é‡ã€‚ä¸€ä¸ªè„šæœ¬å—æ˜¯ä¸€ä¸ªæ¥å— closure ä½œä¸ºå‚æ•°çš„æ–¹æ³•è°ƒç”¨.è¿™ä¸ª closure å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå½“å…¶æ‰§è¡Œæ—¶é…ç½®äº†ä¸€äº›ä»£ç†å¯¹è±¡çš„å¯é…ç½® closure. æœ€é¡¶å±‚çš„è„šæœ¬å—å¦‚ä¸‹</p>
<table>
<thead>
<tr>
<th>è„šæœ¬å—</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>allprojects{}</td>
<td>é…ç½®æ­¤é¡¹ç›®åŠå…¶æ‰€æœ‰å­é¡¹ç›®</td>
</tr>
<tr>
<td>artifacts{}</td>
<td>é…ç½®æ­¤é¡¹ç›®çš„å‘å¸ƒäº§ç‰©</td>
</tr>
<tr>
<td>buildscript{}</td>
<td>é…ç½®æ­¤é¡¹ç›®çš„ build script classpath</td>
</tr>
<tr>
<td>configurations{}</td>
<td>é…ç½®æ­¤é¡¹ç›®çš„ä¾èµ–é…ç½®é¡¹</td>
</tr>
<tr>
<td>dependencies{}</td>
<td>é…ç½®æ­¤é¡¹ç›®çš„ä¾èµ–</td>
</tr>
<tr>
<td>repositories{}</td>
<td>é…ç½®æ­¤é¡¹ç›®çš„ä»“åº“</td>
</tr>
<tr>
<td>sourceSets{}</td>
<td>é…ç½®æ­¤é¡¹ç›®çš„ source set</td>
</tr>
<tr>
<td>subprojects{}</td>
<td>é…ç½®æ­¤é¡¹ç›®çš„å­é¡¹ç›®</td>
</tr>
<tr>
<td>publishing{}</td>
<td>é…ç½®ç”± publishing plugin æ·»åŠ çš„ publishingExtension</td>
</tr>
</tbody></table>
<p>ä¸€æ®µç¼–è¯‘è„šæœ¬åŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ª groovy è„šæœ¬,æ‰€ä»¥å¯ä»¥åŒ…å«èƒ½å‡ºç°åœ¨ groovy è„šæœ¬ä¸­çš„å…ƒç´ ,å¦‚ æ–¹æ³•å®šä¹‰ï¼Œç±»å®šä¹‰</p>
<h4 id="æ ¸å¿ƒç±»å‹"><a href="#æ ¸å¿ƒç±»å‹" class="headerlink" title="æ ¸å¿ƒç±»å‹"></a>æ ¸å¿ƒç±»å‹</h4><p>ä»¥ä¸‹æ˜¯åœ¨ gradle è„šæœ¬ä¸­å¸¸ç”¨çš„æ ¸å¿ƒç±»å‹</p>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>Project</td>
<td>æ­¤æ¥å£æ˜¯ä½ åœ¨ä½ çš„ç¼–è¯‘è„šæœ¬ä¸­æœ€å¸¸ä½¿ç”¨çš„ APIã€‚é€šè¿‡ Project,ä½ å¯ä»¥ä½¿ç”¨ gradle çš„æ‰€æœ‰ç‰¹æ€§</td>
</tr>
<tr>
<td>Task</td>
<td>ä¸€ä¸ª task ä»£è¡¨ä¸€ä¸ªç¼–è¯‘è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªå•ä¸€åŸå­ä»»åŠ¡ï¼Œå¦‚ç¼–è¯‘ class,ç”Ÿæˆ javadoc</td>
</tr>
<tr>
<td>Gradle</td>
<td>è¡¨ç¤º gradle çš„è°ƒç”¨</td>
</tr>
<tr>
<td>Settings</td>
<td>å£°æ˜å®ä¾‹åŒ–å’Œé…ç½®è¦å‚ä¸æ„å»ºçš„ Project å®ä¾‹çš„å±‚æ¬¡ç»“æ„æ‰€éœ€çš„é…ç½®</td>
</tr>
<tr>
<td>Script</td>
<td>æ­¤æ¥å£ç”±æ‰€æœ‰çš„ gradle è„šæœ¬å®ç°å¹¶æ·»åŠ ä¸€äº› gradle ç‰¹å®šçš„æ–¹æ³•ã€‚å½“ä½ ç¼–è¯‘è„šæœ¬ç±»æ—¶å°†ä¼šå®ç°æ­¤æ¥å£ï¼Œä½ å¯ä»¥åœ¨è„šæœ¬ä¸­ä½¿ç”¨æ­¤æ¥å£å£°æ˜çš„æ–¹æ³•å’Œå±æ€§</td>
</tr>
<tr>
<td>JavaToolChain</td>
<td>ä¸€ç»„ç”¨äºç¼–è¯‘ Java æºæ–‡ä»¶çš„å·¥å…·</td>
</tr>
<tr>
<td>SourceSet</td>
<td>è¡¨ç¤º Java æºæ–‡ä»¶å’Œèµ„æºæ–‡ä»¶çš„é€»è¾‘ç»„</td>
</tr>
<tr>
<td>SourceSetOutput</td>
<td>æ‰€æœ‰è¾“å‡ºç›®å½•çš„é›†åˆ(ç¼–è¯‘çš„ç±»ï¼Œå¤„ç†è¿‡çš„èµ„æºç­‰),SourceSetOutput ç»§æ‰¿è‡ª FileCollection</td>
</tr>
<tr>
<td>SourceDirectorySet</td>
<td>è¡¨ç¤ºä¸€ç»„ç”±ä¸€ç³»åˆ—æºæ–‡ä»¶ç›®å½•ç»„æˆçš„æºæ–‡ä»¶ã€‚ä»¥åŠç›¸å…³çš„ include å’Œ exclude pattern</td>
</tr>
<tr>
<td>IncrementalTaskInputs</td>
<td>æä¾›é€šè¿‡å¢é‡ä»»åŠ¡è®¿é—®ä»»æ„éœ€è¦è¢«å¤„ç†æ–‡ä»¶çš„é€”å¾„</td>
</tr>
<tr>
<td>Configuration</td>
<td>è¡¨ç¤ºä¸€ç»„äº§ç‰©åŠå…¶ä¾èµ–ã€‚ä» ConfigurationContainer ä¸­å¯ä»¥è·å–æ›´å¤šå…³äºå¯¹ configuration å£°æ˜ä¾èµ–æˆ–è€…ç®¡ç† configuration çš„ä¿¡æ¯</td>
</tr>
<tr>
<td>ResolutingStrategy</td>
<td>å®šä¹‰ä¾èµ–è§£æçš„ç­–ç•¥.ä¾‹å¦‚å¼ºåˆ¶å›ºå®šä¾èµ–ç‰ˆæœ¬å·ï¼Œæ›¿ä»£ï¼Œå†²çªè§£å†³æ–¹æ¡ˆæˆ–å¿«ç…§</td>
</tr>
<tr>
<td>ArtifactResolutingQuery</td>
<td>å‘èµ·å¯ä»¥è§£æç‰¹å®šç»„ä»¶çš„æŒ‡å®šè½¯ä»¶äº§ç‰©çš„æŸ¥è¯¢çš„ç”Ÿæˆå™¨</td>
</tr>
<tr>
<td>ComponentSelection</td>
<td>è¡¨ç¤ºä¸€ä¸ªæ¨¡å—çš„ç»„ä»¶é€‰æ‹©å™¨å’ŒæŸä¸ªç»„ä»¶é€‰ä¸­è§„åˆ™ä¸­è¯„ä¼°çš„å€™é€‰ç‰ˆæœ¬çš„å…ƒç»„</td>
</tr>
<tr>
<td>ComponentSelectionRules</td>
<td>è¡¨ç¤ºç»„ä»¶é€‰ä¸­è§„åˆ™çš„å®¹å™¨.è§„åˆ™å¯ä»¥ä½œä¸ºä¸€ä¸ª configuration çš„è§£æè§„åˆ™ä¸€éƒ¨åˆ†è¢«ä½¿ç”¨ï¼Œè€Œä¸”ç‹¬ç«‹çš„ç»„ä»¶å¯ä»¥æ˜ç¡®æ¥å—æˆ–æ‹’ç»è¯¥è§„åˆ™ã€‚æ—¢ä¸æ¥å—ä¹Ÿä¸æ‹’ç»çš„ç»„ä»¶å°†è¢«æŒ‡å®šåˆ°é»˜è®¤çš„ç‰ˆæœ¬åŒ¹é…è§„åˆ™</td>
</tr>
<tr>
<td>ExtensionAware</td>
<td>åœ¨è¿è¡Œæ—¶å¯ä»¥å’Œå…¶ä»–å¯¹è±¡ä¸€èµ·è¢«æ‰©å±•çš„å¯¹è±¡</td>
</tr>
<tr>
<td>ExtraPropertiesExtension</td>
<td>Gradle åŸŸå¯¹è±¡çš„é™„åŠ  ad-hoc å±æ€§</td>
</tr>
<tr>
<td>PluginDependenciesSpec</td>
<td>åœ¨è„šæœ¬ä¸­ä½¿ç”¨çš„å£°æ˜æ’ä»¶çš„ DSL</td>
</tr>
<tr>
<td>PluginDependencySpec</td>
<td>æ’ä»¶ä¾èµ–çš„å¯å˜è§„èŒƒ</td>
</tr>
<tr>
<td>PluginManagementSpec</td>
<td>é…ç½®æ’ä»¶å¦‚ä½•è¢«è§£æ</td>
</tr>
<tr>
<td>ResourceHandler</td>
<td>æä¾›è®¿é—®ç‰¹å®šèµ„æºçš„å·¥å…·æ–¹æ³•çš„é€”å¾„,ä¾‹å¦‚åˆ›å»ºå„ç§èµ„æºçš„å·¥å‚æ–¹æ³•</td>
</tr>
<tr>
<td>TextResourceFactory</td>
<td>åˆ›å»ºç”±å­—ç¬¦ä¸²ã€æ–‡ä»¶ã€å­˜æ¡£å®ä½“ç­‰èµ„æºæä¾›çš„ TextResources</td>
</tr>
</tbody></table>
<h4 id="type-safe-model-accessors"><a href="#type-safe-model-accessors" class="headerlink" title="type-safe model accessors"></a>type-safe model accessors</h4><p>æ‰§è¡Œæ—¶æœºï¼šplugins{} å—åï¼Œscript è„šæœ¬ä¹‹å‰.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; build.gradle.kts</span><br><span class="line">plugins &#123;</span><br><span class="line">  &#96;java-library&#96;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">  api(&quot;junit:junit;4.12&quot;)</span><br><span class="line">  implementation(&quot;junit:junit:4.12&quot;)</span><br><span class="line">  testImplementation(&quot;junit:junit:4.12&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">configurations &#123;</span><br><span class="line">  implementation &#123;</span><br><span class="line">    resolutinStrategy.failOnVersionConflict()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sourceSets &#123;</span><br><span class="line">  main &#123;</span><br><span class="line">    java.srcDir(&quot;src&#x2F;core&#x2F;java&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">java &#123;</span><br><span class="line">  sourceCompatibility &#x3D; JavaVersion.VERSION_11</span><br><span class="line">  targetCompatibility &#x3D; JavaVersion.VERSION_11</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tasks &#123;</span><br><span class="line">  test &#123;</span><br><span class="line">    testLogging.showExceptions &#x3D; true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="äº†è§£-type-safe-accessors-ä¸å¯ç”¨æ—¶è¦æ‰§è¡Œçš„æ“ä½œ"><a href="#äº†è§£-type-safe-accessors-ä¸å¯ç”¨æ—¶è¦æ‰§è¡Œçš„æ“ä½œ" class="headerlink" title="äº†è§£ type-safe accessors ä¸å¯ç”¨æ—¶è¦æ‰§è¡Œçš„æ“ä½œ"></a>äº†è§£ type-safe accessors ä¸å¯ç”¨æ—¶è¦æ‰§è¡Œçš„æ“ä½œ</h4><p>ä¸‹é¢çš„è„šæœ¬æ˜ç¡®ä½¿ç”¨äº† apply() æ–¹æ³•åº”ç”¨æ’ä»¶.ç¼–è¯‘è„šæœ¬æ— æ³•ä½¿ç”¨ type-safe accessors,å› ä¸º apply() æ–¹æ³•æ˜¯åœ¨è¿™ä¸ªç¼–è¯‘è„šæœ¬å†…è°ƒç”¨çš„ã€‚ä½ å¯ä»¥é‡‡ç”¨å…¶ä»–æŠ€å·§ï¼Œå¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; build.gradle.kts</span><br><span class="line">apply(plugin &#x3D; &quot;java-library&quot;)</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">  &quot;api&quot;(&quot;junit:junit:4.12&quot;)</span><br><span class="line">  &quot;implementation&quot;(&quot;junit:junit:&quot;4.12&quot;)</span><br><span class="line">  &quot;testImplementation&quot;(&quot;junit:junit:4.12&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">configurations &#123;</span><br><span class="line">  &quot;implementation&quot; &#123;</span><br><span class="line">    resolutinStrategy.failOnVersionConflict()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">configure&lt;SourceSetContainer&gt; &#123;</span><br><span class="line">  named(&quot;main&quot;) &#123;</span><br><span class="line">    java.srcDir(&quot;src&#x2F;core&#x2F;java&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">configure&lt;JavaPluginConvention&gt; &#123;</span><br><span class="line">  sourceCompatibility &#x3D; JavaVersion.VERSION_11</span><br><span class="line">  targetCompatibility &#x3D; JavaVersion.VERSION_11</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tasks &#123;</span><br><span class="line">  named&lt;Test&gt;(&quot;test&quot;) &#123;</span><br><span class="line">    testLogging.showException &#x3D; true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹åˆ—æƒ…å†µä¸‹ï¼Œtype-safe accessor ä¸å¯ç”¨</p>
<ul>
<li>ä½¿ç”¨ apply(plugin = id) åº”ç”¨æ’ä»¶</li>
<li>é¡¹ç›® build script</li>
<li>é€šè¿‡ apply(from = â€œscript-plugin.gradle.ktsâ€) åº”ç”¨çš„è„šæœ¬æ’ä»¶</li>
<li>è·¨é¡¹ç›®é…ç½®çš„æ’ä»¶</li>
</ul>
<h4 id="äº§ç‰©é…ç½®"><a href="#äº§ç‰©é…ç½®" class="headerlink" title="äº§ç‰©é…ç½®"></a>äº§ç‰©é…ç½®</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; build.gradle.jts</span><br><span class="line">apply(plugin &#x3D; &quot;java-library&quot;)&#39;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">  &quot;api&quot;(&quot;junit:junit:4.12&quot;)</span><br><span class="line">  &quot;implementation&quot;(&quot;junit:junit:4.12&quot;)</span><br><span class="line">  &quot;testImplementation&quot;(&quot;junit:junit:4.12&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">configurations &#123;</span><br><span class="line">  &quot;implementation&quot; &#123;</span><br><span class="line">    resolutinStrategy.failOnVersionConflict()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; settings.gradle.kts</span><br><span class="line">pluginManagement &#123;</span><br><span class="line">  repositories &#123;</span><br><span class="line">    google()</span><br><span class="line">    gradlePluginPortal()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resolutionStrategy &#123;</span><br><span class="line">    eachPlugin &#123;</span><br><span class="line">      if (requested.id.namespace &#x3D;&#x3D; &#39;com.android&#39;) &#123;</span><br><span class="line">        useModule(&#39;com.android.tools.build:gradle:$&#123;requested.version&#125;&#39;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; build.gradle.kts</span><br><span class="line">val check by tasks.existing</span><br><span class="line">val myTask1 by tasks.registering</span><br><span class="line"></span><br><span class="line">val compileJava by tasks.existing(JavaCompile::class)</span><br><span class="line">val myCopy1 by tasks.registering(Copy::class)</span><br><span class="line"></span><br><span class="line">va; assemble by tasks.existing &#123;</span><br><span class="line">  dependsOn(myTask1)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">val myTask2 by tasks.registering &#123;</span><br><span class="line">  description &#x3D; &quot;some meaningful words&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">val test by tasks.existing(Test::class) &#123;</span><br><span class="line">  testLogging.showStackTrace &#x3D; true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">val myCopy2 by tasks.registering(Copy::class) &#123;</span><br><span class="line">  from(&quot;source&quot;)</span><br><span class="line">  into(&quot;destination&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å‡çº§-Gradle-Wrapper"><a href="#å‡çº§-Gradle-Wrapper" class="headerlink" title="å‡çº§ Gradle Wrapper"></a>å‡çº§ <code>Gradle Wrapper</code></h3><p>å¦‚æœå·²ç»æœ‰åŸºäº<code>gradlew wrapper</code>çš„é¡¹ç›®,å¯ä»¥é€šè¿‡è¿è¡Œ<code>wrapper</code>ä»»åŠ¡æ¥æŒ‡å®šéœ€è¦çš„<code>gradle</code>ç‰ˆæœ¬.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./gradlew wrapper --gradle-version=5.3 --distribution-type=bin</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶æ²¡å¿…è¦ä½¿ç”¨<code>gradle wrapper</code>æ¥å®‰è£…<code>gradle</code>.è°ƒç”¨<code>gradlew</code>æˆ–<code>gradlew.bat</code>å°†ä¼šä¸‹è½½å¹¶ç¼“å­˜æŒ‡å®šç‰ˆæœ¬çš„ Gradle.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./gradlew taska</span><br></pre></td></tr></table></figure>

<h3 id="CLI-è‡ªåŠ¨è¡¥å…¨"><a href="#CLI-è‡ªåŠ¨è¡¥å…¨" class="headerlink" title="CLI è‡ªåŠ¨è¡¥å…¨"></a>CLI è‡ªåŠ¨è¡¥å…¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install gradle-completion</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$fpath</span> | grep <span class="string">"/usr/local/share/zsh/site-functions"</span></span><br></pre></td></tr></table></figure>

<h3 id="è®¾è®¡-gradle-æ’ä»¶"><a href="#è®¾è®¡-gradle-æ’ä»¶" class="headerlink" title="è®¾è®¡ gradle æ’ä»¶"></a>è®¾è®¡ gradle æ’ä»¶</h3><p>å¯¹ gradle æ–°æ‰‹æ¥è¯´ï¼Œå®ç° gradle æ’ä»¶å¯èƒ½æ˜¯ä¸€ä¸ªå‘:ç»„ç»‡ç®¡ç†æ’ä»¶é€»è¾‘ï¼Œæµ‹è¯•ã€è°ƒè¯•æ’ä»¶ä»£ç ç­‰.å¯ä»¥åœ¨<a href="https://gradle.org/guides" target="_blank" rel="noopener">æ­¤</a>è·å–åˆ°æ›´å¤šçš„ä¿¡æ¯.</p>
<p>###</p>
<p>é€šè¿‡æŒ‡å®š subproject çš„è·¯å¾„ï¼Œå¯ä»¥å°†æœ¬åœ°ä»»ä½•è·¯å¾„ä¸‹çš„ä»£ç å¯¼å…¥å·¥ç¨‹ä¸­ï¼Œä¾›æœ¬åœ°å¼€å‘è°ƒè¯•ã€‚</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">include <span class="string">':lib'</span></span><br><span class="line">project(<span class="string">':lib'</span>).projectDir = <span class="keyword">new</span> File(<span class="string">'xxx/xxx/lib'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="com-android-application-æ’ä»¶"><a href="#com-android-application-æ’ä»¶" class="headerlink" title="com.android.application æ’ä»¶"></a>com.android.application æ’ä»¶</h3><ul>
<li><code>applicationVariants</code></li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  AppExtension ç»§æ‰¿è‡ª BaseExtension å”¯ä¸€æ‰©å±•çš„æˆå‘˜å˜é‡ï¼Œå®ƒçš„å‚æ•°ç±»å‹æ˜¯ DefaultDomainObjectSet,è¿™æ˜¯ä¸åŒ buildType åŠ Flavor çš„é›†åˆ,applicationVariants æœ€é•¿çš„æ˜¯å®ƒçš„ all æ–¹æ³•ï¼Œå¦‚ä¿®æ”¹ apk åå­—</span></span><br><span class="line"><span class="keyword">def</span> buildTime() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Date().format(<span class="string">"yyyy-MM-dd"</span>,TimeZone.getTimeZone(<span class="string">"UTC"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">  applicationVariants.all &#123; variant -&gt;</span><br><span class="line">    variant.outputs.each &#123; output -&gt;</span><br><span class="line">      <span class="keyword">def</span> outputFile = output.outputFile</span><br><span class="line">      <span class="keyword">if</span> (outputFile != <span class="literal">null</span> &amp;&amp; outputFile.name.endsWith(<span class="string">'.apk'</span>)) &#123;</span><br><span class="line">        <span class="keyword">def</span> fileName = <span class="string">"$&#123;variant.buildType.name&#125;-$&#123;variant.versionName&#125;-$&#123;buildTime()&#125;.apk"</span></span><br><span class="line">        output.outputFile = <span class="keyword">new</span> File(output.outputFile.parent,fileName)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>defaultConfig</code></li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">defaultConfig &#123;</span><br><span class="line">    applicationId <span class="string">'**.**.**'</span></span><br><span class="line">    applicationIdSuffix <span class="string">'.two'</span> <span class="comment">//applicationIdçš„åç¼€ï¼Œå¯ä»¥ç”¨åœ¨æƒ³åŒæ—¶å®‰è£…è¿è¡Œä¸¤ä¸ªFlavoråŒ…çš„æ—¶å€™ï¼Œæ¯”å¦‚åŒæ—¶å®‰è£…debugåŒ…å’ŒReleaseåŒ…åšä¸€äº›å¯¹æ¯”ã€‚</span></span><br><span class="line">    minSdkVersion <span class="number">14</span></span><br><span class="line">    minSdkVersion <span class="number">14</span></span><br><span class="line">    targetSdkVersion <span class="number">28</span></span><br><span class="line">    versionCode <span class="number">1</span></span><br><span class="line">    versionName <span class="string">'1.0'</span></span><br><span class="line">    versionNameSuffix <span class="string">'.0'</span> <span class="comment">// versionNameåç¼€</span></span><br><span class="line">    consumerProguardFiles <span class="string">'proguard-rules.pro'</span> <span class="comment">//ç”¨äºLibraryä¸­ï¼Œå¯ä»¥å°†æ··æ·†æ–‡ä»¶è¾“å‡ºåˆ°aarä¸­ï¼Œä¾›Applicationæ··æ·†æ—¶ä½¿ç”¨ã€‚</span></span><br><span class="line">    dimension <span class="string">'api'</span></span><br><span class="line">    <span class="comment">//ç»™æ¸ é“ä¸€ä¸ªåˆ†ç»„åŠ ç»´åº¦çš„æ¦‚å¿µï¼Œæ¯”å¦‚ä½ ç°åœ¨æœ‰ä¸‰ä¸ªæ¸ é“åŒ…ï¼Œåˆ†æˆå…è´¹å’Œæ”¶è´¹ä¸¤ç§ç±»å‹ï¼Œ</span></span><br><span class="line">    <span class="comment">//å¯ä»¥æ·»åŠ ä¸€ä¸ªdimension, æ‰“æ¸ é“åŒ…çš„æ—¶å€™ä¼šè‡ªåŠ¨æ‰“å‡º6ä¸ªåŒ…ï¼Œè€Œä¸éœ€è¦æ·»åŠ 6ä¸ªæ¸ é“ï¼Œ</span></span><br><span class="line">    <span class="comment">// è¯¦ç»†çš„è¯´æ˜å¯è§ https://developer.android.com/studio/build/build-variants.html#flavor-dimensionsã€‚</span></span><br><span class="line">    externalNativeBuild &#123; <span class="comment">//ndkçš„é…ç½®ï¼ŒAS2.2ä¹‹åæ¨èåˆ‡æ¢åˆ°cmakeçš„æ–¹å¼è¿›è¡Œç¼–è¯‘ã€‚</span></span><br><span class="line">        cnamke &#123;</span><br><span class="line">            cppFlags <span class="string">'-frtti --fexceptions'</span></span><br><span class="line">            arguments <span class="string">'-DANDROID_ARM_NEON=TRUE'</span></span><br><span class="line">            buildStagingDirectory <span class="string">'./outputs/cmake'</span></span><br><span class="line">            path <span class="string">'CMakeLists.txt'</span></span><br><span class="line">            version <span class="string">'3.7.1'</span></span><br><span class="line">        &#125;</span><br><span class="line">        ndkBuild &#123;</span><br><span class="line">          path <span class="string">'Android.mk'</span></span><br><span class="line">          buildStagingDirectory <span class="string">'./outputs/ndk-build'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    javaCompileOptions &#123;</span><br><span class="line">      annotationProcessorOptions &#123; <span class="comment">// æ³¨è§£çš„é…ç½®</span></span><br><span class="line">        includeCompileClasspath <span class="literal">true</span> <span class="comment">// ä½¿ç”¨æ³¨è§£åŠŸèƒ½</span></span><br><span class="line">        arguments = [ <span class="string">eventBusIndex :</span> <span class="string">'org.greenrobot.eventbusperf.MyEventBusIndex'</span> ] <span class="comment">// AbstractProcessor ä¸­å¯ä»¥è¯»å–åˆ°è¯¥å‚æ•°</span></span><br><span class="line">        classNames</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    manifestPlaceholders = [<span class="string">key:</span> <span class="string">'value'</span>] <span class="comment">// manifest å ä½ç¬¦ï¼Œå®šä¹‰å‚æ•°ç»™ manifest è°ƒç”¨ï¼Œå¦‚ä¸åŒçš„æ¸ é“id</span></span><br><span class="line">    multiDexEnabled <span class="literal">true</span> <span class="comment">// å¯ç”¨ multiDex</span></span><br><span class="line">    multiDexKeepFile file(<span class="string">'multiDexKeep.txt'</span>) <span class="comment">// æ‰‹åŠ¨æ‹†åŒ…ï¼Œå°†å…·ä½“çš„ç±»æ”¾åœ¨ä¸» dex</span></span><br><span class="line">    mutliDexKeepProguard file(<span class="string">'multiDexKeep.pro'</span>) <span class="comment">// æ”¯æŒ proguard è¯­æ³•ï¼Œè¿›è¡Œä¸€äº›æ¨¡ç³ŠåŒ¹é….</span></span><br><span class="line"></span><br><span class="line">    ndk &#123;</span><br><span class="line">      abiFilterss <span class="string">'x86'</span>,<span class="string">'x86_64'</span>,<span class="string">'armeabi'</span> <span class="comment">// åªä¿ç•™ç‰¹å®šçš„ abi è¾“å‡ºåˆ° apk</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span> <span class="comment">// æ··æ·†æ–‡ä»¶çš„åˆ—è¡¨ï¼Œå¦‚é»˜è®¤çš„ android æ··æ·†æ–‡ä»¶åŠæœ¬åœ°çš„ proguard æ–‡ä»¶ï¼Œåˆ‡è®°ä¸è¦é—æ¼ android æ··æ·†æ–‡ä»¶ï¼Œå¦åˆ™å¯¼è‡´ä¸€äº›é»˜è®¤å®‰å“ç»„ä»¶æ— æ³•æ‰¾åˆ°</span></span><br><span class="line"></span><br><span class="line">    signingConfig &#123;</span><br><span class="line">      storeFile file(<span class="string">'debug.keystore'</span>) <span class="comment">// ç­¾åæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">      storePassword <span class="string">'android'</span> <span class="comment">// ç­¾åæ–‡ä»¶å¯†ç </span></span><br><span class="line">      keyAlias <span class="string">'androiddebugkey'</span> <span class="comment">// åˆ«å</span></span><br><span class="line">      keyPassword <span class="string">'android'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buildConfigField(<span class="string">'boolean'</span>,<span class="string">'IS_RELEASE'</span>,<span class="string">'false'</span>) <span class="comment">// åœ¨ä»£ç ä¸­å¯ä»¥é€šè¿‡ BuildConfig.IS_RELEASE è°ƒç”¨ã€‚é»˜è®¤ false</span></span><br><span class="line">    resValue(<span class="string">'string'</span>,<span class="string">'appname'</span>,<span class="string">'demo'</span>) <span class="comment">// åœ¨ res/value ä¸­æ·»åŠ  &lt;string name="appname" translatable="false"&gt;demo&lt;/string&gt;</span></span><br><span class="line">    resConfigs <span class="string">'cn'</span>,<span class="string">'hdpi'</span> <span class="comment">// æŒ‡å®šç‰¹å®šèµ„æºï¼Œå¯ä»¥ç»“åˆ productFlavors å®ç°ä¸åŒæ¸ é“çš„æœ€å°çš„ apk åŒ….</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>productFlavors</code>: æ¸ é“åŒ…çš„åˆ—è¡¨ï¼Œå¯è¦†ç›– defaultConfig çš„å‚æ•°é…ç½®,å½¢æˆè‡ªå·±çš„é£å‘³</li>
<li><code>flavorDimensionList</code>: æ·»åŠ çº¬åº¦çš„å®šä¹‰</li>
<li><code>resourcePrefix</code>: åœ¨æ¨¡å—åŒ–å¼€å‘ä¸­ç»™æ¯ä¸ªæ¨¡å—æŒ‡å®šä¸€ä¸ªç‰¹å®šçš„èµ„æºå‰ç¼€ï¼Œé¿å…å¤šæ¨¡å—ä½¿ç”¨ç›¸åŒçš„æ–‡ä»¶åååˆå¹¶å†²çªï¼Œåœ¨ build.gradle æŒ‡å®šæ­¤é…ç½®åï¼ŒAS ä¼šæ£€æŸ¥ä¸åˆæ³•çš„èµ„æºå‘½åå¹¶æŠ¥é”™</li>
<li><code>buildTypes</code>: é»˜è®¤æœ‰ debug å’Œ releaseã€‚</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">debug &#123;</span><br><span class="line">  applicationIdSuffix <span class="string">'.debug'</span></span><br><span class="line">  versionNameSuffix <span class="string">'.1'</span></span><br><span class="line">  debugable <span class="literal">true</span> <span class="comment">// ç”Ÿæˆçš„ apk æ˜¯å¦å¯è°ƒè¯•ï¼Œdebug -&gt; true,release -&gt; false</span></span><br><span class="line">  jniDebuggable <span class="literal">true</span> <span class="comment">// æ˜¯å¦å¯ä»¥è°ƒè¯• NDK ä»£ç ï¼Œä½¿ç”¨ lldb è¿›è¡Œ c/c++ ä»£ç è°ƒè¯•</span></span><br><span class="line">  crunchPngs <span class="literal">true</span> <span class="comment">// æ˜¯å¦å¼€å¯ png ä¼˜åŒ–ï¼Œä¼šå¯¹ png å›¾ç‰‡åšä¸€æ¬¡æœ€ä¼˜å‹ç¼©ï¼Œå½±å“ç¼–è¯‘é€Ÿåº¦, debug -&gt; false,release -&gt; true</span></span><br><span class="line">  embedMicroApp <span class="literal">true</span> <span class="comment">// Android Wear æ”¯æŒ</span></span><br><span class="line">  minifyEnabled <span class="literal">true</span> <span class="comment">// æ˜¯å¦å¼€å¯æ··æ·†</span></span><br><span class="line">  renderscriptDebuggable <span class="literal">false</span> <span class="comment">// æ˜¯å¦å¼€å¯æ¸²æŸ“è„šæœ¬</span></span><br><span class="line">  renderscriptOptimLevel <span class="number">5</span> <span class="comment">// æ¸²æŸ“è„šæœ¬ç­‰çº§ é»˜è®¤ 5</span></span><br><span class="line">  zipAlignEnabled <span class="literal">true</span> <span class="comment">// æ˜¯å¦ zip å¯¹é½ä¼˜åŒ–ï¼Œé»˜è®¤ true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ndkDirectory</code>: ä¹Ÿå¯åœ¨ local.properties ä¸­é…ç½® ndk.dir=/Users/shuttle/Library/Android/sdk</li>
<li><code>sdkDirectory</code>: ..</li>
<li><code>aaptOptions</code>: èµ„æºæ‰“åŒ…å·¥å…·</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">aaptOptions &#123;</span><br><span class="line">  additionalParameters <span class="string">'--rename-manifest-package'</span>,<span class="string">'cct.cn.gradle.lsn13'</span>,<span class="string">'-S'</span>,<span class="string">'src/main/res2'</span>,<span class="string">'--auto-add-overlay'</span> <span class="comment">// appt æ‰§è¡Œæ—¶çš„é¢å¤–å‚æ•°</span></span><br><span class="line">  cruncherEnabled <span class="literal">true</span> <span class="comment">// å¯¹ png è¿›è¡Œä¼˜åŒ–æ£€æŸ¥</span></span><br><span class="line">  ignoreAssets <span class="string">'*.jpg'</span> <span class="comment">// å¯¹ res ç›®å½•ä¸‹çš„èµ„æºæ–‡ä»¶è¿›è¡Œæ’é™¤ï¼ŒæŠŠ res æ–‡ä»¶ä¸‹çš„æ‰€æœ‰ .jpg æ–‡ä»¶æ‰“åŒ…åˆ° apk ä¸­</span></span><br><span class="line">  noCompress <span class="string">'.jpg'</span> <span class="comment">// å¯¹æ‰€æœ‰ jpg æ–‡ä»¶ä¸å‹ç¼©</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>adbExecutable</code>: adb è·¯å¾„</li>
<li><code>adbOptions</code></li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">adbOptions &#123;</span><br><span class="line">  installOptions <span class="string">'-r'</span>,<span class="string">'-d'</span> <span class="comment">// è°ƒç”¨ adb install å‘½ä»¤æ—¶é»˜è®¤ä¼ é€’çš„å‚æ•°</span></span><br><span class="line">  timeOutInMs <span class="number">1000</span> <span class="comment">// æ‰§è¡Œ adb å‘½ä»¤çš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>compileOptions</code></li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">compileOptions &#123;</span><br><span class="line">  encoding <span class="string">'UTF-8'</span> <span class="comment">// java æºæ–‡ä»¶çš„ç¼–ç æ ¼å¼ï¼Œé»˜è®¤ utf8</span></span><br><span class="line">  incrmental <span class="literal">true</span> <span class="comment">// javaç¼–è¯‘æ˜¯å¦ä½¿ç”¨ gradle å¢é‡ç¼–è¯‘</span></span><br><span class="line">  sourceCompatibility JavaVersion.VERSION_1_7 <span class="comment">// java æºæ–‡ä»¶ç¼–è¯‘çš„ jdk ç‰ˆæœ¬</span></span><br><span class="line">  targetCompatibility JavaVersion.VERSION_1_7 <span class="comment">// ç¼–è¯‘å‡ºçš„ class ç‰ˆæœ¬</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>dataBinding</code></li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dataBinding &#123;</span><br><span class="line">  enabled = <span class="literal">true</span></span><br><span class="line">  version = <span class="string">"1.0"</span></span><br><span class="line">  addDefaultAdapters = <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>defaultPublishConfig</code>: æŒ‡å®šå‘å¸ƒçš„æ¸ é“åŠ BuildType ç±»å‹ã€‚åœ¨ Library ä¸­ä½¿ç”¨,é»˜è®¤ Release.</li>
<li><code>signingConfigs</code>: ç­¾åé…ç½®åˆ—è¡¨ï¼Œä¾›ä¸åŒæ¸ é“å’Œ buildType ä½¿ç”¨.</li>
<li><code>lintOptions</code></li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">lintOptions &#123;</span><br><span class="line">  quiet <span class="literal">true</span> <span class="comment">// true -&gt; ä¸æŠ¥å‘Šåˆ†æçš„è¿›åº¦</span></span><br><span class="line">  abortOnError <span class="literal">false</span> <span class="comment">// true -&gt; å‘ç°é”™è¯¯æ—¶ç»ˆæ­¢ gradle</span></span><br><span class="line">  ignoreWarnings <span class="literal">true</span> <span class="comment">// true -&gt; åªæŠ¥å‘Šé”™è¯¯</span></span><br><span class="line">  absolutePaths <span class="literal">true</span> <span class="comment">// true -&gt; å½“æœ‰é”™è¯¯æ—¶æ˜¾ç¤ºæ–‡ä»¶çš„å…¨è·¯å¾„æˆ–ç»å¯¹è·¯å¾„</span></span><br><span class="line">  checkAllWarnings <span class="literal">true</span> <span class="comment">// true -&gt; æ£€æŸ¥æ‰€æœ‰é—®é¢˜ï¼ŒåŒ…æ‹¬é»˜è®¤ä¸æ£€æŸ¥é—®é¢˜</span></span><br><span class="line">  warningsAsErrors <span class="literal">true</span> <span class="comment">// true -&gt; å°†æ‰€æœ‰è­¦å‘Šè§†ä¸ºé”™è¯¯</span></span><br><span class="line">  disable <span class="string">'TypeographyFractions'</span>,<span class="string">'TypographyQUotes'</span> <span class="comment">// ä¸æ£€æŸ¥ç»™å®šé—®é¢˜ id</span></span><br><span class="line">  enable <span class="string">'RtlHardCoded'</span>,<span class="string">'RtlCompat'</span>,<span class="string">'RtlEnabled'</span> <span class="comment">// æ£€æŸ¥ç»™å®šé—®é¢˜ id</span></span><br><span class="line">  check <span class="string">'NewApi'</span>,<span class="string">'InlinedApi'</span> <span class="comment">// ä»… æ£€æŸ¥ç»™å®šé—®é¢˜ id</span></span><br><span class="line">  noLines <span class="literal">true</span> <span class="comment">// å¦‚æœä¸º true,åˆ™åœ¨é”™è¯¯æŠ¥å‘Šçš„è¾“å‡ºä¸­ä¸åŒ…å«æºä»£ç è¡Œ</span></span><br><span class="line">  showAll <span class="literal">true</span> <span class="comment">// true -&gt; å¯¹ä¸€ä¸ªé”™è¯¯çš„é—®é¢˜æ˜¾ç¤ºå®ƒæ‰€åœ¨çš„æ‰€æœ‰åœ°æ–¹ï¼Œè€Œä¸ä¼šæˆªçŸ­åˆ—è¡¨ç­‰ç­‰ã€‚</span></span><br><span class="line">  lintConfig file(<span class="string">'default-lint.xml'</span>) <span class="comment">// é‡ç½® lint é…ç½®(ä½¿ç”¨é»˜è®¤çš„ä¸¥é‡æ€§ç­‰è®¾ç½®)</span></span><br><span class="line">  textReport <span class="literal">true</span> <span class="comment">// true -&gt; ç”Ÿæˆä¸€ä¸ªé—®é¢˜çš„çº¯æ–‡æœ¬æŠ¥å‘Š(default -&gt; false)</span></span><br><span class="line">  textOuput <span class="string">'stdout'</span> <span class="comment">// é»˜è®¤å†™å…¥è¾“å‡ºç»“æœçš„ä½ç½®ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶æˆ– stdout</span></span><br><span class="line">  xmlReport <span class="literal">false</span> <span class="comment">// true -&gt; ç”Ÿæˆ xml æŠ¥å‘Šï¼Œjenkins å¯ä»¥ä½¿ç”¨</span></span><br><span class="line">  xmlOutput file(<span class="string">"lint-report.xml"</span>) <span class="comment">// å†™å…¥æŠ¥å‘Šçš„æ–‡ä»¶ï¼Œé»˜è®¤ line-results.xml</span></span><br><span class="line">  htmlReport <span class="literal">true</span> <span class="comment">// html æŠ¥å‘Š</span></span><br><span class="line">  htmlOutput file(<span class="string">'lint-report.html'</span>) <span class="comment">// å†™å…¥æŠ¥å‘Šçš„è·¯å¾„ï¼Œå¯é€‰(é»˜è®¤ä¸ºæ„å»ºç›®å½•ä¸‹çš„ lint-results.html)</span></span><br><span class="line">  checkReleaseBuilds <span class="literal">true</span> <span class="comment">// true -&gt; å°†ä½¿æ‰€æœ‰ release æ„å»ºéƒ½ä»¥ issus çš„ä¸¥é‡æ€§çº§åˆ«ä¸º fatal (serverity=false)çš„è®¾ç½®æ¥è¿è¡Œ lint,ä¸”å¦‚æœå‘ç°äº†è‡´å‘½(fatal)çš„é—®é¢˜,å°†ä¼šä¸­æ­¢æ„å»º(ç”±ä¸Šé¢æåˆ°çš„ abortOnError æ§åˆ¶)</span></span><br><span class="line">  fatal <span class="string">'NewApi'</span>,<span class="string">'InlineApi'</span> <span class="comment">// è®¾ç½®ç»™å®šé—®é¢˜çš„ä¸¥é‡çº§åˆ«(serverity)ä¸º fatalï¼ˆå³å°†ä¼šåœ¨ release æ„å»ºæœŸé—´æ£€æŸ¥,å³ä½¿ lint è¦æ£€æŸ¥çš„é—®é¢˜æ²¡æœ‰åŒ…å«åœ¨ä»£ç ä¸­ï¼‰</span></span><br><span class="line">  error <span class="string">'Wakelock'</span>,<span class="string">'TextViewEdits'</span> <span class="comment">// è®¾ç½®ç»™å®šé—®é¢˜çš„ä¸¥é‡çº§åˆ«ä¸º error</span></span><br><span class="line">  warning <span class="string">'ResourceAsColor'</span> <span class="comment">// è®¾ç½®ç»™å®šé—®é¢˜çš„ä¸¥é‡çº§åˆ«ä¸º warning</span></span><br><span class="line">  ignore <span class="string">'TypographyQUotes'</span> <span class="comment">// è®¾ç½®ç»™å®šé—®é¢˜çš„ä¸¥é‡çº§åˆ«(serverity)ä¸º ignore (å’Œä¸æ£€æŸ¥è¯¥é—®é¢˜ä¸€æ ·)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>dexOptions</code>: çƒ­ä¿®å¤å·®åˆ†åŒ…</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dexOptions &#123;</span><br><span class="line">  additionalParameters <span class="string">'--minimal-main-dex'</span>,<span class="string">'--set-max-idx-number=10000'</span> <span class="comment">// dx å‘½ä»¤é™„åŠ å‚æ•°</span></span><br><span class="line">  javaMaxHeapSize <span class="string">'2048m'</span> <span class="comment">// æ‰§è¡Œ dx æ—¶ Java è™šæ‹Ÿæœºå¯ç”¨çš„æœ€å¤§å†…å­˜å¤§å°</span></span><br><span class="line">  jumboMode <span class="literal">true</span> <span class="comment">// å¼€å¯å¤§æ¨¡å¼ï¼Œæ‰€æœ‰çš„ class æ‰“åˆ°ä¸€ä¸ª dex ä¸­,å¯ä»¥å¿½ç•¥ 65535 æ–¹æ³•æ•°çš„é™åˆ¶, å¤§äº14ç‰ˆæœ¬å¯ç”¨</span></span><br><span class="line">  keepRuntimeAnnotatedClasses <span class="literal">true</span> <span class="comment">// åœ¨ dex ä¸­æ˜¯å¦ä¿ç•™ Runtime æ³¨è§£,é»˜è®¤ true</span></span><br><span class="line">  maxProcessCount <span class="number">4</span> <span class="comment">// dex ä¸­çš„è¿›ç¨‹æ•°,é»˜è®¤ 4</span></span><br><span class="line">  threadCount <span class="number">4</span> <span class="comment">// é»˜è®¤çº¿ç¨‹æ•°</span></span><br><span class="line">  preDexLibraries <span class="literal">true</span> <span class="comment">// å¯¹ library é¢„ç¼–è¯‘ï¼Œæé«˜ç¼–è¯‘æ•ˆç‡ï¼Œä½† clean æ—¶è¾ƒæ…¢ï¼Œé»˜è®¤ true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>packagingOptions</code></li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">packagingOptions &#123;</span><br><span class="line">  pickFirsts = [<span class="string">'META-INF/LICENSE'</span>] <span class="comment">// å½“æœ‰é‡å¤æ–‡ä»¶æ—¶ï¼Œæ‰“åŒ…ä¼šæŠ¥é”™ã€‚æ­¤é…ç½®ä¼šä½¿ç”¨ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ–‡ä»¶æ‰“åŒ…è¿›å…¥ apk</span></span><br><span class="line">  merge <span class="string">'META-INF/LICENSE'</span> <span class="comment">// é‡å¤æ–‡ä»¶ä¼šåˆå¹¶æ‰“åŒ…</span></span><br><span class="line">  exclue <span class="string">'META-INF/LICENSE'</span> <span class="comment">// æ‰“åŒ…æ—¶æ’é™¤åŒ¹é…æ–‡ä»¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>sourceSets</code></li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">sourceSets &#123;</span><br><span class="line">  main &#123;</span><br><span class="line">    res.srcDirs <span class="string">'src/main/res'</span></span><br><span class="line">    jniLibs.srcDirs = [<span class="string">'libs'</span>]</span><br><span class="line">    aidl.srcDirs <span class="string">'src/main/aidl'</span></span><br><span class="line">    assets.srcDirs <span class="string">'src/main/assets'</span></span><br><span class="line">    java.srcDirs <span class="string">'src/main/java'</span></span><br><span class="line">    jni.srcDirs <span class="string">'src/main/jni'</span></span><br><span class="line">    renderscript.srcDirs <span class="string">'src/main/renderscript'</span></span><br><span class="line">    resources.srcDirs <span class="string">'src/main/resources'</span></span><br><span class="line">    manifest.srcFile <span class="string">'src/main/AndroidManifest.xml'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// é™¤äº† main,ä¹Ÿå¯ç»™ä¸åŒçš„æ¸ é“æŒ‡å®šä¸åŒçš„é…ç½®</span></span><br><span class="line">  free &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>splits</code>: google play æŒ‰ CPU/å±å¹•åƒç´ å¯†åº¦æ‰“åŒ…</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">splits &#123;</span><br><span class="line">  abi &#123;</span><br><span class="line">    enable <span class="literal">true</span> <span class="comment">// å¼€å¯ abi åˆ†åŒ…</span></span><br><span class="line">    universalApk <span class="literal">true</span> <span class="comment">// æ˜¯å¦åˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰æœ‰æ•ˆåŠ¨æ€åº“çš„ apk</span></span><br><span class="line">    reset() <span class="comment">// æ¸…ç©º defaultConfig é…ç½®</span></span><br><span class="line">    include <span class="string">'x86'</span>,<span class="string">'armeabi'</span> <span class="comment">// å’Œ defaultConfig åšå’Œé›†</span></span><br><span class="line">    eclude <span class="string">'mips'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  density &#123;</span><br><span class="line">    enable <span class="literal">true</span> <span class="comment">// å¼€å¯ density åˆ†åŒ…</span></span><br><span class="line">    reset() <span class="comment">// æ¸…ç©ºé»˜è®¤</span></span><br><span class="line">    include  <span class="string">'xhdpi'</span>,<span class="string">'xxhdpi'</span> <span class="comment">// å’Œé›†</span></span><br><span class="line">    exclude <span class="string">'mdpi'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  language &#123;</span><br><span class="line">    enable <span class="literal">true</span></span><br><span class="line">    include <span class="string">'en'</span>,<span class="string">'cn'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>variantFilter</code>: è¿‡æ»¤é€šè¿‡ flavor å’Œ buildType æ„å»ºçš„ apk</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">variantFilter &#123; variant -&gt;</span><br><span class="line">  <span class="keyword">def</span> buildTypeName = variant.buildType.name</span><br><span class="line">  <span class="keyword">def</span> flavorName = variant.flavors.name</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (flavorName.contains(<span class="string">"360"</span>) &amp;&amp; buildTypeName.contains(<span class="string">"debug"</span>)) &#123;</span><br><span class="line">    <span class="comment">// ä¸ç”ŸæˆåŒ¹é…çš„ apk</span></span><br><span class="line">    setIgnore(<span class="literal">true</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>com.android.library</code></li>
</ul>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">android.libraryVariants.all &#123; variant -&gt;</span><br><span class="line">  <span class="keyword">def</span> mergedFlavor = variant.getMergedFlavor()</span><br><span class="line">  mergedFlavor.manifestPlaceholers = [<span class="string">hostName:</span><span class="string">'www.example.com'</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>kotlin</tag>
        <tag>gradle</tag>
        <tag>æ„å»º</tag>
      </tags>
  </entry>
  <entry>
    <title>è¯‘-Kotlin-Coroutine(1) case)</title>
    <url>/2019/08/26/%E8%AF%91-Kotlin-Coroutine(1)/</url>
    <content><![CDATA[<p>Kotlin Coroutine</p>
<a id="more"></a>

<h3 id="æå–å‡½æ•°-é‡æ„"><a href="#æå–å‡½æ•°-é‡æ„" class="headerlink" title="æå–å‡½æ•°-é‡æ„"></a>æå–å‡½æ•°-é‡æ„</h3><p>ä½†æ˜¯å¦‚æœæå–å‡ºæ¥çš„å‡½æ•°åŒ…å«äº†ä¸€ä¸ªåœ¨å½“å‰ä½œç”¨åŸŸè°ƒç”¨çš„åç¨‹æ„é€ å™¨æ€ä¹ˆåŠ?è¿™ç§æƒ…å†µä¸‹,<code>suspend</code> ä¿®é¥°ç¬¦å°±ä¸èƒ½æ»¡è¶³éœ€æ±‚äº†ä½¿<code>doWorld</code> æˆä¸º <code>CoroutineScopr</code>çš„ä¸€ä¸ªæ‰©å±•å‡½æ•°æ˜¯ä¸€ç§è§£å†³æ–¹æ¡ˆ,ä½†è¿™ç§æ–¹æ³•ä½¿å¾—APIä¸æ¸…æ™°è€Œä¸é€‚ç”¨å…¶ä»–æƒ…å†µ.ç†æƒ³çš„è§£å†³æ–¹æ¡ˆæ˜¯<code>CoroutineScope</code> ä½œä¸ºä¸€ä¸ªåŒ…å«ç›®æ ‡å‡½æ•°çš„ç±»çš„ä¸€ä¸ªå±æ€§å­˜åœ¨,æˆ–è€…è¿™ä¸ªç±»å®ç°<code>CoroutineScope</code>æ¥å£.æœ€åä¸€ç§æ–¹æ¡ˆå°±æ˜¯é€‚ç”¨<code>CoroutineScope(coroutineContext)</code>,ä½†æ˜¯è¿™ç§æ–¹æ³•ä¼šå› ä¸ºæ— æ³•æ§åˆ¶æ­¤æ–¹æ³•çš„æ‰§è¡ŒèŒƒå›´è€Œè¡¨ç°å‡ºç»“æ„ä¸å®‰å…¨æ€§.åªæœ‰ä¸€äº›ç§æœ‰ APIs å¯ä»¥ä½¿ç”¨è¿™ä¸ªåç¨‹æ„é€ å™¨.</p>
<h3 id="ç±»ä¼¼å®ˆæŠ¤çº¿ç¨‹çš„-Global-Coroutines"><a href="#ç±»ä¼¼å®ˆæŠ¤çº¿ç¨‹çš„-Global-Coroutines" class="headerlink" title="ç±»ä¼¼å®ˆæŠ¤çº¿ç¨‹çš„ Global Coroutines"></a>ç±»ä¼¼å®ˆæŠ¤çº¿ç¨‹çš„ Global Coroutines</h3><p><code>GlobalScope</code>å¯åŠ¨çš„æ´»åŠ¨çº¿ç¨‹ä¸ä¼šæŒ‚ä½çº¿ç¨‹,ä»–ä»¬çš„è¡Œä¸ºç±»ä¼¼å®ˆæŠ¤çº¿ç¨‹.</p>
<h1 id="å–æ¶ˆä¸è¶…æ—¶"><a href="#å–æ¶ˆä¸è¶…æ—¶" class="headerlink" title="å–æ¶ˆä¸è¶…æ—¶"></a>å–æ¶ˆä¸è¶…æ—¶</h1><h3 id="å–æ¶ˆåç¨‹çš„æ‰§è¡Œ"><a href="#å–æ¶ˆåç¨‹çš„æ‰§è¡Œ" class="headerlink" title="å–æ¶ˆåç¨‹çš„æ‰§è¡Œ"></a>å–æ¶ˆåç¨‹çš„æ‰§è¡Œ</h3><p>åœ¨ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„åº”ç”¨ä¸­,ä½ å¯èƒ½éœ€è¦ç²¾ç¡®æ§åˆ¶åå°è¿è¡Œçš„åç¨‹.ä¾‹å¦‚ç”¨æˆ·å¯èƒ½å…³é—­ä¸€ä¸ªå¼€å¯äº†åç¨‹çš„é¡µé¢,é‚£è¿™ä¸ªåç¨‹å°±éœ€è¦è¢«å–æ¶ˆ.<code>launch</code>å‡½æ•°è¿”å›ä¸€ä¸ª<code>Job</code>å¯¹è±¡å¯ä»¥å–æ¶ˆæ­¤åç¨‹çš„æ‰§è¡Œ.</p>
<h3 id="åŒæ—¶å–æ¶ˆ"><a href="#åŒæ—¶å–æ¶ˆ" class="headerlink" title="åŒæ—¶å–æ¶ˆ"></a>åŒæ—¶å–æ¶ˆ</h3><p>åç¨‹å¯ä»¥åŒæ—¶å–æ¶ˆ.æ‰€æœ‰åœ¨ <code>kotlinx.coroutines</code>ä¸­æŒ‚èµ·çš„å‡½æ•°éƒ½æ˜¯å¯å–æ¶ˆçš„.åœ¨å–æ¶ˆæ—¶,æ£€æŸ¥åç¨‹çš„å–æ¶ˆæ ‡è®°ç„¶åæŠ›å‡º<code>CancellationException</code>.ç„¶è€Œ,å¦‚æœä¸€ä¸ªåç¨‹åœ¨<code>computation</code> ä¸­è¿è¡Œ,è€Œä¸”æ²¡æœ‰æ£€æŸ¥å–æ¶ˆæ ‡è®°,é‚£å°±ä¸èƒ½è¢«å–æ¶ˆ.</p>
<h3 id="ä½¿-computation-ä»£ç å¯ä»¥è¢«å–æ¶ˆ"><a href="#ä½¿-computation-ä»£ç å¯ä»¥è¢«å–æ¶ˆ" class="headerlink" title="ä½¿ computation ä»£ç å¯ä»¥è¢«å–æ¶ˆ"></a>ä½¿ computation ä»£ç å¯ä»¥è¢«å–æ¶ˆ</h3><p>æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å–æ¶ˆ computation ä»£ç .ç¬¬ä¸€ç§æ˜¯å‘¨æœŸæ€§çš„è°ƒèµ·ä¸€ä¸ªæŒ‚èµ·å‡½æ•°å»æ£€æµ‹å–æ¶ˆæ ‡è®°.<code>yield</code>å‡½æ•°å¯ä»¥å®ç°è¿™ä¸ªéœ€æ±‚.å¦ä¸€ç§æ˜¯ç²¾ç¡®çš„æ£€æŸ¥å–æ¶ˆæ ‡è®°çŠ¶æ€.</p>
<h3 id="ä½¿ç”¨-finally-å…³é—­èµ„æº"><a href="#ä½¿ç”¨-finally-å…³é—­èµ„æº" class="headerlink" title="ä½¿ç”¨ finally å…³é—­èµ„æº"></a>ä½¿ç”¨ <code>finally</code> å…³é—­èµ„æº</h3><p>åœ¨å–æ¶ˆå…·æœ‰å¯å–æ¶ˆå±æ€§çš„æŒ‚èµ·å‡½æ•°æ—¶ä¼šæŠ›å‡º <code>CancellationException</code>,å¯ä»¥åœ¨ coroutine è¢«å–æ¶ˆæ—¶ä½¿ç”¨å¸¸ç”¨çš„æ–¹æ³•å¤„ç†.å¦‚ <code>try{...}finally{...}</code>è¡¨è¾¾å¼å’Œ <code>use</code>å‡½æ•°æ‰§è¡Œæœ€ç»ˆä»»åŠ¡.<br><code>join</code>å’Œ<code>cancelAndJoin</code>ç­‰å¾…æ‰€æœ‰çš„æœ€ç»ˆä»»åŠ¡æ‰§è¡Œå®Œæˆæ‰ç»“æŸ.</p>
<h3 id="è¿è¡Œä¸å¯å–æ¶ˆçš„ä»£ç å—"><a href="#è¿è¡Œä¸å¯å–æ¶ˆçš„ä»£ç å—" class="headerlink" title="è¿è¡Œä¸å¯å–æ¶ˆçš„ä»£ç å—"></a>è¿è¡Œä¸å¯å–æ¶ˆçš„ä»£ç å—</h3><p>ä»»ä½•åœ¨<code>finally</code>å—ä¸­ä½¿ç”¨æŒ‚èµ·å‡½æ•°éƒ½å°†å¯¼è‡´<code>CancellationException</code>,å› ä¸ºè¿è¡Œæ­¤ä»£ç çš„ coroutine å·²ç»è¢«å–æ¶ˆäº†.é€šå¸¸,è¿™ä¸æ˜¯ä¸ªé—®é¢˜,å› ä¸ºè‰¯å¥½çš„å…³é—­æ“ä½œ(å…³é—­æ–‡ä»¶ã€å–æ¶ˆä»»åŠ¡æˆ–å…³é—­ä»»æ„ç±»å‹çš„æ¶ˆæ¯é€šé“)é€šå¸¸éƒ½æ˜¯éé˜»å¡çš„,è€Œä¸”ä¹Ÿä¸ä¼šæŒ‚èµ·ä»»ä½•å‡½æ•°.åœ¨å·²ç»å–æ¶ˆçš„åç¨‹é‡Œ,å¦‚æœç«æ€æ¡ä»¶ä¸‹æƒ³æŒ‚èµ·,ä½ å¯ä»¥ä½¿ç”¨<code>withContext</code>å‡½æ•°å’Œ<code>NonCancellable</code>ä¸Šä¸‹æ–‡åœ¨<code>withContext(NonCancellable){...}</code>ä¸­å°è£…å“åº”çš„ä»£ç .</p>
<h3 id="è¶…æ—¶"><a href="#è¶…æ—¶" class="headerlink" title="è¶…æ—¶"></a>è¶…æ—¶</h3><p>å–æ¶ˆä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„åç¨‹çš„æœ€å¸¸è§çš„ç†ç”±å¯èƒ½æ˜¯ä»–çš„æ‰§è¡Œæ—¶é•¿å·²ç»è¶…è¿‡äº†è¶…æ—¶æ—¶é—´.å½“ç„¶,ä½ å¯ä»¥æ‰‹åŠ¨è¿½è¸ªç›¸åº”<code>Job</code>çš„å¼•ç”¨,ç„¶åå¯åŠ¨ä¸€ä¸ªç‹¬ç«‹çš„åç¨‹å»¶æ—¶åå–æ¶ˆè¿½è¸ªçš„è¿™ä¸ª<code>Job</code>,<code>withTimeout</code>å‡½æ•°å¯ä»¥å®ç°è¿™ä¸ªéœ€æ±‚.<br><code>withTimeout</code>æŠ›å‡ºçš„<code>TimeoutCancellationException</code>æ˜¯<code>CancellationException</code>çš„å­ç±».ä¹‹å‰æ²¡æœ‰çœ‹åˆ°æ§åˆ¶å°æ‰“å°å¼‚å¸¸å †æ ˆä¿¡æ¯çš„åŸå› æ˜¯åœ¨ä¸€ä¸ªè¢«å–æ¶ˆçš„åç¨‹æŠ›å‡ºçš„ <code>CancellationExcepiton</code>è¢«è®¤ä¸ºæ˜¯åç¨‹æ­£å¸¸æ‰§è¡Œç»“æŸçš„æ ‡è®°.<br>å› ä¸º cancellation ä»…ä»…æ˜¯ä¸€ä¸ªå¼‚å¸¸,æ‰€æœ‰çš„èµ„æºéƒ½å¯ä»¥ä½¿ç”¨æ­£å¸¸çš„é€»è¾‘å¤„ç†.å¦‚æœä½ éœ€è¦åœ¨ä»»ä½•è¶…æ—¶æ—¶æ·»åŠ æŸäº›ç‰¹æ®Šé€»è¾‘,å¯ä»¥æŠŠè¶…æ—¶çš„è¿™äº›ä»£ç æ”¾åœ¨<code>try{...}catch(e:TimeoutCancellationException){...}</code>å—ä¸­,æˆ–è€…ä½¿ç”¨<code>withTimeoutOrNull</code>å‡½æ•°(ç±»ä¼¼<code>withTimeout</code>ä½†æ˜¯åœ¨è¶…æ—¶è¿”å› null è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸).</p>
<h1 id="ç»„åˆæŒ‚èµ·å‡½æ•°"><a href="#ç»„åˆæŒ‚èµ·å‡½æ•°" class="headerlink" title="ç»„åˆæŒ‚èµ·å‡½æ•°"></a>ç»„åˆæŒ‚èµ·å‡½æ•°</h1><h3 id="é»˜è®¤é¡ºåº"><a href="#é»˜è®¤é¡ºåº" class="headerlink" title="é»˜è®¤é¡ºåº"></a>é»˜è®¤é¡ºåº</h3><p>å‡è®¾æœ‰å®šä¹‰åœ¨å…¶ä»–åœ°æ–¹çš„ä¸¤ä¸ªæŒ‚èµ·å‡½æ•°æ‰§è¡Œå¦‚è¿œç¨‹æœåŠ¡æˆ–è®¡ç®—ç­‰ä»»åŠ¡.æˆ‘ä»¬è®¤ä¸ºè¿™äº›ä»»åŠ¡æœ‰ç”¨,å®é™…ä¸Šæ¯éš”ä»»åŠ¡åªæ˜¯ä¸ºäº†å…¶ç‰¹æ®Šç›®çš„å»¶æ—¶äº†1ç§’.</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">doSomethingUsefulOne</span><span class="params">()</span></span>:<span class="built_in">Int</span> &#123;</span><br><span class="line">  delay(<span class="number">1000</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="number">13</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">doSomethingUsefulTwo</span><span class="params">()</span></span>:<span class="built_in">Int</span> &#123;</span><br><span class="line">  delay(<span class="number">1000</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="number">29</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæˆ‘ä»¬éœ€è¦ä¸Šé¢çš„å‡½æ•°æŒ‰é¡ºåºè¢«è°ƒç”¨,ç„¶åè®¡ç®—ä»–ä»¬çš„ç»“æœ?å®é™…ä¸­,æˆ‘ä»¬éƒ½æ˜¯å…ˆæ‹¿ç¬¬ä¸€ä¸ªå‡½æ•°çš„ç»“æœåœ¨å†³å®šæ˜¯å¦è°ƒç”¨ç¬¬äºŒä¸ªå‡½æ•°æˆ–å¦‚ä½•è°ƒç”¨.<br>å’Œæ™®é€šçš„ä»£ç ä¸€æ ·,åœ¨åç¨‹é‡Œçš„ä»£ç ä¹Ÿæ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„.</p>
<h3 id="ä½¿ç”¨-async-å¹¶å‘"><a href="#ä½¿ç”¨-async-å¹¶å‘" class="headerlink" title="ä½¿ç”¨ async å¹¶å‘"></a>ä½¿ç”¨ async å¹¶å‘</h3><p>å¦‚æœä¸¤ä¸ªå‡½æ•°ä¹‹é—´æ²¡æœ‰ç›¸å…³,è€Œä¸”æˆ‘ä»¬æƒ³æ›´å¿«çš„è·å–åˆ°ç»“æœ,å¯ä»¥åŒæ—¶æ‰§è¡Œä¸¤ä¸ªå‡½æ•°å—?<code>async</code>å¯ä»¥å®ç°.<br>ç†è®ºå±±,<code>async</code>ç±»ä¼¼<code>launch</code>.å®ƒä¼šå¼€å¯ä¸€ä¸ªæ–°çš„åç¨‹å’Œå…¶ä»–åç¨‹å¹¶å‘çš„æ‰§è¡Œ.ä¸åŒä¹‹å¤„åœ¨äº<code>launch</code>è¿”å›ä¸€ä¸ªæ²¡æœ‰æºå¸¦ç»“æœçš„<code>Job</code>,è€Œ<code>async</code>è¿”å›ä¸€ä¸ª<code>Deferred</code>(ä¸€ä¸ªè½»é‡çº§çš„éé˜»å¡ future è¡¨ç¤ºåœ¨æœªæ¥çš„æŸä¸€æ—¶åˆ»ä¼šè¿”å›ç»“æœ).å¯ä»¥å¯¹<code>Deferred</code>ä½¿ç”¨<code>.await()</code>æ¥è·å–æœ€ç»ˆçš„ç»“æœ,ä½†æ˜¯<code>Deferred</code>åŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ª<code>Job</code>,æ‰€ä»¥å¿…è¦çš„æ—¶å€™ä¹Ÿå¯ä»¥å–æ¶ˆ.<br>åç¨‹çš„å¹¶å‘æ€§æ€»æ˜¯ç²¾ç¡®çš„.</p>
<h3 id="ä½¿ç”¨-async-å»¶è¿Ÿå¯åŠ¨"><a href="#ä½¿ç”¨-async-å»¶è¿Ÿå¯åŠ¨" class="headerlink" title="ä½¿ç”¨ async å»¶è¿Ÿå¯åŠ¨"></a>ä½¿ç”¨ async å»¶è¿Ÿå¯åŠ¨</h3><p><code>async</code>å¯ä»¥è®¾ç½®å®ƒçš„<code>start</code>å‚æ•°ä¸º<code>CoroutineStart.LAZY</code>æ¥å»¶è¿Ÿå¯åŠ¨.åœ¨æ­¤åœºæ™¯ä¸‹,åªæœ‰åœ¨<code>await</code>è°ƒç”¨è·å–ç»“æœæ—¶æ‰å¯åŠ¨,æˆ–è€…å®ƒçš„<code>Job</code>çš„<code>start</code>å‡½æ•°è¢«è°ƒç”¨æ—¶å¯åŠ¨.<br>å¦‚æœä»…ä»…è°ƒç”¨<code>await</code>è€Œæ²¡åœ¨ä¹‹å‰è°ƒç”¨å„è‡ªåç¨‹çš„<code>start</code>,è¿™å°†ä¼šå¯¼è‡´åºåˆ—åŒ–è¡Œä¸º,å› ä¸º<code>await</code>å¯åŠ¨åç¨‹æ‰§è¡Œä»£ç ç„¶åç­‰å¾…å®ƒç»“æŸ,è¿™ä¸æ˜¯ç”¨æˆ·è§’åº¦çš„å»¶è¿Ÿ.å½“è°ƒç”¨æŒ‚èµ·å‡½æ•°è®¡ç®—æŸä¸ªå€¼æ—¶ä½¿ç”¨<code>async(start=CoroutineStart.LAZY)</code>å¯ä»¥æ›¿æ¢æ ‡å‡†çš„<code>lazy</code>å‡½æ•°.</p>
<h3 id="async-é£æ ¼çš„å‡½æ•°"><a href="#async-é£æ ¼çš„å‡½æ•°" class="headerlink" title="async é£æ ¼çš„å‡½æ•°"></a>async é£æ ¼çš„å‡½æ•°</h3><p>ä½¿ç”¨<code>async</code>åç¨‹æ„é€ å™¨å’Œæ˜ç¡®çš„<code>GlobalScope</code>å¼•ç”¨å¼‚æ­¥è°ƒç”¨å‡½æ•°å°±å¯ä»¥å®ç°asyncé£æ ¼çš„å‡½æ•°.ä¸€èˆ¬è¿™æ ·çš„å‡½æ•°ä»¥<code>...Async</code>åç¼€ç»“å°¾ä»¥è¡¨æ˜åªå¯åŠ¨äº†å¼‚æ­¥æ‰§è¡Œ,éœ€è¦ä½¿ç”¨<code>Deferred</code>æ¥è·å–ç»“æœ.<br><code>xxxAsync</code>å‡½æ•°ä¸æ˜¯æŒ‚èµ·å‡½æ•°.è¿™ç§å‡½æ•°å¯åœ¨ä»»æ„åœ°æ–¹è°ƒç”¨.è¿™ç§å‡½æ•°å°±æ„å‘³ç€å¼‚æ­¥(æ­¤å¤„å³ä¸ºå¹¶å‘)æ‰§è¡Œä»–ä»¬çš„ä»»åŠ¡å’Œä»£ç .</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlin.system.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">val</span> time = measureTimeMillis &#123;</span><br><span class="line">    <span class="keyword">val</span> one = somethingUsefulOneAsync()</span><br><span class="line">    <span class="keyword">val</span> two = somethingUsefulTwoAsync()</span><br><span class="line">    <span class="comment">// ç­‰å¾…ç»“æœå¿…é¡»åœ¨æŒ‚èµ·å‡½æ•°æˆ–è€…é˜»å¡</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥ä½¿ç”¨ runBlocking&#123;&#125; é˜»å¡ä¸»çº¿ç¨‹</span></span><br><span class="line">    runBlocking &#123;</span><br><span class="line">      println(<span class="string">"<span class="subst">$&#123;one.await() + two.await()&#125;</span>"</span>)<span class="string">'</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fun somethingUsefulOneAsync() = GlobalScope.async &#123;</span></span><br><span class="line"><span class="string">    doSomethingUsefulOne()</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fun somethingUsefulTwoAsync() = GlobalScope.async &#123;</span></span><br><span class="line"><span class="string">    doSomethingUsefulTwo()</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">suspend fun doSomethingUsefulOne(): Int &#123;</span></span><br><span class="line"><span class="string">    delay(1000L) // pretend we are doing something useful here</span></span><br><span class="line"><span class="string">    return 13</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">suspend fun doSomethingUsefulTwo(): Int &#123;</span></span><br><span class="line"><span class="string">    delay(1000L) // pretend we are doing something useful here, too</span></span><br><span class="line"><span class="string">    return 29</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç ç±»ä¼¼å…¶ä»–è¯­è¨€çš„å¼‚æ­¥(js).å‡è®¾<code>xxxAsync</code>åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†å¼‚å¸¸,é€šå¸¸å…¨å±€é”™è¯¯å¤„ç†å™¨ä¼šæ•è·è¯¥å¼‚å¸¸,è®°å½•æŠ¥å‘Šæ­¤é”™è¯¯,ç¨‹åºå¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–æ“ä½œ.ä½†æ˜¯æ­¤å¤„çš„å‡½æ•°åœ¨åå°è¿è¡Œ,è€Œä¸ä¼šè¢«æ‰“æ–­,å³ä½¿åˆå§‹åŒ–è°ƒç”¨å®ƒçš„æ“ä½œå·²ç»è¢«ç»ˆæ­¢äº†.æ‰€ä»¥ä¸é¼“åŠ±ä½¿ç”¨è¿™æ ·çš„ä»£ç é£æ ¼.</p>
<h3 id="ä½¿ç”¨-async-è¿›è¡Œç»“æ„åŒ–å¹¶å‘"><a href="#ä½¿ç”¨-async-è¿›è¡Œç»“æ„åŒ–å¹¶å‘" class="headerlink" title="ä½¿ç”¨ async è¿›è¡Œç»“æ„åŒ–å¹¶å‘"></a>ä½¿ç”¨ async è¿›è¡Œç»“æ„åŒ–å¹¶å‘</h3><p>å› ä¸º<code>async</code>åç¨‹æ„é€ å™¨æ˜¯<code>CoroutineScope</code>çš„æ‰©å±•å‡½æ•°,æ‰€ä»¥éœ€è¦ä½¿ç”¨<code>coroutineScopeå‡½æ•°</code>æä¾›æ‰§è¡ŒèŒƒå›´.</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">concurrentSum</span><span class="params">()</span></span>: <span class="built_in">Int</span> = coroutineScope &#123;</span><br><span class="line">  <span class="keyword">val</span> one = async &#123; doOne()&#125;</span><br><span class="line">  <span class="keyword">val</span> two = async &#123; doTwo()&#125;</span><br><span class="line">  one.await+two.await()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœåœ¨ä¸Šé¢çš„å‡½æ•°é‡Œå‡ºé”™æŠ›å‡ºå¼‚å¸¸,é‚£ä¹ˆåœ¨è¿™ä¸ªèŒƒå›´é‡Œå¯åŠ¨çš„æ‰€æœ‰åç¨‹éƒ½å°†è¢«å–æ¶ˆ.</p>
<h1 id="åç¨‹ä¸Šä¸‹æ–‡å’Œåˆ†å‘å™¨"><a href="#åç¨‹ä¸Šä¸‹æ–‡å’Œåˆ†å‘å™¨" class="headerlink" title="åç¨‹ä¸Šä¸‹æ–‡å’Œåˆ†å‘å™¨"></a>åç¨‹ä¸Šä¸‹æ–‡å’Œåˆ†å‘å™¨</h1><p>åç¨‹æ€»æ˜¯åœ¨ kotlin æ ‡å‡†åº“å®šä¹‰çš„ <code>CoroutineContext</code> ç±»å‹çš„æŸä¸ªä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ.<br>åç¨‹æ˜¯ä¸€ç³»åˆ—ä¸åŒå…ƒç´ çš„é›†åˆ.ä¸»å…ƒç´ æ˜¯åç¨‹çš„ <code>Job</code>,<code>dispatcher</code>.</p>
<h3 id="åˆ†å‘å™¨å’Œçº¿ç¨‹"><a href="#åˆ†å‘å™¨å’Œçº¿ç¨‹" class="headerlink" title="åˆ†å‘å™¨å’Œçº¿ç¨‹"></a>åˆ†å‘å™¨å’Œçº¿ç¨‹</h3><p>åç¨‹ä¸Šä¸‹æ–‡åŒ…å«äº†ä¸€ä¸ªåç¨‹åˆ†å‘å™¨(å†³å®šå“ªä¸ªçº¿ç¨‹æˆ–ç›¸åº”åç¨‹æ‰§è¡Œå…¶ä»£ç çš„çº¿ç¨‹).åç¨‹åˆ†å‘å™¨å¯ä»¥é™åˆ¶åç¨‹åœ¨æŸä¸ªæŒ‡å®šçš„çº¿ç¨‹,çº¿ç¨‹æ± ,æˆ–è€…æœªå®šä¹‰çš„çº¿ç¨‹å»æ‰§è¡Œ.<br>æ‰€æœ‰çš„åç¨‹æ„é€ å™¨å¦‚<code>launch</code>å’Œ<code>async</code>æ¥æ”¶ä¸€ä¸ªå¯é€‰çš„<code>CoroutineContext</code>å‚æ•°(å¯ä»¥ç²¾ç¡®çš„æŒ‡å®šä¸ºä¸€ä¸ªæ–°åç¨‹æˆ–è€…å…¶ä»–ä¸Šä¸‹æ–‡å…ƒç´ ).<br>å½“<code>launch{...}</code>æœªä¼ å‚æ•°æ—¶,å®ƒç»§æ‰¿äº†ä»å®ƒè¢«å¯åŠ¨çš„åœ°æ–¹çš„<code>CoroutineScope</code>çš„ä¸Šä¸‹æ–‡(å’Œåˆ†å‘å™¨).<br><code>Dispatchers.Unconfined</code>æ˜¯ä¸€ä¸ªä¹Ÿè¿è¡Œåœ¨<code>main</code>çº¿ç¨‹çš„ç‰¹æ®Šåˆ†å‘å™¨,ä½†å®é™…æœºåˆ¶æ˜¯ä¸åŒçš„.<br>å½“åç¨‹ä»<code>GlobalScope</code>(å³<code>Dispatchers.Default</code>)å¯åŠ¨æ—¶ä½¿ç”¨çš„æ˜¯é»˜è®¤åˆ†å‘å™¨.ä½¿ç”¨äº†ä¸€ä¸ªå…±äº«åå°çº¿ç¨‹æ± ,æ‰€ä»¥<code>launch(Dispatchers.Default){...}</code>å’Œ<code>GloablScope.launch{...}</code>ä½¿ç”¨äº†ç›¸åŒçš„åˆ†å‘å™¨.<br><code>newSingleThreadContext</code>ä¸ºåç¨‹åˆ›å»ºäº†ä¸€ä¸ªæ–°çº¿ç¨‹å»è¿è¡Œ.ä¸“ç”¨çº¿ç¨‹æ˜¯ä¸€ç§éå¸¸æ˜‚è´µçš„èµ„æº.åœ¨çœŸå®åº”ç”¨ä¸‹,å½“ä¸åœ¨ä½¿ç”¨æ—¶,å®ƒå¿…é¡»ä½¿ç”¨ <code>close</code> å‡½æ•° release,æˆ–è€…å­˜å‚¨åœ¨ä¸€ä¸ªé¡¶çº§å˜é‡ä¸­,ç„¶ååœ¨æ•´ä¸ªåº”ç”¨ä¸­å¤ç”¨.</p>
<h3 id="æ— é™åˆ¶å’Œå—é™åˆ¶çš„åˆ†å‘å™¨"><a href="#æ— é™åˆ¶å’Œå—é™åˆ¶çš„åˆ†å‘å™¨" class="headerlink" title="æ— é™åˆ¶å’Œå—é™åˆ¶çš„åˆ†å‘å™¨"></a>æ— é™åˆ¶å’Œå—é™åˆ¶çš„åˆ†å‘å™¨</h3><p><code>Dispatchers.Unconfined</code>åç¨‹åˆ†å‘å™¨ä»…åœ¨ç¬¬ä¸€ä¸ªæŒ‚èµ·ç‚¹æ—¶æ‰åœ¨è°ƒç”¨è€…çº¿ç¨‹å¯åŠ¨ä¸€ä¸ªåç¨‹.æŒ‚èµ·å,çº¿ç¨‹ä¸­çš„åç¨‹å®Œå…¨ç”±è¢«è°ƒç”¨çš„æŒ‚èµ·å‡½æ•°å†³å®šæ˜¯å¦æ¢å¤.æ— é™åˆ¶åç¨‹åˆ†å‘å™¨é€‚ç”¨äºæ—¢ä¸æ¶ˆè€—CPUæ—¶é—´,ä¹Ÿä¸æ›´æ–°é™å®šäºç‰¹å®šçº¿ç¨‹çš„å…±äº«æ•°æ®(å¦‚UI)çš„åç¨‹.<br>æ­¤å¤–,æ­¤åç¨‹é»˜è®¤ç»§æ‰¿å…¶å¤–éƒ¨çš„<code>CoroutineScope</code>.<code>runBlocking</code>åç¨‹çš„é»˜è®¤åˆ†å‘å™¨å—é™äºå…¶è¢«è°ƒç”¨çš„çº¿ç¨‹,æ‰€ä»¥å®ƒå°†å…·æœ‰åœ¨æ­¤çº¿ç¨‹æ‰§è¡Œå¯é¢„æµ‹FIFOè°ƒåº¦çš„å½±å“.</p>
<blockquote>
<p>æ— é™åˆ¶åˆ†å‘å™¨å±äºé«˜çº§æŠ€å·§:åœ¨åˆ†å‘ä¸€ä¸ªåç¨‹åä¸éœ€è¦æˆ–äº§ç”Ÿä¸å¯æœŸçš„å‰¯ä½œç”¨æ—¶å¾ˆæœ‰æ•ˆæœï¼ˆå› ä¸ºåœ¨ä¸€ä¸ªåç¨‹é‡Œçš„æŸäº›æ“ä½œå¿…é¡»è¢«æ­£ç¡®çš„æ‰§è¡Œï¼‰.åœ¨æ­£å¸¸ä»£ç ä¸­ä¸è¦ä½¿ç”¨æ— é™åˆ¶åˆ†å‘å™¨.</p>
</blockquote>
<h3 id="è°ƒè¯•åç¨‹å’Œçº¿ç¨‹"><a href="#è°ƒè¯•åç¨‹å’Œçº¿ç¨‹" class="headerlink" title="è°ƒè¯•åç¨‹å’Œçº¿ç¨‹"></a>è°ƒè¯•åç¨‹å’Œçº¿ç¨‹</h3><p>åç¨‹å¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹è¢«æŒ‚èµ·,åœ¨å¦ä¸€ä¸ªçº¿ç¨‹è¢«å”¤é†’.å³ä½¿æ˜¯ä¸€ä¸ªå•çº¿ç¨‹åˆ†å‘å™¨ä¹Ÿå¾ˆéš¾æ£€æµ‹åç¨‹åœ¨ä»€ä¹ˆæ—¶é—´,ä»€ä¹ˆä½ç½®,æ‰§è¡Œäº†ä»€ä¹ˆæ“ä½œ.æœ€å¸¸ç”¨è°ƒè¯•çº¿ç¨‹çš„æ–¹å¼æ˜¯åœ¨æ¯æ¡æ—¥å¿—è¯­å¥æ‰“å°å‡ºçº¿ç¨‹å.å‡ ä¹æ‰€æœ‰çš„æ—¥å¿—æ¡†æ¶éƒ½æ”¯æŒè¿™ä¸ªç‰¹æ€§.ä½¿ç”¨åç¨‹æ—¶,çº¿ç¨‹æ²¡æœ‰æä¾›æ›´å¤šçš„ä¸Šä¸‹æ–‡ä¿¡æ¯,è€Œ<code>kotlinx.coroutines</code>åŒ…å«äº†è®¸å¤šè°ƒè¯•å·¥å…·å¯ä»¥æ›´æ–¹ä¾¿çš„å®ç°è¿™ä¸ªéœ€æ±‚.<br>åœ¨ JVM å‚æ•°æ—¶é…ç½® <code>-DKotlinx.coroutines.debug</code>.</p>
<blockquote>
<p>JVM é…ç½® <code>-ea</code> å‚æ•°debugæ¨¡å¼è‡ªåŠ¨å¼€å¯.</p>
</blockquote>
<h3 id="åœ¨çº¿ç¨‹ä¹‹é—´è·³è½¬"><a href="#åœ¨çº¿ç¨‹ä¹‹é—´è·³è½¬" class="headerlink" title="åœ¨çº¿ç¨‹ä¹‹é—´è·³è½¬"></a>åœ¨çº¿ç¨‹ä¹‹é—´è·³è½¬</h3><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">log</span><span class="params">(msg:<span class="type">String</span>)</span></span> = println(<span class="string">"[<span class="subst">$&#123;Thread.currentThread().name&#125;</span>] <span class="variable">$msg</span>"</span>)</span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  newSingleThreadContext(<span class="string">"Ctx1).use&#123;ctx1 -&gt;</span></span><br><span class="line"><span class="string">    newSingleThreadContext("</span>Ctx2).use&#123;ctx2 -&gt;</span><br><span class="line">      runBlocking(ctx1) &#123;</span><br><span class="line">        log(<span class="string">"started in ctx1"</span>)</span><br><span class="line">        withContext(ctx2) &#123;</span><br><span class="line">          log(<span class="string">"working in ctx2"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        log(<span class="string">"back to ctx1"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>runBlocking</code>å¯ä»¥æŒ‡å®šä¸Šä¸‹æ–‡å¯¹è±¡.<code>withContext</code>å‡½æ•°å¯ä»¥æ”¹å˜ä¸€ä¸ªåç¨‹çš„ä¸Šä¸‹æ–‡å¯¹è±¡.<br>kotlinæ ‡å‡†åº“é‡Œçš„<code>use</code>å‡½æ•°ä¼šä¸»åŠ¨é‡Šæ”¾<code>newSingleThreadContext</code>åˆ›å»ºçš„çº¿ç¨‹(ä¸å†ä½¿ç”¨æ—¶).</p>
<h3 id="ä¸Šä¸‹æ–‡é‡Œçš„-Job"><a href="#ä¸Šä¸‹æ–‡é‡Œçš„-Job" class="headerlink" title="ä¸Šä¸‹æ–‡é‡Œçš„ Job"></a>ä¸Šä¸‹æ–‡é‡Œçš„ Job</h3><p>åç¨‹é‡Œçš„ Job æ˜¯ä¸Šä¸‹æ–‡çš„ä¸€éƒ¨åˆ†,å¯ä»¥é€šè¿‡<code>coroutineContext[Jon]</code>è¡¨è¾¾å¼è·å–åˆ°.</p>
<blockquote>
<p><code>CoroutineScope</code>é‡Œçš„<code>isActive</code>ä»…ä»…æ˜¯<code>coroutineCOntext[Job]?.isActive == true</code>çš„ç®€å†™.</p>
</blockquote>
<h3 id="å­åç¨‹"><a href="#å­åç¨‹" class="headerlink" title="å­åç¨‹"></a>å­åç¨‹</h3><p>å½“ä»å¦ä¸€ä¸ªåç¨‹çš„<code>CoroutineScope</code>ä¸­å¯åŠ¨ä¸€ä¸ªæ–°åç¨‹æ—¶,åè€…é€šè¿‡å‰è€…çš„<code>CoroutineScope.coroutineContext</code>å’Œæ–°åç¨‹çš„Jobç»§æ‰¿äº†å‰è€…çš„ä¸Šä¸‹æ–‡,å˜æˆäº†çˆ¶åç¨‹ jobçš„å­job.å½“çˆ¶åç¨‹è¢«å–æ¶ˆæ—¶,æ‰€æœ‰çš„å­jobéƒ½ä¼šè¢«è¿­ä»£å–æ¶ˆ.<br>ç„¶è€Œ,å½“ä½¿ç”¨<code>GlobalScope</code>å¯åŠ¨ä¸€ä¸ªåç¨‹æ—¶,æ–°åç¨‹çš„Jobæ˜¯æ²¡æœ‰çˆ¶Jobçš„.æ‰€ä»¥å®ƒä¸ä¼šç»‘å®šåˆ°ä»»ä½• scope,è¿è¡Œæ˜¯ç‹¬ç«‹çš„.</p>
<h3 id="çˆ¶åç¨‹çš„èŒè´£"><a href="#çˆ¶åç¨‹çš„èŒè´£" class="headerlink" title="çˆ¶åç¨‹çš„èŒè´£"></a>çˆ¶åç¨‹çš„èŒè´£</h3><p>çˆ¶åç¨‹æ€»ä¼šç­‰å¾…æ‰€æœ‰çš„å­Jobæ‰§è¡Œå®Œæˆæ‰ç»“æŸ.çˆ¶åç¨‹ä¸éœ€è¦åˆ»æ„è¿½è¸ªå®ƒå¯åŠ¨çš„æ‰€æœ‰å­Job,ä¹Ÿä¸éœ€è¦ä½¿ç”¨<code>Job.join</code>å»ç­‰å¾….</p>
<h3 id="å‘½ååç¨‹"><a href="#å‘½ååç¨‹" class="headerlink" title="å‘½ååç¨‹"></a>å‘½ååç¨‹</h3><p>è‡ªåŠ¨åˆ†é…çš„åç¨‹idå¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™è¿‡æ»¤å…³æ³¨çš„åç¨‹ä¿¡æ¯.å¦‚æœä¸€ä¸ªåç¨‹æ˜¯è¿›è¡Œç‰¹æ®Šè¯·æ±‚æˆ–æ‰§è¡Œç‰¹æ®Šåå°ä»»åŠ¡,å¯¹å…¶è¿›è¡Œåˆé€‚çš„å‘½åæ›´åˆ©äºdebug.contextçš„<code>CoroutineName</code>å…ƒç´ å±æ€§ç±»ä¼¼çº¿ç¨‹åå¯ä»¥ç»™åç¨‹å‘½å.å½“ debug æ¨¡å¼å¼€å¯æ—¶,å®ƒä¼šåŒ…å«æ­¤åç¨‹æ‰€åœ¨çº¿ç¨‹çš„åå­—.</p>
<h3 id="ç»„åˆä¸Šä¸‹æ–‡å¯¹è±¡å…ƒç´ "><a href="#ç»„åˆä¸Šä¸‹æ–‡å¯¹è±¡å…ƒç´ " class="headerlink" title="ç»„åˆä¸Šä¸‹æ–‡å¯¹è±¡å…ƒç´ "></a>ç»„åˆä¸Šä¸‹æ–‡å¯¹è±¡å…ƒç´ </h3><p>æœ‰æ—¶éœ€è¦ä¸ºä¸€ä¸ªåç¨‹ä¸Šä¸‹æ–‡å®šä¹‰å¤šä¸ªå…ƒç´ .å¯ä»¥ä½¿ç”¨<code>+</code>å®ç°.</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">launch(Dispatchers.Default + CoroutineNmae(<span class="string">"Test"</span>)) &#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åç¨‹èŒƒå›´"><a href="#åç¨‹èŒƒå›´" class="headerlink" title="åç¨‹èŒƒå›´"></a>åç¨‹èŒƒå›´</h3><p>å‡è®¾æˆ‘ä»¬çš„åº”ç”¨æœ‰ä¸€ä¸ªæœ‰ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡,ä½†æ˜¯è¿™ä¸ªå¯¹è±¡ä¸æ˜¯åç¨‹.ä¾‹å¦‚æˆ‘ä»¬çš„androidåº”ç”¨åœ¨Actiivtyçš„ä¸Šä¸‹æ–‡ä¸‹å¯åŠ¨äº†è®¸å¤šçš„åç¨‹å»æ‰§è¡Œå¼‚æ­¥æ“ä½œ(å¦‚è·å–æ›´æ–°æ•°æ®ã€æ‰§è¡ŒåŠ¨ç”»ç­‰).å½“activityè¢«é”€æ¯æ—¶æ‰€æœ‰çš„åç¨‹å¿…é¡»è¢«å–æ¶ˆä»¥é¿å…å†…å­˜æ³„æ¼.æˆ‘ä»¬å½“ç„¶å¯ä»¥æ‰‹åŠ¨çš„å°†åç¨‹å’Œjobç»‘å®šåˆ°activityçš„ä¸Šä¸‹æ–‡,ä½†æ˜¯<code>kotlinx.coroutines</code>æä¾›äº†ä¸€ä¸ªæŠ½è±¡çš„å°è£…å¯¹è±¡:<code>CoroutineScope</code>.æ‰€æœ‰çš„åç¨‹æ„é€ å™¨éƒ½æ˜¯ä½œä¸ºå…¶æ‰©å±•è€Œå­˜åœ¨.<br>åˆ›å»ºä¸€ä¸ªç»‘å®šåˆ°activityçš„<code>CoroutineScope</code>å¯¹è±¡æ¥ç®¡ç†ç”Ÿå‘½å‘¨æœŸ.<code>CoroutineScope</code>å®ä¾‹å¯ä»¥é€šè¿‡<code>CoroutineScope()</code>æˆ–<code>MainScope()</code>å·¥å‚å‡½æ•°åˆ›å»º.å‰è€…åˆ›å»ºä¸€ä¸ªé€šç”¨çš„scope,è€Œåè€…ä½¿ç”¨<code>Dispatchers.Main</code> ä½œä¸ºé»˜è®¤åˆ†å‘å™¨åˆ›å»ºä¸€ä¸ªä¸“ä¸ºUIåº”ç”¨æ„é€ çš„scope.</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> mainScope = MainScope()</span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">destroy</span><span class="params">()</span></span>&#123;</span><br><span class="line">    mainScope.cancel()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥ä¸º <code>Activity</code>ç±»ç»§æ‰¿ <code>CoroutineScope</code>æ¥å£.æœ€ä½³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ä»£ç†å®ç°é»˜è®¤å·¥å‚å‡½æ•°.</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Activity</span> : <span class="type">CoroutineScope by CoroutineScope</span></span>(Dispatchers.Default) &#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="çº¿ç¨‹æœ¬åœ°æ•°æ®-Thread-local-data"><a href="#çº¿ç¨‹æœ¬åœ°æ•°æ®-Thread-local-data" class="headerlink" title="çº¿ç¨‹æœ¬åœ°æ•°æ®(Thread-local data)"></a>çº¿ç¨‹æœ¬åœ°æ•°æ®(Thread-local data)</h3><p>æœ‰æ—¶å€™åœ¨åç¨‹ä¹‹é—´èƒ½ä¼ é€’çº¿ç¨‹æœ¬åœ°æ•°æ®å°†ä¼šå¾ˆæ–¹ä¾¿.ä½†æ˜¯å› ä¸ºè¿™æ˜¯æ•°æ®æ²¡æœ‰ç»‘å®šåˆ°ä»»æ„ç‰¹å®šçš„çº¿ç¨‹,æ‰€ä»¥å¯èƒ½éœ€è¦å†™å¾ˆå¤šé‡å¤çš„ä»£ç .</p>
<p><code>asContextElement</code>æ‰©å±•å‡½æ•°å¯ä»¥ä½œä¸º<code>ThreadLocal</code>ä½¿ç”¨.å®ƒä¼šåˆ›å»ºä¸€ä¸ªé¢å¤–çš„ä¸Šä¸‹æ–‡å…ƒç´ ä¿å­˜<code>ThreadLocal</code>å€¼,åœ¨æ¯æ¬¡åç¨‹åˆ‡æ¢å®ƒçš„ä¸Šä¸‹æ–‡æ˜¯è‡ªåŠ¨æ¢å¤.</p>
<p>å¾ˆå®¹æ˜“å¿˜è®°è®¾ç½®ç›¸åº”çš„ä¸Šä¸‹æ–‡å…ƒç´ .å¦‚æœçº¿ç¨‹è¿è¡Œçš„åç¨‹ä¸åŒ,ä»åç¨‹è®¿é—®thread-localå˜é‡å¯èƒ½ä¼šå‡ºç°æœªçŸ¥çš„å€¼.ä¸ºäº†é¿å…è¿™æ ·çš„æƒ…å†µ,æ¨èä½¿ç”¨<code>ensurePresent</code>æ–¹æ³•å’Œåœ¨ä¸æ­£ç¡®ä½¿ç”¨æ—¶<code>fail-fast</code>.</p>
<p><code>ThreadLocal</code>å±äºé¡¶çº§å…ƒç´ æ”¯æŒ,å¯ä»¥åœ¨<code>kotlinx.coroutines</code>æä¾›åŸç”Ÿæ”¯æŒ.ä»…æœ‰ä¸€ä¸ªé™åˆ¶:å³è¿™ä¸ªthread-localå€¼å‘ç”Ÿå˜åŒ–,åç¨‹è°ƒç”¨è€…ä¸ä¼šæ”¶åˆ°é€šçŸ¥(å› ä¸ºåç¨‹ä¸Šä¸‹æ–‡å…ƒç´ ä¸ä¼šè¿½è¸ªæ‰€æœ‰çš„<code>ThreadLocal</code>å¯¹è±¡è®¿é—®è·¯å¾„),é‚£ä¹ˆæ›´æ–°çš„å…ƒç´ åœ¨ä¸‹æ¬¡æŒ‚èµ·æ—¶å°†ä¼šä¸¢å¤±.åœ¨åç¨‹ä¸­ä½¿ç”¨<code>withContext</code>æ›´æ–°ä¸€ä¸ªthread-localå¯¹è±¡çš„å€¼.</p>
<p>å½“ç„¶,æ•°æ®ä¹Ÿå¯ä»¥å­˜å‚¨åœ¨ä¸€ä¸ªå¯å˜çš„boxå¦‚<code>class Counter(var i:Int)</code>ä¸­,æœ€ç»ˆä¼šè¢«è½¬ä¸ºå­˜å‚¨åœ¨thread-localå˜é‡ä¸­.è¿™æ ·ä½ å°±éœ€è¦è‡ªå·±åŒæ­¥æ•°æ®çš„å˜æ›´.</p>
<p><code>ThreadContextElement</code></p>
<h1 id="å¼‚æ­¥æµ"><a href="#å¼‚æ­¥æµ" class="headerlink" title="å¼‚æ­¥æµ"></a>å¼‚æ­¥æµ</h1><p>æŒ‚èµ·å‡½æ•°å¼‚æ­¥è¿”å›ä¸€ä¸ªå€¼,ä½†æ˜¯å¦‚ä½•è¿”å›å¤šä¸ªå¼‚æ­¥å€¼?å¼‚æ­¥æµå¯ä»¥å®ç°è¿™æ ·çš„éœ€æ±‚.</p>
<h3 id="å±•ç¤ºå¤šä¸ªå€¼"><a href="#å±•ç¤ºå¤šä¸ªå€¼" class="headerlink" title="å±•ç¤ºå¤šä¸ªå€¼"></a>å±•ç¤ºå¤šä¸ªå€¼</h3><h6 id="collections"><a href="#collections" class="headerlink" title="collections"></a>collections</h6><p>åœ¨ kotlin ä½¿ç”¨ <code>collections</code>è¡¨ç¤ºå¤šä¸ªå€¼.</p>
<h6 id="sequence"><a href="#sequence" class="headerlink" title="sequence"></a>sequence</h6><p>å¦‚æœæ•°æ®æ˜¯éœ€è¦èŠ±è´¹CPUé˜»å¡è®¡ç®—å‡ºæ¥çš„,é‚£å¯ä»¥ä½¿ç”¨ <code>Sequence</code></p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Sequence&lt;<span class="built_in">Int</span>&gt; = sequence &#123;</span><br><span class="line">  <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">3</span>) &#123;</span><br><span class="line">    Thread.sleep(<span class="number">100</span>)</span><br><span class="line">    yield(i)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  foo().forEach &#123;value -&gt; println(value)&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="æŒ‚èµ·å‡½æ•°"><a href="#æŒ‚èµ·å‡½æ•°" class="headerlink" title="æŒ‚èµ·å‡½æ•°"></a>æŒ‚èµ·å‡½æ•°</h5><p>ä½†æ˜¯ä¸Šé¢è¿™æ ·çš„ä»£ç ä¼šé˜»å¡ä¸»çº¿ç¨‹.</p>
<h5 id="Flows"><a href="#Flows" class="headerlink" title="Flows"></a>Flows</h5><p>ä½¿ç”¨ <code>List&lt;Int&gt;</code>ä¼šä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰çš„å€¼.å¯ä»¥ä½¿ç”¨<code>Flow&lt;int&gt;</code>å¼‚æ­¥çš„è®¡ç®—å€¼æ¥è¡¨ç¤ºæ•°æ®æµ.</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">  <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">3</span>) &#123;</span><br><span class="line">    delay(<span class="number">100</span>)</span><br><span class="line">    emit(i)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">  launch &#123;</span><br><span class="line">    <span class="keyword">for</span> (k <span class="keyword">in</span> <span class="number">1</span>..<span class="number">3</span>) &#123;</span><br><span class="line">      println(<span class="string">"I am not blocked<span class="variable">$K</span>"</span>)</span><br><span class="line">      delay(<span class="number">100</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  foo().collect&#123;value -&gt; println(value)&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>flow{...}</code> æ„é€ å™¨å¯ä»¥æŒ‚èµ·</li>
<li><code>foo()</code> å‡½æ•°ä¸å†è¢«æ ‡è®°ä¸º<code>suspend</code></li>
</ul>
<h3 id="Flows-å±äºå†·å¯åŠ¨"><a href="#Flows-å±äºå†·å¯åŠ¨" class="headerlink" title="Flows å±äºå†·å¯åŠ¨"></a>Flows å±äºå†·å¯åŠ¨</h3><p>Flows ç±»ä¼¼ sequences æ˜¯å†·å¯åŠ¨çš„-åœ¨ flow æ„é€ å™¨ä¸­çš„ä»£ç åœ¨ flow è¢« collect å‰æ˜¯ä¸ä¼šè¿è¡Œçš„.è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ <code>foo()</code>å‡½æ•°æ²¡æœ‰è¢«æ ‡è®°<code>suspend</code>.</p>
<h3 id="Flows-å–æ¶ˆ"><a href="#Flows-å–æ¶ˆ" class="headerlink" title="Flows å–æ¶ˆ"></a>Flows å–æ¶ˆ</h3><p>flow éµå¾ªåç¨‹çš„å–æ¶ˆè§„åˆ™.flow æ²¡æœ‰æä¾›å…¶ä»–é¢å¤–çš„æŒ‚èµ·ç‚¹.å½“flowè¢«ä¸€ä¸ªå¯å–æ¶ˆçš„æŒ‚èµ·å‡½æ•°(<code>delay</code>)æŒ‚èµ·æ—¶æ˜¯å¯ä»¥è¢«å–æ¶ˆçš„.å¦åˆ™æ˜¯ä¸å¯è¢«å–æ¶ˆçš„.</p>
<h3 id="Flow-æ„é€ å™¨"><a href="#Flow-æ„é€ å™¨" class="headerlink" title="Flow æ„é€ å™¨"></a>Flow æ„é€ å™¨</h3><ul>
<li><code>flow{...}</code></li>
<li><code>flowOf</code>æ„é€ å™¨å‘å°„å›ºå®šå¸¦ä¸‹çš„æ•°æ®æµ</li>
<li>ä¸åŒçš„ collections å’Œ sequence å¯ä»¥ä½¿ç”¨ <code>.asFlow()</code> æ‰©å±•å‡½æ•°è½¬ä¸º flow.<h3 id="flow-çš„ä¸­é—´æ“ä½œ"><a href="#flow-çš„ä¸­é—´æ“ä½œ" class="headerlink" title="flow çš„ä¸­é—´æ“ä½œ"></a>flow çš„ä¸­é—´æ“ä½œ</h3>Flows å¯ä»¥ä½¿ç”¨ç±»ä¼¼ collections å’Œ sequences è¿›è¡Œè½¬æ¢.ä¸­é—´æ“ä½œåº”ç”¨åœ¨ä¸Šæ¸¸æµ,ç„¶åè¿”å›ä¸‹æ¸¸æµ.è¿™äº›æµéƒ½æ˜¯å†·å¯åŠ¨æµ.è¿™æ ·çš„æ“ä½œä¸æ˜¯æŒ‚èµ·å‡½æ•°.ç«‹å³è¿”å›æ–°çš„è½¬æ¢æµ.</li>
</ul>
<p>æœ€åŸºæœ¬æ“ä½œåç§°å¦‚<code>map</code>,<code>filter</code>.ä¸åŒäº sequence çš„æ˜¯åœ¨è¿™äº›æ“ä½œé‡Œçš„ä»£ç å—å¯ä»¥è°ƒç”¨æŒ‚èµ·å‡½æ•°.</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">performRequest</span><span class="params">(request: <span class="type">Int</span>)</span></span>: String &#123;</span><br><span class="line">  delay(<span class="number">1000</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"response <span class="variable">$request</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">  (<span class="number">1</span>..<span class="number">3</span>).asFlow()</span><br><span class="line">        .map&#123; request -&gt; performRequest(request)&#125;</span><br><span class="line">        .collect&#123; response -&gt; println(response)&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è½¬æ¢æ“ä½œç¬¦"><a href="#è½¬æ¢æ“ä½œç¬¦" class="headerlink" title="è½¬æ¢æ“ä½œç¬¦"></a>è½¬æ¢æ“ä½œç¬¦</h3><p>flow è½¬æ¢ç¬¦ä¸­,æœ€å¸¸ç”¨çš„è¢«ç§°ä¸º<code>transform</code>.å®ƒå¯ä»¥å®ç°æ¯”<code>map</code>å’Œ<code>filter</code>æ›´å¤æ‚çš„è½¬æ¢æ“ä½œ.ä½¿ç”¨ <code>transform</code>æ“ä½œç¬¦,å¯ä»¥å‘å°„ä»»æ„å€¼ä»»æ„æ¬¡.</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">performRequest</span><span class="params">(request: <span class="type">Int</span>)</span></span>: String &#123;</span><br><span class="line">  delay(<span class="number">1000</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"response <span class="variable">$request</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">  (<span class="number">1</span>..<span class="number">3</span>).asFlow()</span><br><span class="line">        .transform&#123; request -&gt;</span><br><span class="line">          emit(<span class="string">"making request <span class="variable">$request</span>"</span>)</span><br><span class="line">          emit(performRequest(request))</span><br><span class="line">        &#125;</span><br><span class="line">        .collect&#123; resposne -&gt; println(response)&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¤§å°é™åˆ¶æ“ä½œç¬¦"><a href="#å¤§å°é™åˆ¶æ“ä½œç¬¦" class="headerlink" title="å¤§å°é™åˆ¶æ“ä½œç¬¦"></a>å¤§å°é™åˆ¶æ“ä½œç¬¦</h3><p>å¤§å°é™åˆ¶æ“ä½œç¬¦å¦‚<code>take</code>åœ¨ç›¸åº”çš„é™åˆ¶åˆ°æœŸæ—¶ä¼šå–æ¶ˆæ‰§è¡Œ.åç¨‹é‡Œçš„å–æ¶ˆæ€»æ˜¯ä¼šæŠ›å‡ºå¼‚å¸¸,æ‰€ä»¥æ‰€æœ‰çš„èµ„æºç®¡ç†å‡½æ•°å¦‚(<code>try{...}finally{...}</code>)å’Œæ™®é€šçš„æ“ä½œç±»ä¼¼.</p>
<h3 id="ç»ˆæ­¢flowæ“ä½œç¬¦"><a href="#ç»ˆæ­¢flowæ“ä½œç¬¦" class="headerlink" title="ç»ˆæ­¢flowæ“ä½œç¬¦"></a>ç»ˆæ­¢flowæ“ä½œç¬¦</h3><p>ç»ˆæ­¢æ“ä½œç¬¦æ˜¯ä¸€ä¸ªå¯åŠ¨æ”¶é›†æµçš„æŒ‚èµ·å‡½æ•°.<code>collect</code>å‡½æ•°æ˜¯æœ€é•¿ç”¨çš„ä¸€ä¸ª.å…¶ä»–çš„æœ‰:</p>
<ul>
<li>è½¬æ¢ä¸ºä¸åŒçš„ collectionså¦‚: <code>toList</code>,<code>toSet</code></li>
<li>è·å–ç¬¬ä¸€ä¸ªå€¼å¹¶ä¸”ç¡®å®šæµåªå‘é€äº†ä¸€ä¸ªå€¼.</li>
<li>ä½¿ç”¨ <code>reduce</code>å’Œ<code>fold</code>æŠŠæµå‹ç¼©ä¸ºä¸€ä¸ªå€¼.<h3 id="æµæ˜¯è¿ç»­çš„"><a href="#æµæ˜¯è¿ç»­çš„" class="headerlink" title="æµæ˜¯è¿ç»­çš„"></a>æµæ˜¯è¿ç»­çš„</h3>ä¸€ä¸ªæµçš„æ¯ä¸ªç‹¬ç«‹æ”¶é›†éƒ½æ˜¯è¿ç»­çš„é™¤éæŸäº›ç‰¹æ®Šæ“ä½œå¤„ç†äº†å¤šä¸ªæµ.åç¨‹é‡Œçš„æµæ”¶é›†ä¼šè°ƒç”¨ä¸€ä¸ªç»ˆæ­¢æ“ä½œç¬¦.é»˜è®¤ä¸ä¼šå¯åŠ¨æ–°åç¨‹.æ¯ä¸€ä¸ªå‘å°„çš„æ•°æ®éƒ½ä¼šè¢«ä»ä¸Šæ¸¸åˆ°ä¸‹æ¸¸çš„ä¸­é—´å¤„ç†æ“ä½œç¬¦å¤„ç†.æœ€åè¢«ä¼ é€åˆ°ç»ˆæ­¢æ“ä½œç¬¦.<h3 id="Flow-context"><a href="#Flow-context" class="headerlink" title="Flow context"></a>Flow context</h3>æµçš„æ”¶é›†æ“ä½œæ€»æ˜¯å¤„äºæ­£åœ¨è¢«è°ƒç”¨çš„åç¨‹ä¸­,è€Œä¸æ˜¯flowæ‰€åœ¨çš„åç¨‹.</li>
</ul>
<p>æµçš„è¿™ä¸ªæ“ä½œè¢«ç§°ä¸ºä¸Šä¸‹æ–‡ä¿å­˜.<br>æ‰€ä»¥é»˜è®¤<code>flow{...}</code>é‡Œçš„ä»£ç è¿è¡Œçš„ä¸Šä¸‹æ–‡æ˜¯ç”±æµçš„ç›¸åº”æ”¶é›†è€…æä¾›çš„.å¯¹äºå¿«é€Ÿè¿è¡Œæˆ–å¼‚æ­¥ä»£ç è€Œè¨€,è¿™æ˜¯ä¸ªå®Œç¾çš„é»˜è®¤è®¾ç½®,å®ƒä¸å…³å¿ƒä¸Šä¸‹æ–‡æ‰§è¡Œè€…,ä¹Ÿä¸é˜»å¡è°ƒç”¨è€….</p>
<h6 id="withContext-å‘å°„é”™è¯¯"><a href="#withContext-å‘å°„é”™è¯¯" class="headerlink" title="withContext å‘å°„é”™è¯¯"></a>withContext å‘å°„é”™è¯¯</h6><p>é•¿æ—¶é—´æ¶ˆè€—CPUçš„ä»£ç éœ€è¿è¡Œåœ¨<code>Dispatchers.Default</code>ä¸Šä¸‹æ–‡,UIæ›´æ–°ä»£ç éœ€è¿è¡Œåœ¨<code>Dispatchers.Main</code>ä¸Šä¸‹æ–‡ä¸­.é€šå¸¸,åœ¨åç¨‹ä¸­ä½¿ç”¨ <code>withContext</code>åˆ‡æ¢ä¸Šä¸‹æ–‡,ä½†æ˜¯<code>flow{...}</code>ä¸­çš„ä»£ç æœ‰ä¸Šä¸‹æ–‡ä¿ç•™ç‰¹æ€§,ä¸å…è®¸åœ¨å…¶ä»–ä¸Šä¸‹æ–‡å‘å°„æ•°æ®.</p>
<h6 id="flowOn-æ“ä½œç¬¦"><a href="#flowOn-æ“ä½œç¬¦" class="headerlink" title="flowOn æ“ä½œç¬¦"></a>flowOn æ“ä½œç¬¦</h6><p>æŒ‡å‘ flowOn å‡½æ•°çš„å¼‚å¸¸å¯ä»¥ç”¨æ¥æ›´æ”¹ flow å‘å°„çš„ä¸Šä¸‹æ–‡.æ”¹å˜flowä¸Šä¸‹æ–‡çš„æ­£ç¡®æ“ä½œå¦‚ä¸‹:</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span>:Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">  <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">3</span>) &#123;</span><br><span class="line">    delay(<span class="number">100</span>)</span><br><span class="line">    emit(i)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;.flowOn(Dispatchers.Default)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">  foo().collect&#123; value -&gt;</span><br><span class="line">    log(<span class="string">"llll"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>flowOn</code>æ“ä½œç¬¦æ”¹å˜äº†æµçš„é»˜è®¤é¡ºåº.ç°åœ¨æ”¶é›†è€…åœ¨ä¸€ä¸ªåç¨‹,è€Œå‘å°„å´å¹¶å‘çš„è¿è¡Œåœ¨åœ¨å¦ä¸€ä¸ªçº¿ç¨‹çš„ä¸€ä¸ªåç¨‹ä¸­.å½“åœ¨å®ƒçš„ä¸Šä¸‹æ–‡ä¸­æ”¹å˜<code>CoroutineDispatcher</code>æ—¶<code>flowOn</code>æ“ä½œç¬¦ä¸ºä¸Šæ¸¸åˆ›å»ºäº†å¦ä¸€ä¸ªåç¨‹.</p>
<h3 id="Buffering"><a href="#Buffering" class="headerlink" title="Buffering"></a>Buffering</h3><p>åœ¨æ¶‰åŠé•¿æ—¶é—´è¿è¡Œçš„å¼‚æ­¥æ“ä½œæ—¶,åœ¨ä¸åŒåç¨‹è¿è¡Œæµçš„ä¸åŒéƒ¨åˆ†å¯¹æµæ”¶é›†çš„æ€»æ—¶é—´å¾ˆæœ‰å¸®åŠ©.<br>ä½¿ç”¨<code>buffer</code>æ“ä½œç¬¦æ“ä½œæ“ä½œæ­£åœ¨å‘å°„æ•°æ®çš„æµ,å¹¶å‘çš„æ”¶é›†è€Œä¸æ˜¯é¡ºåºæ”¶é›†.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">val time &#x3D; measureTimeMillis &#123;</span><br><span class="line">  foo()</span><br><span class="line">    .buffer()</span><br><span class="line">    .collect &#123; value -&gt;</span><br><span class="line">      delay(300)</span><br><span class="line">      println(value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">println(&quot;Collected in $time ms&quot;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å½“æ”¹å˜ <code>CoroutineDispatcher</code>æ—¶<code>flowOn</code>æ“ä½œç¬¦ä½¿ç”¨ç›¸ä¼¼çš„æœºåˆ¶,ä½†æ˜¯æ­¤å¤„ä¸éœ€è¦æ”¹å˜æ‰§è¡Œä¸Šä¸‹æ–‡.</p>
</blockquote>
<h5 id="å¼‚æ­¥åˆå¹¶"><a href="#å¼‚æ­¥åˆå¹¶" class="headerlink" title="å¼‚æ­¥åˆå¹¶"></a>å¼‚æ­¥åˆå¹¶</h5><p>å½“æµè¡¨ç¤ºäº†éƒ¨åˆ†æ“ä½œç»“æœæˆ–å‚æ•°æ›´æ–°çŠ¶æ€,å¤„ç†æ¯ä¸ªå€¼å¯èƒ½æ²¡å¿…è¦,ä½†æ˜¯éœ€è¦å¤„ç†æœ€è¿‘çš„ä¸€ä¸ª.å½“æ”¶é›†è€…å¤„ç†å¤ªæ…¢æ—¶<code>conflate</code>æ“ä½œç¬¦å¯ä»¥è·³è¿‡æŸäº›ä¸­é—´å€¼.</p>
<h5 id="å¤„ç†æœ€åä¸€ä¸ªå€¼"><a href="#å¤„ç†æœ€åä¸€ä¸ªå€¼" class="headerlink" title="å¤„ç†æœ€åä¸€ä¸ªå€¼"></a>å¤„ç†æœ€åä¸€ä¸ªå€¼</h5><p>å½“ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¤„ç†éƒ½å¾ˆæ…¢æ—¶,conflate æ˜¯ä¸€ç§åŠ é€Ÿçš„æ–¹æ³•.å®ƒä¸¢å¼ƒäº†ä¸€éƒ¨åˆ†æ•°æ®.å¦ä¸€ç§æ–¹å¼æ˜¯å–æ¶ˆæ…¢æ¶ˆè´¹è€…,ç„¶ååªè¦ç”Ÿäº§è€…å‘é€ä¸€ä¸ªæ•°æ®å°±é‡å¯.</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">foo()</span><br><span class="line">  .follectLastes &#123;value -&gt;</span><br><span class="line">    println(<span class="string">"collection <span class="variable">$value</span>"</span>)</span><br><span class="line">    delay(<span class="number">300</span>)</span><br><span class="line">    pritln(<span class="string">"Done <span class="variable">$value</span>"</span>)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç»„åˆå¤šä¸ªæµ"><a href="#ç»„åˆå¤šä¸ªæµ" class="headerlink" title="ç»„åˆå¤šä¸ªæµ"></a>ç»„åˆå¤šä¸ªæµ</h3><h6 id="Zip"><a href="#Zip" class="headerlink" title="Zip"></a>Zip</h6><p>ç±»ä¼¼<code>Sequence.zip</code>æ‰©å±•å‡½æ•°,æµä¹Ÿæœ‰<code>è‡ªæ‹</code>æ“ä½œç¬¦</p>
<h6 id="Combine"><a href="#Combine" class="headerlink" title="Combine"></a>Combine</h6><p>å½“æµè¡¨ç¤ºæŸäº›å˜é‡æˆ–æ“ä½œæœ€è¿‘çš„å€¼æ—¶(è§<code>conflation</code>),å®ƒå¯èƒ½éœ€è¦æ ¹æ®ç›¸åº”æµçš„æœ€æ–°å€¼å’Œä¸Šæ¸¸å‘å°„çš„æ–°æ•°æ®è®¡ç®—,<code>combine</code>å¯ä»¥å®ç°.ä½¿ç”¨<code>zip</code>çš„è¯å°±å¾—ç­‰æ—¶é—´æœ€é•¿çš„å“ªä¸ªæµæ”¶åˆ°å€¼æ‰èƒ½è®¡ç®—.</p>
<h3 id="å±•å¼€æµ"><a href="#å±•å¼€æµ" class="headerlink" title="å±•å¼€æµ"></a>å±•å¼€æµ</h3><p>å› ä¸ºæµè¡¨ç¤ºå¼‚æ­¥æ¥å—åˆ°çš„æ•°æ®æµ,æ‰€ä»¥æ¯ä¸ªå€¼å¯ä»¥è½¬ä¸ºå¦ä¸€ä¸ªåºåˆ—çš„æµ.å¦‚<code>Flow&lt;Flow&lt;String&gt;&gt;</code></p>
<h6 id="flatMapConcat"><a href="#flatMapConcat" class="headerlink" title="flatMapConcat"></a>flatMapConcat</h6><p><code>flatMapConcat</code>å’Œ<code>flattenConcat</code>æ“ä½œç¬¦å®ç°äº†æ‹¼æ¥æ¨¡å¼.è¿™æ˜¯æœ€æ¥è¿‘ sequenceçš„æ“ä½œç¬¦.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import kotlinx.coroutines.*</span><br><span class="line">import kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line">fun requestFlow(i: Int): Flow&lt;String&gt; &#x3D; flow &#123;</span><br><span class="line">    emit(&quot;$i: First&quot;)</span><br><span class="line">    delay(500) &#x2F;&#x2F; wait 500 ms</span><br><span class="line">    emit(&quot;$i: Second&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fun main() &#x3D; runBlocking&lt;Unit&gt; &#123;</span><br><span class="line">&#x2F;&#x2F;sampleStart</span><br><span class="line">    val startTime &#x3D; currentTimeMillis() &#x2F;&#x2F; remember the start time</span><br><span class="line">    (1..3).asFlow().onEach &#123; delay(100) &#125; &#x2F;&#x2F; a number every 100 ms</span><br><span class="line">        .flatMapConcat &#123; requestFlow(it) &#125;</span><br><span class="line">        .collect &#123; value -&gt; &#x2F;&#x2F; collect and print</span><br><span class="line">            println(&quot;$value at $&#123;System.currentTimeMillis() - startTime&#125; ms from start&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">&#x2F;&#x2F;sampleEnd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="flatMapMerge"><a href="#flatMapMerge" class="headerlink" title="flatMapMerge"></a>flatMapMerge</h6><p>å¦ä¸€ç§å±•å¼€æ¨¡å¼æ˜¯å¹¶å‘çš„æ”¶é›†æ‰€æœ‰è¿›æ¥çš„æµ,ç„¶åæŠŠä»–ä»¬åˆå¹¶ä¸ºä¸€ä¸ªå•ä¸€æµ,è¿™æ ·å€¼å°±å¯ä»¥å°½å¿«è¢«å‘å‡ºå».<code>flatMapMerge</code>,<code>flattenMerge</code>.å®ƒä»¬éƒ½æ¥å—ä¸€ä¸ª<code>concurrency</code>å‚æ•°é™åˆ¶å¹¶å‘æµçš„æ•°é‡.</p>
<h6 id="flatmapLatest"><a href="#flatmapLatest" class="headerlink" title="flatmapLatest"></a>flatmapLatest</h6><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import kotlinx.coroutines.*</span><br><span class="line">import kotlinx.coroutines.flow.*</span><br><span class="line"></span><br><span class="line">fun requestFlow(i: Int): Flow&lt;String&gt; &#x3D; flow &#123;</span><br><span class="line">    emit(&quot;$i: First&quot;)</span><br><span class="line">    delay(500) &#x2F;&#x2F; wait 500 ms</span><br><span class="line">    emit(&quot;$i: Second&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fun main() &#x3D; runBlocking&lt;Unit&gt; &#123;</span><br><span class="line">&#x2F;&#x2F;sampleStart</span><br><span class="line">    val startTime &#x3D; currentTimeMillis() &#x2F;&#x2F; remember the start time</span><br><span class="line">    (1..3).asFlow().onEach &#123; delay(100) &#125; &#x2F;&#x2F; a number every 100 ms</span><br><span class="line">        .flatMapLatest &#123; requestFlow(it) &#125;</span><br><span class="line">        .collect &#123; value -&gt; &#x2F;&#x2F; collect and print</span><br><span class="line">            println(&quot;$value at $&#123;System.currentTimeMillis() - startTime&#125; ms from start&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">&#x2F;&#x2F;sampleEnd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>ç¿»è¯‘</tag>
      </tags>
  </entry>
  <entry>
    <title>docker,docker-composeå­¦ä¹ ç¬”è®°</title>
    <url>/2019/03/01/docker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>Compose æ˜¯ä¸€ä¸ªä¸ºäº†å®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨ Docker åº”ç”¨çš„å·¥å…·ã€‚<br><a href="https://github.com/docker/labs" target="_blank" rel="noopener">å®˜æ–¹åŠ¨æ‰‹ç¤ºä¾‹</a></p>
<a id="more"></a>
<h3 id="ç‰¹æ€§"><a href="#ç‰¹æ€§" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h3><ul>
<li>ä¸€ä¸ªä¸»æœºå¤šä¸ªéš”ç¦»ç¯å¢ƒ</li>
<li>å½“å®¹å™¨åˆ›å»ºæ—¶ä¿ç•™æ‰€æœ‰çš„ volume</li>
<li>åªæœ‰å®¹å™¨è¢«æ›´æ”¹æ—¶æ‰è§¦å‘åˆ›å»º</li>
<li>å®šä¹‰å˜é‡å’Œåœ¨ä¸åŒç¯å¢ƒä¸­ä½¿ç”¨</li>
</ul>
<h3 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h3><ul>
<li>è‡ªåŠ¨æµ‹è¯•ç¯å¢ƒ</li>
<li>å•ç‹¬ä¸»æœºéƒ¨ç½²</li>
</ul>
<h3 id="docker-compose-å®‰è£…"><a href="#docker-compose-å®‰è£…" class="headerlink" title="docker-compose å®‰è£…"></a>docker-compose å®‰è£…</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo curl -L "https://github.com/docker/compose/releases/download/1.23.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose</span><br><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br><span class="line">sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose</span><br><span class="line">sudo docker-compose --version</span><br></pre></td></tr></table></figure>

<p>pip å®‰è£…</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install docker-compose</span><br></pre></td></tr></table></figure>

<p>å¸è½½</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo rm /usr/local/bin/docker-compose</span><br><span class="line">pip uninstall docker-compose</span><br></pre></td></tr></table></figure>

<h3 id="docker-compose-å‘½ä»¤"><a href="#docker-compose-å‘½ä»¤" class="headerlink" title="docker-compose å‘½ä»¤"></a>docker-compose å‘½ä»¤</h3><ul>
<li><code>-f</code> æŒ‡å®š ä¸€ä¸ªæˆ–å¤šä¸ª compose æ–‡ä»¶çš„åç§°å’Œè·¯å¾„<blockquote>
<p>1ã€ä½¿ç”¨å¤šä¸ª Compose æ–‡ä»¶æ—¶ï¼ŒCompose ä¼šæŠŠè¿™å‡ ä¸ªæ–‡ä»¶åˆå¹¶ä¸ºä¸€ä¸ªé…ç½®ã€‚æŒ‰é¡ºåºåˆå¹¶ï¼Œåè¾¹çš„è¦†ç›–å‰è¾¹çš„é…ç½®ã€‚<br>2ã€<code>docker-compose -f docker-compose.yml -f docker-compose.admin.yml run backup_db</code><br>3ã€ä½¿ç”¨ <code>-(dash)</code> ä½œä¸º <code>-f</code> çš„å€¼ï¼Œå°†ä¼šä»è¾“å…¥ä¸­è¯»å–é…ç½®æ–‡ä»¶åã€‚ä½¿ç”¨ <code>stdin</code> æ—¶ï¼Œé…ç½®é‡Œæ¶‰åŠåˆ°çš„è·¯å¾„éƒ½æ˜¯ç›¸å¯¹äºå½“å‰å·¥ä½œä¸Šä¸‹æ–‡è·¯å¾„ã€‚<br>4ã€å¦‚æœä¸æ˜¯ç”¨ <code>-f</code>,Compose éå†å½“å‰ä¸Šä¸‹æ–‡è·¯å¾„å’Œå®ƒçš„çˆ¶è·¯å¾„æŸ¥è¯¢ <code>docker-compose.yml</code> å’Œ <code>docker-compose.override.yml</code> æ–‡ä»¶ã€‚è¯·è‡³å°‘æä¾›ä¸€ä¸ª <code>docker-compose.yml</code> æ–‡ä»¶ã€‚å¦‚æœæ‰€æœ‰çš„æ–‡ä»¶éƒ½åœ¨åŒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹ï¼ŒCompose å°†åˆå¹¶å®ƒä»¬ã€‚<br>5ã€<code>docker-compose.override.yml</code> çš„é…ç½®é«˜äº <code>docker-compose.yml</code>,ä¸”ä¸ºåè€…æä¾›é¢å¤–çš„é…ç½®å±æ€§ã€‚</p>
</blockquote>
</li>
<li>ä¸ºå•ç‹¬çš„ Compose æ–‡ä»¶æŒ‡å®šè·¯å¾„<blockquote>
<p>1ã€ä½¿ç”¨ <code>-f</code>, æˆ–ä»å‘½ä»¤è¡Œè¾“å…¥ï¼Œæˆ–åœ¨ shell / æŸä¸ªç¯å¢ƒé…ç½®æ–‡ä»¶ä¸­è®¾ç½® COMPOSE_FILE ç¯å¢ƒå˜é‡,æŒ‡å®šä¸åœ¨å½“å‰æ–‡ä»¶å¤¹çš„ Compose æ–‡ä»¶è·¯å¾„.<br>2ã€<code>docker-compose -f ~/sandbox/rails/docker-compose.yml pull db</code> ä» <code>~/sandbox/rails/docker-compose.yml</code> æ–‡ä»¶ä¸­è·å– db æœåŠ¡ä¸­å®šä¹‰çš„ postgres db é•œåƒã€‚</p>
</blockquote>
</li>
<li><code>-p</code> æŒ‡å®šé¡¹ç›®å<blockquote>
<p>1ã€å¦‚æœä¸æŒ‡å®š <code>-p</code>,Compose é»˜è®¤ä½¿ç”¨å½“å‰æ–‡ä»¶å¤¹çš„åç§°ã€‚</p>
</blockquote>
</li>
<li>é…ç½®ç¯å¢ƒå˜é‡</li>
</ul>
<h3 id="docker-compose-CLI-ç¯å¢ƒå˜é‡"><a href="#docker-compose-CLI-ç¯å¢ƒå˜é‡" class="headerlink" title="docker-compose CLI ç¯å¢ƒå˜é‡"></a>docker-compose CLI ç¯å¢ƒå˜é‡</h3><p>é»˜è®¤å†…ç½®äº†å‡ ä¸ªç¯å¢ƒå˜é‡å¯ä»¥é…ç½® docker-compose.<br>ä»¥ <code>DOCKER_</code> å¼€å¤´çš„å˜é‡å’Œé…ç½® docker å‘½ä»¤è¡Œå®¢æˆ·ç«¯çš„å˜é‡ç±»ä¼¼ã€‚å¦‚æœä½¿ç”¨ <code>docker-machine</code>çš„è¯ï¼Œ<code>eval &quot;$(docker-machine env my-docker-vm)&quot;</code>å°†ä¸ºå˜é‡è®¾ç½®æ­£ç¡®çš„å€¼ã€‚</p>
<ul>
<li><code>COMPOSE_PROJECT_NAME</code><blockquote>
<p>1ã€è®¾ç½®é¡¹ç›®å.è¯¥å€¼åœ¨å¯åŠ¨æ—¶ä¼šä½œä¸ºå®¹å™¨æœåŠ¡çš„å‰ç¼€.æ¯”å¦‚é¡¹ç›®å myapp,åŒ…å«ä¸¤ä¸ªæœåŠ¡ db å’Œ web,é‚£ä¹ˆ Compose å¯åŠ¨çš„å®¹å™¨åä¸º myapp_db_1 å’Œ myapp_web_1.<br>2ã€é»˜è®¤æ—¶é¡¹ç›®æ–‡ä»¶å¤¹çš„æ ¹ç›®å½•åã€‚</p>
</blockquote>
</li>
<li><code>COMPOSE_FILE</code><blockquote>
<p>1ã€æŒ‡å®š Compose æ–‡ä»¶è·¯å¾„ã€‚å¦‚æœæœªæŒ‡å®šï¼ŒCompose å°†åœ¨å½“å‰æ–‡ä»¶å¤¹æŸ¥è¯¢ docker-compose.yml æ–‡ä»¶ï¼Œå¦‚æœä¸å­˜åœ¨å°†ç»§ç»­éå†çˆ¶ç›®å½•ç›´åˆ°æ‰¾åˆ°ã€‚<br>2ã€æ”¯æŒä½¿ç”¨æ–‡ä»¶è·¯å¾„åˆ†éš”ç¬¦(Linux &amp; MacOS [:] Windows [;]).æ¯”å¦‚ <code>COMPOSE_FILE=docker-compose.yml:docker-compose.prod.yml</code>,è·¯å¾„åˆ†éš”ç¬¦å¯ä»¥é€šè¿‡ <code>COMPOSE_PATH_SEPARATOR</code> è‡ªå®šä¹‰</p>
</blockquote>
</li>
<li><code>COMPOSE_API_VERSION</code><blockquote>
<p>1ã€Docker API ä»…æ”¯æŒæ¥è‡ªæŒ‡å®šç‰ˆæœ¬å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚ä½¿ç”¨ docker-compose æ—¶å‡ºç° <code>client and server don&#39;t have same version</code> é”™è¯¯ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡è®¾ç½®è¯¥å˜é‡è§£å†³ã€‚<br>2ã€è®¾ç½®è¯¥å˜é‡ä¸»è¦é’ˆå¯¹ä¸´æ—¶çš„è¿è¡Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç‰ˆæœ¬ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p>
</blockquote>
</li>
<li><code>DOCKER_HOST</code><blockquote>
<p>1ã€ä¸º docker daemon è®¾ç½® URL.å’Œ docker å®¢æˆ·ç«¯ä¸€æ ·ï¼Œé»˜è®¤ä¸º <code>unix:///var/run/docker.sock</code></p>
</blockquote>
</li>
<li><code>DOCKER_TLS_VERIFY</code><blockquote>
<p>1ã€è®¾ç½®ç©ºå­—ç¬¦ä»¥å¤–çš„ä»»ä½•å€¼æ—¶ï¼Œå¼€å¯ TLS.</p>
</blockquote>
</li>
<li><code>DOCKER_CERT_PATH</code><blockquote>
<p>1ã€é…ç½® <code>ca.pem,cert.pem,key.pem</code> çš„è·¯å¾„ã€‚é»˜è®¤ <code>~/.docker</code></p>
</blockquote>
</li>
<li><code>COMPOSE_HTTP_TIMEOUT</code><blockquote>
<p>1ã€è¶…æ—¶æ—¶é—´(ç§’).é»˜è®¤ 60s</p>
</blockquote>
</li>
<li><code>COMPOSE_TLS_VERSION</code><blockquote>
<p>1ã€TLS ç‰ˆæœ¬.é»˜è®¤ TLSv1. å¯ä¾›é€‰é¡¹ TLSv1, TLSv1_1, TLSv1_2</p>
</blockquote>
</li>
<li><code>COMPOSE_CONVERT_WINDOWS_PATH</code><blockquote>
<p>1ã€æ˜¯å¦å¼€å¯æŠŠ Windos-style çš„è·¯å¾„è½¬ä¸º Unix-style çš„å·å®šä¹‰ã€‚åœ¨ Windos ä¸Šä½¿ç”¨ Docker Machine å’Œ Docker Toolbox æ—¶æ€»æ˜¯è¦è®¾ç½®è¯¥å˜é‡ã€‚é»˜è®¤ 0ã€‚ true/1 ä»£è¡¨å¼€å¯ï¼Œfalse/0 ä»£è¡¨å…³é—­.</p>
</blockquote>
</li>
<li><code>COMPOSE_PATH_SEPARATOR</code><blockquote>
<p>1ã€å¦‚æœè®¾ç½®ï¼ŒCOMPOSE_FILE å€¼å°†ä½¿ç”¨æ­¤å¤„çš„å®šä¹‰ä½œä¸ºåˆ†éš”ç¬¦ã€‚</p>
</blockquote>
</li>
<li><code>COMPOSE_FORCE_WINDOWS_HOST</code><blockquote>
<p>1ã€å¦‚æœè®¾ç½®ï¼Œå³ä½¿ Compose è¿è¡Œåœ¨ Unix-based ç³»ç»Ÿä¸Šï¼Œå·å®šä¹‰ä¹Ÿå°†ä½¿ç”¨ç®€ç•¥è¯­æ³•è§£æä¸ºå‡è®¾è¿è¡Œåœ¨ Windows ä¸Šçš„è·¯å¾„ã€‚true/a,false/0</p>
</blockquote>
</li>
<li><code>COMPOSE_IGNORE_ORPHANS</code><blockquote>
<p>1ã€å¦‚æœè®¾ç½®ï¼ŒCompose ä¸ä¼šè¯•ç€å¯¹é¡¹ç›®çš„å•ç‹¬å®¹å™¨æ£€æµ‹ã€‚true/1,false/0</p>
</blockquote>
</li>
<li><code>COMPOSE_PARALLEL_LIMIT</code><blockquote>
<p>1ã€å¹¶è¡Œæ‰§è¡Œçš„é™åˆ¶ã€‚é»˜è®¤ 64ï¼Œç»ä¸èƒ½ä½äº 2.</p>
</blockquote>
</li>
<li><code>COMPOSE_INTERACTIVE_NO_CLI</code><blockquote>
<p>1ã€å¦‚æœè®¾ç½®ï¼ŒCompose ä¸ä¼šå°è¯•ä½¿ç”¨ Docker CLI å’Œ run exec æ“ä½œäº¤äº’ã€‚true/1,false/0</p>
</blockquote>
</li>
</ul>
<h3 id="Compose-file"><a href="#Compose-file" class="headerlink" title="Compose file"></a>Compose file</h3><h4 id="version-3"><a href="#version-3" class="headerlink" title="version 3"></a>version 3</h4><h5 id="build"><a href="#build" class="headerlink" title="build"></a>build</h5><p>é…ç½®é€‰é¡¹åœ¨ç¼–è¯‘æœŸç”Ÿæ•ˆã€‚<br>build å¯ä»¥æŒ‡å®šä¸€ä¸ªè·¯å¾„</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  webapp:</span></span><br><span class="line"><span class="attr">    build:</span> <span class="string">./dir</span></span><br></pre></td></tr></table></figure>

<p>æˆ–è€…æ˜¯ä¸€ä¸ªåœ¨æŒ‡å®š context ä¸‹çš„è·¯å¾„å¯¹è±¡ï¼ŒåŒæ—¶å¯åŒ…å« Dockerfile å’Œ args</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  webapp:</span></span><br><span class="line"><span class="attr">    build:</span></span><br><span class="line"><span class="attr">      context:</span> <span class="string">./dir</span></span><br><span class="line"><span class="attr">      dockerfile:</span> <span class="string">Dockerfile-alternate</span></span><br><span class="line"><span class="attr">      args:</span></span><br><span class="line"><span class="attr">        buildno:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœåŒæ—¶ä¹ŸæŒ‡å®šäº† image,Compose ä½¿ç”¨ webapp å’Œ image ä¸­æŒ‡å®šçš„å¯é€‰çš„ tag å‘½åæœ€ç»ˆç”Ÿæˆçš„é•œåƒå</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">build:</span> <span class="string">./dir</span></span><br><span class="line"><span class="attr">image:</span> <span class="attr">webapp:tag</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>swarm mode ä¸æ”¯æŒã€‚docker stack å‘½ä»¤åªæ¥å—é¢„ç¼–è¯‘çš„é•œåƒ.</p>
</blockquote>
<h6 id="CONTEXT"><a href="#CONTEXT" class="headerlink" title="CONTEXT"></a>CONTEXT</h6><p>å¯ä»¥æ˜¯åŒ…å« Dockerfile æ–‡ä»¶çš„è·¯å¾„ï¼Œæˆ– git ä»“åº“çš„ url.<br>å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œé‚£ä¹ˆè¢«è§£æä¸ºç›¸å¯¹äºå½“å‰ Compose æ–‡ä»¶çš„è·¯å¾„ã€‚æ­¤æ–‡ä»¶å¤¹åŒæ—¶ä¹Ÿæ˜¯å‘é€åˆ° Docker daemon çš„ç¼–è¯‘ä¸Šä¸‹æ–‡ã€‚</p>
<h6 id="DOCKERFILE"><a href="#DOCKERFILE" class="headerlink" title="DOCKERFILE"></a>DOCKERFILE</h6><p>å¯é€‰<br>æ­¤å¤„å¿…é¡»æŒ‡å®šç¼–è¯‘è·¯å¾„</p>
<h6 id="ARGS"><a href="#ARGS" class="headerlink" title="ARGS"></a>ARGS</h6><p>åªæœ‰åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å¯è®¿é—®çš„ç¯å¢ƒå˜é‡ã€‚<br>é¦–å…ˆï¼Œåœ¨ Dokcerfile ä¸­æŒ‡å®šå‚æ•°:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">ARG</span> <span class="string">buildno</span></span><br><span class="line"><span class="string">ARG</span> <span class="string">gitcommithash</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">echo</span> <span class="string">"Build number: $buildno"</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">echo</span> <span class="string">"Bashed on commit: $gitcommithash"</span></span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨ build ä¸‹ç»™è¯¥å‚æ•°å¤åˆ¶ï¼ˆå¯ä»¥æ˜¯é”®å€¼å¯¹åˆ—è¡¨ï¼‰ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line"><span class="attr">  context:</span> <span class="string">.</span></span><br><span class="line"><span class="attr">  args:</span></span><br><span class="line"><span class="attr">    buildno:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    gitcommithash:</span> <span class="string">cdc3b19</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line"><span class="attr">  context:</span> <span class="string">.</span></span><br><span class="line"><span class="attr">  args:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">buildno=1</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">gitcommithash=cdc3b19</span></span><br></pre></td></tr></table></figure>

<p>ä½ ä¹Ÿå¯ä»¥ä¸æŒ‡å®šå€¼ï¼Œå®ƒçš„å€¼å°±æ˜¯ç¼–è¯‘æ—¶ Compose å½“å‰è¿è¡Œç¯å¢ƒçš„å€¼.</p>
<blockquote>
<p>YAML å¸ƒå°”å€¼(true,false,yes,no,on,off)åº”è¯¥ä½¿ç”¨å¼•å·åº”ç”¨ï¼Œè¿™æ ·è§£æå™¨æ‰èƒ½æŠŠå®ƒä»¬è§£æä¸º string</p>
</blockquote>
<h6 id="CACHE-FROM"><a href="#CACHE-FROM" class="headerlink" title="CACHE_FROM"></a>CACHE_FROM</h6><blockquote>
<p>v3.2+</p>
</blockquote>
<p>æŒ‡å®š engine å¯ä»¥ç¼“å­˜çš„é•œåƒåˆ—è¡¨</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line"><span class="attr">  context:</span> <span class="string">.</span></span><br><span class="line"><span class="attr">  cache_from:</span></span><br><span class="line"><span class="attr">    - alpine:</span><span class="string">latest</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">corp/webapp:3.14</span></span><br></pre></td></tr></table></figure>

<h6 id="LABELS"><a href="#LABELS" class="headerlink" title="LABELS"></a>LABELS</h6><blockquote>
<p>v3.3+</p>
</blockquote>
<p>å‘ç”Ÿæˆçš„é•œåƒæ·»åŠ å…ƒæ•°æ®ã€‚å¯ä»¥æ˜¯æ•°ç»„æˆ–ç›®å½•<br>æ¨èä½¿ç”¨åå‘ DNS æ ‡è®°ä»¥é¿å…å’Œå…¶ä»–è½¯ä»¶å†²çª</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line"><span class="attr">  context:</span> <span class="string">.</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">com.example.description:</span> <span class="string">"Accounting webapp"</span></span><br><span class="line">    <span class="string">com.example.department:</span> <span class="string">"Finance"</span></span><br><span class="line">    <span class="string">com.example.label-with-empty-value:</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line"><span class="attr">  context:</span> <span class="string">.</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"com.example.description=Accounting webapp"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"com.example.department=Finance"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"com.example.label-with-empty-value"</span></span><br></pre></td></tr></table></figure>

<h6 id="SHM-SIZE"><a href="#SHM-SIZE" class="headerlink" title="SHM_SIZE"></a>SHM_SIZE</h6><blockquote>
<p>v3.5+</p>
</blockquote>
<p>è®¾ç½®ç¼–è¯‘ç”Ÿæˆå®¹å™¨ <code>dev/shm&#39;</code> åˆ†åŒºå¤§å°ã€‚int å€¼å•ä½ä¸º byte. string å¯ä»¥æºå¸¦å•ä½</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line"><span class="attr">  context:</span> <span class="string">.</span></span><br><span class="line"><span class="attr">  shm_size:</span> <span class="string">'2gb'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line"><span class="attr">  context:</span> <span class="string">.</span></span><br><span class="line"><span class="attr">  shm_size:</span> <span class="number">10000000</span></span><br></pre></td></tr></table></figure>

<h6 id="TARGET"><a href="#TARGET" class="headerlink" title="TARGET"></a>TARGET</h6><blockquote>
<p>v3.4+</p>
</blockquote>
<p>ç¼–è¯‘ Dockerfile ä¸­å®šä¹‰çš„æŒ‡å®šç‰ˆæœ¬</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line"><span class="attr">  context:</span> <span class="string">.</span></span><br><span class="line"><span class="attr">  target:</span> <span class="string">prod</span></span><br></pre></td></tr></table></figure>

<h5 id="cap-add-cap-drop"><a href="#cap-add-cap-drop" class="headerlink" title="cap_add,cap_drop"></a>cap_add,cap_drop</h5><p>æ·»åŠ æˆ–åˆ é™¤å®¹å™¨çš„å®¹é‡ã€‚<code>man 7 capabilities</code> æŸ¥çœ‹å¯ç”¨åˆ—è¡¨</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">cap_add:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ALL</span></span><br><span class="line"><span class="attr">cap_drop:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">NET_ADMIN</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">SYS_ADMIN</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>swarm mode æ— æ•ˆ</p>
</blockquote>
<h5 id="cgroup-parent"><a href="#cgroup-parent" class="headerlink" title="cgroup_parent"></a>cgroup_parent</h5><p>ä¸ºå®¹å™¨æŒ‡å®šå¯é€‰çš„ cgroup parent</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">cgroup_parent:</span> <span class="string">m-executor-abcd</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>swarm mode æ— æ•ˆ</p>
</blockquote>
<h5 id="command"><a href="#command" class="headerlink" title="command"></a>command</h5><p>è¦†ç›–é»˜è®¤çš„å‘½ä»¤</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">command:</span> <span class="string">bundle</span> <span class="string">exec</span> <span class="string">thin</span> <span class="bullet">-p</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥æ˜¯åˆ—è¡¨</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">command:</span> <span class="string">["bundle",</span> <span class="string">"exec"</span><span class="string">,</span> <span class="string">"thin"</span><span class="string">,</span> <span class="string">"-p"</span><span class="string">,</span> <span class="string">"3000"</span><span class="string">]</span></span><br></pre></td></tr></table></figure>

<h5 id="configs"><a href="#configs" class="headerlink" title="configs"></a>configs</h5><h3 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h3><ul>
<li>å…±äº«æ–‡ä»¶å¤¹ï¼Œå·ï¼Œç»‘å®šæŒ‚è½½<blockquote>
<p>å¦‚æœä½ çš„é¡¹ç›®ä¸åœ¨ <code>Users</code>ç›®å½•(<code>cd ~</code>),é‚£ä¹ˆä½ éœ€è¦å…±äº«é©±åŠ¨å™¨æˆ– Dockerfile æ‰€åœ¨ä½ç½®å’Œå½“å‰æ­£åœ¨ä½¿ç”¨çš„å·ã€‚å¦‚æœå‡ºç°è¿è¡Œæ—¶é”™è¯¯è¡¨ç¤ºæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸€ä¸ªæŒ‚è½½å·çš„è¯·æ±‚è¢«æ‹’ç»ï¼Œæˆ–æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯•ç€å…±äº«æ–‡ä»¶æˆ–é©±åŠ¨ã€‚æŒ‚è½½å·è¦æ±‚å…±äº«é¡¹ç›®ä¸åœ¨ <code>C:\Users (Windows)</code>,æˆ– <code>/Users (Mac)</code> çš„é©±åŠ¨ï¼Œå¹¶ä¸”å¦‚æœæ˜¯è¿è¡Œåœ¨ <code>Dokcer Desktop for Windows</code> çš„ Linux å®¹å™¨ä¸Šçš„æ‰€æœ‰åº”ç”¨éƒ½éœ€è¦å…±äº«ã€‚</p>
</blockquote>
</li>
<li>å¦‚æœæ”¹å˜äº†ä¸€ä¸ªæœåŠ¡çš„ Dockerfile æˆ–è€…ç¼–è¯‘æ–‡ä»¶å¤¹é‡Œçš„å†…å®¹ï¼Œè¿è¡Œ <code>docker-compose build</code>é‡æ–°ç¼–è¯‘</li>
</ul>
<h3 id="å®˜æ–¹ç¤ºä¾‹"><a href="#å®˜æ–¹ç¤ºä¾‹" class="headerlink" title="å®˜æ–¹ç¤ºä¾‹"></a>å®˜æ–¹ç¤ºä¾‹</h3><h4 id="Compose-amp-WordPress"><a href="#Compose-amp-WordPress" class="headerlink" title="Compose &amp; WordPress"></a>Compose &amp; WordPress</h4><ul>
<li>ä¸ºé¡¹ç›®åˆ›å»ºç©ºæ–‡ä»¶å¤¹ã€‚è¯¥æ–‡ä»¶å¤¹ä½œä¸ºåº”ç”¨çš„ä¸Šä¸‹æ–‡ï¼Œä¸”åªä¿å­˜æ„å»ºé•œåƒæ‰€éœ€çš„èµ„æºã€‚</li>
<li>åˆ›å»º docker-compose.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3.3"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  db:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">mysql:5.7</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="attr">      - db_data:</span><span class="string">/var/lib/mysql</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      MYSQL_ROOT_PASSWORD:</span> <span class="string">somewordpress</span></span><br><span class="line"><span class="attr">      MYSQL_DATABASE:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">      MYSQL_USER:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">      MYSQL_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">  wordpress:</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">db</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">wordpress:latest</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"8000:80"</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      WORDPRESS_DB_HOST:</span> <span class="attr">db:3306</span></span><br><span class="line"><span class="attr">      WORDPRESS_DB_USER:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">      WORDPRESS_DB_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">      WORDPRESS_DB_NAME:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="attr">      db_data:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="comment"># db_data å·ä¼šä¿å­˜ä»»ä½• WordPress å¯¹æ•°æ®åº“çš„æ”¹å˜ã€‚</span></span><br><span class="line"><span class="comment"># WordPress é€šå¸¸å¼€æ”¾ 80 å’Œ 443 ç«¯å£.</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>docker-compose up -d</code>.<blockquote>
<p>å¦‚æœä½¿ç”¨ Docker Machine, é‚£ä¹ˆè¿è¡Œ <code>docker-machine ip MACHINE_VM</code> è·å–è¿è¡Œåœ°å€ã€‚å¦‚æœæ˜¯ destop ç‰ˆï¼Œ<a href="http://localhost" target="_blank" rel="noopener">http://localhost</a> å³å¯.</p>
</blockquote>
</li>
<li><code>docker-compose down</code> ç§»é™¤å®¹å™¨ï¼Œé»˜è®¤çš„ç½‘ç»œï¼Œä¿ç•™ WordPress å’Œæ•°æ®åº“ã€‚<code>docker-compose down --volumes</code> å…¨éƒ¨ç§»é™¤ã€‚</li>
</ul>
]]></content>
      <tags>
        <tag>docker</tag>
        <tag>å­¦ä¹ ç¬”è®°</tag>
      </tags>
  </entry>
  <entry>
    <title>Flutter desktop support</title>
    <url>/2020/02/18/Flutter-desktop-support/</url>
    <content><![CDATA[<p>å½“å‰ Flutter å¯¹æ¡Œé¢å¼€å‘ç¯å¢ƒçš„æ”¯æŒæ­£åœ¨å¼€å‘ä¸­.</p>
<a id="more"></a>
<h3 id="macOS"><a href="#macOS" class="headerlink" title="macOS"></a>macOS</h3><p>macOS æ˜¯å½“å‰æœ€æˆç†Ÿçš„æ¡Œé¢å¼€å‘å¹³å°(ä»… flutter è€Œè¨€),å·²ç»è¿›å…¥ alpha é˜¶æ®µ.</p>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>Windows shell å¤„äº technical preview.å½“å‰æ˜¯åŸºäº Win32 çš„,ä½†è®¡åˆ’åç»­æ¢ç´¢ UWP æ”¯æŒ.<br>æ³¨æ„:æœ€ç»ˆå®šå‹ç‰ˆæœ¬çš„ API å¯èƒ½å’Œå½“å‰æœ‰æ˜æ˜¾å·®å¼‚.</p>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>å½“å‰ Linux shell ä»…ä»…æ˜¯ GLFW çš„æ›¿ä»£å“,æ¥æ¢ç´¢ Linux æ¡Œé¢å®ç°,æœªæ¥å¯èƒ½ä¼šè¢«æ›¿æ¢æˆå…¶ä»–å®ç°.<br>å°†æ¥ä½ çš„åº”ç”¨æ— è®ºæ˜¯ä½¿ç”¨ GTK+,Qt,WxWidgets,Motif æˆ–å…¶ä»–ä»»æ„å¼€å‘å·¥å…·å¥—ä»¶éƒ½å¯ä»¥é€šè¿‡ Flutter æ¥åˆ›å»º library,ä½†æ˜¯å½“å‰è¿˜æ²¡æƒ³å¥½å¦‚ä½•è§„åˆ’.å½“å‰è®¡åˆ’å…ˆæ— æ¡ä»¶æ”¯æŒ GTK+,ç„¶åæ…¢æ…¢æ”¯æŒå…¶ä»–.</p>
<h2 id="å‘½ä»¤"><a href="#å‘½ä»¤" class="headerlink" title="å‘½ä»¤"></a>å‘½ä»¤</h2><h3 id="create"><a href="#create" class="headerlink" title="create"></a><code>create</code></h3><p>å½“å‰,åªæœ‰ macOS æ”¯æŒ<code>flutter create</code>.å¯¹äº Windows å’Œ Linux,æ¨èå‚è€ƒ <code>flutter-desktop-embedding project</code>.</p>
<h4 id="è¦†ç›–ç›®æ ‡å¹³å°"><a href="#è¦†ç›–ç›®æ ‡å¹³å°" class="headerlink" title="è¦†ç›–ç›®æ ‡å¹³å°"></a>è¦†ç›–ç›®æ ‡å¹³å°</h4><p>å¤§éƒ¨åˆ†åº”ç”¨éœ€è¦è¦†ç›–æ”¯æŒçš„åº”ç”¨å¹³å°å¯¹åº”çš„å€¼ï¼Œå¦åˆ™ä¼šå‡ºç°<code>Unknown platform</code> å¼‚å¸¸.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import &#39;package:flutter&#x2F;foundation.dart&#39; show debugDefaultTargetPlatformOverride;</span><br><span class="line"></span><br><span class="line">void _setTargetPlatformForDesktop() &#123;</span><br><span class="line">    if (Platform.isLiinux || Platform.isWindows) &#123;</span><br><span class="line">        debugDefaultTargetPlatformOverride &#x3D; TargetPlatform.fuchsia;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main()&#123;</span><br><span class="line">    _setTargetPlatformForDesktop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>Termux åŸç†æ¢ç©¶</title>
    <url>/2020/03/31/Termux-%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/</url>
    <content><![CDATA[<p>è¯¦ç»†ä»‹ç»è¯·ç§»æ­¥: <a href="https://termux.com/" target="_blank" rel="noopener">å®˜ç½‘</a>,<a href="http://www.termux.cn/" target="_blank" rel="noopener">ä¸­æ–‡é•œåƒ</a>,<a href="https://mirror.tuna.tsinghua.edu.cn/help/termux/" target="_blank" rel="noopener">æ¸…åæº</a></p>
<a id="more"></a>
<h3 id="æºç æ¢ç©¶"><a href="#æºç æ¢ç©¶" class="headerlink" title="æºç æ¢ç©¶"></a>æºç æ¢ç©¶</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">create_subprocess</span><span class="params">(JNIEnv* env,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">char</span> <span class="keyword">const</span>* cmd,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">char</span> <span class="keyword">const</span>* cwd,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">char</span>* <span class="keyword">const</span> argv[],</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">char</span>** envp,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span>* pProcessId,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint rows,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint columns)</span></span></span><br></pre></td></tr></table></figure>
<p>æ­¤æ–¹æ³•å³ä¸º termux çš„æ ¸å¿ƒ,é€šè¿‡è¯¥æ–¹æ³•å°†ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤å’Œå½“å‰å·¥ä½œçš„æ–‡ä»¶å¤¹ä¼ å…¥æ‰“å¼€çš„ç»ˆç«¯å»æ‰§è¡Œ.</p>
<p>1ã€æ‰“å¼€ä¼ªç»ˆç«¯</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> ptm = open(<span class="string">"/dev/ptmx"</span>, O_RDWR | O_CLOEXEC);</span><br><span class="line"><span class="keyword">if</span> (ptm &lt; <span class="number">0</span>) <span class="keyword">return</span> throw_runtime_exception(env, <span class="string">"Cannot open /dev/ptmx"</span>);</span><br><span class="line"><span class="comment">// UNIX98 çš„ä¼ªç»ˆç«¯æ¨¡å¼.</span></span><br><span class="line"><span class="comment">// pts(pseudo-terminal slave)/ptmx(pseudo-terminal master) ç»“åˆä½¿ç”¨å³å¯å®ç° pty(pseudo-tty).</span></span><br><span class="line"><span class="comment">// pts/ptmx æ˜¯æˆå †çš„é€»è¾‘ç»ˆç«¯è®¾å¤‡(å¯¹ master çš„æ“ä½œä¼šæ˜ å°„åˆ° slave ä¸Š).</span></span><br></pre></td></tr></table></figure>

<p>2ã€åˆå§‹åŒ–è®¾ç½®</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LACKS_PTSNAME_R</span></span><br><span class="line">    <span class="keyword">char</span>* devname;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">char</span> devname[<span class="number">64</span>];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// grantpt åœ¨ä¼ªç»ˆç«¯ slave è®¾å¤‡å¯è¢«ä½¿ç”¨ä¹‹å‰è®¾ç½®æƒé™,ä½¿åº”ç”¨ç¨‹åºå¯ä»¥è®¿é—®å®ƒ.</span></span><br><span class="line">    <span class="comment">// æŠŠè®¾å¤‡èŠ‚ç‚¹çš„ userid è®¾ç½®ä¸ºè°ƒç”¨è€…çš„å®é™… userid, groupid ä¸ºä¸€éæŒ‡å®šå€¼,é€šå¸¸å¯ä»¥æ˜¯è®¿é—®è¯¥ç»ˆç«¯è®¾å¤‡çš„ç»„.</span></span><br><span class="line">    <span class="comment">// å°†æƒé™è®¾ä¸º: å¯¹å•ä¸ªæ‰€æœ‰è€…æ˜¯è¯»å†™,å¯¹ç»„æ‰€æœ‰è€…æ˜¯å†™(0620).</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// unlockpt ç”¨äºå‡†äºˆå¯¹ä¼ªç»ˆç«¯ slave è®¾å¤‡çš„è®¿é—®,ä»è€Œå…è®¸åº”ç”¨æ‰“å¼€è¯¥è®¾å¤‡.</span></span><br><span class="line">    <span class="comment">// å¯ä»¥é˜»æ­¢å…¶ä»–è¿›ç¨‹æ‰“å¼€è¯¥è®¾å¤‡,ä½¿å¾—å»ºç«‹è¯¥è®¾å¤‡çš„åº”ç”¨ç¨‹åºæœ‰æœºä¼šåœ¨ä½¿ç”¨masterã€slave è®¾å¤‡ä¹‹å‰æ­£ç¡®çš„åˆå§‹åŒ–è¿™äº›è®¾å¤‡.</span></span><br><span class="line"><span class="keyword">if</span> (grantpt(ptm) || unlockpt(ptm) ||</span><br><span class="line">#ifdef LACKS_PTSNAME_R </span><br><span class="line">            <span class="comment">// åœ¨ç»™å®šä¼ªç»ˆç«¯ master çš„è®¾å¤‡æ–‡ä»¶ç¬¦æ—¶,æ‰¾åˆ°å¯¹åº” slave è®¾å¤‡çš„è·¯å¾„å.</span></span><br><span class="line">            <span class="comment">// å¦‚æœæˆåŠŸ,ä¼šåœ¨ä¸€ä¸ªé™æ€å­˜å‚¨åŒºå­˜æ”¾è®¾å¤‡åç§°å¹¶è¿”å›å…¶åœ°å€,å¦åˆ™ NULL.</span></span><br><span class="line">            <span class="comment">// include &lt;stdlib.h&gt;</span></span><br><span class="line">            <span class="comment">// è¿”å›æŒ‡é’ˆä¸èƒ½è¢«è°ƒç”¨è¿›ç¨‹é‡Šæ”¾.</span></span><br><span class="line">            (devname = ptsname(ptm)) == <span class="literal">NULL</span></span><br><span class="line">#<span class="keyword">else</span>       </span><br><span class="line">            <span class="comment">// å¯é‡å…¥ç‰ˆæœ¬.</span></span><br><span class="line">            ptsname_r(ptm, devname, <span class="keyword">sizeof</span>(devname))</span><br><span class="line">#endif</span><br><span class="line">       ) &#123;</span><br><span class="line">        <span class="keyword">return</span> throw_runtime_exception(env, <span class="string">"Cannot grantpt()/unlockpt()/ptsname_r() on /dev/ptmx"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Enable UTF-8 mode and disable flow control to prevent Ctrl+S from locking up the display.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">tios</span>;</span></span><br><span class="line"><span class="comment">// è¿”å› ptm å¯¹åº”ä¼ªç»ˆç«¯çš„å±æ€§.</span></span><br><span class="line">tcgetattr(ptm, &amp;tios);</span><br><span class="line"><span class="comment">// tcgetattr(STDIN_FILENO,&amp;ts); STDIN_FILENO å€¼ä¸º1,è¡¨ç¤ºæ ‡å‡†è¾“å…¥çš„æ–‡ä»¶å–µè¾“å…¥.</span></span><br><span class="line">tios.c_iflag |= IUTF8;</span><br><span class="line">tios.c_iflag &amp;= ~(IXON | IXOFF); <span class="comment">// å…³é—­è¾“å…¥æ—¶å¯¹ XON/XOFFæµè¿›è¡Œæ§åˆ¶</span></span><br><span class="line">tcsetattr(ptm, TCSANOW, &amp;tios); </span><br><span class="line"><span class="comment">// TCSANOW: ç«‹å³ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="comment">// TCSADRAIN: åœ¨æ‰€æœ‰å†™å…¥ fd çš„è¾“å‡ºè¢«ä¼ è¾“åç”Ÿæ•ˆ.å»ºè®®åœ¨ä¿®æ”¹è¾“å‡ºå‚æ•°æ—¶ä½¿ç”¨.</span></span><br><span class="line"><span class="comment">// TCSAFLUSH: åœ¨æ‰€æœ‰å†™å…¥ fd åº”ç”¨å¯¹è±¡çš„è¾“å‡ºéƒ½è¢«ä¼ è¾“åç”Ÿæ•ˆ,æ‰€æœ‰å·²æ¥å—ä½†æœªè¯»å…¥çš„è¾“å…¥éƒ½åœ¨æ”¹å˜ç”Ÿæ•ˆå‰è¢«ä¸¢å¼ƒ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®åˆå§‹åŒ–çª—å£å¤§å°</span></span><br><span class="line"><span class="comment">// include &lt;termios.h&gt;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">sz</span> = &#123;</span> .ws_row = (<span class="keyword">unsigned</span> <span class="keyword">short</span>) rows, .ws_col = (<span class="keyword">unsigned</span> <span class="keyword">short</span>) columns &#125;;</span><br><span class="line">ioctl(ptm, TIOCSWINSZ, &amp;sz); <span class="comment">// è·å– winsize å€¼</span></span><br><span class="line"><span class="comment">// ioctl TIOCSWINSZ å‘½ä»¤ä¹Ÿå¯å°†æ­¤ç»“æ„çš„æ–°å€¼å­˜æ”¾åˆ°å†…æ ¸ä¸­ã€‚å¦‚æœæ­¤æ–°å€¼å’Œå­˜æ”¾åœ¨å†…æ ¸ä¸­çš„å½“å‰å€¼ä¸åŒ,åˆ™å‘å‰å°è¿›ç¨‹ç»„å‘é€ SIGWINCH ä¿¡å·.</span></span><br><span class="line"><span class="comment">// ioctl(STDIN_FILENO,TIOCGWINSZ,&amp;wz);</span></span><br></pre></td></tr></table></figure>

<p>3ã€åˆ›å»ºæ–°è¿›ç¨‹</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">pid_t</span> pid = fork();</span><br><span class="line"><span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> throw_runtime_exception(env, <span class="string">"Fork failed"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// å½“å‰è¿›ç¨‹</span></span><br><span class="line">    *pProcessId = (<span class="keyword">int</span>) pid;</span><br><span class="line">    <span class="keyword">return</span> ptm;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Clear signals which the Android java process may have blocked:</span></span><br><span class="line">    <span class="keyword">sigset_t</span> signals_to_unblock;</span><br><span class="line">    sigfillset(&amp;signals_to_unblock); <span class="comment">// åˆå§‹åŒ– signals_to_unblock,ç„¶åå°†æ‰€æœ‰çš„ä¿¡å·åŠ å…¥æ­¤ä¿¡å·é›†.</span></span><br><span class="line">    sigprocmask(SIG_UNBLOCK, &amp;signals_to_unblock, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// SIG_BLOCK: å°†å‚æ•°äºŒä¸­çš„ä¿¡å·æ·»åŠ åˆ°ä¿¡å·å±è”½å­—ä¸­</span></span><br><span class="line">    <span class="comment">// SIG_SETMASK: å°†ä¿¡å·å±è”½å­—è®¾ç½®ä¸ºå‚æ•°äºŒä¸­ä¿¡å·</span></span><br><span class="line">    <span class="comment">// SIG_UNBLOCK: ä»ä¿¡å·å±è”½å­—ä¸­åˆ é™¤å‚æ•°äºŒä¸­çš„ä¿¡å·.</span></span><br><span class="line"></span><br><span class="line">    close(ptm);</span><br><span class="line">    setsid();</span><br><span class="line">    <span class="comment">// å­è¿›ç¨‹ä»çˆ¶è¿›ç¨‹ç»§æ‰¿äº†: SessionID, process GroupID å’Œæ‰“å¼€çš„ç»ˆç«¯</span></span><br><span class="line">    <span class="comment">// setsid å¸®åŠ©å­è¿›ç¨‹è„±ç¦»çˆ¶è¿›ç¨‹ç»§æ‰¿çš„å±æ€§.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pts = open(devname, O_RDWR); <span class="comment">// æ‰“å¼€ä¼ªç»ˆç«¯ slave è®¾å¤‡.</span></span><br><span class="line">    <span class="keyword">if</span> (pts &lt; <span class="number">0</span>) <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    dup2(pts, <span class="number">0</span>);</span><br><span class="line">    dup2(pts, <span class="number">1</span>);</span><br><span class="line">    dup2(pts, <span class="number">2</span>);</span><br><span class="line">    <span class="comment">// ä¸€èˆ¬ä¸€ä¸ªè¿›ç¨‹ä¼šæœ‰3ä¸ªæ–‡ä»¶æè¿°ç¬¦å­˜åœ¨(0,1,2)0 -&gt; è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥,1 -&gt; è¿›ç¨‹çš„æ ‡å‡†è¾“å‡º,2 -&gt; è¿›ç¨‹çš„æ ‡å‡†é”™è¯¯è¾“å‡º.</span></span><br><span class="line">    <span class="comment">// int dup(int oldfd); </span></span><br><span class="line">    <span class="comment">// å†…æ ¸åœ¨è¿›ç¨‹åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦,æ­¤æè¿°ç¬¦æ˜¯å½“å‰å¯ç”¨æ–‡ä»¶æè¿°ç¬¦çš„æœ€å°æ•°å€¼,æŒ‡å‘ oldfd æ‰€æ‹¥æœ‰çš„æ–‡ä»¶è¡¨é¡¹.</span></span><br><span class="line">    <span class="comment">// int dup2(int oldfd,int newfd); </span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨newfd æŒ‡å®šæ–°æè¿°ç¬¦çš„æ•°å€¼,å¦‚æœ newfd å·²ç»æ‰“å¼€,å…ˆå°†å…¶å…³é—­.å¦‚æœ newfd ç­‰äº oldfd,åˆ™è¿”å› newfd,ä¸å…³é—­å®ƒ.</span></span><br><span class="line"></span><br><span class="line">    DIR* self_dir = opendir(<span class="string">"/proc/self/fd"</span>); <span class="comment">// å½“å‰è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (self_dir != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> self_dir_fd = dirfd(self_dir); <span class="comment">// æŠŠ DIR* è½¬ä¸ºæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span>* <span class="title">entry</span>;</span></span><br><span class="line">        <span class="keyword">while</span> ((entry = readdir(self_dir)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> fd = atoi(entry-&gt;d_name);</span><br><span class="line">            <span class="keyword">if</span>(fd &gt; <span class="number">2</span> &amp;&amp; fd != self_dir_fd) close(fd); <span class="comment">// å…³é—­æ‰“å¼€çš„æ–‡ä»¶</span></span><br><span class="line">        &#125;</span><br><span class="line">        closedir(self_dir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clearenv(); <span class="comment">// åˆ é™¤ç¯å¢ƒè¡¨ä¸­æ‰€æœ‰çš„ç¯å¢ƒå˜é‡</span></span><br><span class="line">    <span class="comment">// getenv() æŒ‰ç¯å¢ƒå˜é‡çš„åç§°å–å¾—ç¯å¢ƒå˜é‡çš„å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (envp) <span class="keyword">for</span> (; *envp; ++envp) putenv(*envp); <span class="comment">// å°†ä¼ è¿›æ¥çš„ç¯å¢ƒå˜é‡è®¾ä¸ºå½“å‰ç¯å¢ƒå˜é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (chdir(cwd) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span>* error_message;</span><br><span class="line">        <span class="comment">// No need to free asprintf()-allocated memory since doing execvp() or exit() below.</span></span><br><span class="line">        <span class="keyword">if</span> (asprintf(&amp;error_message, <span class="string">"chdir(\"%s\")"</span>, cwd) == <span class="number">-1</span>) error_message = <span class="string">"chdir()"</span>;</span><br><span class="line">        perror(error_message);</span><br><span class="line">        fflush(<span class="built_in">stderr</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä» PATH ç¯å¢ƒå˜é‡æ‰€å€¼çš„ç›®å½•ä¸­æŸ¥æ‰¾ç¬¦åˆå‚æ•° cmd çš„æ–‡ä»¶å,æ‰¾åˆ°åä¾¿æ‰§è¡Œè¯¥æ–‡ä»¶,ç„¶åå°†ç¬¬äºŒä¸ªå‚æ•° argv ä¼ ç»™æ­¤æ–‡ä»¶.</span></span><br><span class="line">    <span class="comment">// æˆåŠŸæ— è¿”å›ï¼Œå¤±è´¥è¿”å› -1,å¤±è´¥åŸå› å­˜äº errno ä¸­.</span></span><br><span class="line">    execvp(cmd, argv);</span><br><span class="line">    <span class="comment">// Show terminal output about failing exec() call:</span></span><br><span class="line">    <span class="keyword">char</span>* error_message;</span><br><span class="line">    <span class="keyword">if</span> (asprintf(&amp;error_message, <span class="string">"exec(\"%s\")"</span>, cmd) == <span class="number">-1</span>) error_message = <span class="string">"exec()"</span>;</span><br><span class="line">    perror(error_message);</span><br><span class="line">    _exit(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸º termux çš„ä¸»ç•Œé¢æ˜¯ä¸€ä¸ª psuedo terminal,æ‰€ä»¥ç¬¬ä¸€æ­¥å…ˆå»ºç«‹ä¼ªç»ˆç«¯è®¾å¤‡,ç„¶ååˆ›å»ºå½“å‰è¿›ç¨‹çš„å­è¿›ç¨‹å»æ‰§è¡Œå‘½ä»¤.å› æ­¤,termux èƒ½è®¿é—®çš„å°±åªèƒ½ termux app ç§æœ‰æ–‡ä»¶ç›®å½•åŠ SD å¡å…¬å¼€ç›®å½•(éœ€è¦ç‰¹æ®Šå‘½ä»¤æ”¯æŒ)</p>
]]></content>
  </entry>
  <entry>
    <title>libgit2 androidäº¤å‰ç¼–è¯‘</title>
    <url>/2020/04/25/libgit2-android%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91/</url>
    <content><![CDATA[<p>libgit2 æ˜¯ä¸€ä¸ªè·¨å¹³å°ã€å¯åœ¨è‡ªå·±åº”ç”¨ä¸­é“¾æ¥çš„ git å®ç°åº“.</p>
<a id="more"></a>
<p><code>libgit2</code>æ˜¯ä¸€ä¸ªä¾¿æºã€çº¯Cå®ç° git æ ¸å¿ƒåŠŸèƒ½çš„ä¾èµ–åº“.å½“å‰å·²ç»å®ç°äº†å¤šç§è¯­è¨€ç»‘å®š,å¦‚ <code>Rugged(Ruby)</code>ã€<code>LibGit2Sharp(.NET)</code>ã€<code>pygit2(Python)</code>ã€<code>NodeGit(Node)</code>ç­‰.</p>
<p>git GUI å®¢æˆ·ç«¯å¦‚ <code>GitKraken</code> å’Œ <code>gmaster</code>,git æ‰˜ç®¡å¹³å°å¦‚ <code>GitHub</code>,<code>GitLab</code>å’Œ<code>Azure DevOps</code>éƒ½æ˜¯åŸºäºæ­¤å®ç°çš„.æ¯ä¸€æ¬¡<code>merge pull request</code> éƒ½æ˜¯é€šè¿‡ libgit2 æ¥å®ç°çš„.</p>
<p>æœ€è¿‘ libgit2 åˆšåˆšæ”¾å‡º 1.0 ç‰ˆæœ¬,é‚£ä¹ˆå…ˆæ¥ä¸ª android äº¤å‰ç¼–è¯‘å§.</p>
<h4 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h4><pre><code>macos 
NDKr21</code></pre><h4 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h4><p>1ã€ä¸‹è½½æºç </p>
<pre><code>`git clone git@github.com:libgit2/libgit2.git`</code></pre><p>2ã€é…ç½® openSSL(å¯è·³è¿‡)</p>
<pre><code>å› ä¸º libgit2 æ”¯æŒ openSSL,æ‰€ä»¥å…ˆç¼–è¯‘ openSSL.
ä¸‹è½½æºç ,configure/make å³å¯</code></pre><p>3ã€é…ç½®å·¥å…·é“¾</p>
<ul>
<li><p>åœ¨ NDKr21 ä¸­,å·²ç»å°†å„ä¸ªæ¶æ„ã€å„ä¸ªAPIçš„å·¥å…·é¢„ç¼–è¯‘å¥½äº†,ä¸ç”¨å†å¦‚ README æ‰€è¯´(é€šè¿‡ make-standalone-toolchain.sh è„šæœ¬æ¥å‡†å¤‡äº†).</p>
</li>
<li><p>åœ¨é¡¹ç›®æ ¹ç›®å½•(éšæ„) æ·»åŠ  CMakeLists.android.txt(åç§°éšæ„).</p>
</li>
</ul>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SET</span>(CMAKE_SYSTEM_NAME Linux)</span><br><span class="line"><span class="keyword">SET</span>(CMAKE_SYSTEM_VERSION Android)</span><br><span class="line"><span class="keyword">SET</span>(NDK_HOME /Users/aka/Library/Android/sdk/ndk/<span class="number">21.0</span>.<span class="number">6113669</span>/)</span><br><span class="line"><span class="keyword">SET</span>(OPENSSL_DYHOME /Users/aka/Downloads/source/openssl)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span>(CMAKE_C_COMPILER <span class="variable">$&#123;NDK_HOME&#125;</span>toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android21-clang)</span><br><span class="line"><span class="keyword">SET</span>(CMAKE_CXX_COMPILER <span class="variable">$&#123;NDK_HOME&#125;</span>toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android21-clang++)</span><br><span class="line"><span class="keyword">SET</span>(CMAKE_FIND_ROOT_PATH <span class="variable">$&#123;NDK_HOME&#125;</span>toolchains/llvm/prebuilt/darwin-x86_64/sysroot)</span><br><span class="line"><span class="keyword">SET</span>(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)</span><br><span class="line"><span class="keyword">SET</span>(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)</span><br><span class="line"><span class="keyword">SET</span>(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)</span><br><span class="line"><span class="keyword">SET</span>(OPENSSL_ROOT_DIR <span class="variable">$&#123;OPENSSL_DYHOME&#125;</span>)</span><br><span class="line"><span class="keyword">SET</span>(OPENSSL_INCLUDE_DIR <span class="variable">$&#123;OPENSSL_DYHOME&#125;</span>/<span class="keyword">include</span>)</span><br><span class="line"><span class="keyword">SET</span>(OPENSSL_CRYPTO_LIBRARY <span class="variable">$&#123;OPENSSL_DYHOME&#125;</span>/libcrypto.so)</span><br><span class="line"><span class="keyword">SET</span>(OPENSSL_SSL_LIBRARY <span class="variable">$&#123;OPENSSL_DYHOME&#125;</span>/libssl.so)</span><br><span class="line"><span class="keyword">add_definitions</span>(<span class="string">"--sysroot=$&#123;CMAKE_FIND_ROOT_PATH&#125;"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>mkdir build &amp;&amp; cd build</code></li>
<li><code>cmake -DCMAKE_TOOLCHAIN_FILE=../CMakeLists.android.txt</code></li>
<li><code>cmake --build .</code></li>
</ul>
<p>4ã€å¤§åŠŸå‘Šæˆ!</p>
<h3 id="çº¦å®šä¿—æˆ"><a href="#çº¦å®šä¿—æˆ" class="headerlink" title="çº¦å®šä¿—æˆ"></a>çº¦å®šä¿—æˆ</h3><h4 id="å…¬å¼€-API"><a href="#å…¬å¼€-API" class="headerlink" title="å…¬å¼€ API"></a>å…¬å¼€ API</h4><p>è°ƒç”¨å‡½æ•°æ—¶éµå¾ªä»¥ä¸‹å‡ ç‚¹åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå¯ä»¥å°‘èµ°å¼¯è·¯.</p>
<ul>
<li>å±æ€§è®¿é—®é€šå¸¸ä¼šç›´æ¥è¿”å›å€¼(å¦‚ <code>int</code> æˆ– <code>const char *</code>),ä½†å¦‚æœå‡½æ•°è°ƒç”¨å¤±è´¥,é‚£ä¹ˆå°†è¿”å›ä¸€ä¸ª<code>int</code>å€¼,ä¸”è¿”å›å€¼åœ¨å‚æ•°åˆ—è¡¨çš„ç¬¬ä¸€ä½,è·Ÿåœ¨æ­¤å‡½æ•°æ­£åœ¨æ“ä½œçš„å¯¹è±¡ä¹‹å,å¯èƒ½ä¹Ÿä¼šéœ€è¦å…¶ä»–çš„å‚æ•°</li>
<li>å¦‚æœä¸€ä¸ªå‡½æ•°è¿”å›å€¼æ˜¯ä¸ªå¯¹è±¡,é‚£ä¹ˆæ­¤å‡½æ•°æ˜¯ä¸ª <code>getter</code> å‡½æ•°,è¿™ä¸ªå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå’Œå®ƒçš„çˆ¶å¯¹è±¡ç»‘å®š.å¦‚æœå‡½æ•°è¿”å›å€¼çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æŒ‡é’ˆç±»å‹çš„,é‚£ä¹ˆå®ƒçš„ç”Ÿå‘½å‘¨æœŸç”±è°ƒç”¨è€…æ§åˆ¶,å¿…è¦çš„æ—¶å€™åº”è¯¥è¢«é‡Šæ”¾.è¿”å›çš„ <code>String</code> é€šè¿‡ <code>git_buf</code> ä»£æ›¿,ä»¥ä¾¿å¯ä»¥å¤ç”¨å’Œå®‰å…¨é‡Šæ”¾.</li>
<li>å¤§å¤šæ•° <code>libgit2</code> å’Œ I/O ç›¸å…³çš„æ“ä½œå¤±è´¥å¯èƒ½æ˜¯å› ä¸ºä»æ–‡ä»¶ç³»ç»Ÿè·å–æ•°æ®å¯¼è‡´çš„å„ç§ä¸ªæ ·çš„é”™è¯¯å’Œå¤æ‚çš„åŸå› .</li>
<li><code>Git</code> ç³»ç»Ÿä¸­çš„è·¯å¾„ä¹‹é—´æ˜¯ä»¥ / (0x2F) åˆ†éš”çš„.å¦‚æœä¸€ä¸ªå‡½æ•°æ¥å—æŸä¸ªç£ç›˜ä¸Šçš„è·¯å¾„,é‚£ä¹ˆåœ¨ Windows ä¸Šå°±å¯ä»¥ä½¿ç”¨ \ (0x5C) ä½œä¸ºåˆ†éš”.</li>
<li>ä¸è¦æ··ç”¨å†…å­˜ç”³è¯·.åœ¨ <code>libgit2</code> ä¸­å¦‚æœéœ€è¦ç”³è¯·å†…å­˜,é€šå¸¸æƒ…å†µä¸‹æ²¡æœ‰åˆé€‚çš„é‡Šæ”¾å‡½æ•°æ¨è.è¯·ä½¿ç”¨é’ˆå¯¹å„è‡ªå¯¹è±¡ç±»å‹çš„é‡Šæ”¾å‡½æ•°.</li>
</ul>
<h4 id="å…¼å®¹æ€§"><a href="#å…¼å®¹æ€§" class="headerlink" title="å…¼å®¹æ€§"></a>å…¼å®¹æ€§</h4><p><code>libgit2</code> å¯ä»¥é€šè¿‡å„ç§ä¸åŒçš„ç¼–è¯‘å™¨è¿è¡Œåœ¨ä¸åŒçš„å¹³å°ä¸Š.</p>
<p><code>libgit2</code> çš„å…¬å¼€ API æ˜¯ <code>ANISI C(c89)</code> å…¼å®¹çš„.</p>
<p><code>libgit2</code> å†…éƒ¨ä½¿ç”¨ C99 çš„ä¾¿æºå­é›†-ä»¥ä¾¿æœ€å¤§å…¼å®¹å„ç§å¹³å°(å¦‚ MSVC),é¿å…ç‰¹å®š C99 çš„æ‰©å±•ç­‰.å±€éƒ¨å˜é‡éƒ½æ˜¯åœ¨å—çš„é¡¶éƒ¨å£°æ˜,åŒæ—¶é¿å…ä½¿ç”¨ // æ³¨é‡Š.</p>
<p>ä¸ºäº†æé«˜æ‰©å±•æ€§,æˆ‘ä»¬åœ¨ä»£ç å†…é¿å…ä½¿ç”¨ <code>#ifdef</code> è¯­å¥.é€šå¸¸æƒ…å†µä¸‹,è¿™æ˜¯ä¸å¯é¿å…çš„,å› ä¸ºå®ƒä¼šå¯¼è‡´éš¾ä»¥ç»´æŠ¤,æ‰€ä»¥æˆ‘ä»¬å°½é‡é¿å…ä½¿ç”¨è¿™äº›è¯­å¥.</p>
<h4 id="å’Œä¸Šä¸‹æ–‡åŒ¹é…"><a href="#å’Œä¸Šä¸‹æ–‡åŒ¹é…" class="headerlink" title="å’Œä¸Šä¸‹æ–‡åŒ¹é…"></a>å’Œä¸Šä¸‹æ–‡åŒ¹é…</h4><p>å¦‚æœè¦ä»æ­¤æ–‡æ¡£ä¸­åªæç‚¼ä¸€æ¡è§„åˆ™å‡ºæ¥,é‚£å°±æ˜¯<i style="background:white;color:black">æ–°æ·»åŠ çš„ä»£ç åº”è¯¥å’Œä¸Šä¸‹æ–‡åŒ¹é…,ä½¿å¾—çœ‹ä¸å‡ºæ¥æ–°æ—§ä»£ç çš„åŒºåˆ«</i>.å¯¹æˆ‘ä»¬æ¥è¯´,ä»£ç çš„ä¸€è‡´æ€§æ¯”æ‹¬å·çš„ä½ç½®æˆ–ä½¿ç”¨ç©ºæ ¼è¿˜æ˜¯ tab çš„äº‰è®ºæ›´é‡è¦.</p>
<p>æˆ‘ä»¬æ¥å—ä»£ç é‡æ„,ä½†æ˜¯æ‹’ç»ä»…ä»…æ ¼å¼åŒ–çš„æäº¤.</p>
<h4 id="å‘½å"><a href="#å‘½å" class="headerlink" title="å‘½å"></a>å‘½å</h4><p>æ‰€æœ‰å¯¼å‡ºçš„ç±»å‹å’Œå‡½æ•°éƒ½æ˜¯ä»¥ <code>git_</code> å¼€å¤´,æ‰€æœ‰çš„ <code>#define</code> å®éƒ½æ˜¯ä»¥ <code>GIT_</code> å¼€å¤´.<code>libgit2</code> çš„ API é€šå¸¸éƒ½æ˜¯åˆ†æ•£åœ¨å’Œå…¶å¤´æ–‡ä»¶å¯¹åº”çš„å‡½æ•°æ¨¡å—ä¸­.æ¨¡å—ä¸­çš„æ‰€æœ‰å‡½æ•°éƒ½åº”è¯¥åƒè¿™æ ·å‘½å <code>git_modulename_functionname()ï¼ˆå¦‚ git_repository_open()ï¼‰</code></p>
<p>ä»…æœ‰ä¸€ä¸ªè¾“å‡ºå‚æ•°çš„å‡½æ•°çš„å…¥å‚åº”å‘½åä¸º <code>out</code>.å¤šè¾“å‡ºå‡½æ•°çš„å…¥å‚åº”å‘½åä¸º <code>foo_out</code>ã€<code>bar_out</code> ç­‰.</p>
<p><code>git_oid</code> ç±»å‹çš„å‚æ•°åº”è¯¥å‘½åä¸º <code>id</code> æˆ– <code>foo_id</code>.è¿”å› <code>git_oid</code> ç±»å‹çš„å‡½æ•°å‚æ•°åº”å‘½åä¸º <code>git_foo_id</code>.</p>
<p>å¦‚æœä¼ å…¥é—­åŒ…å‡½æ•°,é‚£ä¹ˆåŒæ—¶åº”æä¾›ä¸€ä¸ªåä¸º <code>void*</code> çš„é¢å¤–è¾“å…¥å‚æ•°è´Ÿè½½ä»¥ä¾¿åœ¨é—­åŒ…è¢«è°ƒç”¨æ—¶ä¼ å…¥.</p>
<h4 id="ç±»å‹å®šä¹‰"><a href="#ç±»å‹å®šä¹‰" class="headerlink" title="ç±»å‹å®šä¹‰"></a>ç±»å‹å®šä¹‰</h4><p>æ— è®ºä½•æ—¶éƒ½åº”ä½¿ç”¨ <code>typedef</code>.å¦‚æœæŸä¸ªç»“æ„ä½“ä»…æ˜¯å‡½æ•°æŒ‡é’ˆçš„é›†åˆ,é‚£ä¹ˆæŒ‡é’ˆç±»å‹æ˜¯ä¸å¿…å•ç‹¬å®šä¹‰çš„,ä½†æ˜¯æ¾æ•£çš„å‡½æ•°æŒ‡é’ˆç±»å‹(æ­¤å¤„åº”å€¼éå…¨å‡½æ•°æŒ‡é’ˆçš„ç»“æ„ä½“)åº”è¯¥å®šä¹‰ç±»å‹.</p>
<h4 id="å¯¼å‡º"><a href="#å¯¼å‡º" class="headerlink" title="å¯¼å‡º"></a>å¯¼å‡º</h4><p>æ‰€æœ‰å¯¼å‡ºçš„å‡½æ•°éƒ½åº”å¦‚ä¸‹å£°æ˜:<br><code>GIT_EXTERN(result_type) git_modulename_functionanme(arg_list);</code></p>
<h4 id="å†…éƒ¨æ¶ˆæ¯"><a href="#å†…éƒ¨æ¶ˆæ¯" class="headerlink" title="å†…éƒ¨æ¶ˆæ¯"></a>å†…éƒ¨æ¶ˆæ¯</h4><p>å‘½åæ¨¡å—çš„å‡½æ•°åº”éµä»ä¸¤ä¸ªä¸‹åˆ’çº¿,å¦‚<code>git_odb__read_packed</code>,æ˜¯åŠç§æœ‰çš„å‡½æ•°.é€šå¸¸åº”è¯¥åœ¨ <code>libgit2</code> å†…éƒ¨ä½¿ç”¨,æœªæ¥å¯èƒ½ä¼šè¢«åºŸå¼ƒæˆ–è€…å£°æ˜å‘ç”Ÿå˜åŒ–.</p>
<h4 id="å‡½æ•°å‚æ•°"><a href="#å‡½æ•°å‚æ•°" class="headerlink" title="å‡½æ•°å‚æ•°"></a>å‡½æ•°å‚æ•°</h4><p>ç¬¬ä¸€ä¸ªæ˜¯è¾“å‡ºå‚æ•°.</p>
<p>æ— è®ºä½•æ—¶,å‡ºå…¥çš„æŒ‡é’ˆå‚æ•°å¿…é¡»æ˜¯ <code>const</code>,æŸäº›ç»“æ„ä½“å†…éƒ¨é€šè¿‡å¯å˜ç»“æ„æ¥é˜»æ­¢è¿™ä¸€ç‰¹æ€§(å¦‚ <code>git_repository å’Œ git_index</code>).</p>
<p>å›è°ƒæ€»æ˜¯ä½¿ç”¨ <code>void*</code> è´Ÿè½½ä½œä¸ºå®ƒçš„æœ€åä¸€ä¸ªå‚æ•°,å›è°ƒæŒ‡é’ˆæ€»æ˜¯å’Œè´Ÿè½½åŒ¹é…,é€šå¸¸æƒ…å†µä¸‹éƒ½åœ¨å‚æ•°åˆ—è¡¨çš„æœ€å:<br><code>int git_foo(git_repository *repo,git_foo_cb callback,void *payload);</code></p>
<h4 id="å†…å­˜æ‰€å±"><a href="#å†…å­˜æ‰€å±" class="headerlink" title="å†…å­˜æ‰€å±"></a>å†…å­˜æ‰€å±</h4><p>è°ç”³è¯·çš„å†…å­˜è°è´Ÿè´£é‡Šæ”¾;ä½†æŸäº›è¿”å›æŒ‡å‘æŸä¸ª buffer çš„æŒ‡é’ˆåˆ™å½’å…¶ä»–å¯¹è±¡æ‰€æœ‰.</p>
<h4 id="è¿”å›ä»£ç "><a href="#è¿”å›ä»£ç " class="headerlink" title="è¿”å›ä»£ç "></a>è¿”å›ä»£ç </h4><p>å¤§å¤šæ•°å…¬å¼€ API éƒ½åº”è¿”å› <code>int</code> ç±»å‹çš„é”™è¯¯ç .å’Œå¤§å¤šæ•° C å‡½æ•°åº“ç±»ä¼¼,0 è¡¨ç¤ºæˆåŠŸ,è´Ÿæ•°è¡¨ç¤ºå¤±è´¥.</p>
<p>æŸäº›ç»‘å®šä¼šæŠŠé”™è¯¯ç è½¬ä¸ºç²¾ç¡®çš„å¼‚å¸¸ç±»å‹.æ‰€ä»¥è¿”å›ä¸€ä¸ªè¯­ä¹‰æ˜ç¡®çš„é”™è¯¯ç hiné‡è¦.æŸ¥çœ‹<code>include/git2/errors.h</code>äº†è§£æ›´å¤šé”™è¯¯ç .</p>
<p>åœ¨ä½ è‡ªå·±çš„å®ç°ä¸­,ä½¿ç”¨ <code>git_error_set()</code> ç»™è°ƒç”¨è€…æä¾›æ›´å¤šçš„é¢å¤–ä¿¡æ¯.</p>
<p>å¦‚æœ <code>libgit2</code> å‡½æ•°å†…éƒ¨è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°æŠ¥é”™,ä½†æ˜¯é”™è¯¯æ²¡æœ‰å‘ä¸ŠæŠ›,ä½¿ç”¨ <code>git_error_clear()</code> æ¥é˜»æ­¢è°ƒç”¨è€…ä¹‹åè·å–åˆ°è¯¥é”™è¯¯ä¿¡æ¯.</p>
<h4 id="ç»“æ„ä½“"><a href="#ç»“æ„ä½“" class="headerlink" title="ç»“æ„ä½“"></a>ç»“æ„ä½“</h4><p>å¤§å¤šæ•°å…¬å¼€çš„ç±»å‹éƒ½åº”è¯¥æ˜¯ä¸é€æ˜çš„,å¦‚:<code>typedef struct git_odb git_odb;</code></p>
<p>åœ¨åº“å‡½æ•°å£°æ˜æ—¶å°±è¿”å›ä¸€ä¸ªæ–°å®ä¾‹,è€Œä¸æ˜¯åœ¨åº”ç”¨é‡Œ.è¿™æ ·æœ‰åŠ©äºä¸æ”¹åŠ¨å®¢æˆ·ç«¯ä»£ç å¢åŠ (å‹ç¼©)å¤§å°.</p>
<p>ä¸ºäº†ä¿è¯ ABI å…¼å®¹æ€§,åœ¨æ‰€æœ‰å…¨å±€å¯è§çš„ç»“æ„ä½“ä¸­å¼•å…¥ <code>int version</code> å±æ€§,åŒæ—¶åœ¨åˆå§‹åŒ–ç»“æ„ä½“æ—¶èµ‹äºˆæœ€æ–°çš„å€¼.åªè¦ç»“æ„ä½“å‘ç”Ÿå˜åŒ–,åˆ™å¢åŠ  <code>latest</code> å€¼,å¹¶ä¸”æ­¤å€¼ä»…åœ¨ç»“æ„ä½“æœ«å°¾å£°æ˜.</p>
<h4 id="å¯é€‰ç»“æ„ä½“"><a href="#å¯é€‰ç»“æ„ä½“" class="headerlink" title="å¯é€‰ç»“æ„ä½“"></a>å¯é€‰ç»“æ„ä½“</h4><p>å¦‚æœæŸä¸ªå‡½æ•°å‚æ•°åˆ—è¡¨è¿‡å¤š,é‚£ä¹ˆå¯ä»¥æŠŠä»–ä»¬å°è£…ä¸ºä¸€ä¸ªå¯é€‰çš„ç»“æ„ä½“.ç¡®ä¿ä»–ä»¬çš„å…¨å±€å¯è§çš„,åŒ…å« version å±æ€§,æä¾›åˆå§‹åŒ–å¸¸é‡æˆ–æ„é€ æ–¹æ³•. ä½¿ç”¨èµ·æ¥å°±hinç®€å•äº†.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git_foo_option opts &#x3D; GIT_FOO_OPTIONS_INIT;</span><br><span class="line">opts.baz &#x3D; BAZ_OPTION_ONE;</span><br><span class="line">git_foo(&amp;opts);</span><br></pre></td></tr></table></figure>
<h4 id="æšä¸¾"><a href="#æšä¸¾" class="headerlink" title="æšä¸¾"></a>æšä¸¾</h4><p>å®šä¹‰æ‰€æœ‰çš„æšä¸¾ç±»å‹.å¦‚æœæ¯ä¸ªé€‰é¡¹éƒ½æ˜¯ç‹¬ç«‹çš„,é‚£ä¹ˆä½¿ç”¨æšä¸¾ç±»å‹ä½œä¸ºä¼ å…¥å‚æ•°.å¦‚æœæ˜¯ä½ç§»æ“ä½œåçš„æ ‡è®°,ä½¿ç”¨ <code>unsigned int æˆ– uint32_t</code> æˆ–å…¶ä»–åˆé€‚çš„ç±»å‹.</p>
<h4 id="ä»£ç å¸ƒå±€"><a href="#ä»£ç å¸ƒå±€" class="headerlink" title="ä»£ç å¸ƒå±€"></a>ä»£ç å¸ƒå±€</h4><p>å°½é‡ä¿æŒä¸€è¡Œæœ€å¤š80ä¸ªå­—ç¬¦.è¿™ä¸ªè¦æ±‚ä¸æ˜¯å¾ˆä¸¥æ ¼,å¾ˆæ˜æ˜¾è¶…è¿‡ 80 å­—ç¬¦å°±å¾ˆä¸å¥½çœ‹äº†.æŒ‰ç…§æƒ¯ä¾‹å¯¹ä»£ç å¯¹é½,å…¬å¼€å‡½æ•°å£°æ˜å¯ä»¥ä½¿ç”¨ä¸åŒçš„é£æ ¼.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;** All on one line is okay if it fits *&#x2F;</span><br><span class="line">GIT_EXTERN(int) git_foo_simple(git_oid *id);</span><br><span class="line"></span><br><span class="line">&#x2F;** Otherwise one argument per line is a good next step *&#x2F;</span><br><span class="line">GIT_EXTERN(int) git_foo_id(</span><br><span class="line">	git_oid **out,</span><br><span class="line">	int a,</span><br><span class="line">	int b);</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ tab ç¼©ç´§,8 ä½æœ€ä½³.</p>
<p>é¿å…å¤šä½™ç©ºæ ¼,æ–°è¡Œä½¿ç”¨ Unix é£æ ¼(å¦‚ä»“åº“æ²¡æœ‰ CRLF-å¦‚æœæ˜¯åœ¨ windows æœºå™¨ç å­—,é‚£ä¹ˆè®¾ç½® <code>core.autocrlf</code> ä¸º true)</p>
<h4 id="æ–‡æ¡£"><a href="#æ–‡æ¡£" class="headerlink" title="æ–‡æ¡£"></a>æ–‡æ¡£</h4><p>æ‰€æœ‰çš„æ³¨é‡Šéƒ½åº”ä»¥ Doxygen çš„ <code>javadoc</code> é£æ ¼ä½œä¸ºå…¬å¼€ API å‡½æ•°çš„æ ¼å¼åŒ–é£æ ¼.å°½é‡å¯¹æ¯ä¸ªå‚æ•°æ³¨é‡Š,å¦‚æœå‚æ•°åˆ—è¡¨æ”¹å˜,é‚£ä¹ˆéšæ‰‹æ›´æ–°.</p>
<h4 id="å…¬å¼€å¤´æ¨¡ç‰ˆ"><a href="#å…¬å¼€å¤´æ¨¡ç‰ˆ" class="headerlink" title="å…¬å¼€å¤´æ¨¡ç‰ˆ"></a>å…¬å¼€å¤´æ¨¡ç‰ˆ</h4><p>å¦‚æœåˆ›å»ºæ–°çš„å…¬å¼€å¤´æ–‡ä»¶ä½¿ç”¨å¦‚ä¸‹ä½œä¸ºå¤´æ¨¡ç‰ˆ:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#ifndef INCLUDE_git_$&#123;filename&#125;_h__</span><br><span class="line">#define INCLUDE_git_$&#123;filename&#125;_h__</span><br><span class="line"></span><br><span class="line">#include &quot;git&#x2F;common.h&quot;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @file git&#x2F;$&#123;filename&#125;.h</span><br><span class="line"> * @brief Git some description</span><br><span class="line"> * @defgroup git_$&#123;filename&#125; some description routines</span><br><span class="line"> * @ingroup Git</span><br><span class="line"> * @&#123;</span><br><span class="line"> *&#x2F;</span><br><span class="line">GIT_BEGIN_DECL</span><br><span class="line"></span><br><span class="line">&#x2F;* ... definitions ... *&#x2F;</span><br><span class="line"></span><br><span class="line">&#x2F;** @&#125; *&#x2F;</span><br><span class="line">GIT_END_DECL</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<h4 id="å†…è”å‡½æ•°"><a href="#å†…è”å‡½æ•°" class="headerlink" title="å†…è”å‡½æ•°"></a>å†…è”å‡½æ•°</h4><p>æ‰€æœ‰çš„å†…è”å‡½æ•°éƒ½åº”å¦‚ä¸‹å£°æ˜</p>
<p><code>GIT_INLINE(result_type) git_modulename_functionname(arg_list);</code></p>
<p>ä¸ºäº†ä¿è¯ ANSI C å…¼å®¹,<code>GIT_INLINE æˆ– inline</code> éƒ½ä¸åº”è¯¥å‡ºç°åœ¨å…¬å¼€ API å¤´æ–‡ä»¶.</p>
<h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><p><code>libgit2</code> ä½¿ç”¨ <code>clar</code> æµ‹è¯•æ¡†æ¶.</p>
<p>Balahbalahâ€¦J</p>
]]></content>
  </entry>
</search>
